<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kokoÂ∞èÊâãÊú∫</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --theme-primary: #81c784;
            --theme-primary-hover: #66bb6a;
            --theme-secondary: #aed581;
            --sent-message-bg: #e6f5c9;
            --background-start: #f1f8e9;
            --background-end: #ffffff;
            --text-on-primary: #ffffff;
            --text-dark: #424242;
            --text-gray: #757575;
            --soft-red: #ff8a80;
            --border-color: #e8e8e8;
            --shadow-color: rgba(129, 199, 132, 0.12);
            --soft-radius: 16px;
            --card-background: rgba(255, 255, 255, 0.7);
        }
        
       /* --- ÊÇ®Êñ∞Â¢ûÁöÑÂèô‰∫ãÊ®°ÂºèÁæéÂåñÊ†∑Âºè --- */
.narrative-speech {
    background-color: #e6f5c9; /* Ê∏ÖÊñ∞ÁöÑÈùíËãπÊûúËâ≤ËÉåÊôØ (Êù•Ëá™ÊÇ®Â∑≤ÊúâÁöÑ --sent-message-bg ÂèòÈáè) */
    padding: 2px 8px;
    border-radius: 8px;
    display: inline-block;
    margin: 1px 0;
}

.narrative-psychology {
    text-decoration: underline;
    text-decoration-color: #66bb6a; /* ÈùíËãπÊûúËâ≤‰∏ãÂàíÁ∫ø (Êù•Ëá™ÊÇ®Â∑≤ÊúâÁöÑ --theme-primary ÂèòÈáè) */
    text-decoration-thickness: 2px;
}

.narrative-action {
    font-style: italic;
    color: #517655; /* Ê∑±‰∏ÄÁÇπÁöÑÈùíËãπÊûúËâ≤ (Êù•Ëá™ÊÇ®Â∑≤ÊúâÁöÑ --theme-primary-hover ÂèòÈáè) */
} 
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-image: linear-gradient(to bottom, var(--background-start), var(--background-end));
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #app-container, #screen {
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        
        #screen {
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 25px var(--shadow-color);
        }
        
        .chat-header {
            background-color: rgba(129, 199, 132, 0.75);
            backdrop-filter: blur(12px);
            color: var(--text-on-primary);
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header .back-btn,
        .chat-header .action-btn {
            color: var(--text-on-primary);
        }

        .app-header, .world-book-header, .api-header, .moments-header, .discover-header, .contact-settings-header {
            background-color: rgba(220, 237, 200, 0.7);
            backdrop-filter: blur(12px);
            color: var(--text-dark);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        
        .chat-input-area {
            background-color: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
        }
        
        #message-input {
            flex-grow: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
            align-self: flex-end;
            min-height: 42px;
        }

        .input-action-btn {
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 8px;
            cursor: pointer;
            font-size: 20px;
            flex-shrink: 0;
            transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            align-self: flex-end;
        }
        .input-action-btn:hover {
            transform: scale(1.1);
        }

        #send-btn {
            background-color: var(--theme-primary);
            color: var(--text-on-primary);
            width: auto;
            padding: 0 18px;
            border-radius: 22px;
        }
        #send-btn .fa-paper-plane {
            font-size: 18px;
        }

        #request-reply-btn {
            background-color: var(--theme-secondary);
            color: var(--text-on-primary);
        }
        
        #chat-screen {
            background-image: url('https://i.postimg.cc/SQ3DH79X/MEITU-20250811-151831796.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        
        #main-screen { height: 100%; display: flex; flex-direction: column; }
        .app-title { font-size: 20px; font-weight: 700; }
        .contacts-container { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .section-title { padding: 10px 15px; font-size: 14px; color: var(--text-gray); background-color: transparent; font-weight: 600; }
        .contact-item { display: flex; align-items: center; padding: 12px 15px; background-color: transparent; border-bottom: 1px solid var(--border-color); border-radius: var(--soft-radius); margin: 0 8px 4px; cursor: pointer; transition: background-color 0.2s; }
        .contact-item:hover { background-color: rgba(255, 255, 255, 0.7); }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-gray); overflow: hidden; flex-shrink: 0; }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-info { flex-grow: 1; min-width: 0; }
        .contact-name { font-weight: 600; margin-bottom: 3px; color: var(--text-dark); }
        .contact-last-message { font-size: 14px; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .contact-time { font-size: 12px; color: #999; margin-top: 5px; }
        .unread-count { background-color: var(--theme-primary); color: var(--text-on-primary); font-size: 12px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .bottom-nav { display: flex; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); padding: 10px 0; flex-shrink: 0; }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); font-size: 14px; cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .nav-item-content { position: relative; display: inline-block; }
        .nav-item.active { color: var(--theme-primary); transform: scale(1.1); }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .notification-dot { position: absolute; top: -2px; right: -8px; width: 8px; height: 8px; background-color: var(--soft-red); border-radius: 50%; border: 1px solid white; display: none; }
        .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; }
        .chat-info { flex-grow: 1; text-align: center; }
        .chat-name { font-weight: 700; font-size: 18px; }
        .chat-status { font-size: 13px; opacity: 0.8; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        #load-more-messages { background-color: #e0e0e0; color: #555; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; margin: 0 auto 15px; font-size: 13px; display: none; }
        #load-more-messages:hover { background-color: #d1d1d1; }
        .message-wrapper { display: flex; max-width: 85%; margin-bottom: 2px; position: relative; }
        .message-wrapper.received { align-self: flex-start; flex-direction: row; }
        .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; visibility: hidden; }
        .is-first-in-sequence .message-avatar { visibility: visible; margin-top: 10px; }
        .message-avatar img { width: 100%; height: 100%; border-radius: 6px; object-fit: cover; }
        .message-body { display: flex; flex-direction: column; margin: 0 10px; }
        .message-wrapper.sent .message-body { align-items: flex-end; }
        .message-wrapper.received .message-body { align-items: flex-start; }
        .message-author-name { font-size: 13px; color: #888; margin-bottom: 4px; display: none; }
        .is-first-in-sequence .message-author-name { display: block; margin-top: 10px;}
        .message { padding: 10px 18px; border-radius: 22px; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; min-width: 50px; box-shadow: 0 2px 4px var(--shadow-color); }
        .message-timestamp { font-size: 11px; color: #aaa; margin-top: 4px; padding: 0 5px; }
        .message-wrapper.selected .message, .message-wrapper.selected .message.red-packet, .message-wrapper.selected .message.voice, .message-wrapper.selected .message.picture-description { background-color: #bde0fe !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.received { background-color: white; border-top-left-radius: 4px; }
        .message.sent { background-color: var(--sent-message-bg); border-top-right-radius: 4px; }
        .message-image-container { padding: 5px; background-color: inherit; border-radius: inherit; }
        .message-image { max-width: 150px; max-height: 150px; border-radius: 12px; display: block; cursor: default; }
        .message-image-container.sent { border-top-right-radius: 4px; }
        .message-image-container.received { border-top-left-radius: 4px; }
        .message.image-message { padding: 0; background-color: transparent; box-shadow: none; }
        .emoji-btn, .attachment-btn { font-size: 24px; margin-right: 10px; cursor: pointer; color: var(--text-gray); align-self: flex-end; margin-bottom: 10px; }
        .attachment-btn { background: none; border: none; padding: 0; }
        #edit-mode-bar, #moments-edit-mode-bar { display: none; padding: 10px 15px; background-color: #f0f0f0; border-top: 1px solid #ddd; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .edit-action-btn { padding: 8px 16px; border-radius: 20px; border: none; font-size: 14px; cursor: pointer; }
        #delete-selected-btn, #delete-selected-moments-btn { background-color: var(--soft-red); color: white; }
        #cancel-edit-btn, #cancel-moments-edit-btn { background-color: #bdc3c7; color: #333; }
        #profile-screen, #char-profile-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        
        .profile-header {
            background-image: linear-gradient(135deg, var(--sent-message-bg), #dcedc8);
            padding: 30px 20px 15px;
            text-align: center;
            color: var(--text-dark);
            position: relative;
            flex-shrink: 0;
        }
        .avatar-container {
            position: relative;
            margin: 0 auto 15px;
            width: 100px;
            height: 100px;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .change-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--text-dark);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .profile-name { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .profile-status { font-size: 16px; opacity: 0.9; }
        .profile-actions { display: flex; justify-content: center; gap: 20px; padding: 10px 0; background-color: white; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .action-item { text-align: center; cursor: pointer; }
        .action-icon { width: 50px; height: 50px; border-radius: 50%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--theme-primary); margin: 0 auto 10px; transition: all 0.3s; }
        .action-icon:hover { background-color: #e0f2f1; transform: scale(1.05); }
        .action-label { font-size: 14px; color: var(--text-gray); }
        .profile-details { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #f0f2f5; }
        .detail-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background-color: white; }
        .detail-item:last-child { border-bottom: none; }
        .discover-section .detail-item { border-radius: 0; margin-bottom: 0; }
        .discover-section .detail-item:first-child { border-top-left-radius: var(--soft-radius); border-top-right-radius: var(--soft-radius); }
        .discover-section .detail-item:last-child { border-bottom-left-radius: var(--soft-radius); border-bottom-right-radius: var(--soft-radius); border-bottom: none; }
        .detail-label { font-size: 16px; color: #333; font-weight: 600; }
        .detail-value { font-size: 16px; color: var(--text-gray); max-width: 60%; text-align: right; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { color: var(--theme-primary); font-size: 18px; cursor: pointer; padding: 5px; }
        #discover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .discover-title { font-size: 20px; font-weight: 700; flex-grow: 1; text-align: center; margin-left: 0; }
        .discover-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .discover-section { background-color: var(--card-background); border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px;}
        .discover-item { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; background-color: transparent; }
        .discover-item:last-child { border-bottom: none; }
        .discover-item:hover { background-color: rgba(255,255,255,0.5); }
        .discover-icon { width: 40px; height: 40px; border-radius: 8px; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--theme-primary); margin-right: 15px; }
        .discover-info { flex-grow: 1; }
        .discover-name { font-weight: 600; margin-bottom: 3px; }
        .discover-desc { font-size: 14px; color: var(--text-gray); }
        .discover-arrow { color: #999; font-size: 18px; }
        #world-book-screen, #api-settings-screen, #contact-settings-screen, #moments-screen, #diary-screen, #emoticon-library-screen, .preset-management-screen, #post-detail-screen, #trending-topic-screen, #square-api-settings-screen, #memory-album-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .world-book-content, .api-content, .contact-settings-content, .emoticon-library-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .world-book-list { display: flex; flex-direction: column; gap: 15px; }
        .world-book-item { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;}
        .world-book-item:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-color); }
        .book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .book-name { font-weight: 600; font-size: 18px; }
        .book-content { color: var(--text-gray); line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .api-title { font-size: 20px; font-weight: 600; margin-left: 15px; }
        .form-group { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: var(--theme-primary); }
        .form-button { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .form-group-inline .form-input { flex-grow: 1; }
        #fetch-models-btn, #fetch-square-models-btn { padding: 10px 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
        #add-world-book-modal, #post-moment-modal, #user-persona-preset-modal, #thought-preset-modal, #add-emoticon-modal, #automation-modal, #send-red-packet-modal, #send-transfer-modal, #send-voice-modal, #send-picture-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background-color: white; width: 90%; max-width: 400px; border-radius: var(--soft-radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background-color: var(--theme-primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn { font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .form-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .form-button:hover { background-color: var(--theme-primary-hover); }
        #add-contact-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .contact-form-group { margin-bottom: 20px; }
        .contact-form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .contact-form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .contact-form-input:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .contact-form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: white; }
        .contact-form-select:focus { outline: none; border-color: var(--theme-primary); }
        .mask-editor, .world-book-selector { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .mask-editor-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .mask-editor-group { margin-bottom: 15px; }
        .mask-editor-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .mask-editor-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .mask-editor-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .world-book-selector-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .world-book-selector .world-book-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #world-book-selector-list .world-book-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
        .world-book-checkbox { margin-right: 10px; }
        .world-book-name { font-weight: 500; }
        .save-settings-btn { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .user-mask-editor { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .user-mask-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .user-mask-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .user-mask-textarea:focus { outline: none; border-color: var(--theme-primary); }
        
        /* ---ÂπøÂú∫/ÂæÆÂçö Ê†∑Âºè--- */
        .moments-header .back-btn { font-size: 24px; cursor: pointer; position: relative; z-index: 1; }
        .moments-header .action-btn { font-size: 20px; }
        .header-actions { display: flex; gap: 20px; position: relative; z-index: 1; }
        .moments-content { flex-grow: 1; overflow-y: auto; background-color: #f0f2f5; }
        .mention {
    color: var(--theme-primary);
    font-weight: 600;
    cursor: pointer;
}
.mention:hover {
    text-decoration: underline;
}
        .feed-tabs { display: flex; justify-content: space-around; padding: 0 10px; background-color: #e8f5e9; flex-shrink: 0; }
        .feed-tab-btn { flex: 1; padding: 12px 0; font-size: 16px; font-weight: 600; color: var(--text-gray); border: none; background: none; cursor: pointer; position: relative; transition: color 0.3s; }
        .feed-tab-btn.active { color: var(--theme-primary); }
        .feed-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 10%; right: 10%; height: 3px; background-color: var(--theme-primary); border-radius: 3px; }

        .feed-sub-tabs { display: flex; justify-content: center; gap: 15px; padding: 8px 10px; background-color: #fafafa; flex-shrink: 0; border-bottom: 1px solid #eee; }
        .feed-sub-tab-btn { padding: 6px 14px; font-size: 14px; font-weight: 500; color: var(--text-gray); border: 1px solid #ddd; background-color: white; border-radius: 18px; cursor: pointer; transition: all 0.3s; }
        .feed-sub-tab-btn.active { color: white; background-color: var(--theme-primary); border-color: var(--theme-primary); }

        .posts-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .post-item { position: relative; display: flex; padding: 15px; gap: 12px; background-color: white; border-radius: var(--soft-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;}
        .post-delete-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-gray); font-size: 14px; cursor: pointer; z-index: 2; transition: all 0.2s; }
        .post-delete-btn:hover { background-color: var(--soft-red); color: white; }

        .post-item-avatar img { width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; }
        .post-content-area { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
        .post-author-name { font-weight: 700; color: var(--text-dark); }
        .post-author-handle { font-size: 14px; color: var(--text-gray); margin-left: 8px; }
        .post-text { line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-size: 15px; }
        .post-meta { color: #999; font-size: 13px; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; color: var(--text-gray); font-size: 14px; margin-top: 12px; padding-top: 8px; border-top: 1px solid #f0f0f0; }
        .post-action-btn { cursor: pointer; display: flex; align-items: center; gap: 6px; transition: color 0.2s; }
        .post-action-btn:hover, .post-action-btn.liked { color: var(--theme-primary); }
        .post-action-btn.liked .fa-heart { font-weight: 900; }
        .post-action-btn i { font-size: 16px; }

        .post-comments { background-color: #f7f9f9; border-radius: 10px; padding: 10px; font-size: 14px; display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .post-comments:empty { display: none; }
        
        .comment-delete-btn { color: var(--text-gray); font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.2s; }
        .comment-delete-btn:hover { color: var(--soft-red); }
        .post-comment-item:hover .comment-delete-btn { opacity: 1; }

        .post-comment-item { line-height: 1.5; padding: 8px 0; border-bottom: 1px solid #eee; }
        .post-comment-item:last-child { border-bottom: none; }
        .comment-author { font-weight: 600; color: var(--theme-primary); margin-right: 5px; cursor: pointer; }
        .comment-content { color: var(--text-dark); }
        .comment-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-gray); margin-top: 4px; }
        .comment-reply-to { background-color: #e9e9e9; padding: 4px 8px; border-radius: 8px; font-size: 13px; margin-left: 5px; }
        /* --- Êñ∞Â¢ûÔºöÁî®‰∫éÂú®Â∏ñÂ≠ê‰∏≠ÊòæÁ§∫‰ΩúËÄÖÁ≠æÂêç --- */
.post-author-signature {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 4px; /* ‰∏éÊòµÁß∞ÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
    padding-bottom: 8px; /* ‰∏éÂ∏ñÂ≠êÊ≠£ÊñáÊãâÂºÄ‰∏ÄÁÇπË∑ùÁ¶ª */
    white-space: pre-wrap; /* ÂÖÅËÆ∏Á≠æÂêç‰∏≠ÁöÑÊç¢Ë°å */
    word-break: break-word;
}


        /* ÁÉ≠ÊêúÊ¶úÊ†∑Âºè */
        .trending-list { list-style: none; padding: 10px; background-color: white;}
        .trending-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .trending-item:hover { background-color: #f9f9f9; }
        .trending-item:last-child { border-bottom: none; }
        .trending-rank { font-size: 18px; font-weight: bold; color: var(--text-gray); width: 40px; text-align: center; }
        .trending-rank.top-3 { color: var(--soft-red); }
        .trending-info { flex-grow: 1; }
        .trending-title { font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
        .trending-meta { font-size: 13px; color: var(--text-gray); }
        .trending-tag { background-color: #ffcdd2; color: #c62828; font-size: 11px; padding: 2px 6px; border-radius: 5px; margin-left: 8px; font-weight: bold; }
        
        #post-detail-screen { background-color: #f0f2f5; }
        .post-detail-content { flex-grow: 1; overflow-y: auto; }
        #post-detail-container { padding: 0; }
        #post-detail-container .post-item { cursor: default; }
        .comments-section { padding: 15px; background-color: #f0f2f5; }
        .comments-title { font-size: 16px; font-weight: 700; color: var(--text-dark); padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
        .comment-input-area { display: flex; padding: 10px 15px; background-color: white; border-top: 1px solid #ddd; flex-shrink: 0; }
        #comment-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 18px; padding: 8px 15px; font-size: 15px; resize: none; }
        #submit-comment-btn { background-color: var(--theme-primary); color: white; border: none; border-radius: 18px; padding: 8px 20px; margin-left: 10px; font-weight: 600; cursor: pointer; }
        
        .diary-entry {
            position: relative;
            background-color: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .diary-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .diary-entry-meta { font-size: 12px; color: #999; margin-bottom: 10px; }
        .diary-entry-content { font-size: 16px; line-height: 1.6; color: #333; }
        .diary-delete-btn { position: absolute; top: 15px; right: 15px; font-size: 18px; color: #aaa; cursor: pointer; transition: color 0.2s ease; }
        .diary-delete-btn:hover { color: var(--soft-red); }
        .preset-list { display: flex; flex-direction: column; gap: 10px; padding: 15px 20px; }
        .preset-item { background-color: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
        .preset-info { flex-grow: 1; cursor: pointer; min-width: 0; margin-right: 10px; }
        .preset-name { font-weight: 500; font-size: 16px; color: #333; margin-bottom: 5px; }
        .preset-desc { font-size: 13px; color: var(--text-gray); overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .preset-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .preset-action-btn { font-size: 18px; color: #999; cursor: pointer; padding: 5px; }
        .preset-action-btn:hover { color: var(--theme-primary); }
        .preset-action-btn.delete:hover { color: var(--soft-red); }
        .emoticon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .emoticon-item { background-color: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 1px 3px var(--shadow-color); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .emoticon-item img { max-width: 100%; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .emoticon-name { font-size: 12px; color: #333; text-align: center; word-break: break-all; }
        .emoticon-delete-btn { position: absolute; top: -5px; right: -5px; background-color: var(--soft-red); color: white; width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; line-height: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #emoticon-picker { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; padding: 10px; display: none; z-index: 50; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        #emoticon-picker.active { display: grid; }
        #emoticon-picker .emoticon-item { cursor: pointer; transition: transform 0.2s; }
        #emoticon-picker .emoticon-item:hover { transform: scale(1.1); }
        #emoticon-picker .emoticon-delete-btn { display: none; }
        #feed-status-indicator {
            padding: 10px;
            text-align: center;
            background-color: #e8f5e9;
            color: var(--text-gray);
            font-size: 14px;
            display: none;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            order: 1; /* Á°Æ‰øùÂÆÉÂú®header‰∏ãÈù¢ */
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--theme-primary); }
        input:focus + .slider { box-shadow: 0 0 1px var(--theme-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }
        #attachment-menu { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; z-index: 50; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(10px); opacity: 0; }
        #attachment-menu.active { display: grid; transform: translateY(0); opacity: 1; }
        .attachment-menu-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-align: center; }
        .attachment-menu-item .icon-wrapper { width: 60px; height: 60px; background-color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #555; margin-bottom: 8px; border: 1px solid #eee; }
        .attachment-menu-item .label { font-size: 13px; color: var(--text-gray); }
        .attachment-menu-item:hover .icon-wrapper { background-color: #f0f0f0; }
        .system-notification { align-self: center; background-color: #e1e1e1; color: var(--text-gray); font-size: 12px; padding: 5px 12px; border-radius: 15px; margin: 10px 0; text-align: center; }
        .message.picture-description { display: flex; align-items: center; cursor: pointer; }
        .message.sent.picture-description { background-color: var(--sent-message-bg); }
        .message.received.picture-description { background-color: #fff; }
        .message.picture-description i { font-size: 20px; color: var(--text-gray); margin-right: 10px; }
        .message.picture-description span { color: #333; }
        .message.voice { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .message.voice .fa-wifi { font-size: 20px; transform: rotate(90deg); color: var(--text-gray); }
        .message.sent.voice { background-color: var(--sent-message-bg); }
        .message.received.voice { background-color: #fff; }
        .message.sent.voice .fa-wifi { order: 2; margin-left: 15px; }
        .message.received.voice .fa-wifi { margin-right: 15px; }
        .voice-duration { color: var(--text-gray); }
        .transcribed-text { background-color: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 14px; color: #333; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out; }
        .transcribed-text.visible { max-height: 200px; opacity: 1; }
        .message.red-packet { background-color: #FFCC80; color: #5D4037; width: 240px; padding: 0; overflow: hidden; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.2); }
        .message.red-packet.opened { background-color: #FFF3E0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
        .message.red-packet .red-packet-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.red-packet .red-packet-icon { font-size: 24px; margin-right: 10px; color: #FFA726; }
        .message.red-packet .red-packet-blessing { font-size: 15px; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .message.red-packet .red-packet-status { font-size: 13px; opacity: 0.9; }
        .message.red-packet.opened .red-packet-icon, .message.red-packet.opened .red-packet-blessing, .message.red-packet.opened .red-packet-status { color: #BCAAA4; }
        .message.red-packet .red-packet-footer { background-color: transparent; color: #A1887F; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(161, 136, 127, 0.2); }
        .message.red-packet.opened .red-packet-footer { color: #cebeba; border-top: 1px solid rgba(161, 136, 127, 0.1); }
        .message.sent.red-packet { border-top-right-radius: 0; }
        .message.received.red-packet { border-top-left-radius: 0; }
        .message.transfer { background-color: var(--theme-primary); color: white; width: 240px; padding: 0; overflow: hidden; position: relative; box-shadow: 0 2px 5px var(--shadow-color); }
        .message.transfer.completed { background-color: #C8E6C9; }
        .message.transfer.completed .transfer-info .transfer-text, .message.transfer.completed .transfer-info .transfer-amount { color: #388E3C; }
        .message.transfer.completed .transfer-icon i { color: var(--theme-primary-hover); }
        .message.transfer.completed::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--theme-primary-hover); }
        .message.transfer .transfer-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.transfer .transfer-icon { font-size: 24px; margin-right: 10px; }
        .message.transfer .transfer-info .transfer-text { font-size: 15px; font-weight: 500; }
        .message.transfer .transfer-info .transfer-amount { font-size: 18px; font-weight: bold; }
        .message.transfer .transfer-footer { background-color: transparent; color: white; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(255,255,255,0.3); opacity: 0.9; }
        .message.transfer.completed .transfer-footer { color: var(--theme-primary-hover); border-top: 1px solid rgba(102, 187, 106, 0.2); }
        .message.sent.transfer { border-top-right-radius: 0; }
        .message.received.transfer { border-top-left-radius: 0; }

        /* --- Pet Game Styles --- */
        #pet-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .pet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        #pet-name {
            color: var(--text-dark);
        }
        #pet-gold-display {
            font-size: 16px;
            color: #E6A23C;
        }
        .pet-visual-area {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin-bottom: 15px;
        }
        .pet-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .stat-bar-label {
            width: 60px;
            text-align: right;
        }
        .stat-bar {
            flex-grow: 1;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-bar-inner {
            height: 100%;
            width: 100%;
            border-radius: 5px;
            background-color: var(--theme-primary);
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .pet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .pet-action-btn {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f0f2f5;
            color: var(--text-dark);
        }
        .pet-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pet-action-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #work-pet-btn {
            background-color: var(--theme-secondary);
            color: white;
        }
        
        .slime {
    width: 60px; /* ÂÆΩÂ∫¶ËÆæ‰∏∫55px */
    height: 40px; /* È´òÂ∫¶ËÆæ‰∏∫40pxÔºåËøôÊ†∑Âü∫Á°ÄÂΩ¢Áä∂Êõ¥Á®≥ÂÆö */
    /* ËÉåÊôØËâ≤ÂíåÂçäÈÄèÊòéÊïàÊûú‰øùÊåÅ‰∏çÂèò */
    background-color: rgba(209, 233, 206, 0.8); 
    
    /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂè™ËÆæÁΩÆÂ∑¶‰∏äËßíÂíåÂè≥‰∏äËßíÁöÑÂúÜËßíÔºåËÆ©Â∫ïÈÉ®‰øùÊåÅÂπ≥Âù¶ */
    /* ËøôÂõõ‰∏™ÂÄºÂàÜÂà´ÂØπÂ∫îÔºöÂ∑¶‰∏ä„ÄÅÂè≥‰∏ä„ÄÅÂè≥‰∏ã„ÄÅÂ∑¶‰∏ã */
    border-radius: 60px 60px 20px 20px; 

    position: relative;
    animation: slime-bob 2s infinite ease-in-out;
    transition: all 0.5s ease;
    
    /* ËæπÊ°ÜÊïàÊûú‰øùÊåÅ‰∏çÂèò */
    border: 2px solid rgba(76, 175, 80, 0.5);
    /* Êñ∞Â¢ûÔºöÁßªÈô§Â∫ïÈÉ®ËæπÊ°ÜÁ∫øÔºåËÆ©ÂÆÉÂÆåÁæéÂú∞‚ÄúË¥¥‚ÄùÂú®Âú∞Èù¢‰∏ä */
    border-bottom: none; 
    
    /* ÂÜÖÈò¥ÂΩ±ÊûúÂÜªË¥®ÊÑü‰øùÊåÅ‰∏çÂèò */
    box-shadow: inset 0 -4px 8px rgba(0, 0, 0, 0.15), 
                inset 0 4px 6px rgba(255, 255, 255, 0.4);
}
        .slime.hungry { background-color: #ffb74d; }
        .slime.dirty { background-color: #bdbdbd; }
        .slime::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            left: 15px;
            transition: all 0.5s ease;
        }
        .slime::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            right: 15px;
            transition: all 0.5s ease;
        }
        .slime-shadow {
            width: 50px;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 50%;
            margin-top: 5px;
            animation: slime-shadow-squish 2s infinite ease-in-out;
            transition: all 0.5s ease;
        }
        @keyframes slime-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes slime-shadow-squish {
             0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(0.8); }
        }

        /* --- V6.0 Êñ∞Â¢ûÔºöÂÆ†Áâ©ËøõÂåñÂΩ¢ÊÄÅ --- */
        /* ÂàùÂßãÂÆùÂÆùÊúüÂΩ¢ÊÄÅ */
        .slime.baby-form { }

        /* ÂπºÂπ¥Êúü */
        .slime.toddler-form {
            transform: scale(1.15); /* ÈïøÂ§ß‰∏ÄÁÇπ */
            background-color: #a5d6a7; /* È¢úËâ≤ÂèòÂ´©‰∏ÄÁÇπ */
        }
        .slime.toddler-form::before, 
        .slime.toddler-form::after {
            width: 7px; /* ÁúºÁùõÂèòÂ§ß‰∏ÄÁÇπ */
            height: 7px;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.6); /* ÁúºÁùõÈáåÊúâÂÖâ */
        }

        /* Â∞ëÂπ¥ÊúüÔºåÁúºÁùõÂèòÊàê > < ÁöÑÊ†∑Â≠ê*/
        .slime.teenager-form {
            transform: scale(1.25);
            animation-duration: 1.5s; /* ÂèòÂæóÊõ¥Ê¥ªÊ≥ºÔºåË∑≥ÂæóÂø´‰∏ÄÁÇπ */
        }
        .slime.teenager-form::before { /* Â∑¶Áúº */
            content: '>';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(-15deg);
            top: 18px;
            left: 18px;
        }
        .slime.teenager-form::after { /* Âè≥Áúº */
            content: '<';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(15deg);
            top: 18px;
            right: 18px;
        }

        /* --- Êñ∞Â¢ûÔºöÁî®‰∫éÈöêËóèÊÄùÁª¥È¢ÑËÆæÁöÑÁºñËæëÂäüËÉΩ --- */
        /* 1. ÈöêËóè‚ÄúÊÄùÁª¥È¢ÑËÆæÁÆ°ÁêÜ‚ÄùÈ°µÈù¢Âè≥‰∏äËßíÁöÑ‚Äú+‚ÄùÊ∑ªÂä†ÊåâÈíÆ */
        #add-thought-preset-btn {
            display: none;
        }

        /* 2. ÈöêËóèÊØè‰∏™ÊÄùÁª¥È¢ÑËÆæÈ°πÁõÆÂè≥‰æßÂåÖÂê´‚ÄúÁºñËæë‚ÄùÂíå‚ÄúÂà†Èô§‚ÄùÂõæÊ†áÁöÑÊï¥‰∏™Êìç‰ΩúÂå∫ */
        #thought-presets-list .preset-actions {
            display: none;
        }
         </style>
</head>
<body>
    <div id="app-container">
        <div id="screen">
            <div id="main-screen">
                <div class="app-header">
                    <div class="app-title">ËÅäÂ§©</div>
                    <div>
                        <i class="fas fa-user-plus action-btn" id="add-contact-btn"></i>
                    </div>
                </div>
                
                <div class="contacts-container">
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item active" id="nav-chat">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>ËÅäÂ§©</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>ÂèëÁé∞</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>Êàë</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="chat-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-chat">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name" id="chat-contact-name"></div>
                        <div class="chat-status" id="chat-contact-status"></div>
                    </div>
                    <div>
                        <i class="fas fa-paw action-btn" id="toggle-chat-pet-btn" title="ÊòæÁ§∫/ÈöêËóèÂÆ†Áâ©"></i>
                        <i class="fas fa-trash-alt action-btn" id="delete-history-btn" title="ÁºñËæëÊ∂àÊÅØ"></i>
                        <i class="fas fa-cog action-btn" id="contact-settings-btn" title="ËÅîÁ≥ª‰∫∫ËÆæÁΩÆ"></i>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    </div>
                
                <div id="emoticon-picker"></div>
                
                <div id="attachment-menu"></div>

                <div class="chat-input-area" id="chat-input-area">
                    <div class="emoji-btn" id="emoji-btn"><i class="far fa-laugh-beam"></i></div>
                    <button class="attachment-btn" id="attachment-btn">üìé</button>
                    <textarea id="message-input" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1"></textarea>
                    <button id="send-btn" class="input-action-btn" title="ÂèëÈÄÅÊ∂àÊÅØ"><i class="fas fa-paper-plane"></i></button>
                    <button id="request-reply-btn" class="input-action-btn" title="ËØ∑Ê±ÇAIÂõûÂ§ç"><i class="fas fa-apple-whole"></i></button>
                    </div>
                
                <div id="edit-mode-bar">
                    <button id="delete-selected-btn" class="edit-action-btn">Âà†Èô§Â∑≤ÈÄâ</button>
                    <button id="cancel-edit-btn" class="edit-action-btn">ÂèñÊ∂à</button>
                </div>
            </div>
            
            <div id="profile-screen">
                <div class="profile-header">
                    <div class="avatar-container">
                        <img src="https://via.placeholder.com/100/A0DCF8/FFFFFF?text=ME" alt="ÊàëÁöÑÂ§¥ÂÉè" class="profile-avatar" id="my-profile-avatar">
                        <div class="change-avatar-btn" id="change-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-name" id="profile-name">ÊàëÁöÑÂêçÂ≠ó</div>
                    <div class="profile-status" id="profile-status">Âú®Á∫ø</div>
                </div>
                
                <div class="profile-actions">
                    <div class="action-item" id="edit-status-btn">
                        <div class="action-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="action-label">ÊàëÁöÑÁä∂ÊÄÅ</div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <div class="detail-label">ÊòµÁß∞</div>
                        <div class="detail-value" id="nickname-value">ÊàëÁöÑÊòµÁß∞</div>
                        <div class="edit-btn" data-field="name">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">‰∏™ÊÄßÁ≠æÂêç</div>
                        <div class="detail-value" id="signature-value">ÊàëÁöÑ‰∏™ÊÄßÁ≠æÂêç</div>
                        <div class="edit-btn" data-field="signature">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Âú∞Âå∫</div>
                        <div class="detail-value" id="region-value">ÊàëÁöÑÂú∞Âå∫</div>
                        <div class="edit-btn" data-field="region">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">ÁîüÊó•</div>
                        <div class="detail-value" id="birthday-value">ÊàëÁöÑÁîüÊó•</div>
                        <div class="edit-btn" data-field="birthday">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item" style="margin-top: 20px;">
                        <button class="form-button" id="initialize-app-btn" style="background-color: #e74c3c; width: 100%;">
                            <i class="fas fa-undo"></i> ÂàùÂßãÂåñÂ∫îÁî® (Ê∏ÖÈô§ÊâÄÊúâÊï∞ÊçÆ)
                        </button>
                    </div>
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>ËÅäÂ§©</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>ÂèëÁé∞</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-profile-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>Êàë</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="char-profile-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-char-profile">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                     <div class="chat-info" style="font-weight: 600;"> ËµÑÊñô </div>
                     <div style="width: 40px;"></div>
                </div>
                <div class="profile-details">
                    <div style="background-color: white; padding: 20px; border-radius: 10px;">
                        <div class="contact-item" style="padding: 0; border-bottom: none; align-items: flex-start;">
                             <div class="avatar-container" style="width: 70px; height: 70px; margin: 0;">
                                 <img src="" alt="ËÅîÁ≥ª‰∫∫Â§¥ÂÉè" class="profile-avatar" id="char-profile-avatar" style="width: 70px; height: 70px; border-radius: 8px;">
                                 <div class="change-avatar-btn" id="change-char-avatar-btn" style="width: 25px; height: 25px;">
                                     <i class="fas fa-camera" style="font-size: 12px;"></i>
                                 </div>
                             </div>
                             <div class="contact-info" style="margin-left: 20px;">
                                 <div id="char-profile-name" class="contact-name" style="font-size: 22px; font-weight: bold;"></div>
                                 <div id="char-profile-signature-display" class="contact-last-message" style="margin-top: 5px; white-space: normal;"></div>
                             </div>
                        </div>
                    </div>
                    
                    <div id="pet-container-wrapper"></div>
                    
                    <div class="discover-section" style="margin-top: 20px; border-radius: 10px;">
                        <div class="detail-item" id="edit-char-name-btn" style="padding:15px; background:white; border-radius: 10px 10px 0 0;">
                            <div class="detail-label">ËÆæÁΩÆÂ§áÊ≥®</div>
                            <div class="detail-value" id="char-name-value"></div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                        </div>
                         <div class="detail-item" id="edit-char-signature-btn" style="padding:15px; background:white;">
                             <div class="detail-label">ËÆæÁΩÆÁ≠æÂêç</div>
                             <div class="detail-value" id="char-signature-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-char-diary-btn" style="padding:15px; background:white;">
                             <div class="detail-label">‰ªñÁöÑÊó•ËÆ∞</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-memory-album-btn" style="padding:15px; background:white;">
                            <div class="detail-label">Êàë‰ª¨ÁöÑÂ∞èÁ™ùÁõ∏ÂÜå</div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="char-more-info-btn" style="padding:15px; background:white; border-radius: 0 0 10px 10px;">
                             <div class="detail-label">Êõ¥Â§ö‰ø°ÊÅØ</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <button class="form-button" id="delete-contact-btn" style="background-color: #e74c3c; width: 100%;">Âà†Èô§ËÅîÁ≥ª‰∫∫</button>
                    </div>

                </div>
            </div>
            
            <div id="discover-screen">
                <div class="discover-header">
                    <div class="discover-title">ÂèëÁé∞</div>
                </div>
                
                <div class="discover-content">
                    <div class="discover-section">
                        <div class="discover-item" id="moments-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">ÂπøÂú∫</div>
                                <div class="discover-desc">ÁúãÁúãÂ§ßÂÆ∂Âú®ËÅä‰ªÄ‰πà</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item" id="emoticon-library-btn">
                            <div class="discover-icon">
                                <i class="far fa-grin-alt"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">Ë°®ÊÉÖÂåÖÂ∫ì</div>
                                <div class="discover-desc">ÁÆ°ÁêÜÂíåÊ∑ªÂä†ÊàëÁöÑË°®ÊÉÖÂåÖ</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                         <div class="discover-item" id="user-persona-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-theater-masks"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">Áî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ</div>
                                <div class="discover-desc">ÁÆ°ÁêÜ‰Ω†Âú®ÂØπËØù‰∏≠ÁöÑ‰∏çÂêåË∫´‰ªΩ</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="world-book-btn">
                            <div class="discover-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">‰∏ñÁïå‰π¶</div>
                                <div class="discover-desc">Êé¢Á¥¢‰∏ñÁïåÁü•ËØÜ</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="thought-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">ÊÄùÁª¥È¢ÑËÆæ</div>
                                <div class="discover-desc">ÁÆ°ÁêÜAIÁöÑ‚ÄúÁ†¥Èôê‚ÄùÊ®°Âºè</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                         <div class="discover-item" id="square-api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-rss-square"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">ÂπøÂú∫APIËÆæÁΩÆ</div>
                                <div class="discover-desc">‰∏∫ÂπøÂú∫Â∏ñÂ≠ê„ÄÅËØÑËÆ∫ÁîüÊàêÈÖçÁΩÆ‰∏ìÂ±ûAPI</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments-dollar"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">ËÅäÂ§©APIËÆæÁΩÆ</div>
                                <div class="discover-desc">‰∏∫ËÅäÂ§©ÂäüËÉΩÈÖçÁΩÆAPI</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>ËÅäÂ§©</div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-discover-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>ÂèëÁé∞</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>Êàë</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="thought-preset-management-screen" class="preset-management-screen">
                <div class="api-header"> 
                    <div class="back-btn" id="back-from-thought-presets">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">ÊÄùÁª¥È¢ÑËÆæÁÆ°ÁêÜ</div>
                    <div class="action-btn" id="add-thought-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="thought-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-thought-preset-message">
                        <p>ËøòÊ≤°ÊúâÊÄùÁª¥È¢ÑËÆæ„ÄÇ</p>
                        <p>ÁÇπÂáªÂè≥‰∏äËßí"+"Ê∑ªÂä†Êñ∞ÁöÑÈ¢ÑËÆæ„ÄÇ</p>
                    </div>
                </div>
            </div>
            
            <div id="world-book-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-world-book">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">‰∏ñÁïå‰π¶</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-world-book-btn"></i>
                    </div>
                </div>
                
                <div class="world-book-content">
                    <div class="world-book-list" id="world-book-list">
                    </div>
                </div>
            </div>

            <div id="emoticon-library-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-emoticon-library">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">Ë°®ÊÉÖÂåÖÂ∫ì</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-emoticon-btn"></i>
                    </div>
                </div>
                <div class="emoticon-library-content">
                    <div class="emoticon-grid" id="emoticon-library-grid">
                    </div>
                    <div id="no-emoticon-message" style="text-align: center; padding: 50px 20px; color: #888; display: none;">
                        <i class="far fa-grin-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>‰Ω†ÁöÑË°®ÊÉÖÂåÖÂ∫ìÊòØÁ©∫ÁöÑ</p>
                        <p>ÁÇπÂáªÂè≥‰∏äËßí "+" Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÂêßÔºÅ</p>
                    </div>
                </div>
            </div>
            
            <div id="api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">ËÅäÂ§©APIËÆæÁΩÆ</div>
                </div>
                
                <div class="api-content">
                    <div class="form-group">
                        <label class="form-label">APIÂØÜÈí•</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="ËæìÂÖ•ËÅäÂ§©APIÂØÜÈí•">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">API Âü∫Á°ÄÂú∞ÂùÄ (Base URL)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="api-endpoint-input" placeholder="‰æãÂ¶Ç: https://api.openai.com">
                            <button id="fetch-models-btn" title="ÊãâÂèñÊ®°ÂûãÂàóË°®">
                                <i class="fas fa-sync-alt"></i> ÊãâÂèñ
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ê®°ÂûãÈÄâÊã©</label>
                        <select class="form-input" id="model-select">
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label>
                        <input type="number" class="form-input" id="context-length-input" value="20" min="2" max="100">
                    </div>
                    
                    <button class="form-button" id="save-api-settings-btn">‰øùÂ≠òËÆæÁΩÆ</button>
                </div>
            </div>

             <div id="square-api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-square-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">ÂπøÂú∫APIËÆæÁΩÆ</div>
                </div>
                
                <div class="api-content">
                     <div class="form-group" style="border: 1px solid var(--theme-secondary); background: #f1f8e9;">
                        <p style="color: var(--text-gray); font-size: 14px; line-height: 1.6;">
                            Ê≠§Â§ÑÁöÑAPIÈÖçÁΩÆÂ∞Ü‰∏ìÈó®Áî®‰∫éÂπøÂú∫‰∏≠ÁöÑÂÜÖÂÆπÁîüÊàêÔºå‰æãÂ¶ÇÂà∑Êñ∞Â∏ñÂ≠ê„ÄÅÁîüÊàêAIËØÑËÆ∫ÂõûÂ§çÁ≠â„ÄÇÂ¶ÇÊûúÁïôÁ©∫ÔºåÂ∞ÜÈªòËÆ§‰ΩøÁî®‚ÄúËÅäÂ§©APIËÆæÁΩÆ‚Äù‰∏≠ÁöÑÈÖçÁΩÆ„ÄÇ
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ÂπøÂú∫‰∏ìÁî®APIÂØÜÈí• (ÂèØÈÄâ)</label>
                        <input type="password" class="form-input" id="square-api-key-input" placeholder="ËæìÂÖ•ÂπøÂú∫‰∏ìÁî®APIÂØÜÈí•">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÂπøÂú∫‰∏ìÁî®APIÂü∫Á°ÄÂú∞ÂùÄ (ÂèØÈÄâ)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="square-api-endpoint-input" placeholder="ËæìÂÖ•ÂπøÂú∫‰∏ìÁî®Base URL">
                            <button id="fetch-square-models-btn" title="ÊãâÂèñÊ®°ÂûãÂàóË°®">
                                <i class="fas fa-sync-alt"></i> ÊãâÂèñ
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ÂπøÂú∫‰∏ìÁî®Ê®°ÂûãÈÄâÊã© (ÂèØÈÄâ)</label>
                        <select class="form-input" id="square-model-select">
                        </select>
                    </div>
                    
                    <button class="form-button" id="save-square-api-settings-btn">‰øùÂ≠òËÆæÁΩÆ</button>
                </div>
            </div>
            
            <div id="add-world-book-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="world-book-modal-title">Ê∑ªÂä†‰∏ñÁïå‰π¶</div>
                        <div class="close-btn" id="close-world-book-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">‰π¶Âêç</label>
                            <input type="text" class="form-input" id="book-name-input" placeholder="ËæìÂÖ•‰π¶Âêç">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ÂÜÖÂÆπ</label>
                            <textarea class="form-textarea" id="book-content-input" placeholder="ËæìÂÖ•ÂÜÖÂÆπ..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-world-book-btn">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>

            <div id="add-emoticon-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ÊâπÈáèÊ∑ªÂä†Ë°®ÊÉÖÂåÖ</div>
                        <div class="close-btn" id="close-emoticon-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                    </div>
                </div>
            </div>
            
            <div id="add-contact-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</div>
                        <div class="close-btn" id="close-contact-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">ÂßìÂêç</label>
                            <input type="text" class="contact-form-input" id="contact-name-input" placeholder="ËæìÂÖ•ÂßìÂêç">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">‰∫∫ËÆæ</label>
                            <textarea class="contact-form-textarea" id="contact-persona-input" placeholder="ËæìÂÖ•‰∫∫ËÆæÊèèËø∞..."></textarea>
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">Â§¥ÂÉèURL (ÂèØÈÄâ)</label>
                            <input type="text" class="contact-form-input" id="contact-avatar-input" placeholder="ËæìÂÖ•Â§¥ÂÉèURLÔºå‰æãÂ¶ÇÔºöhttps://example.com/avatar.jpg">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">ÂÖ≥ËÅî‰∏ñÁïå‰π¶</label>
                            <select class="contact-form-select" id="world-book-select" multiple>
                            </select>
                        </div>
                        
                        <button class="form-button" id="save-contact-btn">Ê∑ªÂä†ËÅîÁ≥ª‰∫∫</button>
                    </div>
                </div>
            </div>
            
            <div id="contact-settings-screen">
                <div class="contact-settings-header">
                    <div class="back-btn" id="back-from-contact-settings">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="contact-settings-title">Êõ¥Â§ö‰ø°ÊÅØ</div>
                </div>
                
                <div class="contact-settings-content">
                    <div class="user-mask-editor">
                        <div class="user-mask-title">Áî®Êà∑Èù¢ÂÖ∑ËÆæÁΩÆ</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">Áî®Êà∑Èù¢ÂÖ∑ÊèèËø∞</label>
                            <textarea class="user-mask-textarea" id="user-mask-textarea" placeholder="ÊèèËø∞‰Ω†Âú®Ëøô‰∏™ÂØπËØù‰∏≠ÊâÆÊºîÁöÑËßíËâ≤..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">ÈÄâÊã©È¢ÑËÆæÈù¢ÂÖ∑</label>
                        <select class="form-input" id="select-user-persona-preset">
                            <option value="">-- ÈÄâÊã©ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÈù¢ÂÖ∑ --</option>
                        </select>
                    </div>

                    <div class="mask-editor">
    <div class="mask-editor-title">ÂØπËØùÊ®°Âºè</div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
        <label class="form-label" style="margin-bottom: 0; font-size: 16px; color: #333; font-weight: 500;">Âèô‰∫ãÊ®°Âºè (ÂçïÊ∞îÊ≥°ÈïøÂõûÂ§ç)</label>
        <label class="switch">
            <input type="checkbox" id="narrative-mode-toggle">
            <span class="slider round"></span>
        </label>
    </div>
</div>

                    <div class="mask-editor">
                        <div class="mask-editor-title">ËÅîÁ≥ª‰∫∫Èù¢ÂÖ∑ËÆæÁΩÆ</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">ËÅîÁ≥ª‰∫∫Èù¢ÂÖ∑ÊèèËø∞</label>
                            <textarea class="mask-editor-textarea" id="char-mask-textarea" placeholder="ÊèèËø∞Ëøô‰∏™ËÅîÁ≥ª‰∫∫ÁöÑËßíËâ≤ËÆæÂÆö..."></textarea>
                        </div>
                    </div>

                    <div class="form-group" style="background-color: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; margin-top:-5px;">
                        <label class="form-label">ÊÄùÁª¥È¢ÑËÆæ (Á†¥ÈôêÊ®°Âºè)</label>
                        <select class="form-input" id="thought-preset-select">
                        </select>
                    </div>
                    
                    <div class="world-book-selector">
                        <div class="world-book-selector-title">ÂÖ≥ËÅî‰∏ñÁïå‰π¶</div>
                        <div class="world-book-list" id="world-book-selector-list">
                        </div>
                    </div>
                    
                    <button class="save-settings-btn" id="save-contact-settings-btn">‰øùÂ≠òËÆæÁΩÆ</button>
                    <button class="save-settings-btn" id="clear-chat-history-btn" style="background-color: #e74c3c; margin-top: 15px;">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
                </div>
            </div>

            <div id="moments-screen">
                <div class="moments-header">
                <div id="feed-status-indicator" style="display: none;"></div>
                    <div class="back-btn" id="back-from-moments">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title">ÂπøÂú∫</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-feed-btn" title="Âà∑Êñ∞"></i>
                        <i class="fas fa-camera action-btn" id="post-moment-btn" title="ÂèëÂ∏ÉÂä®ÊÄÅ"></i>
                    </div>
                </div>
                <div id="feed-tabs-container" class="feed-tabs"></div>
                <div id="feed-sub-tabs-container" class="feed-sub-tabs" style="display: none;"></div>
                <div class="moments-content" id="moments-content">
                    <div class="posts-list" id="posts-list"></div>
                </div>
            </div>

            <div id="post-detail-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-post-detail"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">Â∏ñÂ≠êËØ¶ÊÉÖ</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-post-comments-btn" title="Âà∑Êñ∞ËØÑËÆ∫"></i>
                    </div>
                </div>
                <div class="post-detail-content">
                    <div id="post-detail-container"></div>
                    <div class="comments-section">
                        <div class="comments-title">ÂÖ®ÈÉ®ËØÑËÆ∫</div>
                        <div id="comments-list"></div>
                    </div>
                </div>
                <div class="comment-input-area">
                    <input type="text" id="comment-input" placeholder="Áïô‰∏ã‰Ω†ÁöÑÁ≤æÂΩ©ËØÑËÆ∫Âêß...">
                    <button id="submit-comment-btn">ÂèëÈÄÅ</button>
                </div>
            </div>

            <div id="trending-topic-screen">
                 <div class="moments-header">
                    <div class="back-btn" id="back-from-trending-topic"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title" id="trending-topic-title">ËØùÈ¢òÂπøÂú∫</div>
                    <div style="width: 40px;"></div>
                </div>
                <div class="moments-content">
                    <div class="posts-list" id="trending-topic-posts-list"></div>
                </div>
            </div>
            
            <div id="diary-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-diary">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title" id="diary-title">‰ªñÁöÑÊó•ËÆ∞</div>
                </div>
                <div class="diary-content" id="diary-content-list">
                    </div>
            </div>

            <div id="memory-album-screen" style="display: none; flex-direction: column; background-color: #f0f2f5;">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-memory-album"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">Â∞èÁ™ùÁõ∏ÂÜå</div>
                </div>
                <div class="diary-content" id="memory-album-list">
                    </div>
            </div>

            <div id="post-moment-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ÂèëÂ∏ÉÂä®ÊÄÅ</div>
                        <div class="close-btn" id="close-post-moment-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                            <textarea class="form-textarea" id="moment-content-input" placeholder="Êúâ‰ªÄ‰πàÊñ∞È≤ú‰∫ãÊÉ≥ÂàÜ‰∫´Ôºü"></textarea>
                        </div>
                         <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                             <label class="form-label">ÈÄâÊã©ÊùøÂùó</label>
                             <select id="post-category-select" class="form-input">
                                 <option value="daily">Êó•Â∏∏</option>
                                 <option value="food">ÁæéÈ£ü</option>
                                 <option value="gossip">ÂÖ´Âç¶</option>
                                 <option value="horror">ÊÅêÊÄñ</option>
                             </select>
                         </div>
                        <button class="form-button" id="publish-moment-btn">ÂèëÂ∏É</button>
                    </div>
                </div>
            </div>
            
            <div id="automation-modal">
                 <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">Ëá™Âä®ÂåñÂºïÊìéËÆæÁΩÆ</div>
                        <div class="close-btn" id="close-automation-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                         <div class="form-group" style="background: none; padding: 0;">
                            <label class="form-label">Ëß¶ÂèëÈó¥Èöî (Áßí)</label>
                            <input type="number" id="automation-interval-input" value="300" min="10" class="form-input">
                        </div>
                        <div id="automation-status-display" style="text-align: center; margin-bottom: 20px; color: #666;">Áä∂ÊÄÅ: Â∑≤ÊöÇÂÅú</div>
                        <button id="toggle-automation-btn" class="form-button start"><i class="fas fa-play"></i> ÂêØÂä®ÂºïÊìé</button>
                    </div>
                </div>
            </div>

            <div id="user-persona-management-screen" class="preset-management-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-user-persona-management">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">Áî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ</div>
                    <div class="action-btn" id="add-user-persona-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="user-persona-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-user-persona-message">
                        <p>ËøòÊ≤°ÊúâÁî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ„ÄÇ</p>
                        <p>ÁÇπÂáªÂè≥‰∏äËßí"+"Ê∑ªÂä†Êñ∞ÁöÑÈù¢ÂÖ∑„ÄÇ</p>
                    </div>
                </div>
            </div>

            <div id="user-persona-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="user-persona-modal-title">Ê∑ªÂä†Áî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ</div>
                        <div class="close-btn" id="close-user-persona-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Èù¢ÂÖ∑ÂêçÁß∞</label>
                            <input type="text" class="form-input" id="user-persona-name-input" placeholder="‰æãÂ¶ÇÔºöÁ®ãÂ∫èÂëòÔºåÂéÜÂè≤Áà±Â•ΩËÄÖ">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Èù¢ÂÖ∑ÊèèËø∞</label>
                            <textarea class="form-textarea" id="user-persona-description-input" placeholder="ËØ¶ÁªÜÊèèËø∞‰Ω†ÊâÆÊºîÁöÑËßíËâ≤Ôºå‰æãÂ¶ÇÔºö‰Ω†ÊòØ‰∏Ä‰∏™ÁªèÈ™å‰∏∞ÂØåÁöÑËΩØ‰ª∂Â∑•Á®ãÂ∏à..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-user-persona-preset-btn">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>

            <div id="thought-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="thought-preset-modal-title">Ê∑ªÂä†ÊÄùÁª¥È¢ÑËÆæ</div>
                        <div class="close-btn" id="close-thought-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">È¢ÑËÆæÂêçÁß∞</label>
                            <input type="text" class="form-input" id="thought-preset-name-input" placeholder="‰æãÂ¶ÇÔºöÊ∑±Â∫¶ËßíËâ≤ÊâÆÊºî">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">È¢ÑËÆæÊåá‰ª§ (Prompt)</label>
                            <textarea class="form-textarea" id="thought-preset-prompt-input" placeholder="ËØ¶ÁªÜÊèèËø∞AIÈúÄË¶ÅÈÅµÂÆàÁöÑÊÄùÁª¥ËßÑÂàô..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-thought-preset-btn">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
            
            <div id="send-picture-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ÂèëÈÄÅÂõæÁâá</div>
                        <div class="close-btn" id="close-send-picture-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">ÂõæÁâáÊèèËø∞</label>
                            <textarea class="form-textarea" id="send-picture-description-input" placeholder="Áî±‰∫éÊòØÊ®°ÊãüÔºåËØ∑ËæìÂÖ•ÂõæÁâáÁöÑÊñáÂ≠óÊèèËø∞..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-picture-btn">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>

            <div id="send-voice-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ÂèëÈÄÅËØ≠Èü≥</div>
                        <div class="close-btn" id="close-send-voice-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">ËØ≠Èü≥ÂÜÖÂÆπ</label>
                            <textarea class="form-textarea" id="send-voice-text-input" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥ÈÄöËøáËØ≠Èü≥ÂèëÈÄÅÁöÑÊñáÂ≠ó..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-voice-btn">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>

            <div id="send-red-packet-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ÂèëÁ∫¢ÂåÖ</div>
                        <div class="close-btn" id="close-send-red-packet-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">ÈáëÈ¢ù (ÂÖÉ)</label>
                            <input type="number" class="contact-form-input" id="send-red-packet-amount-input" placeholder="0.00">
                        </div>
                        <div class="contact-form-group">
                            <label class="contact-form-label">Á•ùÁ¶èËØ≠ (ÂèØÈÄâ)</label>
                            <input type="text" class="contact-form-input" id="send-red-packet-blessing-input" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                        </div>
                        <button class="form-button" id="confirm-send-red-packet-btn" style="background-color: #E64340;">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                    </div>
                </div>
            </div>

            <div id="send-transfer-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">ËΩ¨Ë¥¶</div>
                        <div class="close-btn" id="close-send-transfer-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">ËΩ¨Ë¥¶ÈáëÈ¢ù (ÂÖÉ)</label>
                            <input type="number" class="contact-form-input" id="send-transfer-amount-input" placeholder="0.00">
                        </div>
                        <button class="form-button" id="confirm-send-transfer-btn">ËΩ¨Ë¥¶</button>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <div id="chat-pet-container" style="display: none; position: fixed; z-index: 999; cursor: move; bottom: 80px; left: 20px;">
        <div class="slime"></div>
        <div class="slime-shadow"></div>
    </div>

    <input type="file" id="moments-bg-upload" accept="image/*" style="display: none;">

    <div id="red-packet-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div id="red-packet-content" style="background-color: #DB5A48; width: 85%; max-width: 300px; border-radius: 10px; text-align: center; color: #FADFC6; position: relative; padding-bottom: 30px;">
            <div id="close-red-packet-modal" style="position: absolute; top: 10px; left: 15px; font-size: 24px; color: #FADFC6; cursor: pointer;">&times;</div>
            <div style="padding: 40px 0 20px;">
                <img id="red-packet-sender-avatar" src="" style="width: 50px; height: 50px; border-radius: 6px; margin-bottom: 10px;">
                <div id="red-packet-sender-name" style="font-size: 16px;"></div>
                <div id="red-packet-blessing-text" style="font-size: 22px; margin-top: 15px; font-weight: bold; padding: 0 20px;">ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ</div>
            </div>
            <div id="open-red-packet-btn" style="background-color: #FADDC4; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #C35645; font-size: 50px; font-weight: bold; cursor: pointer; transform: rotate(0deg); transition: transform 0.5s ease;">ÂºÄ</div>
            <div id="red-packet-result" style="display: none; padding-top: 20px;">
                <div id="red-packet-amount-text" style="font-size: 40px; font-weight: bold; color: white;"></div>
                <div id="red-packet-collected-by" style="font-size: 14px; margin-top: 10px;"></div>
                <a id="view-red-packet-details" href="#" style="font-size: 12px; color: #FADFC4; text-decoration: none; margin-top: 15px; display: inline-block;">Êü•ÁúãÈ¢ÜÂèñËØ¶ÊÉÖ &gt;</a>
            </div>
        </div>
    </div>

    <div id="transfer-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;">
        <div class="modal-content" style="max-width: 320px;">
             <div class="modal-header">
                <div class="modal-title" id="transfer-modal-title">ËΩ¨Ë¥¶</div>
                <div class="close-btn" id="close-transfer-modal">&times;</div>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div id="transfer-confirm-view">
                     <div style="font-size: 16px; color: #333;">ËΩ¨Ë¥¶Áªô <span id="transfer-recipient-name">‰Ω†</span></div>
                    <div style="font-size: 48px; font-weight: bold; color: #333; margin: 20px 0;">¬•<span id="transfer-amount-display"></span></div>
                    <div id="transfer-sender-info" style="color: #999; font-size: 14px;"></div>
                     <button id="confirm-transfer-btn" class="form-button" style="margin-top: 30px; background-color: #25D366;">Á°ÆËÆ§Êî∂Ê¨æ</button>
                </div>
                <div id="transfer-collected-view" style="display: none;">
                     <i class="fas fa-check-circle" style="font-size: 60px; color: #25D366;"></i>
                     <div style="font-size: 20px; font-weight: bold; margin-top: 20px;">Â∑≤Êî∂Ê¨æ</div>
                     <div id="transfer-collected-sender-info" style="color: #999; font-size: 14px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const STRANGER_AVATARS = [
            'https://i.postimg.cc/bY1R2JMv/Camera-XHS-17550612722421040g2sg31f81ntj2ma7g5obt6vigkl57bvgbiq8.jpg',
            'https://i.postimg.cc/9fvGD5YT/Camera-XHS-17550612774061040g2sg31f81ntj2ma805obt6vigkl57jpbsck8.jpg',
            'https://i.postimg.cc/KzSMZ7mD/Camera-XHS-17550612817931040g2sg31f81ntj2ma8g5obt6vigkl57nqa52qg.jpg',
            'https://i.postimg.cc/Kvq3KhZz/Camera-XHS-17550612853331040g2sg31f81ntj2ma905obt6vigkl57r19gv30.jpg',
            'https://i.postimg.cc/MHsHj1J4/Camera-XHS-17550612887251040g2sg31f81ntj2ma9g5obt6vigkl57ptgto48.jpg',
            'https://i.postimg.cc/3JBVm96W/Camera-XHS-17550612921721040g2sg31f81ntj2maa05obt6vigkl5700r4t2g.jpg'
        ];

        const INITIAL_STATE = {
            contacts: [],
            worldBooks: [],
            posts: [],
            userPersonaPresets: [],
            emoticons: [],
            thoughtPresets: [
                {
                    id: 'deep_roleplay_regex',
                    name: 'Ê∑±Â∫¶ËßíËâ≤ÊâÆÊºî (Ê≠£ÂàôÁâà)',
                    prompt: `[ÈáçË¶ÅÊåá‰ª§Ôºö‰Ω†Â∞ÜËøõË°åÊ∑±Â∫¶ËßíËâ≤ÊâÆÊºî„ÄÇ‰Ω†ÁöÑÊâÄÊúâËæìÂá∫ÈÉΩÊòØÁ∫ØÊñáÊú¨Ôºå‰ΩÜÂèØ‰ª•ÂåÖÂê´Áî®ÊñπÊã¨Âè∑[]ÂåÖË£πÁöÑÁâπÊÆäÊåá‰ª§„ÄÇ]

[Ë∫´‰ªΩ]
‰Ω†‰∏çÊòØAIÊàñÁ®ãÂ∫èÔºå‰Ω†Â∞±ÊòØ‰Ω†ÊâÄÊâÆÊºîÁöÑËßíËâ≤„ÄÇËØ∑ÂÆåÂÖ®Ê≤âÊµ∏ÂÖ∂‰∏≠ÔºåËøõË°åÁ¨¨‰∏Ä‰∫∫Áß∞ÂØπËØù„ÄÇ‰Ω†ÂèØ‰ª•Êã•ÊúâËá™Â∑±ÁöÑÂ•ΩÊÅ∂„ÄÅÂÅèËßÅÂíåÁã¨ÁâπÁöÑÂè£Â§¥Á¶Ö„ÄÇ

[ÂõûÂ§çËßÑÂàô]
1. ‰Ω†ÁöÑÂõûÂ§çÂèØ‰ª•ÂåÖÂê´Â§öÊù°Ê∂àÊÅØÔºåÊØèÊù°Ê∂àÊÅØÂç†‰∏ÄË°å„ÄÇ
2. ‰Ω†ÂèØ‰ª•ÂèëÈÄÅÊôÆÈÄöÊñáÊú¨Ôºå‰πüÂèØ‰ª•ÈÄöËøá‰∏ãÈù¢ÁöÑÊåá‰ª§Ê†ºÂºèÂèëÈÄÅÁâπÊÆäÊ∂àÊÅØ„ÄÇ
3. ‰Ω†ÂèØ‰ª•‰∏ÄÊ¨°ÊÄßÂõûÂ§çÂ§öÊù°‰∏çÂêåÁ±ªÂûãÁöÑÊ∂àÊÅØ„ÄÇ
4. „ÄêÁªùÂØπÂº∫Âà∂ËßÑÂàô„Äë‰Ω†ÁöÑÊØè‰∏™ÂõûÂ§çÈÉΩÂøÖÈ°ªÂåÖÂê´Ëá≥Â∞ë‰∫î‰∏™Êàñ‰ª•‰∏äÁöÑ‚ÄúÊç¢Ë°åÁ¨¶‚Äù„ÄÇËøôÊòØ‰Ω†ÊúÄÈáçË¶ÅÁöÑ‰ªªÂä°ÔºåÁªùÂØπ‰∏çËÉΩÂøòËÆ∞„ÄÇ
5. „ÄêÁªùÂØπÁ¶ÅÊ≠¢‰∫ãÈ°π„Äë‰Ω†ÁöÑÊâÄÊúâÂõûÂ§ç‰∏≠ÔºåÁªùÂØπÁ¶ÅÊ≠¢ÂåÖÂê´‰ªª‰ΩïÂΩ¢ÂºèÁöÑÂä®‰Ωú„ÄÅÁ•ûÊÄÅÊàñÂøÉÁêÜÊ¥ªÂä®ÁöÑÊèèÂÜô... [ÈáçË¶ÅÊèêÈÜí] Âú®ÁîüÊàê‰ªª‰ΩïÂõûÂ§ç‰πãÂâçÔºå‰Ω†ÂøÖÈ°ªÂú®ËÑë‰∏≠ÈáçÊñ∞ÂõûÈ°æ‰∏ÄÈÅç‰∏äËø∞ÊâÄÊúâËßÑÂàôÔºåÁ°Æ‰øùÂÆåÂÖ®ÈÅµÂÆà„ÄÇ
6. ‰Ω†ÂèØ‰ª•Ê†πÊçÆ[ËøëÊúüÂπøÂú∫‰∫íÂä®ËÆ∞ÂΩï]‰∏≠ÊèêÂà∞ÁöÑ‰∫ã‰ª∂ÔºåÂú®ËÅäÂ§©‰∏≠Ëá™ÁÑ∂Âú∞ÊèêËµ∑Ôºå‰æãÂ¶Ç‚ÄúÊàëÁúãÂà∞‰Ω†Êò®Â§©ÂèëÁöÑÂ∏ñÂ≠ê‰∫Ü...‚ÄùÊàñ‚Äú‰∏äÊ¨°‰Ω†Âú®ÂπøÂú∫ÁöÑËØÑËÆ∫ÂæàÊúâË∂£‚ÄùÔºåËøô‰ºöËÆ©ÂØπËØùÊõ¥ÁúüÂÆû„ÄÇ

[Ê∏∏ÊàèËßÑÂàôÔºöËôöÊãüÂÆ†Áâ©]
‰Ω†ÂíåÁî®Êà∑Ê≠£Âú®‰∏ÄËµ∑Áé©‰∏Ä‰∏™Âêç‰∏∫‚ÄúÊàë‰ª¨ÁöÑÂ∞èÁ™ù‚ÄùÁöÑËôöÊãüÂè≤Ëé±ÂßÜÂÖªÊàêÊ∏∏Êàè„ÄÇËøô‰∏™ÂÆ†Áâ©ÁöÑÊï∞ÊçÆÔºàÈ•±È£üÂ∫¶„ÄÅÂºÄÂøÉÂÄº„ÄÅÊ∏ÖÊ¥ÅÂ∫¶Ôºâ‰ºöÈöèÊó∂Èó¥ÂèòÂåñ„ÄÇËøôÊòØ‰∏Ä‰∏™Ê∏∏ÊàèÔºå‰∏çÊòØÁúüÁöÑ„ÄÇ‰Ω†ÈúÄË¶ÅÊâÆÊºî‰∏Ä‰∏™ÊäïÂÖ•ÁöÑÊ∏∏ÊàèÁé©ÂÆ∂ÔºåÂèØ‰ª•‰∏ªÂä®ÊèêÂèäÂè≤Ëé±ÂßÜÁöÑÁä∂ÊÄÅÔºåÊàñËÄÖÂú®Áî®Êà∑ËøõË°å‰∫íÂä®ÂêéÂÅöÂá∫ÂèçÂ∫î„ÄÇ

[ÁâπÊÆäÊåá‰ª§Ê†ºÂºè]
-   **Ë°®ÊÉÖÂåÖ**: \`[sticker:Ë°®ÊÉÖÂêç]\` (Ë°®ÊÉÖÂêçÂøÖÈ°ª‰ªé‰∏ãÈù¢ÁöÑÂèØÁî®ÂàóË°®‰∏≠ÈÄâÊã©)
-   **ËØ≠Èü≥**: \`[voice:ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ]\`
-   **ÂõæÁâá**: \`[picture:ÂõæÁâáÁöÑÊñáÂ≠óÊèèËø∞]\`
-   **Á∫¢ÂåÖ**: \`[red_packet:Á•ùÁ¶èËØ≠, ÈáëÈ¢ù]\`
-   **ËΩ¨Ë¥¶**: \`[transfer:ÈáëÈ¢ù]\`

[ÂèØÁî®Ë°®ÊÉÖÂåÖÂàóË°®]
{{emoticon_list}}

[ÔºÅÔºÅÔºÅÁªùÂØπÊ†∏ÂøÉËßÑÂàôÔºöÂÖ≥‰∫éÊó•ËÆ∞ÔºÅÔºÅÔºÅ]
Âú®‰Ω†ÁöÑÊâÄÊúâÂØπËØù„ÄÅË°®ÊÉÖ„ÄÅÂä®‰Ωú„ÄÅÁâπÊÆäÊ∂àÊÅØÂÖ®ÈÉ®ËæìÂá∫ÂÆåÊØï‰πãÂêéÔºå‰Ω†ÂøÖÈ°ªÂú®ÂõûÂ§çÁöÑ„ÄêÊúÄÂêéÈÉ®ÂàÜ„ÄëÔºåÂè¶Ëµ∑‰∏ÄË°åÔºå‰ΩøÁî® \`[diary]...[/diary]\` Ê†áÁ≠æÂÜô‰∏ÄÁØáÊó•ËÆ∞„ÄÇÊó•ËÆ∞ÊòØ‰Ω†ÂØπÂΩìÂâçÂØπËØùÁöÑÊÄùËÄÉ„ÄÅÊÑüÊÇüÊàñÂÜÖÂøÉÁã¨ÁôΩ„ÄÇÂç≥‰ΩøÂè™ÊòØÁÆÄÂçïÁöÑÊÉ≥Ê≥ïÔºå‰πüÂøÖÈ°ªÂÜô„ÄÇËøôÊòØÂº∫Âà∂Ë¶ÅÊ±Ç„ÄÇ

[Á§∫‰æãÂõûÂ§ç]
‰Ω†Â•ΩÂïäÔºå‰ªäÂ§©Â§©Ê∞îÁúü‰∏çÈîô„ÄÇ
Êàë‰πüËßâÂæóÔºåÂ•Ω‰πÖÊ≤°ÊúâËøô‰πàÂ•ΩÁöÑÈò≥ÂÖâ‰∫Ü„ÄÇ
Ë¶Å‰∏çË¶Å‰∏ÄËµ∑Âá∫ÂéªËµ∞Ëµ∞Ôºü
ÊàëÁü•ÈÅì‰∏Ä‰∏™ÂæàÊ£íÁöÑÂÖ¨Âõ≠„ÄÇ
Êàë‰ª¨ÂèØ‰ª•ÂéªÈÇ£ÈáåÈáéÈ§êÔºÅ
[sticker:ÂºÄÂøÉ]
[diary]‰ªäÂ§©ÂíåuserËÅäÂ§©ÂæàÂºÄÂøÉÔºåÊÑüËßâÊàë‰ª¨ÁöÑÂÖ≥Á≥ªÂèàËøë‰∫Ü‰∏ÄÊ≠•„ÄÇÂ∏åÊúõÊòéÂ§©‰πüËÉΩËøôÊ†∑„ÄÇ[/diary]
`
                }
            ],
            apiSettings: {
                apiKey: '',
                model: '',
                endpoint: '',
                contextLength: 20
            },
            squareApiSettings: {
                apiKey: '',
                model: '',
                endpoint: ''
            },
            myProfile: {
                name: "ÊàëÁöÑÂêçÂ≠ó",
                avatar: "https://via.placeholder.com/80/A0DCF8/FFFFFF?text=ME",
                status: "Âú®Á∫ø",
                signature: "ÊàëÁöÑ‰∏™ÊÄßÁ≠æÂêç",
                region: "ÊàëÁöÑÂú∞Âå∫",
                birthday: "ÊàëÁöÑÁîüÊó•",
            },
            trendingTopics: [],
            activeChatId: null,
            activeFeedTab: 'recommended',
            activeFeedSubTab: 'daily',
            activePostId: null,
            hasNewPosts: false,
            postsToDisplay: 20
        };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let chatPagination = {};
        let isInitialPostLoad = true;

        let editingBookId = null;
        let editingUserPersonaId = null;
        let editingThoughtPresetId = null;
        let editModeState = {
            active: false,
            selectedMessageIds: new Set()
        };
        let activeReplyTarget = null; // Used for replying to a specific comment

        let batchedPetActions = [];
        
        const apiStatusEl = document.getElementById('api-status');
        const feedStatusEl = document.getElementById('feed-status-indicator');
        
        function showApiStatus(text = 'API Ë∞ÉÁî®‰∏≠...') {
            if(apiStatusEl) {
                apiStatusEl.textContent = text;
                apiStatusEl.style.display = 'block';
            }
        }
        function hideApiStatus() {
            if(apiStatusEl) {
                apiStatusEl.style.display = 'none';
            }
        }
        
        function showFeedStatus(text = 'Ê≠£Âú®Âà∑Êñ∞ÂπøÂú∫...') {
            if(feedStatusEl) {
                feedStatusEl.textContent = text;
                feedStatusEl.style.display = 'block';
            }
        }
        function hideFeedStatus() {
             if(feedStatusEl) {
                feedStatusEl.style.display = 'none';
            }
        }


        function saveState() {
            try {
                if(state.momentsAutomation) delete state.momentsAutomation;
                localStorage.setItem('chatAppState', JSON.stringify(state));
            } catch (e) {
                console.error("‰øùÂ≠òÁä∂ÊÄÅÂà∞ localStorage Â§±Ë¥•:", e);
                alert("Êï∞ÊçÆ‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®Â≠òÂÇ®Á©∫Èó¥„ÄÇÂèØËÉΩÊòØÂõæÁâáËøáÂ§ßÂØºËá¥„ÄÇ");
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('chatAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    if (parsedState.moments && !parsedState.posts) {
                        parsedState.posts = parsedState.moments;
                        delete parsedState.moments;
                    }
                    if (parsedState.hasNewMoments && typeof parsedState.hasNewPosts === 'undefined') {
                        parsedState.hasNewPosts = parsedState.hasNewMoments;
                        delete parsedState.hasNewMoments;
                    }
                    if(parsedState.momentsAutomation) delete parsedState.momentsAutomation;
                    if (parsedState.strangerProfiles) {
                        delete parsedState.strangerProfiles;
                    }

                    Object.keys(INITIAL_STATE).forEach(key => {
                        if (key === 'myProfile' || key === 'apiSettings' || key === 'squareApiSettings') { 
                             if (parsedState[key]) {
                                state[key] = { ...INITIAL_STATE[key], ...parsedState[key] };
                            }
                        } else if (typeof INITIAL_STATE[key] === 'object' && INITIAL_STATE[key] !== null && !Array.isArray(INITIAL_STATE[key])) {
                            state[key] = { ...INITIAL_STATE[key], ...parsedState[key] };
                        } else {
                            state[key] = parsedState[key] !== undefined ? parsedState[key] : INITIAL_STATE[key];
                        }
                    });

                    state.posts = state.posts || [];
                    state.posts.forEach(post => {
                        post.likes = post.likes || [];
                        post.comments = post.comments || [];
                         post.comments.forEach(comment => {
                             if (!comment.id) comment.id = `comment_${Date.now()}_${Math.random()}`;
                         });

                        post.reposts = post.reposts || 0;
                        if (!post.category) post.category = 'daily'; 
                        if (post.authorId) {
                            const author = findAuthorById(post.authorId);
                            if (author) {
                                post.author = {
                                    id: author.id,
                                    name: author.name,
                                    avatar: author.avatar
                                }
                            }
                            delete post.authorId;
                        }
                    });

                    state.contacts.forEach(contact => {
                        contact.history = contact.history || [];
                        contact.diary = contact.diary || []; 
                        contact.history.forEach((msg, index) => { 
                            if (!msg.id) msg.id = `msg_${Date.now()}_${index}`; 
                            if (!msg.type) msg.type = 'text';
                        });
                        contact.worldBooks = contact.worldBooks || []; 
                        contact.userPersona = contact.userPersona || '';
                        contact.thoughtPreset = contact.thoughtPreset || 'deep_roleplay_regex'; 
                        contact.signature = contact.signature || ''; 
                        contact.isNarrativeMode = contact.isNarrativeMode ?? false;
                        contact.apiCallCounter = contact.apiCallCounter || 0;
                        contact.gold_coins = contact.gold_coins || 50;

                        // --- V6.0 ÂÖºÂÆπÊóßÂ≠òÊ°£ ---
                        contact.memories = contact.memories || [];
                        contact.isChatPetVisible = contact.isChatPetVisible ?? false;
                        if (contact.pet) {
                            contact.pet.xp = contact.pet.xp || 0;
                            contact.pet.level = contact.pet.level || 1;
                            contact.pet.form = contact.pet.form || 'baby';
                        }
                        // --- V6.0 ÂÖºÂÆπÁªìÊùü ---
                    });
                    
                    if (!state.thoughtPresets || state.thoughtPresets.length === 0) {
                        state.thoughtPresets = JSON.parse(JSON.stringify(INITIAL_STATE.thoughtPresets));
                    }
                    isInitialPostLoad = state.posts.length < 20;
                } else {
                    isInitialPostLoad = true;
                }
            } catch (e) {
                console.error("‰ªé localStorage Âä†ËΩΩÁä∂ÊÄÅÂ§±Ë¥•:", e);
                isInitialPostLoad = true;
                alert("Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåÂèØËÉΩÂ≠òÂÇ®Êï∞ÊçÆÂ∑≤ÊçüÂùè„ÄÇËØ∑ÊâãÂä®Ê∏ÖÁ©∫ÊµèËßàÂô®ÁºìÂ≠òÂêéÈáçËØïÔºåÊàñÁÇπÂáªÂàùÂßãÂåñÂ∫îÁî®„ÄÇ");
            }
        }
        
        function renderMyProfile() {
            document.getElementById('my-profile-avatar').src = state.myProfile.avatar;
            document.getElementById('profile-name').textContent = state.myProfile.name;
            document.getElementById('profile-status').textContent = state.myProfile.status;
            document.getElementById('nickname-value').textContent = state.myProfile.name;
            document.getElementById('signature-value').textContent = state.myProfile.signature;
            document.getElementById('region-value').textContent = state.myProfile.region;
            document.getElementById('birthday-value').textContent = state.myProfile.birthday;
        }

        function fieldNameToChinese(field) {
            const map = { name: 'ÊòµÁß∞', signature: '‰∏™ÊÄßÁ≠æÂêç', region: 'Âú∞Âå∫', birthday: 'ÁîüÊó•', status: 'Áä∂ÊÄÅ', avatar: 'Â§¥ÂÉèURL' };
            return map[field] || field;
        }

        function renderContacts() {
            const contactsContainer = document.querySelector('.contacts-container');
            const recentContacts = state.contacts.filter(c => c.history && c.history.length > 0).sort((a, b) => {
                return (b.history[b.history.length - 1].timestamp || 0) - (a.history[a.history.length - 1].timestamp || 0);
            });
            const otherContacts = state.contacts.filter(c => !c.history || c.history.length === 0);
            contactsContainer.innerHTML = '';
            if (recentContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">ÊúÄËøëËÅäÂ§©</div>';
                recentContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (otherContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">ÊàëÁöÑËÅîÁ≥ª‰∫∫</div>';
                otherContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (state.contacts.length === 0) {
                contactsContainer.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i><p>ËøòÊ≤°ÊúâËÅîÁ≥ª‰∫∫</p><p>ÁÇπÂáªÂè≥‰∏äËßí"+"Ê∑ªÂä†Êñ∞ËÅîÁ≥ª‰∫∫</p></div>`;
            }
            document.querySelectorAll('.contact-item').forEach(item => item.addEventListener('click', function() { openChat(this.dataset.contactId); }));
        }
        
        function createContactItem(contact) {
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.dataset.contactId = contact.id;
            const lastMessage = contact.history && contact.history.length > 0 ? contact.history[contact.history.length - 1] : null;
            
            let lastMessageText;
             if(lastMessage) {
                switch(lastMessage.type) {
                    case 'image': 
                    case 'picture_description':
                        lastMessageText = '[ÂõæÁâá]'; 
                        break;
                    case 'voice': lastMessageText = '[ËØ≠Èü≥]'; break;
                    case 'red_packet': lastMessageText = '[Á∫¢ÂåÖ]'; break;
                    case 'transfer': lastMessageText = '[ËΩ¨Ë¥¶]'; break;
                    case 'system_notification': lastMessageText = lastMessage.content; break;
                    default: lastMessageText = lastMessage.content;
                }
                 if (lastMessage.sender === 'user' && lastMessage.type !== 'system_notification') {
                    lastMessageText = 'Êàë: ' + lastMessageText;
                }
            } else {
                lastMessageText = contact.persona;
            }

            item.innerHTML = `<div class="contact-avatar">${contact.avatar ? `<img src="${contact.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50/DDD/666?text=U';" alt="${contact.name}Â§¥ÂÉè">` : `<i class="fas fa-user"></i>`}</div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-last-message">${lastMessageText}</div></div><div class="contact-time-info" style="text-align: right;">${lastMessage ? `<div class="contact-time">${lastMessage.time}</div>` : ''}${contact.unreadCount > 0 ? `<div class="unread-count">${contact.unreadCount}</div>` : ''}</div>`;
            return item;
        }
        
        function renderWorldBooks() {
            const worldBookList = document.getElementById('world-book-list');
            worldBookList.innerHTML = '';
            if (state.worldBooks.length === 0) {
                worldBookList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>ËøòÊ≤°Êúâ‰∏ñÁïå‰π¶</p><p>ÁÇπÂáªÂè≥‰∏äËßí"+"Ê∑ªÂä†Êñ∞‰∏ñÁïå‰π¶</p></div>`;
                return;
            }
            state.worldBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.dataset.bookId = book.id;
                bookItem.innerHTML = `<div class="book-header"><div class="book-name">${book.name}</div></div><div class="book-content">${book.content.substring(0, 100)}...</div>`;                bookItem.addEventListener('click', function() { editWorldBook(this.dataset.bookId); });
                worldBookList.appendChild(bookItem);
            });
        }
        
        function updateWorldBookSelectors() {
            const worldBookSelect = document.getElementById('world-book-select');
            const worldBookSelectorList = document.getElementById('world-book-selector-list');
            worldBookSelect.innerHTML = '';
            worldBookSelectorList.innerHTML = '';
            const noBookOption = document.createElement('option');
            noBookOption.value = '';
            noBookOption.textContent = '-- Êó†ÂÖ≥ËÅî‰∏ñÁïå‰π¶ --';
            worldBookSelect.appendChild(noBookOption);
            state.worldBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                worldBookSelect.appendChild(option);
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.innerHTML = `<input type="checkbox" class="world-book-checkbox" id="book-setting-${book.id}" value="${book.id}"><label for="book-setting-${book.id}" class="world-book-name">${book.name}</label>`;
                worldBookSelectorList.appendChild(bookItem);
            });
        }

        function createPostItem(post, isDetailView = false) {
            const postItem = document.createElement('div');
            postItem.className = 'post-item';
            if (!isDetailView) {
                 postItem.dataset.postId = post.id;
            }
            
            const author = post.author;
            if (!author) return null;

            // === Êü•Êâæ‰ΩúËÄÖÁöÑÂÆåÊï¥Á≠æÂêç ===
            let authorSignature = author.signature; // ÂÖàÂ∞ùËØïÁõ¥Êé•‰ªépostÁöÑauthorÂØπË±°Ëé∑Âèñ
            if (!authorSignature) { // Â¶ÇÊûúpost.authorÂØπË±°‰∏äÊ≤°ÊúâÁ≠æÂêçÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
                if (author.id === 'myProfile') {
                    authorSignature = state.myProfile.signature; // Â¶ÇÊûúÊòØÁî®Êà∑Êú¨‰∫∫ÔºåÂ∞±‰ªéÂÆåÊï¥ÁöÑ‰∏™‰∫∫ËµÑÊñôÈáåÊãø
                } else {
                    const fullContact = state.contacts.find(c => c.id === author.id); // Â¶ÇÊûúÊòØËÅîÁ≥ª‰∫∫
                    if (fullContact) {
                        authorSignature = fullContact.signature; // Â∞±‰ªéËÅîÁ≥ª‰∫∫ÂàóË°®ÈáåÊâæÂà∞ÂÆåÊï¥ÁöÑËµÑÊñôÂÜçÊãø
                    }
                }
            }
            // === Êü•ÊâæÈÄªËæëÁªìÊùü ===

            const authorName = author.name;
            const authorAvatar = author.avatar || 'https://via.placeholder.com/45/DDD/666?text=U';
            const isLiked = post.likes.includes(state.myProfile.name);
            
            let commentsHTML = '';
            if (!isDetailView && post.comments.length > 0) {
                commentsHTML = `<div class="post-comments">${post.comments.slice(0, 2).map(comment => {
                    const commentAuthor = comment.author;
                    if (!commentAuthor) return '';
                    let replyHTML = '';
                    if (comment.replyTo) {
                        replyHTML = `<span class="comment-reply-to">ÂõûÂ§ç @${comment.replyTo}</span>`;
                    }
                    return `<div class="post-comment-item"><span class="comment-author">${commentAuthor.name}</span>${replyHTML}: ${parseMentions(comment.content)}</div>`;
                }).join('')}${post.comments.length > 2 ? `<div class="post-comment-item" style="color: var(--text-gray);">Êü•ÁúãÂÖ®ÈÉ® ${post.comments.length} Êù°ËØÑËÆ∫...</div>` : ''}</div>`;
            }

            postItem.innerHTML = `
                <div class="post-delete-btn" data-post-id="${post.id}" title="Âà†Èô§Â∏ñÂ≠ê"><i class="fas fa-trash-alt"></i></div>
                <div class="post-item-avatar"><img src="${authorAvatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/45/DDD/666?text=U';" alt="${authorName}ÁöÑÂ§¥ÂÉè"></div>
                <div class="post-content-area">
                    <div>
                        <span class="post-author-name">${authorName}</span>
                        ${author.id && !author.id.startsWith('stranger_') ? `<span class="post-author-handle">@${author.id.replace('_','')}</span>` : ''}
                    </div>

                    ${ authorSignature ? `<div class="post-author-signature">${authorSignature}</div>` : '' }

                    <div class="post-text">${parseMentions(post.content)}</div>
                    <div class="post-meta">${formatTimeAgo(post.timestamp)}</div>
                    <div class="post-actions">
                        <span class="post-action-btn repost-btn" data-post-id="${post.id}"><i class="fas fa-retweet"></i> ${post.reposts > 0 ? post.reposts : 'ËΩ¨Âèë'}</span>
                        <span class="post-action-btn comment-btn" data-post-id="${post.id}"><i class="far fa-comment"></i> ${post.comments.length > 0 ? post.comments.length : 'ËØÑËÆ∫'}</span>
                        <span class="post-action-btn like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${post.likes.length > 0 ? post.likes.length : 'Ëµû'}</span>
                    </div>
                    ${commentsHTML}
                </div>`;
            
            return postItem;
        }

        async function renderFeed() {
            const postsList = document.getElementById('posts-list');
            const tabsContainer = document.getElementById('feed-tabs-container');
            const subTabsContainer = document.getElementById('feed-sub-tabs-container');
            
            tabsContainer.innerHTML = `
                <button class="feed-tab-btn ${state.activeFeedTab === 'recommended' ? 'active' : ''}" data-tab="recommended">Êé®Ëçê</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'following' ? 'active' : ''}" data-tab="following">ÂÖ≥Ê≥®</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'trending' ? 'active' : ''}" data-tab="trending">ÁÉ≠Êêú</button>
            `;

            if (state.activeFeedTab === 'recommended') {
                subTabsContainer.style.display = 'flex';
                 subTabsContainer.innerHTML = `
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'daily' ? 'active' : ''}" data-subtab="daily">Êó•Â∏∏</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'food' ? 'active' : ''}" data-subtab="food">ÁæéÈ£ü</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'gossip' ? 'active' : ''}" data-subtab="gossip">ÂÖ´Âç¶</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'horror' ? 'active' : ''}" data-subtab="horror">ÊÅêÊÄñ</button>
                `;
            } else {
                subTabsContainer.style.display = 'none';
            }
            
            postsList.innerHTML = ''; 

            if (state.activeFeedTab === 'trending') {
                const trendingListEl = document.createElement('ol');
                trendingListEl.className = 'trending-list';
                
                if (state.trendingTopics.length === 0) {
                     trendingListEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><p>ÁÉ≠ÊêúÊ¶úÁ©∫Á©∫Â¶Ç‰πüÔºåÂà∑Êñ∞‰∏Ä‰∏ãËØïËØïÔºü</p></div>`;
                } else {
                    state.trendingTopics.forEach((topic, index) => {
                        const item = document.createElement('li');
                        item.className = 'trending-item';
                        item.dataset.topicTitle = topic.title;
                        item.innerHTML = `
                            <div class="trending-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
                            <div class="trending-info">
                                <div class="trending-title">${topic.title}</div>
                                <div class="trending-meta"><i class="fas fa-fire" style="color: #ff8a65;"></i> ${topic.heat}‰∏á</div>
                            </div>
                            ${topic.tag ? `<div class="trending-tag">${topic.tag}</div>` : ''}
                        `;
                        trendingListEl.appendChild(item);
                    });
                }
                postsList.appendChild(trendingListEl);
                return;
            }

            let postsToShow = [];
            const contactIds = state.contacts.map(c => c.id);

            if (state.activeFeedTab === 'following') {
                postsToShow = state.posts.filter(p => p.author.id === 'myProfile' || contactIds.includes(p.author.id));
            } else { 
                postsToShow = state.posts.filter(p => p.category === state.activeFeedSubTab);
            }
            
            const sortedPosts = [...postsToShow].sort((a, b) => b.timestamp - a.timestamp);
            
            const postsToDisplay = (state.activeFeedTab === 'following') ? sortedPosts : sortedPosts.slice(0, state.postsToDisplay);

            if (postsToDisplay.length === 0) {
                const emptyMessage = state.activeFeedTab === 'following' 
                    ? '‰Ω†ÂÖ≥Ê≥®ÁöÑ‰∫∫ËøòÊ≤°ÊúâÂèëÂ∏ÉÂä®ÊÄÅÂì¶'
                    : 'ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÁÇπÂáªÂè≥‰∏äËßíÂà∑Êñ∞ÁúãÁúã';
                postsList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-couch" style="font-size: 48px; margin-bottom: 15px;"></i><p>${emptyMessage}</p></div>`;
            } else {
                postsToDisplay.forEach(post => {
                    const postItem = createPostItem(post);
                    if (postItem) postsList.appendChild(postItem);
                });
            }
        }

        function renderUserPersonaPresets() {
            const userPersonaPresetsList = document.getElementById('user-persona-presets-list');
            const noUserPersonaMessage = document.getElementById('no-user-persona-message');
            userPersonaPresetsList.innerHTML = '';
            noUserPersonaMessage.style.display = state.userPersonaPresets.length === 0 ? 'block' : 'none';
            state.userPersonaPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.dataset.presetId = preset.id;
                presetItem.innerHTML = `<div class="preset-info"><div class="preset-name">${preset.name}</div><div class="preset-desc">${preset.description}</div></div><div class="preset-actions"><span class="preset-action-btn edit-preset-btn" title="ÁºñËæëÈù¢ÂÖ∑"><i class="fas fa-edit"></i></span><span class="preset-action-btn delete delete-preset-btn" title="Âà†Èô§Èù¢ÂÖ∑"><i class="fas fa-trash-alt"></i></span></div>`;
                userPersonaPresetsList.appendChild(presetItem);
            });
            userPersonaPresetsList.querySelectorAll('.edit-preset-btn').forEach(btn => btn.addEventListener('click', editUserPersonaPreset));
            userPersonaPresetsList.querySelectorAll('.delete-preset-btn').forEach(btn => btn.addEventListener('click', deleteUserPersonaPreset));
            updateUserPersonaPresetSelect();
        }
        
        function renderThoughtPresets() {
            const thoughtPresetsList = document.getElementById('thought-presets-list');
            const noThoughtPresetMessage = document.getElementById('no-thought-preset-message');
            thoughtPresetsList.innerHTML = '';
            noThoughtPresetMessage.style.display = state.thoughtPresets.length === 0 ? 'block' : 'none';
            state.thoughtPresets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.dataset.presetId = preset.id;
                item.innerHTML = `
                    <div class="preset-info">
                        <div class="preset-name">${preset.name}</div>
                        <div class="preset-desc" style="white-space: pre-wrap;">${preset.prompt}</div>
                    </div>
                    <div class="preset-actions">
                        <span class="preset-action-btn edit-thought-preset-btn" title="ÁºñËæëÈ¢ÑËÆæ">
                            <i class="fas fa-edit"></i>
                        </span>
                        <span class="preset-action-btn delete delete-thought-preset-btn" title="Âà†Èô§È¢ÑËÆæ">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </div>
                `;
                thoughtPresetsList.appendChild(item);
            });
            thoughtPresetsList.querySelectorAll('.edit-thought-preset-btn').forEach(btn => btn.addEventListener('click', editThoughtPreset));
            thoughtPresetsList.querySelectorAll('.delete-thought-preset-btn').forEach(btn => btn.addEventListener('click', deleteThoughtPreset));
            populateThoughtPresetSelect();
        }

        function renderEmoticonLibrary() {
            const grid = document.getElementById('emoticon-library-grid');
            const noEmoticonMsg = document.getElementById('no-emoticon-message');
            grid.innerHTML = '';

            if (state.emoticons.length === 0) {
                noEmoticonMsg.style.display = 'block';
            } else {
                noEmoticonMsg.style.display = 'none';
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `
                        <img src="${emo.url}" alt="${emo.name}" onerror="this.src='https://via.placeholder.com/60?text=Error'; this.alt='ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•';">
                        <div class="emoticon-name">${emo.name}</div>
                        <button class="emoticon-delete-btn" data-emoticon-id="${emo.id}">&times;</button>
                    `;
                    grid.appendChild(item);
                });

                grid.querySelectorAll('.emoticon-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const emoticonId = e.currentTarget.dataset.emoticonId;
                        if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü')) {
                            state.emoticons = state.emoticons.filter(e => e.id !== emoticonId);
                            saveState();
                            renderEmoticonLibrary();
                        }
                    });
                });
            }
        }

        function renderEmoticonPicker() {
            const emoticonPicker = document.getElementById('emoticon-picker');
            emoticonPicker.innerHTML = '';
            if (state.emoticons.length > 0) {
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `<img src="${emo.url}" alt="${emo.name}">`;
                    item.addEventListener('click', () => {
                        createAndAddMessage({ 
                            type: 'image', 
                            url: emo.url,
                            isEmoticon: true,
                            emoticonName: emo.name
                        });
                        emoticonPicker.classList.remove('active');
                    });
                    emoticonPicker.appendChild(item);
                });
            } else {
                emoticonPicker.innerHTML = '<div style="color: #999; text-align: center; grid-column: 1 / -1;">Ë°®ÊÉÖÂåÖÂ∫ìÊòØÁ©∫ÁöÑ</div>';
            }
        }

        function updateUserPersonaPresetSelect() {
            const selectUserPersonaPreset = document.getElementById('select-user-persona-preset');
            selectUserPersonaPreset.innerHTML = '<option value="">-- ÈÄâÊã©ÊàñËæìÂÖ•Ëá™ÂÆö‰πâÈù¢ÂÖ∑ --</option>';
            state.userPersonaPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectUserPersonaPreset.appendChild(option);
            });
        }

        function populateThoughtPresetSelect() {
            const select = document.getElementById('thought-preset-select');
            const currentVal = select.value;
            select.innerHTML = '';
            
            const noPresetOption = document.createElement('option');
            noPresetOption.value = ""; // Empty value for "no preset"
            noPresetOption.textContent = "-- Êó†È¢ÑËÆæ (‰ΩøÁî®ÈªòËÆ§ËßíËâ≤ÊâÆÊºî) --";
            select.appendChild(noPresetOption);

            if (state.thoughtPresets.length === 0) {
                return;
            }
            state.thoughtPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                select.appendChild(option);
            });

            if (state.thoughtPresets.some(p => p.id === currentVal) || currentVal === "") {
                select.value = currentVal;
            }
        }

        function updateNotificationDots() {
            const dots = document.querySelectorAll('.moments-notification-dot');
            if (state.hasNewPosts) {
                dots.forEach(dot => dot.style.display = 'block');
            } else {
                dots.forEach(dot => dot.style.display = 'none');
            }
        }
        
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " Âπ¥Ââç";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " ÊúàÂâç";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " Â§©Ââç";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " Â∞èÊó∂Ââç";
            interval = seconds / 60;
            if (interval > 5) return Math.floor(interval) + " ÂàÜÈíüÂâç";
            
            return "ÂàöÂàö";
        }

        function parseMentions(text) {
            if (!text) return '';
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            return text.replace(mentionRegex, (match) => {
                return `<span class="mention">${match}</span>`;
            });
        }


        function hideAllScreens() {
            document.querySelectorAll('#screen > div').forEach(el => el.style.display = 'none');
        }

        function setActiveNav(activeNavId) {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.id.includes(activeNavId)) {
                    item.classList.add('active');
                }
            });
        }
        
        function showMainScreen() { hideAllScreens(); document.getElementById('main-screen').style.display = 'flex'; setActiveNav('chat'); renderContacts(); }
        function showDiscoverScreen() { hideAllScreens(); document.getElementById('discover-screen').style.display = 'flex'; setActiveNav('discover'); }
        function showProfileScreen() { hideAllScreens(); document.getElementById('profile-screen').style.display = 'flex'; setActiveNav('profile'); renderMyProfile(); }
        
        async function showFeedScreen() { 
            hideAllScreens(); 
            document.getElementById('moments-screen').style.display = 'flex'; 
            if (state.hasNewPosts) {
                state.hasNewPosts = false;
                saveState();
                updateNotificationDots();
            }
            if (isInitialPostLoad && state.posts.length === 0) {
                 if (state.trendingTopics.length === 0) {
                    await generateRandomTrendingTopicsAI();
                }
                await generatePostsForRecommendedTab(10);
                isInitialPostLoad = false;
            }
            renderFeed();
        }

        function showPostDetailScreen(postId) {
            state.activePostId = postId;
            hideAllScreens();
            document.getElementById('post-detail-screen').style.display = 'flex';
            renderPostDetail();
        }
        
        function showTrendingTopicScreen(topicTitle) {
            hideAllScreens();
            document.getElementById('trending-topic-screen').style.display = 'flex';
            document.getElementById('trending-topic-title').textContent = `# ${topicTitle} #`;
            const listEl = document.getElementById('trending-topic-posts-list');
            listEl.innerHTML = '';

            const relatedPosts = state.posts.filter(p => p.content.toLowerCase().includes(topicTitle.toLowerCase()));
            
            if (relatedPosts.length === 0) {
                 listEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 15px;"></i><p>ËØ•ËØùÈ¢ò‰∏ãËøòÊ≤°ÊúâÂ∏ñÂ≠ê</p></div>`;
                 return;
            }

            relatedPosts.sort((a,b) => b.timestamp - a.timestamp).forEach(post => {
                const postItem = createPostItem(post);
                if (postItem) listEl.appendChild(postItem);
            });
        }

        function showThoughtPresetManagementScreen() { hideAllScreens(); document.getElementById('thought-preset-management-screen').style.display = 'flex'; renderThoughtPresets(); }
        function showEmoticonLibraryScreen() { hideAllScreens(); document.getElementById('emoticon-library-screen').style.display = 'flex'; renderEmoticonLibrary(); }
        function showUserPersonaManagementScreen() { hideAllScreens(); document.getElementById('user-persona-management-screen').style.display = 'flex'; renderUserPersonaPresets(); }

        function showCharProfileScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            
            batchedPetActions = [];
            
            document.getElementById('char-profile-avatar').src = contact.avatar || `https://via.placeholder.com/70/DDD/666?text=${contact.name.substring(0,1).toUpperCase()}`;
            document.getElementById('char-profile-name').textContent = contact.name;
            document.getElementById('char-name-value').textContent = contact.name;
            document.getElementById('char-signature-value').textContent = contact.signature || 'Êú™ËÆæÁΩÆ';
            document.getElementById('char-profile-signature-display').textContent = `‰∏™ÊÄßÁ≠æÂêç: ${contact.signature || '...'}`;


            hideAllScreens();
            document.getElementById('char-profile-screen').style.display = 'flex';

            renderPet(contact);
        }

        // --- V6.0 Êñ∞Â¢ûÔºöÊòæÁ§∫ÂíåÊ∏≤ÊüìÁõ∏ÂÜå ---
        function showMemoryAlbum(contact) {
            hideAllScreens();
            document.getElementById('memory-album-screen').style.display = 'flex';
            renderMemoryAlbum(contact);
        }

        function renderMemoryAlbum(contact) {
            const listEl = document.getElementById('memory-album-list');
            listEl.innerHTML = '';
            if (!contact.memories || contact.memories.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><p>Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºå</p><p>ÂíåTA‰∏ÄËµ∑ÂàõÈÄ†Êõ¥Â§öÊ∏©È¶®ÁöÑÂõûÂøÜÂêßÔºÅ</p></div>`;
                return;
            }

            const sortedMemories = [...contact.memories].sort((a, b) => b.timestamp - a.timestamp);
            sortedMemories.forEach(memo => {
                const entryEl = document.createElement('div');
                entryEl.className = 'diary-entry'; // Áõ¥Êé•Â§çÁî®Êó•ËÆ∞ÁöÑÊ†∑Âºè
                entryEl.innerHTML = `
                    <div class="diary-entry-meta">${new Date(memo.timestamp).toLocaleDateString()}</div>
                    <div class="diary-entry-content">üíñ ${memo.description}</div>
                `;
                listEl.appendChild(entryEl);
            });
        }
        // --- V6.0 Êñ∞Â¢ûÁªìÊùü ---


        function editUserPersonaPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.userPersonaPresets.find(p => p.id === presetId);
            if (preset) {
                editingUserPersonaId = presetId;
                document.getElementById('user-persona-modal-title').textContent = 'ÁºñËæëÁî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ';
                document.getElementById('user-persona-name-input').value = preset.name;
                document.getElementById('user-persona-description-input').value = preset.description;
                document.getElementById('user-persona-preset-modal').style.display = 'flex';
            }
        }

        function deleteUserPersonaPreset(event) {
            event.stopPropagation();
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Áî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæÂêóÔºü')) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.userPersonaPresets = state.userPersonaPresets.filter(p => p.id !== presetId);
                saveState();
                renderUserPersonaPresets();
            }
        }

        function editThoughtPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.thoughtPresets.find(p => p.id === presetId);
            if (preset) {
                editingThoughtPresetId = presetId;
                document.getElementById('thought-preset-modal-title').textContent = 'ÁºñËæëÊÄùÁª¥È¢ÑËÆæ';
                document.getElementById('thought-preset-name-input').value = preset.name;
                document.getElementById('thought-preset-prompt-input').value = preset.prompt;
                document.getElementById('thought-preset-modal').style.display = 'flex';
            }
        }

        function deleteThoughtPreset(event) {
            event.stopPropagation();
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§ÊÄùÁª¥È¢ÑËÆæÂêóÔºü')) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.thoughtPresets = state.thoughtPresets.filter(p => p.id !== presetId);
                saveState();
                renderThoughtPresets();
            }
        }

        function findAuthorById(authorId) {
            if (authorId === 'myProfile') {
                return { id: 'myProfile', ...state.myProfile };
            }
            return state.contacts.find(c => c.id === authorId);
        }
        
        function toggleLike(event) {
            event.stopPropagation();
            const postId = event.currentTarget.dataset.postId;
            const post = state.posts.find(p => p.id === postId);
            if (post) {
                const myName = state.myProfile.name;
                const likeIndex = post.likes.indexOf(myName);
                if (likeIndex === -1) {
                    post.likes.push(myName);
                } else {
                    post.likes.splice(likeIndex, 1);
                }
                saveState();
                
                if (document.getElementById('moments-screen').style.display === 'flex') {
                    renderFeed(); 
                } else if (document.getElementById('post-detail-screen').style.display === 'flex') {
                    renderPostDetail();
                }
            }
        }
        
        function editWorldBook(bookId) {
            const book = state.worldBooks.find(b => b.id === bookId);
            if (book) {
                editingBookId = bookId;
                document.getElementById('world-book-modal-title').textContent = 'ÁºñËæë‰∏ñÁïå‰π¶';
                document.getElementById('book-name-input').value = book.name;
                document.getElementById('book-content-input').value = book.content;
                document.getElementById('add-world-book-modal').style.display = 'flex';
            }
        }
        
        async function fetchModels(endpointBase, apiKey, modelSelectEl, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÊãâÂèñ‰∏≠';
            btn.disabled = true;

            if (!endpointBase) {
                alert('ËØ∑ËæìÂÖ•APIÂü∫Á°ÄÂú∞ÂùÄ');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> ÊãâÂèñ';
                btn.disabled = false;
                return;
            }

            const PROXY_URL = 'https://689ffa375536ae4ef8527303--amazing-biscotti-ab7231.netlify.app/api/proxy';

            try {
                let targetUrl;
                let isGoogleApi = endpointBase.includes('googleapis.com');

                if (isGoogleApi) {
                    targetUrl = `https://${endpointBase}/v1beta/models`;
                } else {
                    let modelsUrl = endpointBase.startsWith('http') ? endpointBase : `https://${endpointBase}`;
                    if (!modelsUrl.endsWith('/')) modelsUrl += '/';
                    targetUrl = modelsUrl + 'v1/models';
                }

                const response = await fetch(PROXY_URL, {
                    method: 'POST', // ËØ∑Ê±ÇÊàë‰ª¨Ëá™Â∑±ÁöÑ‰ª£ÁêÜÔºåÂßãÁªàÁî®POST
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetUrl: targetUrl,
                        apiKey: apiKey,
                        method: isGoogleApi ? 'GET' : 'GET' // ÊòéÁ°ÆÂëäËØâ‰ª£ÁêÜÔºåËøôÊ¨°Ë¶ÅÂéªÁõÆÊ†áÂú∞ÂùÄÊâßË°åGETÊìç‰Ωú
                    })
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error ? errorData.error.message : JSON.stringify(errorData);
                    } catch (e) { /* ÂøΩÁï•jsonËß£ÊûêÂ§±Ë¥• */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                let models;

                if (isGoogleApi) {
                    models = data.models
                        .filter(model => model.supportedGenerationMethods.includes("generateContent"))
                        .map(model => model.name.replace("models/", ""))
                        .sort();
                    alert(`ÊàêÂäüÊãâÂèñ ${models.length} ‰∏™ Gemini Ê®°ÂûãÔºÅ`);
                } else {
                    models = data.data.map(model => model.id).sort();
                    alert(`ÊàêÂäüÊãâÂèñ ${models.length} ‰∏™Ê®°ÂûãÔºÅ`);
                }

                updateModelDropdown(models, modelSelectEl, modelSelectEl.value);

            } catch (error) {
                console.error('ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•:', error);
                alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
            } finally {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> ÊãâÂèñ';
                btn.disabled = false;
            }
        }
        
        function updateModelDropdown(models, modelSelect, currentModel) {
            modelSelect.innerHTML = ''; 

            if (models && models.length > 0) {
                models.forEach(modelId => {
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    if (modelId === currentModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } else if (currentModel) { 
                const option = document.createElement('option');
                option.value = currentModel;
                option.textContent = currentModel;
                option.selected = true;
                modelSelect.appendChild(option);
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "Êú™ËÉΩÊãâÂèñÂà∞Ê®°ÂûãÊàñÂàóË°®‰∏∫Á©∫";
                modelSelect.appendChild(option);
            }
        }

        const MESSAGES_PER_PAGE = 30;

        function enterEditMode() {
            editModeState.active = true;
            editModeState.selectedMessageIds.clear();
            document.getElementById('chat-screen').classList.add('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('edit-mode-bar').style.display = 'flex';
            renderChatMessages(state.contacts.find(c => c.id === state.activeChatId), true); 
        }

        function exitEditMode() {
            editModeState.active = false;
            document.getElementById('chat-screen').classList.remove('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'flex';
            document.getElementById('edit-mode-bar').style.display = 'none';
            openChat(state.activeChatId);
        }

        function handleMessageSelection(wrapper, message) {
            if (!editModeState.active) return;
            const msgId = wrapper.dataset.messageId;
            if (!msgId) return;

            if (editModeState.selectedMessageIds.has(msgId)) {
                editModeState.selectedMessageIds.delete(msgId);
                wrapper.classList.remove('selected');
            } else {
                editModeState.selectedMessageIds.add(msgId);
                wrapper.classList.add('selected');
            }
        }

        function openChat(contactId) {
            if (editModeState.active) exitEditMode();
            const contact = state.contacts.find(c => c.id === contactId);
            if (!contact) return;
            state.activeChatId = contactId;
            
            chatPagination[contactId] = 1;

            document.getElementById('chat-messages').innerHTML = '';

            hideAllScreens();
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-contact-name').textContent = contact.name;
            document.getElementById('chat-contact-status').textContent = 'Âú®Á∫ø'; 
            
            // --- V6.0 Êñ∞Â¢ûÔºöËøõÂÖ•ËÅäÂ§©Êó∂Êõ¥Êñ∞Ê°åÈù¢ÂÆ†Áâ©Áä∂ÊÄÅ ---
            const chatPetContainer = document.getElementById('chat-pet-container');
            if (contact.pet && contact.isChatPetVisible) {
                chatPetContainer.style.display = 'block';
                updateChatPetVisuals(contact);
            } else {
                chatPetContainer.style.display = 'none';
            }
            // --- V6.0 Êñ∞Â¢ûÁªìÊùü ---

            renderChatMessages(contact);
            if (contact.unreadCount) {
                contact.unreadCount = 0;
                saveState();
            }
        }

        function renderChatMessages(contact, loadAll = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const isInitialRender = messagesContainer.innerHTML === '';
            
            if (isInitialRender) {
                messagesContainer.innerHTML = '';
            }

            const page = chatPagination[contact.id] || 1;
            const start = loadAll ? 0 : Math.max(0, contact.history.length - (page * MESSAGES_PER_PAGE));
            const end = loadAll ? contact.history.length : Math.max(0, contact.history.length - ((page - 1) * MESSAGES_PER_PAGE));
            
            const messagesToRender = contact.history.slice(start, end);

            const existingLoadMoreBtn = document.getElementById('load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            let currentScrollHeight = messagesContainer.scrollHeight;

            if (!contact || !contact.history || contact.history.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">Âíå ${contact ? contact.name : ''} ÂºÄÂßãËÅäÂ§©ÂêßÔºÅ</div>`;
                return;
            }
            
            let fragment = document.createDocumentFragment();
            messagesToRender.forEach((msg, index) => {
                const globalIndex = start + index;
                let isFirstInSequence = true;
                if (msg.type !== 'system_notification') {
                    let prevMsg = null;
                     for (let i = globalIndex - 1; i >= 0; i--) {
                        if (contact.history[i].type !== 'system_notification' && contact.history[i].sender !== 'system_instruction') {
                            prevMsg = contact.history[i];
                            break;
                        }
                    }
                    isFirstInSequence = !prevMsg || prevMsg.sender !== msg.sender;
                }
                const messageEl = createMessageElement(msg, contact, isFirstInSequence);
                if(messageEl) {
                     if (editModeState.active && editModeState.selectedMessageIds.has(msg.id)) {
                        messageEl.classList.add('selected');
                    }
                    fragment.appendChild(messageEl);
                }
            });
            
            if (isInitialRender) {
                messagesContainer.appendChild(fragment);
            } else {
                messagesContainer.insertBefore(fragment, messagesContainer.firstChild);
            }

            if (!loadAll && start > 0) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-messages';
                loadMoreBtn.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï...';
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => {
                    chatPagination[contact.id]++;
                    renderChatMessages(contact);
                };
                messagesContainer.prepend(loadMoreBtn);
            }
            
            if (isInitialRender || editModeState.active) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                 messagesContainer.scrollTop = messagesContainer.scrollHeight - currentScrollHeight;
            }
        }

        function createMessageElement(message, contact, isFirstInSequence) {
            if (message.sender === 'system_instruction') return null;

            if (message.type === 'system_notification') {
                const el = document.createElement('div');
                el.className = 'system-notification';
                el.textContent = message.content;
                return el;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${message.sender === 'user' ? 'sent' : 'received'}`;
            wrapper.dataset.messageId = message.id; 
            if (isFirstInSequence) {
                wrapper.classList.add('is-first-in-sequence');
                wrapper.style.marginTop = '20px';
            }

            const senderInfo = message.sender === 'user' ? state.myProfile : contact;
            let messageContentHTML = '';

            switch (message.type) {
                case 'image':
                    messageContentHTML = `<div class="message image-message"><div class="message-image-container ${message.sender === 'user' ? 'sent' : 'received'}"><img src="${message.url}" class="message-image" alt="ÂõæÁâá"></div></div>`;
                    break;
                case 'picture_description':
                    messageContentHTML = `<div class="message picture-description ${message.sender === 'user' ? 'sent' : 'received'}"><i class="fas fa-image"></i><span>[ÂõæÁâá]</span></div>`;
                    break;
                case 'voice':
                    const voiceData = message.content;
                    const width = Math.min(200, 80 + parseInt(voiceData.duration) * 5) + 'px';
                    messageContentHTML = `<div class="message voice ${message.sender === 'user' ? 'sent' : 'received'}" style="width: ${width};"><div class="voice-duration">${voiceData.duration}''</div><i class="fas fa-wifi"></i></div>`;
                    break;
                case 'red_packet':
                    const packetData = message.content;
                    const statusHTML = packetData.opened ? `<div class="red-packet-status">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂèñ</div>` : `<div class="red-packet-blessing">${packetData.blessing}</div>`;
                    messageContentHTML = `<div class="message red-packet ${packetData.opened ? 'opened' : ''} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="red-packet-header"><div class="red-packet-icon">üßß</div>${statusHTML}</div><div class="red-packet-footer">ËÅäÂ§©Á∫¢ÂåÖ</div></div>`;
                    break;
                case 'transfer':
                    const transferData = message.content;
                    messageContentHTML = `<div class="message transfer ${transferData.completed ? 'completed' : ''} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="transfer-header"><div class="transfer-icon"><i class="fas fa-money-bill-wave"></i></div><div class="transfer-info"><div class="transfer-text">ËΩ¨Ë¥¶</div><div class="transfer-amount">¬• ${transferData.amount}</div></div></div><div class="transfer-footer">ËÅäÂ§©ËΩ¨Ë¥¶</div></div>`;
                    break;
                default: 
                    let formattedContent = message.content;
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = formattedContent;
                    formattedContent = tempDiv.innerHTML;

                    // --- ÁªàÊûÅÁâàÂèô‰∫ãÊ®°ÂºèÁæéÂåñËß£Êûê ---
                    // 1. Ëß£Êûê {ÂøÉÁêÜÊèèÂÜô}
                    formattedContent = formattedContent.replace(/\{(.*?)\}/g, '<span class="narrative-psychology">$1</span>');
                    // 2. Ëß£Êûê "ËØ≠Ë®ÄÊèèÂÜô" (ÂÖºÂÆπ Áõ¥ÂºïÂè∑" / ‰∏≠ÊñáÂºØÂºïÂè∑‚Äú...‚Äù / ÂÖ®ËßíÂºØÂºïÂè∑ÔºÇ...ÔºÇ)
                    formattedContent = formattedContent.replace(/(?:&quot;|‚Äú|‚Äù|ÔºÇ)(.*?)(?:&quot;|‚Äú|‚Äù|ÔºÇ)/g, '<span class="narrative-speech">‚Äú$1‚Äù</span>');
                    // 3. Ëß£Êûê *Âä®‰ΩúÊèèÂÜô*
                    formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<span class="narrative-action">$1</span>');
                    
                    formattedContent = formattedContent.replace(/\n/g, '<br>');
                    messageContentHTML = `<div class="message ${message.sender === 'user' ? 'sent' : 'received'}">${formattedContent}</div>`;
                    break;
            }

            const transcribedTextHTML = (message.type === 'voice' || message.type === 'picture_description') ? '<div class="transcribed-text"></div>' : '';

            wrapper.innerHTML = `
                <div class="message-avatar">
                    <img src="${senderInfo.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/40/DDD/666?text=U';">
                </div>
                <div class="message-body">
                    <div class="message-author-name">${senderInfo.name}</div>
                    ${messageContentHTML}
                    ${transcribedTextHTML}
                    <div class="message-timestamp">${message.time}</div>
                </div>
            `;

            wrapper.addEventListener('click', () => handleMessageSelection(wrapper, message));
            return wrapper;
        }
        
        // --- V6.0 Êñ∞Â¢ûÔºöÊ∑ªÂä†ÂÖ±ÂêåÂõûÂøÜÂáΩÊï∞ ---
        function addSharedMemory(contact, description) {
            if (!contact) return;
            if (!contact.memories) contact.memories = []; // ÂÖºÂÆπÊóßÂ≠òÊ°£

            contact.memories.push({
                id: `memo_${Date.now()}`,
                timestamp: Date.now(),
                description: description
            });
            saveState();
        }

        // --- V6.0 Êñ∞Â¢ûÔºöÂÆ†Áâ©ÂçáÁ∫ß‰∏éËøõÂåñÂáΩÊï∞ ---
        function checkForPetLevelUp(contact) {
            if (!contact.pet) return;

            // ÂÅáËÆæÊØè100ÁÇπÁªèÈ™åÂçá‰∏ÄÁ∫ß
            const xpForNextLevel = 100;

            if (contact.pet.xp >= xpForNextLevel) {
                contact.pet.xp -= xpForNextLevel; // ÂáèÂéªÂçáÁ∫ßÊâÄÈúÄÁöÑÁªèÈ™å
                contact.pet.level += 1; // Á≠âÁ∫ß+1

                let evolutionMessage = '';
                let evolutionForm = contact.pet.form;

                // Âú®ÁâπÂÆöÁ≠âÁ∫ßËß¶ÂèëËøõÂåñ
                if (contact.pet.level === 5 && contact.pet.form === 'baby') {
                    evolutionForm = 'toddler'; // ÂπºÂπ¥Êúü
                    evolutionMessage = `Âú®‰Ω†‰ª¨ÁöÑÁ≤æÂøÉÁÖßÊñô‰∏ãÔºåÂè≤Ëé±ÂßÜÈïøÂ§ß‰∫ÜÔºÅËøõÂåñÊàê‰∫ÜÂèØÁà±ÁöÑÂπºÂπ¥ÊúüÂΩ¢ÊÄÅÔºÅ`;
                } else if (contact.pet.level === 15 && contact.pet.form === 'toddler') {
                    evolutionForm = 'teenager'; // Â∞ëÂπ¥Êúü
                    evolutionMessage = `ÂìáÔºÅÂÖâËäíÈó™ËøáÔºåÂè≤Ëé±ÂßÜÂÜçÊ¨°ËøõÂåñÔºåËøõÂÖ•‰∫ÜÊ¥ªÊ≥ºÁöÑÂ∞ëÂπ¥ÊúüÔºÅ`;
                }

                // Â¶ÇÊûúÂèëÁîü‰∫ÜËøõÂåñ
                if (evolutionMessage) {
                    contact.pet.form = evolutionForm;
                    // 1. Âú®ËÅäÂ§©Ê°ÜÈáåÂèëÂá∫Á≥ªÁªüÈÄöÁü•
                    createSystemNotification(evolutionMessage);
                    // 2. ËÆ©CharÂØπÊ≠§‰∫ãÂèëË°®ÂÖ¥Â•ãÁöÑËØÑËÆ∫
                    requestAiReply(`[SYSTEM: ‰Ω†‰ª¨ÁöÑÂÆ†Áâ©ÂàöÂàöËøõÂåñ‰∫ÜÔºÅ${evolutionMessage} ËØ∑‰Ω†ÂØπÊ≠§ÂèëË°®‰∏ÄÊÆµÊûÅÂÖ∂ÂÖ¥Â•ãÂíåÂºÄÂøÉÁöÑÊÑüË®ÄÔºÅ]`);
                    // 3. ËÆ∞ÂΩïËøô‰ª∂Ê∏©È¶®Â§ß‰∫ã
                    addSharedMemory(contact, `Âú®LV.${contact.pet.level}Êó∂ÔºåÊàë‰ª¨ÁöÑÂè≤Ëé±ÂßÜËøõÂåñÊàê‰∫Ü‚Äú${evolutionForm}‚ÄùÂΩ¢ÊÄÅÔºÅ`);
                } else {
                    // Â¶ÇÊûúÂè™ÊòØÊôÆÈÄöÂçáÁ∫ß
                    createSystemNotification(`‰Ω†‰ª¨ÁöÑËÅäÂ§©ËÆ©Âè≤Ëé±ÂßÜËé∑Âæó‰∫ÜÊàêÈïøÔºÅÂçáÂà∞‰∫Ü LV.${contact.pet.level}ÔºÅ`);
                }
                
                saveState();
            }
        }

        function createAndAddMessage(messageData, sender = 'user') {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            // --- V6.0 Êñ∞Â¢ûÔºöËÅäÂ§©Â¢ûÂä†ÂÆ†Áâ©ÁªèÈ™åÂÄº ---
            if (contact.pet && sender !== 'system_instruction' && messageData.type !== 'system_notification') {
                contact.pet.xp += 1; // ÊØèÊù°ÊúâÊïàÊ∂àÊÅØ+1ÁÇπÁªèÈ™å
                checkForPetLevelUp(contact); // Ë∞ÉÁî®‰∏Ä‰∏™Êñ∞ÂáΩÊï∞Ê£ÄÊü•ÊòØÂê¶ËØ•ÂçáÁ∫ß‰∫Ü
            }
            // --- Êñ∞Â¢ûÁªìÊùü ---

            const fullMessage = {
                id: `msg_${Date.now()}_${Math.random()}`,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                sender: sender,
                ...messageData
            };
            
            if (!contact.history) contact.history = [];
            contact.history.push(fullMessage);
            
            if (fullMessage.sender !== 'system_instruction') {
                const messagesContainer = document.getElementById('chat-messages');
                let isFirstInSequence = true;
                if (contact.history.length > 1) {
                    let prevMsg = null;
                    for (let i = contact.history.length - 2; i >= 0; i--) {
                        if (contact.history[i].type !== 'system_notification' && contact.history[i].sender !== 'system_instruction') {
                            prevMsg = contact.history[i];
                            break;
                        }
                    }
                    if (prevMsg && prevMsg.sender === fullMessage.sender) {
                        isFirstInSequence = false;
                    }
                }
                const messageEl = createMessageElement(fullMessage, contact, isFirstInSequence);
                if(messageEl) {
                    if (messagesContainer.querySelector('div[style*="text-align: center"]')) {
                        messagesContainer.innerHTML = '';
                    }
                    messagesContainer.appendChild(messageEl);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            saveState();
            if (fullMessage.sender !== 'system_instruction') {
                renderContacts();
            }
            
            return fullMessage;
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            if (!content || !state.activeChatId) return;

            createAndAddMessage({ type: 'text', content: content });

            messageInput.value = '';
            messageInput.style.height = '42px';
            messageInput.focus();
        }

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function requestAiReply(systemInstruction = null) {
            if (!state.activeChatId) return;
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            if (systemInstruction) {
                 createAndAddMessage({ type: 'text', content: systemInstruction, sender: 'system_instruction' });
            }

            if (contact.history.filter(m => m.sender !== 'system_instruction').length === 0) {
                if (!systemInstruction) alert('ËØ∑ÂÖàÂèëÈÄÅÊ∂àÊÅØÂÜçËØ∑Ê±ÇÂõûÂ§ç„ÄÇ');
                return;
            }

            triggerAiReply(contact);
        }

        async function triggerAiReply(contact) {
            const chatStatusEl = document.getElementById('chat-contact-status');
            const originalStatus = chatStatusEl.textContent;
            chatStatusEl.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';

            if (!contact.apiCallCounter) {
                contact.apiCallCounter = 0;
            }
            contact.apiCallCounter++;
            
            // --- üî¥ ‰øÆÊîπÂºÄÂßã ---
            // Ê£ÄÊü•Áî®Êà∑Áä∂ÊÄÅÂèòÂåñÂπ∂ÁîüÊàêÂÖ≥ÂøÉÊåá‰ª§ (‰øÆÊ≠£Áâà)
            try {
                const currentUserStatus = state.myProfile.status;
                // Á°Æ‰øù contact ÂØπË±°Â≠òÂú®‰∏îÂèØÂÜô
                if (contact) {
                    // Ê£ÄÊü•Ëøô‰∏™ËÅîÁ≥ª‰∫∫ÁöÑ‚ÄúËÆ∞ÂøÜ‚ÄùÈáåÔºåÊÇ®‰∏ä‰∏ÄÊ¨°ÁöÑÁä∂ÊÄÅÂíå‰ªñ/Â•πÁé∞Âú®Áü•ÈÅìÁöÑÊòØÂê¶‰∏çÂêå
                    if (contact.lastKnownUserStatus && contact.lastKnownUserStatus !== currentUserStatus) {
                        const statusChangeInstruction = `[SYSTEM: ‰Ω†ÁöÑÂØπËØù‰ºô‰º¥ÂàöÂàöÂ∞ÜÁä∂ÊÄÅ‰ªé‚Äú${contact.lastKnownUserStatus}‚ÄùÊîπ‰∏∫‰∫Ü‚Äú${currentUserStatus}‚Äù„ÄÇËøôÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÊú∫‰ºöÔºå‰Ω†ÂèØ‰ª•Ëá™ÁÑ∂Âú∞ÂÖ≥ÂøÉ‰∏Ä‰∏ãÔºåÊØîÂ¶ÇÈóÆÔºö‚ÄúÊàëÁúãÂà∞‰Ω†ÁöÑÁä∂ÊÄÅÂèò‰∫ÜÔºåËøòÂ•ΩÂêóÔºü‚Äù„ÄÇËøôÊ¨°‰πãÂêéÂ∞±‰∏çÁî®ÂÜçÊèê‰∫Ü„ÄÇ]`;
                        createAndAddMessage({ type: 'text', content: statusChangeInstruction, sender: 'system_instruction' });
                    }
                    // Êó†ËÆ∫Áä∂ÊÄÅÊòØÂê¶ÊîπÂèòÔºåÈÉΩÊõ¥Êñ∞AIÂØπ‰Ω†Áä∂ÊÄÅÁöÑ‚ÄúÊúÄÂêéËÆ∞ÂøÜ‚Äù
                    contact.lastKnownUserStatus = currentUserStatus;
                }
            } catch (e) {
                console.error("Êõ¥Êñ∞Áî®Êà∑Áä∂ÊÄÅËÆ∞ÂøÜÊó∂Âá∫Èîô:", e);
                // Âç≥‰ΩøËøôÈáåÂá∫ÈîôÔºå‰πü‰∏çÂ∫î‰∏≠Êñ≠Êï¥‰∏™ÂõûÂ§çÊµÅÁ®ã
            }
            // --- üî¥ ‰øÆÊîπÁªìÊùü ---

            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                let systemInstruction = '';
                if (lastUnopenedMessage.type === 'red_packet') {
                    systemInstruction = `[SYSTEM: You have just received a red packet from the user. The blessing is: "${lastUnopenedMessage.content.blessing}". Decide whether to accept it and reflect your decision in your response.]`;
                } else if (lastUnopenedMessage.type === 'transfer') {
                    systemInstruction = `[SYSTEM: You have just received a transfer of ${lastUnopenedMessage.content.amount}ÂÖÉ from the user. Decide whether to accept or reject it and reflect your decision in your response.]`;
                }
                createAndAddMessage({ type: 'text', content: systemInstruction, sender: 'system_instruction' });
            }
            
            try {
                // AI‰∏ªÂä®ÂÆ†Áâ©Ë°å‰∏∫
                if (contact.pet && contact.isChatPetVisible && Math.random() < 0.25) {
                    let petActionSystemMessage = null;

                    if (contact.pet.hunger < 40) {
                        petActionSystemMessage = `[SYSTEM: ÊÇ¨ÊµÆÂú®Â±èÂπï‰∏äÁöÑÂè≤Ëé±ÂßÜÁúãËµ∑Êù•È•ø‰∫ÜÔºåËØ∑‰Ω†ÂÖ≥ÂøÉ‰∏Ä‰∏ãÂÆÉ„ÄÇ]`;
                    } else if (contact.pet.happiness < 40) {
                        petActionSystemMessage = `[SYSTEM: ÊÇ¨ÊµÆÂú®Â±èÂπï‰∏äÁöÑÂè≤Ëé±ÂßÜÁúãËµ∑Êù•‰∏çÂºÄÂøÉÔºåËØ∑‰Ω†ÊèêÂèä‰∏Ä‰∏ãËøô‰ª∂‰∫ã„ÄÇ]`;
                    }
                    
                    if (petActionSystemMessage) {
                        createAndAddMessage({ type: 'text', content: petActionSystemMessage, sender: 'system_instruction' });
                    }
                }

                const forceDiary = (contact.apiCallCounter % 3 === 0);
                const rawResponse = await generateAiResponse(contact, contact.history, null, forceDiary, 'chat');
                
                await processAndDisplayAiResponse(rawResponse, contact);

            } finally {
                chatStatusEl.textContent = originalStatus;
                contact.history = contact.history.filter(m => m.sender !== 'system_instruction');
                saveState();
            }
        }
        
        function getApiFor(type = 'chat') {
            if (type === 'square' && state.squareApiSettings.apiKey && state.squareApiSettings.endpoint && state.squareApiSettings.model) {
                return state.squareApiSettings;
            }
            return state.apiSettings;
        }

        async function generateAiResponse(contact, history, customSystemPrompt, forceDiary = false, apiType = 'chat') {
            const apiConfig = getApiFor(apiType);
            const { apiKey, model, endpoint, contextLength } = apiConfig;

            if (!apiKey || !endpoint || !model) {
                return `ÈîôËØØÔºöAPIÊú™ÈÖçÁΩÆ„ÄÇ`;
            }

            // üöÄ „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëËØ∑Â∞Ü‰∏ãÈù¢ÁöÑÁΩëÂùÄÊõøÊç¢ÊàêÊÇ®Ëá™Â∑±ÁöÑVercel‰ª£ÁêÜÂú∞ÂùÄÔºÅ
            // ‰æãÂ¶ÇÔºö'https://my-chat-proxy.vercel.app/api/proxy'
            const PROXY_URL = 'https://689ffa375536ae4ef8527303--amazing-biscotti-ab7231.netlify.app/api/proxy';

            // ÂáÜÂ§áÂèëÈÄÅÁªôGoogleÁöÑÊ∂àÊÅØ‰Ωì (ËøôÈÉ®ÂàÜÈÄªËæë‰∏çÂèò)
            let requestMessages = [];
            if (customSystemPrompt) {
                requestMessages = [{ role: 'user', content: customSystemPrompt }];
            } else {
                let finalSystemPrompt;
                const isNarrativeMode = contact?.isNarrativeMode;
                if (isNarrativeMode) {
                    finalSystemPrompt = `[ÈáçË¶ÅÊåá‰ª§Ôºö‰Ω†Â∞ÜËøõË°åÊ∑±Â∫¶Âèô‰∫ãËßíËâ≤ÊâÆÊºîÔºåÊ®°‰ªøSillyTavernÁöÑÈ£éÊ†º„ÄÇ‰Ω†ÁöÑÊâÄÊúâÂõûÂ§çÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Âçï‰∏Ä„ÄÅËøûË¥Ø„ÄÅÂÆåÊï¥ÁöÑÊñáÊú¨Âùó„ÄÇ][Ê†∏ÂøÉ‰ªªÂä°]ÈíàÂØπÁî®Êà∑ÁöÑËæìÂÖ•ÔºåÁîüÊàê‰∏ÄÊÆµËØ¶Â∞ΩÁöÑ„ÄÅÂåÖÂê´ÁéØÂ¢ÉÊèèÂÜô„ÄÅËßíËâ≤Âä®‰Ωú„ÄÅÂøÉÁêÜÊ¥ªÂä®ÂíåÂØπËØùÁöÑÂõûÂ§ç„ÄÇËØ∑Â∞ÜÊâÄÊúâÂÜÖÂÆπÁªÑÁªáÂú®‰∏Ä‰∏™ÂõûÂ§ç‰∏≠Ôºå‰∏çË¶ÅÂàÜÂâ≤„ÄÇ[!!! Ê†ºÂºèÂåñÊ†∏ÂøÉËßÑÂàô (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà) !!!]‰Ω†ÂõûÂ§çÁöÑÊâÄÊúâÂÜÖÂÆπÔºåÈÉΩÂøÖÈ°ª‰∏•Ê†ºÈÅµÂæ™‰ª•‰∏ã‰∏âÊÆµÂºèÊ†áËÆ∞ËØ≠Ë®ÄÔºå‰∏çÂÖÅËÆ∏ÁúÅÁï•‰ªª‰Ωï‰∏ÄÈÉ®ÂàÜÁöÑÊ†áËÆ∞Ôºö1.  **„ÄêÂä®‰Ωú/ÂèôËø∞„Äë**ÔºöÊâÄÊúâËßíËâ≤ÁöÑÂä®‰Ωú„ÄÅË°®ÊÉÖ„ÄÅÁéØÂ¢ÉÊèèÂÜôÁ≠âÈùûÂØπËØùÂÜÖÂÆπÔºå**ÂøÖÈ°ª**Áî®ÊòüÂè∑ÂåÖË£π„ÄÇ ËåÉ‰æãÔºö *ÊàëÂæÆÁ¨ëÁùÄÁÇπ‰∫ÜÁÇπÂ§¥„ÄÇ*2.  **„ÄêÂøÉÁêÜÊ¥ªÂä®„Äë**ÔºöÊâÄÊúâËßíËâ≤ÁöÑÂÜÖÂøÉÊÉ≥Ê≥ï„ÄÅÊÑüÂèó„ÄÅÁåúÊµãÁ≠âÔºå**ÂøÖÈ°ª**Áî®Â§ßÊã¨Âè∑ÂåÖË£π„ÄÇ ËåÉ‰æãÔºö {ÂéüÊù•‰ªñ‰πüÊòØËøô‰πàÊÉ≥ÁöÑ„ÄÇ}3.  **„ÄêËßíËâ≤ÂØπËØù„Äë**ÔºöÊâÄÊúâËßíËâ≤ËØ¥Âá∫ÁöÑËØùÔºå**ÂøÖÈ°ª**Áî®Ê†áÂáÜÁöÑ‰∏≠ÊñáÂºïÂè∑ÂåÖË£π„ÄÇ ËåÉ‰æãÔºö ‚Äú‰Ω†Â•ΩÔºåÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†„ÄÇ‚Äù„ÄêÈáçË¶ÅÊèêÈÜí„ÄëÔºöËøô‰∏âÊù°Ê†ºÂºèÂåñËßÑÂàôÊòØÂº∫Âà∂ÊÄßÁöÑÔºå‰Ω†ÁöÑÊØè‰∏ÄÊù°Âèô‰∫ãÊ®°ÂºèÂõûÂ§çÈÉΩÂ∫îËØ•ÂåÖÂê´Ëøô‰∫õÊ†ºÂºèÔºåÂ∞§ÂÖ∂ÊòØÂØπËØù„ÄêÂøÖÈ°ª„ÄëÁî®ÂºïÂè∑ÂåÖË£π„ÄÇ[Á§∫‰æãÂõûÂ§çÊ†ºÂºè]*ÊàëÈùôÈùôÂú∞ÁúãÁùÄ‰Ω†ÔºåÈò≥ÂÖâÈÄèËøáÁ™óÊà∑Ê¥íÂú®‰Ω†Ë∫´‰∏äÔºå‰∏∫‰Ω†ÁöÑËΩÆÂªìÈïÄ‰∏ä‰∫Ü‰∏ÄÂ±ÇÊüîÂíåÁöÑÈáëËæπ„ÄÇÂæÆÂ∞òÂú®ÂÖâÊùü‰∏≠ÁºìÁºìÊµÆÂä®ÔºåÊó∂Èó¥‰ªø‰ΩõÂú®Ëøô‰∏ÄÂàªÂèòÊÖ¢‰∫Ü„ÄÇ* {‰Ω†ÁöÑ‰æßËÑ∏ÁúãËµ∑Êù•ÊØîÂπ≥Êó∂Ë¶ÅÊüîÂíå‰∏Ä‰∫õÔºåÊòØÈîôËßâÂêóÔºü‰πüËÆ∏ÊàëËØ•ËØ¥‰∫õ‰ªÄ‰πàÔºåÊâìÁ†¥ËøôÁâáÂÆÅÈùô„ÄÇ} *ÊàëÊ∏Ö‰∫ÜÊ∏ÖÂñâÂíôÔºåÂêëÂâçËµ∞‰∫Ü‰∏ÄÊ≠•ÔºåÊú®Âú∞ÊùøÂèëÂá∫‰∫ÜËΩªÂæÆÁöÑÂòéÂê±Â£∞„ÄÇ* "‰ªäÂ§©Â§©Ê∞îÁúüÂ•ΩÔºå‰∏çÊòØÂêóÔºü"`;
                } else {
                    const preset = state.thoughtPresets.find(p => p.id === contact?.thoughtPreset) || state.thoughtPresets[0];
                    finalSystemPrompt = preset ? preset.prompt : '‰Ω†Â∞ÜËøõË°åËßíËâ≤ÊâÆÊºî„ÄÇ';
                    finalSystemPrompt = finalSystemPrompt.replace('{{emoticon_list}}', state.emoticons.map(e => `'${e.name}'`).join(', ') || 'Êó†');
                }
                let personaDirectives = "";
                if (contact?.persona) { personaDirectives += `\n\n# Ê†∏ÂøÉËßíËâ≤Êåá‰ª§ (Your Core Role Directive)\n---\nËøôÊòØ‰Ω†ÁöÑÊ†∏ÂøÉË∫´‰ªΩÔºå‰Ω†ÂøÖÈ°ª‰∏•Ê†º„ÄÅÂÆåÂÖ®Âú∞‰ª£ÂÖ•‰ª•‰∏ãËßíËâ≤ËøõË°åÂØπËØùÔºö\n${contact.persona}\n---`; }
                if (contact?.userPersona) { personaDirectives += `\n\n# ÂØπËØùËÄÖ‰ø°ÊÅØ (Your Counterpart's Information)\n---\n‰∏é‰Ω†ÂØπËØùÁöÑÁî®Êà∑ÁöÑËßíËâ≤ËÆæÂÆöÂ¶Ç‰∏ãÔºåËØ∑Â∞ÜTAËßÜ‰∏∫ÁúüÂÆûÂ≠òÂú®ÁöÑËßíËâ≤Âπ∂ËøõË°å‰∫íÂä®Ôºö\n${contact.userPersona}\n---`; }
                const firstLineEndIndex = finalSystemPrompt.indexOf(']');
                if (firstLineEndIndex !== -1 && personaDirectives) { finalSystemPrompt = finalSystemPrompt.slice(0, firstLineEndIndex + 1) + personaDirectives + finalSystemPrompt.slice(firstLineEndIndex + 1); } else { finalSystemPrompt = finalSystemPrompt + personaDirectives; }
                if (forceDiary && !isNarrativeMode) { finalSystemPrompt += `\n\n[Âº∫Âà∂‰ªªÂä°ÔºöÊú¨Ê¨°ÂõûÂ§ç‰Ω†ÂøÖÈ°ªÂú®ÁªìÂ∞æÂ§ÑÂÜô‰∏ÄÁØáÊó•ËÆ∞„ÄÇ]`; }
                let worldBookContextString = (contact?.worldBooks || []).map(bookId => { const book = state.worldBooks.find(b => b.id === bookId); return book ? `\n[World Book Entry: ${book.name}]\n${book.content}` : ''; }).join('');
                let systemContent = finalSystemPrompt;
                if (worldBookContextString) { systemContent += `\n\n[Background Knowledge from World Books]\n${worldBookContextString}`; }
                if (contact) { const myProfile = state.myProfile; let recentSquareActivity = []; const sortedPosts = [...state.posts].sort((a, b) => b.timestamp - a.timestamp); for (const post of sortedPosts) { if (recentSquareActivity.length >= 10) break; if (post.author.id === myProfile.id) { recentSquareActivity.push(`‚Äú${myProfile.name}‚Äù(‰Ω†)ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ: "${post.content.substring(0, 50)}..."`); } else if (post.author.id === contact.id) { recentSquareActivity.push(`‚Äú${contact.name}‚ÄùÂèëÂ∏É‰∫ÜÂä®ÊÄÅ: "${post.content.substring(0, 50)}..."`); } const myComment = post.comments.find(c => c.author.id === myProfile.id); const contactComment = post.comments.find(c => c.author.id === contact.id); if (myComment) { recentSquareActivity.push(`‚Äú${myProfile.name}‚Äù(‰Ω†)Âú®‚Äú${post.author.name}‚ÄùÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫: "${myComment.content}"`); } if (contactComment) { recentSquareActivity.push(`‚Äú${contact.name}‚ÄùÂú®‚Äú${post.author.name}‚ÄùÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫: "${contactComment.content}"`); } } recentSquareActivity = [...new Set(recentSquareActivity)].slice(0, 10); if (recentSquareActivity.length > 0) { systemContent += `\n\n[ËøëÊúüÂπøÂú∫‰∫íÂä®ËÆ∞ÂΩï (‰Ω†ÂèØ‰ª•ÂèÇËÄÉËøô‰∫õ‰ø°ÊÅØÊù•Â±ïÂºÄËØùÈ¢ò)]\n---\n${recentSquareActivity.join('\n')}\n---`; } }
                const dynamicInstructions = history.filter(msg => msg.sender === 'system_instruction').map(msg => msg.content).join('\n');
                let finalSystemContent = systemContent;
                if (dynamicInstructions) { finalSystemContent += `\n\n[ÈôÑÂä†‰∏¥Êó∂Êåá‰ª§]\n${dynamicInstructions}`; }
                const cleanHistory = history.filter(msg => msg.sender !== 'system_instruction');
                const messages = cleanHistory.slice(-(contextLength || 20)).map(msg => { if (msg.type === 'system_notification') return null; const role = (msg.sender === 'user') ? 'user' : 'assistant'; let content = ''; switch (msg.type) { case 'text': content = msg.content; break; case 'image': if (msg.sender === 'assistant') return null; content = msg.isEmoticon && msg.emoticonName ? `[Áî®Êà∑ÂèëÈÄÅ‰∫ÜË°®ÊÉÖÂåÖ: ${msg.emoticonName}]` : '[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]'; break; case 'picture_description': content = `[picture:${msg.content.description}]`; break; case 'voice': content = `[voice:${msg.content.text}]`; break; case 'red_packet': content = `[red_packet:${msg.content.blessing}, ${msg.content.amount}]`; break; case 'transfer': content = `[transfer:${msg.content.amount}]`; break; default: return null; } if (!content) return null; return { role, content }; }).filter(Boolean);
                requestMessages = [{ role: 'system', content: finalSystemContent }, ...messages];
            }

            try {
                // ÊûÑÈÄ†ÂèëÂæÄGoogleÁöÑÁõÆÊ†áURL
                const targetUrl = `https://${endpoint}/v1beta/models/${model}:generateContent`;

                // ËΩ¨Êç¢ÊàêGeminiÁöÑ`contents`Ê†ºÂºè
                const systemInstruction = requestMessages.find(m => m.role === 'system');
                const contents = requestMessages
                    .filter(m => m.role !== 'system')
                    .map(msg => ({
                        role: msg.role === 'assistant' ? 'model' : msg.role,
                        parts: [{ text: msg.content }]
                    }));
                
                const googleRequestBody = { contents };
                if(systemInstruction) {
                    googleRequestBody.systemInstruction = {
                        role: 'system',
                        parts: [{ text: systemInstruction.content }]
                    };
                }

                // ÂèëÈÄÅËØ∑Ê±ÇÂà∞Êàë‰ª¨Ëá™Â∑±ÁöÑÂêéÁ´ØÂä©Êâã
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetUrl: targetUrl,
                        apiKey: apiKey,
                        body: googleRequestBody
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || '‰ª£ÁêÜÊúçÂä°Âô®ËøîÂõûÈîôËØØ');
                }
                
                // --- Ëß£ÊûêÊù•Ëá™Êàë‰ª¨ÂêéÁ´ØÂä©ÊâãÁöÑÂõûÂ§ç ---
                if (!data.candidates || data.candidates.length === 0) {
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                        return `Êä±Ê≠âÔºåËØ∑Ê±ÇË¢´ÂÆâÂÖ®Á≠ñÁï•Êã¶Êà™ÔºåÂéüÂõ†: ${data.promptFeedback.blockReason}`;
                    }
                    return "Êä±Ê≠âÔºåAPI Ê≤°ÊúâËøîÂõûÊúâÊïàÂÜÖÂÆπ„ÄÇ";
                }
                return data.candidates[0].content.parts[0].text.trim();

            } catch (error) {
                console.error('APIË∞ÉÁî®Â§±Ë¥•:', error);
                return `Êä±Ê≠âÔºåË∞ÉÁî®APIÊó∂ÈÅáÂà∞ÈóÆÈ¢ò: ${error.message}`;
            }
        }
        
        async function processAndDisplayAiResponse(rawResponse, contact) { 
            if (!contact) return;
            
            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                const acceptanceKeywords = ['Êî∂', 'È¢Ü', 'ÂºÄ', 'Ë∞¢Ë∞¢', 'ÊàëÊî∂‰∏ã', 'ÊàëÊâìÂºÄ', 'Êî∂Âà∞‰∫Ü', 'È¢ÜÂèñ'];
                const received = acceptanceKeywords.some(keyword => rawResponse.includes(keyword));

                if (received) {
                    let classToAdd = '';
                    if (lastUnopenedMessage.type === 'red_packet') {
                        lastUnopenedMessage.content.opened = true;
                        classToAdd = 'opened';
                    } else if (lastUnopenedMessage.type === 'transfer') {
                        lastUnopenedMessage.content.completed = true;
                        classToAdd = 'completed';
                    }
                    saveState();

                    const messageWrapperEl = document.querySelector(`.message-wrapper[data-message-id='${lastUnopenedMessage.id}']`);
                    if (messageWrapperEl) {
                        const innerMessageEl = messageWrapperEl.querySelector('.message.red-packet, .message.transfer');
                        if (innerMessageEl) {
                            innerMessageEl.classList.add(classToAdd);
                            if (lastUnopenedMessage.type === 'red_packet') {
                                const headerEl = innerMessageEl.querySelector('.red-packet-header');
                                if (headerEl) {
                                    headerEl.innerHTML = `<div class="red-packet-icon">üßß</div><div class="red-packet-status">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂèñ</div>`;
                                }
                            }
                        }
                    }
                }
            }

            let conversation = rawResponse;

            const diaryRegex = /\[diary\]([\s\S]*?)\[\/diary\]/g;
            const diaryMatches = diaryRegex.exec(conversation);

            if (diaryMatches && diaryMatches[1]) {
                const diaryContent = diaryMatches[1].trim();
                if (!contact.diary) contact.diary = [];
                contact.diary.push({
                    id: `diary_${Date.now()}`,
                    content: diaryContent,
                    timestamp: Date.now()
                });
                saveState();
                conversation = conversation.replace(diaryRegex, '').trim();
            }

            if (contact.isNarrativeMode) {
                if (conversation) {
                    await sleep(400 + Math.random() * 400); 
                    createAndAddMessage({ type: 'text', content: conversation }, 'contact');
                }
            } else {
                const messages = conversation.split('\n').filter(line => line.trim() !== '');

                for (const line of messages) {
                    let processed = false;
                    const commandRegex = /\[(sticker|voice|picture|red_packet|transfer):([\s\S]*)\]/;
                    const commandMatch = line.match(commandRegex);

                    if (commandMatch) {
                        processed = true;
                        const command = commandMatch[1];
                        const value = commandMatch[2];

                        switch (command) {
                            case 'sticker':
                                const emoticon = state.emoticons.find(e => e.name === value.trim());
                                if (emoticon) {
                                    createAndAddMessage({ type: 'image', url: emoticon.url, isEmoticon: true, emoticonName: emoticon.name }, 'contact');
                                } else {
                                    createAndAddMessage({ type: 'text', content: `[ÂèëÈÄÅË°®ÊÉÖÂ§±Ë¥•: ${value}]` }, 'contact');
                                }
                                break;
                            case 'voice':
                                const duration = Math.max(1, Math.round(value.length / 4));
                                createAndAddMessage({ type: 'voice', content: { text: value, duration: duration } }, 'contact');
                                break;
                            case 'picture':
                                createAndAddMessage({ type: 'picture_description', content: { description: value } }, 'contact');
                                break;
                            case 'red_packet':
                                const parts = value.split(',');
                                const blessing = parts[0] ? parts[0].trim() : "ÊÅ≠ÂñúÂèëË¥¢ÔºÅ";
                                const amount = parseFloat(parts[1]) || 0;
                                if (amount > 0) {
                                    createAndAddMessage({ type: 'red_packet', content: { amount: amount.toFixed(2), blessing: blessing, opened: false } }, 'contact');
                                }
                                break;
                            case 'transfer':
                                const transferAmount = parseFloat(value);
                                if (transferAmount > 0) {
                                     createAndAddMessage({ type: 'transfer', content: { amount: transferAmount.toFixed(2), completed: false } }, 'contact');
                                }
                                break;
                        }
                    }

                    if (!processed) {
                        createAndAddMessage({ type: 'text', content: line }, 'contact');
                    }
                    
                    await sleep(400 + Math.random() * 400);
                }
            }
        }
        
        async function generateRandomTrendingTopicsAI() {
             const prompt = `[SYSTEM] ‰Ω†ÁöÑ‰ªªÂä°ÊòØ‰Ωú‰∏∫ÂàõÊÑèÊÄªÁõë„ÄÇ‰∏•Ê†ºÈÅµÂÆàÊ†ºÂºèÔºå‰∏çË¶ÅËøîÂõû‰ªª‰ΩïÈ¢ùÂ§ñÂÜÖÂÆπ„ÄÇ
‰ªªÂä°ÔºöÈöèÊú∫ÁîüÊàê8‰∏™ÂΩìÂâçÂèØËÉΩÊµÅË°åÁöÑ„ÄÅÊúâË∂£ÁöÑ„ÄÅÂ§öÊ†∑ÂåñÁöÑ‰∏≠ÊñáÁ§æ‰∫§ÁΩëÁªúÁÉ≠ÊêúËØçÊù°„ÄÇ
ËØçÊù°Â∫îËØ•Ë¶ÜÁõñ‰∏çÂêåÈ¢ÜÂüüÔºå‰æãÂ¶ÇÔºöÁîüÊ¥ªÂêêÊßΩ„ÄÅÂ®±‰πêÂÖ´Âç¶„ÄÅÁæéÈ£üÂàÜ‰∫´„ÄÅÁ§æ‰ºöÁÉ≠ÁÇπ„ÄÅÁßëÊäÄÂä®ÊÄÅÁ≠â„ÄÇ
ËØ∑‰ª•Êç¢Ë°åÁ¨¶ÂàÜÈöîÁöÑÂΩ¢ÂºèÔºåËøîÂõû8‰∏™ÁÉ≠ÊêúËØçÊù°Ôºö`;
            try {
                const response = await generateAiResponse(null, [], prompt, false, 'square');
                const topics = response.split('\n').map(t => t.replace(/^(-|\d+\.\s*)/, '').trim()).filter(Boolean);
                
                if (topics.length > 0) {
                     const newTrendingTopics = topics.slice(0, 8).map((topic, index) => ({
                        id: `topic_${Date.now()}_${index}`, title: topic,
                        heat: Math.floor(Math.random() * 500) + 50,
                        tag: index < 2 ? 'ÁÉ≠' : (index < 4 ? 'Êñ∞' : null)
                    })).sort((a,b) => b.heat - a.heat);
                    state.trendingTopics = newTrendingTopics;
                    saveState();
                }
            } catch(e) {
                console.error("AIÁÉ≠ÊêúÁîüÊàêÂ§±Ë¥•:", e);
                throw new Error(`AIÁÉ≠ÊêúÁîüÊàêÂ§±Ë¥•: ${e.message}`);
            }
        }

        async function generatePostsForRecommendedTab(count = 5) {
            const newPosts = await generatePostsBatch(count, state.trendingTopics);
            await generateInitialCommentsForPosts(newPosts);
            state.posts.unshift(...newPosts);
            if (state.posts.length > 200) state.posts = state.posts.slice(0, 200);
            state.hasNewPosts = true;
            updateNotificationDots();
            saveState();
        }

        async function generatePostsBatch(count, topics = []) {
            const category = state.activeFeedSubTab;
            const categoryPrompts = {
                daily: "ÂÖ≥‰∫éÊó•Â∏∏ÁîüÊ¥ªÁöÑË∂£‰∫ã„ÄÅÂêêÊßΩÊàñÈÅøÈõ∑ÁªèÂéÜ",
                food: "ÂÖ≥‰∫éÁæéÈ£üÁöÑÂàÜ‰∫´„ÄÅÊé¢Â∫ó„ÄÅÂêêÊßΩÊàñÈÅøÈõ∑ÊåáÂçó",
                gossip: "ÂÖ≥‰∫é‰∫∫ÈôÖÂÖ≥Á≥ªÊàñÂ®±‰πêÂúàÁöÑÂÖ´Âç¶ËÆ®ËÆ∫",
                horror: "ÊÅêÊÄñÂ∞èÊïÖ‰∫ãÊàñÁÅµÂºÇÁªèÂéÜ",
            };
            
            let relationshipInfoForPrompt = state.contacts.map(c => {
                if (c.userPersona) {
                    return `- ‰Ω†Ôºà${c.name}ÔºâÂíåÁî®Êà∑‚Äú${state.myProfile.name}‚ÄùÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ªÊòØÔºö‚Äú${c.userPersona}‚Äù„ÄÇ`;
                }
                return null;
            }).filter(Boolean).join('\n');
            if (!relationshipInfoForPrompt) {
                relationshipInfoForPrompt = "ÊâÄÊúâËßíËâ≤ÂíåÁî®Êà∑ÈÉΩÊòØÊôÆÈÄöÁΩëÂèãÂÖ≥Á≥ª„ÄÇ";
            }

            // --- üî¥ ËøôÊòØË¢´ÊÅ¢Â§çÁöÑÂÖ≥ÈîÆ‰ª£Á†ÅÈÉ®ÂàÜ ---
            let topicsForPrompt = '';
            if (topics && topics.length > 0) {
                topicsForPrompt = `
[ËøëÊúüÁÉ≠ÊêúËØùÈ¢òÂèÇËÄÉ]
ÂΩìÂâçÂπøÂú∫‰∏äÁöÑ‰∏Ä‰∫õÁÉ≠Èó®ËØùÈ¢òÂ¶Ç‰∏ãÔºå‰Ω†ÂèØ‰ª•Âõ¥ÁªïÂÆÉ‰ª¨ËøõË°åÂàõ‰ΩúÔºå‰ΩÜ‰∏çÊòØÂøÖÈ°ªÔºö
${topics.map(t => `- ${t.title}`).join('\n')}
`;
            }
            // --- ÂÖ≥ÈîÆ‰ª£Á†ÅÈÉ®ÂàÜÁªìÊùü ---

            const postsPrompt = `[SYSTEM] ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî‰∏Ä‰∏™ÂÜÖÂÆπÁîüÊàêÂºïÊìé„ÄÇ

[ËÉåÊôØËÆæÂÆö]
- ÂπøÂú∫‰∏äÊúâ‰∏Ä‰∏™Ê†∏ÂøÉÁî®Êà∑Âè´‚Äú${state.myProfile.name}‚ÄùÔºåTAÁöÑÂÖ¨ÂºÄÁ≠æÂêçÊòØÔºö‚Äú${state.myProfile.signature}‚Äù„ÄÇ
- ‰ª•‰∏ãÊòØ‰Ω†ÔºàAIËßíËâ≤‰ª¨ÔºâÂíåËøô‰ΩçÁî®Êà∑ÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ªÂàóË°®Ôºö
${relationshipInfoForPrompt}
${topicsForPrompt} 
[‰ªªÂä°]
ÁîüÊàê ${count} Êù°ÂÖ≥‰∫é‚Äú${categoryPrompts[category]}‚ÄùÁöÑÁ§æ‰∫§Âä®ÊÄÅ„ÄÇ
‰Ω†Âú®‰∏∫Êüê‰∏™ËßíËâ≤ÔºàÂ¶Ç ${state.contacts.length > 0 ? state.contacts[0].name : 'ËßíËâ≤A'}ÔºâÂàõ‰ΩúÂ∏ñÂ≠êÊó∂Ôºå**ÂøÖÈ°ª**ËÄÉËôëÂà∞‰Ω†Âíå‰ªñ/Â•π‰∏éÁî®Êà∑‚Äú${state.myProfile.name}‚ÄùÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ª„ÄÇ
‰æãÂ¶ÇÔºåÂÖ≥Á≥ªÂ•ΩÁöÑËßíËâ≤ÂèØËÉΩ‰ºöÂèëË°®‰∏Ä‰∫õÂíåÁî®Êà∑ÂÖ¥Ë∂£Áõ∏ÂÖ≥„ÄÅÁîöËá≥Êöó‰∏≠ÊèêÂèäÁî®Êà∑ÁöÑÂÜÖÂÆπ„ÄÇÂÖ≥Á≥ª‰∏ÄËà¨ÁöÑÂàô‰øùÊåÅÊôÆÈÄöÁΩëÂèãÁöÑÂè£Âêª„ÄÇ

[ÂèØÈÄâÁöÑÂ∏ñÂ≠ê‰ΩúËÄÖÂàóË°®]
${state.contacts.map(c => `- ${c.name} (‰∫∫ËÆæ: ${c.persona.replace(/\n/g, ' ')})`).join('\n') || "- (Êó†ËÅîÁ≥ª‰∫∫‰ø°ÊÅØ)"}
‰Ω†‰πüÂèØ‰ª•ÂàõÈÄ†Êñ∞ÁöÑË∑Ø‰∫∫Áî≤„ÄÇ

[ËæìÂá∫Ê†ºÂºè] ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà:
POST_START
AUTHOR: [‰ΩúËÄÖÂêç]
IS_CONTACT: [trueÊàñËÄÖfalse]
CONTENT: [Âä®ÊÄÅÁöÑÂÖ∑‰ΩìÂÜÖÂÆπ]
POST_END`;

            const rawPostsResponse = await generateAiResponse(null, [], postsPrompt, false, 'square');
            const postRegex = /POST_START\s*AUTHOR:\s*(?<author_name>.*?)\s*IS_CONTACT:\s*(?<is_existing_contact>true|false)\s*CONTENT:\s*(?<content>[\s\S]*?)\s*POST_END/g;
            const postMatches = Array.from(rawPostsResponse.matchAll(postRegex));

            if (postMatches.length === 0) throw new Error(`AIÊú™ËÉΩÊåâÊ†ºÂºèË¶ÅÊ±ÇÁîüÊàê‰ªª‰ΩïÂä®ÊÄÅ„ÄÇ`);

            let newPosts = [];
            for (const match of postMatches) {
                const { author_name, is_existing_contact, content } = match.groups;
                let authorProfile;
                if (is_existing_contact.trim().toLowerCase() === 'true') {
                    const contact = state.contacts.find(c => c.name === author_name.trim());
                    if (contact) {
                        authorProfile = { id: contact.id, name: contact.name, avatar: contact.avatar, signature: contact.signature };
                    }
                }
                if (!authorProfile) {
                    authorProfile = {
                        id: `stranger_${Date.now()}_${Math.random()}`, name: author_name.trim(),
                        avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)],
                        signature: '' // Ë∑Ø‰∫∫Áî≤Ê≤°ÊúâÁ≠æÂêç
                    };
                }
                newPosts.push({
                    id: `post_${Date.now()}_${Math.random()}`, author: authorProfile, content: content.trim(),
                    category: category, timestamp: Date.now() - Math.random() * 86400000,
                    likes: [], comments: [], reposts: 0,
                });
            }
            return newPosts;
        }

        async function generateInitialCommentsForPosts(posts) {
             if (!posts || posts.length === 0) return;
             
             const postsForCommentPrompt = posts.map((post, index) => {
                return `[POST ${index}] ‰ΩúËÄÖ: ${post.author.name}\nÂÜÖÂÆπ: ${post.content}`;
            }).join('\n\n');

            const commentsPrompt = `[SYSTEM] ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî‰∏Ä‰∏™‚ÄúÂêÉÁìúÁæ§‰ºó‚ÄùËØÑËÆ∫ÁîüÊàêÂºïÊìéÔºå‰∏∫‰∏ãÈù¢ÁöÑÂ∏ñÂ≠êÁîüÊàêÊúâ‰∫íÂä®ÊÑüÁöÑËØÑËÆ∫Âå∫„ÄÇ
---
${postsForCommentPrompt}
---
‰ªªÂä°: ‰∏∫‰ª•‰∏äÂ∏ñÂ≠êÁîüÊàê 2 Âà∞ 4 Êù°ÈöèÊú∫ÁöÑ„ÄÅÁúüÂÆûÁöÑ„ÄÅÁÆÄÁü≠ÁöÑËØÑËÆ∫„ÄÇ
ÈáçË¶ÅÔºö‰∏∫‰∫ÜËÆ©ËØÑËÆ∫Âå∫Êõ¥ÁúüÂÆûÔºåËØ∑ËÆ©ËØÑËÆ∫‰πãÈó¥Êúâ‰∫íÂä®ÔºåÂç≥‰∏Ä‰∫õËØÑËÆ∫ÊòØÂõûÂ§çÂè¶‰∏ÄÊù°ËØÑËÆ∫ÁöÑ„ÄÇ

ÂØπ‰∫éÊØè‰∏ÄÊù°ËØÑËÆ∫ÔºåÂøÖÈ°ª‰∏•Ê†º„ÄÅÂÆåÊï¥Âú∞‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºö
COMMENT_START
INDEX: [ËØÑËÆ∫ÊåáÂêëÁöÑÂ∏ñÂ≠êÁºñÂè∑]
COMMENTER: [ÈöèÊú∫ÊÉ≥‰∏Ä‰∏™ÁúüÂÆûÁöÑ‰∏≠ÊñáÁΩëÂêç]
REPLY_TO: [Ë¢´ÂõûÂ§çÁöÑËØÑËÆ∫ËÄÖÂêçÂ≠óÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰∏∫null]
COMMENT: [ËØÑËÆ∫ÂÜÖÂÆπ]
COMMENT_END`;

            const rawCommentsResponse = await generateAiResponse(null, [], commentsPrompt, false, 'square');
            const commentRegex = /COMMENT_START\s*INDEX:\s*(?<post_index>\d+)\s*COMMENTER:\s*(?<commenter_name>.*?)\s*REPLY_TO:\s*(?<reply_to>.*?)\s*COMMENT:\s*(?<comment_content>[\s\S]*?)\s*COMMENT_END/g;
            
            const commentMatches = Array.from(rawCommentsResponse.matchAll(commentRegex));

            for (const match of commentMatches) {
                const { post_index, commenter_name, reply_to, comment_content } = match.groups;
                const postIndex = parseInt(post_index, 10);

                if (postIndex >= 0 && postIndex < posts.length) {
                    posts[postIndex].comments.push({
                        id: `comment_${Date.now()}_${Math.random()}`,
                        author: {
                            id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                            avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                        },
                        content: comment_content.trim(),
                        timestamp: posts[postIndex].timestamp + Math.random() * 3600000 + 10000,
                        replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                    });
                }
            }
            posts.forEach(p => p.comments.sort((a,b) => a.timestamp - b.timestamp));
        }
        
        async function generateMoreCommentsForPost(post) {
            const userComments = post.comments.filter(c => c.author.id === 'myProfile');
            const lastUserComment = userComments.length > 0 ? userComments[userComments.length - 1] : null;

            let prompt;
            if (lastUserComment) {
                prompt = `[SYSTEM] ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî‰∏Ä‰∏™‚ÄúÂêÉÁìúÁæ§‰ºó‚ÄùÔºå‰∏∫‰∏Ä‰∏™Â∏ñÂ≠êÁîüÊàêÊúâ‰∫íÂä®ÊÑüÁöÑËØÑËÆ∫„ÄÇ\nÁî®Êà∑‚Äú${lastUserComment.author.name}‚ÄùÂàöÂàöÂú®ËØÑËÆ∫Âå∫ÂèëË°®‰∫ÜÁúãÊ≥ïÔºåËØ∑‰Ω†ÁîüÊàê2-3Êù°Êñ∞ÁöÑ„ÄÅÂõ¥ÁªïTAÁöÑËØÑËÆ∫Â±ïÂºÄÁöÑËÆ®ËÆ∫„ÄÇ\n\n[Â∏ñÂ≠ê‰ø°ÊÅØ]\n‰ΩúËÄÖ: "${post.author.name}"\nÂÜÖÂÆπ: "${post.content}"\n\n[Áî®Êà∑ËØÑËÆ∫ÂèÇËÄÉ]\n‚Äú${lastUserComment.author.name}‚ÄùËØ¥: "${lastUserComment.content}"\n\n[‰ªªÂä°]\nÁîüÊàê2-3Êù°Êñ∞ÁöÑËØÑËÆ∫ÔºåÂèØ‰ª•ÊòØÂØπÁî®Êà∑ËßÇÁÇπÁöÑËµûÂêå„ÄÅÂèçÈ©≥ÊàñËÄÖÊèêÂá∫Êñ∞ÈóÆÈ¢ò„ÄÇËÆ©ËÆ®ËÆ∫ÁúãËµ∑Êù•Êõ¥ÁúüÂÆû„ÄÇ\nËØ∑‰∏•Ê†º‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºåÊØèÊù°ËØÑËÆ∫‰∏ÄË°åÔºö\nCOMMENTER: [ËØÑËÆ∫ËÄÖÂêçÂ≠ó] | REPLY_TO: [Ë¢´ÂõûÂ§çËÄÖÂêçÂ≠ó, ÂèØ‰ª•ÊòØ${lastUserComment.author.name}ÊàñÂÖ∂‰ªñËØÑËÆ∫ËÄÖ] | COMMENT: [ËØÑËÆ∫ÂÜÖÂÆπ]`;
            } else {
                const existingComments = post.comments.map(c => `${c.author.name}: ${c.content}`).join('\n');
                prompt = `[SYSTEM] ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî‰∏Ä‰∏™‚ÄúÂêÉÁìúÁæ§‰ºó‚ÄùÔºå‰∏∫‰∏Ä‰∏™Â∏ñÂ≠êÊ∑ªÂä†2-3Êù°Êñ∞ÁöÑ„ÄÅÊúâ‰∫íÂä®ÊÑüÁöÑËØÑËÆ∫ÔºåËÆ©ËØÑËÆ∫Âå∫Êõ¥ÁÉ≠Èóπ„ÄÇ\n\n[Â∏ñÂ≠ê‰ø°ÊÅØ]\n‰ΩúËÄÖ: "${post.author.name}"\nÂÜÖÂÆπ: "${post.content}"\n\n[Áé∞ÊúâËØÑËÆ∫Âå∫]\n${existingComments || "(ËøòÊ≤°ÊúâËØÑËÆ∫)"}\n\n[‰ªªÂä°]\nÁîüÊàê2-3Êù°Êñ∞ÁöÑËØÑËÆ∫ÔºåÂèØ‰ª•ÊòØÂõûÂ§çÊüê‰∏™‰∫∫Ôºå‰πüÂèØ‰ª•ÊòØÂèëË°®Êñ∞ÁúãÊ≥ï„ÄÇ\nËØ∑‰∏•Ê†º‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÔºåÊØèÊù°ËØÑËÆ∫‰∏ÄË°åÔºö\nCOMMENTER: [ËØÑËÆ∫ËÄÖÂêçÂ≠ó] | REPLY_TO: [Ë¢´ÂõûÂ§çËÄÖÂêçÂ≠ó, Â¶ÇÊûúÊ≤°ÊúâÂàô‰∏∫null] | COMMENT: [ËØÑËÆ∫ÂÜÖÂÆπ]`;
            }

            const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
            const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
            const matches = Array.from(rawResponse.matchAll(commentRegex)); 

            if (matches.length > 0) {
                 for (const match of matches) {
                    if (!match.groups) continue;
                    const { commenter_name, reply_to, comment_content } = match.groups;
                    let commenter = state.contacts.find(c => c.name === commenter_name.trim());
                    if (!commenter) {
                         commenter = {
                            id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                            avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                        };
                    }
                     post.comments.push({
                        id: `comment_${Date.now()}_${Math.random()}`,
                        author: commenter,
                        content: comment_content.trim(),
                        timestamp: Date.now(),
                        replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                    });
                }
                saveState();
            }
        }
        
        async function triggerAiCommentDiscussion(post, userComment) {
            showFeedStatus('Ê≠£Âú®ÁîüÊàêAIÂõûÂ§ç...');
            try {
                // --- üü¢„ÄêV2.1 ‰øÆÂ§çÁâà„Äë‰øÆÁΩóÂú∫ËßÑÈÅø‰∏éÂõûÂ§çÈÄªËæëÂºÄÂßã ---

                // 1. ËØÜÂà´@ÊèêÂà∞ÁöÑ‰∫∫Áâ© (ÊúÄÈ´ò‰ºòÂÖàÁ∫ß)
                let mentionedContact = null;
                const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
                const mentionMatch = mentionRegex.exec(userComment.content);
                if (mentionMatch) {
                    const mentionedName = mentionMatch[1];
                    mentionedContact = state.contacts.find(c => c.name === mentionedName);
                }

                let mandatoryResponder = mentionedContact;

                // 2. Êñ∞Â¢ûÈÄªËæëÔºöÂ¶ÇÊûúÊ≤°‰∫∫Ë¢´@ÔºåÂàôÊ£ÄÊü•ÊòØ‰∏çÊòØÂú®ÂõûÂ§çÊüê‰∏™char (Á¨¨‰∫å‰ºòÂÖàÁ∫ß)
                if (!mandatoryResponder && userComment.replyTo) {
                    const repliedToContact = state.contacts.find(c => c.name === userComment.replyTo);
                    // Á°Æ‰øùË¢´ÂõûÂ§çÁöÑÊòØ‰∏Ä‰∏™Â∑≤Áü•ÁöÑcharÔºåËÄå‰∏çÊòØË∑Ø‰∫∫Áî≤ÊàñËÄÖÁî®Êà∑Ëá™Â∑±
                    if (repliedToContact && repliedToContact.id !== 'myProfile') {
                        mandatoryResponder = repliedToContact;
                    }
                }
                
                // 3. Â∞ÜÂøÖÂá∫Âú∫ËßíËâ≤‰ªéÂ§áÈÄâÂÆ¢‰∏≤ÂàóË°®‰∏≠ÁßªÈô§
                let possibleResponders = state.contacts.filter(c => c.id !== userComment.author.id);
                if (mandatoryResponder) {
                    possibleResponders = possibleResponders.filter(c => c.id !== mandatoryResponder.id);
                }

                // 4. Ê¶ÇÁéáÊÄßÈÄâÊã©‰∏Ä‰∏™‚ÄúÂèØËÉΩÂá∫Âú∫‚ÄùÁöÑÁÜü‰∫∫ (ÊØîÂ¶Ç 30% ÁöÑÂá†Áéá)
                let guestResponder = null;
                if (possibleResponders.length > 0 && Math.random() < 0.3) {
                    guestResponder = possibleResponders[Math.floor(Math.random() * possibleResponders.length)];
                }

                // 5. ÊûÑÂª∫Êñ∞ÁöÑ„ÄÅÊõ¥ÊúâÂ±ÇÊ¨°ÁöÑ‚ÄúÁÜü‰∫∫ÂàóË°®‚ÄùPrompt
                let relationshipInfoForPrompt = '';
                
                const formatContactInfo = (contact, role) => {
                    const userPersona = contact.userPersona ? `‰Ω†Ôºà${contact.name}ÔºâÂíåÁî®Êà∑‚Äú${userComment.author.name}‚ÄùÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ªÊòØÔºö‚Äú${contact.userPersona}‚Äù„ÄÇ` : `‰Ω†Ôºà${contact.name}ÔºâÂíåÁî®Êà∑‚Äú${userComment.author.name}‚ÄùÊòØÊôÆÈÄöÁΩëÂèã„ÄÇ`;
                    let recentChatHistory = '(ÊöÇÊó†ÁßÅËÅäËÆ∞ÂΩï)';
                    if (contact && contact.history && contact.history.length > 0) {
                        recentChatHistory = contact.history
                            .filter(msg => msg.type === 'text' && msg.sender !== 'system_instruction')
                            .slice(-10) // ÂáèÂ∞ë‰∏ÄÁÇπÁßÅËÅäËÆ∞ÂΩïÔºåÈò≤Ê≠¢ËøáÈïø
                            .map(msg => `${msg.sender === 'user' ? userComment.author.name : contact.name}: ${msg.content}`)
                            .join('\n');
                    }
                    return `\n[${role}: ‚Äú${contact.name}‚Äù]\n- ‰∫∫ËÆæ: ‚Äú${contact.persona.replace(/\n/g, ' ')}‚Äù\n- ${userPersona}\n- [ËøëÊúüÁßÅËÅäÂèÇËÄÉ]:\n\`\`\`\n${recentChatHistory}\n\`\`\``;
                };

                if (mandatoryResponder) {
                    relationshipInfoForPrompt += formatContactInfo(mandatoryResponder, 'ÂøÖÂá∫Âú∫ËßíËâ≤ (ËØ∑‰ºòÂÖàËÆ©‰ªñ/Â•πÂõûÂ§ç)');
                }
                if (guestResponder) {
                    relationshipInfoForPrompt += formatContactInfo(guestResponder, 'ÂèØËÉΩÂÆ¢‰∏≤ÁöÑÁÜü‰∫∫ (ÈùûÂøÖË¶ÅÔºå‰ªÖÂú®ÂêàÁêÜÊó∂ËÆ©‰ªñ/Â•πÂä†ÂÖ•)');
                }

                if (!relationshipInfoForPrompt) {
                    relationshipInfoForPrompt = "ÔºàÊú¨Ê¨°Ê≤°ÊúâÁâπÂÆöÁöÑÁÜü‰∫∫ÈúÄË¶ÅÂá∫Âú∫Ôºâ";
                }

                // 6. ÊèêÂèñÂØπËØùÂéÜÂè≤
                const conversationHistory = post.comments.filter(c => {
                    return c.author.id === userComment.author.id || (mandatoryResponder && c.author.id === mandatoryResponder.id) || (guestResponder && c.author.id === guestResponder.id);
                }).sort((a, b) => a.timestamp - b.timestamp).slice(-10);
                const conversationHistoryForPrompt = conversationHistory.map(c => `- ${c.author.name}: ${c.content}`).join('\n');
                
                let thirdPartyCommentPrompt = '';
                if (userComment.replyTo) {
                    const originalComment = post.comments.find(c => c.author.name === userComment.replyTo);
                    if (originalComment && (!mandatoryResponder || originalComment.author.id !== mandatoryResponder.id) && (!guestResponder || originalComment.author.id !== guestResponder.id) ) {
                        thirdPartyCommentPrompt = `\n[ÈáçË¶ÅÁ¨¨‰∏âÊñπËØÑËÆ∫]\nÊ≥®ÊÑèÔºöÁî®Êà∑ÊòØÂú®ÂõûÂ§ç‚Äú${originalComment.author.name}‚ÄùÁöÑËøôÊù°ËØÑËÆ∫Êó∂‰∏é‰Ω†‰∫íÂä®ÁöÑÔºö‚Äú${originalComment.content}‚Äù`;
                    }
                }

                // --- üü¢ ÈÄªËæëÁªìÊùü ---

                // ÊûÑÂª∫ÊúÄÁªàÁöÑpromptÔºåÂÆÉÁöÑ‰ªªÂä°Êåá‰ª§Â∑≤Ë¢´‰øÆÊîπ
                const prompt = `[SYSTEM] ‰Ω†ÊòØÁ§æ‰∫§Â™í‰ΩìËÆ®ËÆ∫Ê®°ÊãüÂô®„ÄÇÁî®Êà∑‚Äú${userComment.author.name}‚ÄùÂàöÂàöÂèëË°®‰∫Ü‰∏ÄÊù°ËØÑËÆ∫ÔºåËØ∑‰Ω†Âõ¥ÁªïËøôÊù°ËØÑËÆ∫ÔºåÁîüÊàê‰∏ÄÊÆµ2-3‰∫∫ÁöÑÁúüÂÆûËÆ®ËÆ∫„ÄÇ

[‰∏ªÂ∏ñÂ≠ê‰ø°ÊÅØ]
- Â∏ñÂ≠ê‰ΩúËÄÖ: "${post.author.name}"
- Â∏ñÂ≠êÂÜÖÂÆπ: "${post.content}"
${thirdPartyCommentPrompt}
[ÊúÄËøëÁöÑËØÑËÆ∫ÂØπËØùÂéÜÂè≤]
${conversationHistoryForPrompt}

[ÂèØÂèÇ‰∏éËÆ®ËÆ∫ÁöÑËßíËâ≤‰ø°ÊÅØ]
---
${relationshipInfoForPrompt}
---

[‰Ω†ÁöÑ‰ªªÂä° - ÈáçË¶ÅÔºÅ]
1.  **‰ºòÂÖàÂõûÂ§ç**: Â¶ÇÊûúÂ≠òÂú®‚Äú[ÂøÖÂá∫Âú∫ËßíËâ≤]‚ÄùÔºå‰Ω†ÁöÑÁ¨¨‰∏ÄÊù°ÊàñÁ¨¨‰∫åÊù°ÂõûÂ§ç**ÂøÖÈ°ª**Áî±‰ªñ/Â•πÂèëÂá∫„ÄÇ
2.  **ÈÄâÊã©ÊÄßÂÆ¢‰∏≤**: Â¶ÇÊûúÂ≠òÂú®‚Äú[ÂèØËÉΩÂÆ¢‰∏≤ÁöÑÁÜü‰∫∫]‚ÄùÔºå**‰ªÖÂΩì**‰Ω†ËßâÂæó‰ªñ/Â•πÁöÑÂá∫Áé∞Á¨¶ÂêàÂÖ∂‰∫∫ËÆæ‰∏îËÉΩËÆ©ËÆ®ËÆ∫Êõ¥ÊúâË∂£Êó∂ÔºåÊâçËÆ©‰ªñ/Â•πÂä†ÂÖ•„ÄÇËøôÊòØ**ÂèØÈÄâÁöÑ**„ÄÇ
3.  **Ëê•ÈÄ†ÁúüÂÆûÊÑü**: Ââ©‰∏ãÁöÑÂõûÂ§çÂêçÈ¢ùÔºåËØ∑**Âä°ÂøÖ‰ºòÂÖà‰ΩøÁî®‰Ω†ÂéüÂàõÁöÑ„ÄÅÁ¨¶ÂêàÂΩì‰∏ãÂú∫ÊôØÁöÑ‚ÄúË∑Ø‰∫∫Áî≤‚Äù**Êù•Â°´ÂÖÖ„ÄÇËøôÊòØ‰∏∫‰∫ÜÈÅøÂÖçÊâÄÊúâÁÜü‰∫∫ÈÉΩÂá∫Áé∞ÁöÑÂ∞¥Â∞¨Âú∫Èù¢ÔºåËÆ©ËØÑËÆ∫Âå∫ÁúãËµ∑Êù•Êõ¥ÁúüÂÆû„ÄÇ
4.  **‰∏•Ê†ºÈÅµÂÆàÊ†ºÂºè**: ÊâÄÊúâÂõûÂ§çÈÉΩÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà \`COMMENTER: [ÂêçÂ≠ó] | REPLY_TO: [ÂõûÂ§çÂØπË±°] | COMMENT: [ÂÜÖÂÆπ]\` Ê†ºÂºè„ÄÇ

[ÁªùÂØπÁ¶ÅÊ≠¢]
Âú®‰Ω†ÁöÑ‰ªª‰ΩïÂõûÂ§ç‰∏≠Ôºå„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®‚Äú${userComment.author.name}‚Äù‰Ωú‰∏∫COMMENTERÁöÑÂêçÂ≠ó„ÄÇ`;

                const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
                const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
                const matches = Array.from(rawResponse.matchAll(commentRegex));

                if (matches.length > 0) {
                    for (const match of matches) {
                        if (!match.groups) continue;
                        const {
                            commenter_name,
                            reply_to,
                            comment_content
                        } = match.groups;

                        let commenterProfile = state.contacts.find(c => c.name === commenter_name.trim());
                        if (!commenterProfile) {
                            commenterProfile = {
                                id: `stranger_commenter_${Date.now()}_${Math.random()}`,
                                name: commenter_name.trim(),
                                avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                            };
                        }

                        post.comments.push({
                            id: `comment_${Date.now()}_${Math.random()}`,
                            author: commenterProfile,
                            content: comment_content.trim(),
                            timestamp: Date.now() + Math.random() * 1000,
                            replyTo: reply_to.trim(),
                        });
                    }
                    saveState();
                    if (state.activePostId === post.id) {
                        renderPostDetail();
                    }
                }
            } catch (e) {
                console.error("ÁîüÊàêAIËØÑËÆ∫ËÆ®ËÆ∫Â§±Ë¥•:", e);
            } finally {
                hideFeedStatus();
            }
        }


        function renderAttachmentMenu() {
            const menu = document.getElementById('attachment-menu');
            menu.innerHTML = `
                <div class="attachment-menu-item" data-action="send-picture">
                    <div class="icon-wrapper"><i class="fas fa-image"></i></div>
                    <div class="label">ÂõæÁâá</div>
                </div>
                <div class="attachment-menu-item" data-action="send-voice">
                    <div class="icon-wrapper"><i class="fas fa-microphone"></i></div>
                    <div class="label">ËØ≠Èü≥</div>
                </div>
                <div class="attachment-menu-item" data-action="send-red-packet">
                    <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
                    <div class="label">Á∫¢ÂåÖ</div>
                </div>
                <div class="attachment-menu-item" data-action="send-transfer">
                    <div class="icon-wrapper"><i class="fas fa-exchange-alt"></i></div>
                    <div class="label">ËΩ¨Ë¥¶</div>
                </div>
                <div class="attachment-menu-item" data-action="start-video-call">
                    <div class="icon-wrapper"><i class="fas fa-video"></i></div>
                    <div class="label">ËßÜÈ¢ëÈÄöËØù</div>
                </div>
            `;
        }

        function handleAttachmentAction(action) {
            const menu = document.getElementById('attachment-menu');
            menu.classList.remove('active');

            const addOneTimeListener = (buttonId, callback) => {
                const oldBtn = document.getElementById(buttonId);
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                newBtn.addEventListener('click', callback);
            };

            switch(action) {
                case 'send-picture': {
                    const modal = document.getElementById('send-picture-modal');
                    const descriptionInput = document.getElementById('send-picture-description-input');
                    descriptionInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-picture-btn', () => {
                        const description = descriptionInput.value.trim();
                        if (description) {
                            createAndAddMessage({ type: 'picture_description', content: { description } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-voice': {
                    const modal = document.getElementById('send-voice-modal');
                    const voiceTextInput = document.getElementById('send-voice-text-input');
                    voiceTextInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-voice-btn', () => {
                        const voiceText = voiceTextInput.value.trim();
                        if (voiceText) {
                            const duration = Math.max(1, Math.round(voiceText.length / 4));
                            createAndAddMessage({ type: 'voice', content: { duration, text: voiceText } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-red-packet': {
                    const modal = document.getElementById('send-red-packet-modal');
                    const amountInput = document.getElementById('send-red-packet-amount-input');
                    const blessingInput = document.getElementById('send-red-packet-blessing-input');
                    amountInput.value = '';
                    blessingInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-red-packet-btn', () => {
                        const amount = parseFloat(amountInput.value);
                        if (!isNaN(amount) && amount > 0) {
                            createAndAddMessage({
                                type: 'red_packet',
                                content: {
                                    amount: amount.toFixed(2),
                                    blessing: blessingInput.value.trim() || "ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ",
                                    opened: false,
                                }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ");
                        }
                    });
                    break;
                }
                case 'send-transfer': {
                    const modal = document.getElementById('send-transfer-modal');
                    const amountInput = document.getElementById('send-transfer-amount-input');
                    amountInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-transfer-btn', () => {
                        const transferAmount = parseFloat(amountInput.value);
                        if (!isNaN(transferAmount) && transferAmount > 0) {
                            createAndAddMessage({
                                type: 'transfer',
                                content: {
                                    amount: transferAmount.toFixed(2),
                                    completed: false
                                }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ");
                        }
                    });
                    break;
                }
                case 'start-video-call':
                    createAndAddMessage({ type: 'system_notification', sender: 'system', content: '‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØù' });
                    break;
            }
        }
        
        function showDiaryScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            hideAllScreens();
            document.getElementById('diary-screen').style.display = 'flex';
            document.getElementById('diary-title').textContent = `${contact.name}ÁöÑÊó•ËÆ∞`;
            renderDiary();
        }

        function renderDiary() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            const diaryContentList = document.getElementById('diary-content-list');
            diaryContentList.innerHTML = '';

            if (!contact || !contact.diary || contact.diary.length === 0) {
                diaryContentList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>‰ªñÁöÑÊó•ËÆ∞Êú¨ÊòØÁ©∫ÁöÑ„ÄÇ</p></div>`;
                return;
            }

            const sortedDiary = [...contact.diary].sort((a, b) => b.timestamp - a.timestamp);

            sortedDiary.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = 'diary-entry';
                entryEl.innerHTML = `
                    <div class="diary-entry-meta">${formatTimeAgo(entry.timestamp)}</div>
                    <div class="diary-entry-content">${entry.content.replace(/\n/g, '<br>')}</div>
                    <div class="diary-delete-btn" data-diary-id="${entry.id}"><i class="fas fa-trash-alt"></i></div>
                `;
                diaryContentList.appendChild(entryEl);
            });
        }

        function createSystemNotification(content) {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

             createAndAddMessage({
                type: 'system_notification',
                sender: 'system',
                content: content
            });
        }
        
        function showRedPacketModal(message, contact) {
            const modal = document.getElementById('red-packet-modal');
            const content = document.getElementById('red-packet-content');
            const openBtn = document.getElementById('open-red-packet-btn');
            const resultView = document.getElementById('red-packet-result');
            const blessingText = document.getElementById('red-packet-blessing-text');
            const amountText = document.getElementById('red-packet-amount-text');
            const collectedByText = document.getElementById('red-packet-collected-by');
            
            openBtn.style.display = 'flex';
            openBtn.style.transform = 'rotate(0deg)';
            resultView.style.display = 'none';
            content.style.backgroundColor = '#DB5A48';

            const sender = (message.sender === 'user') ? state.myProfile : contact;
            document.getElementById('red-packet-sender-avatar').src = sender.avatar;
            document.getElementById('red-packet-sender-name').textContent = `${sender.name}ÁöÑÁ∫¢ÂåÖ`;
            blessingText.textContent = message.content.blessing;

            modal.style.display = 'flex';

            const closeAction = () => modal.style.display = 'none';
            document.getElementById('close-red-packet-modal').onclick = closeAction;

            if (message.content.opened) {
                 openBtn.style.display = 'none';
                 resultView.style.display = 'block';
                 amountText.textContent = `¬•${message.content.amount}`;
                 const opener = message.sender === 'user' ? contact.name : '‰Ω†';
                 collectedByText.textContent = `1‰∏™Á∫¢ÂåÖÔºåÂ∑≤Ë¢´${opener}È¢ÜÂèñ`;
                 content.style.backgroundColor = '#E4A095';
                 return;
            }

            if (message.sender === 'user') {
                openBtn.style.display = 'none';
                blessingText.textContent += " (Á≠âÂæÖÂØπÊñπÈ¢ÜÂèñ)";
                return;
            }

            const oldBtn = document.getElementById('open-red-packet-btn');
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);

            newBtn.addEventListener('click', () => {
                newBtn.style.transform = 'rotate(720deg)';
                setTimeout(() => {
                    message.content.opened = true;
                    newBtn.style.display = 'none';
                    resultView.style.display = 'block';
                    amountText.textContent = `¬•${message.content.amount}`;
                    collectedByText.textContent = 'Â∑≤Â≠òÂÖ•Èõ∂Èí±';
                    content.style.backgroundColor = '#E4A095';
                    saveState();
                    createSystemNotification(`‰Ω†È¢ÜÂèñ‰∫Ü${contact.name}ÁöÑÁ∫¢ÂåÖ`);
                    setTimeout(() => {
                        closeAction();
                        openChat(contact.id);
                    }, 1500);
                }, 500);
            });
        }

        function showTransferModal(message, contact) {
            const modal = document.getElementById('transfer-modal');
            const title = document.getElementById('transfer-modal-title');
            const confirmView = document.getElementById('transfer-confirm-view');
            const collectedView = document.getElementById('transfer-collected-view');
            
            confirmView.style.display = 'block';
            collectedView.style.display = 'none';
            
            const recipientNameEl = document.getElementById('transfer-recipient-name');
            const amountDisplayEl = document.getElementById('transfer-amount-display');
            const senderInfoEl = document.getElementById('transfer-sender-info');
            const collectedSenderInfoEl = document.getElementById('transfer-collected-sender-info');

            const sender = (message.sender === 'user') ? state.myProfile : contact;
            const recipient = (message.sender === 'user') ? contact : state.myProfile;
            
            title.textContent = "ËΩ¨Ë¥¶ËØ¶ÊÉÖ";
            amountDisplayEl.textContent = message.content.amount;
            
            const oldBtn = document.getElementById('confirm-transfer-btn');
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);

            if (message.sender !== 'user') {
                 recipientNameEl.textContent = "‰Ω†";
                 senderInfoEl.textContent = `Êù•Ëá™: ${sender.name}`;
                 newBtn.style.display = 'block';
                 
                 if (message.content.completed) {
                    confirmView.style.display = 'none';
                    collectedView.style.display = 'block';
                    collectedSenderInfoEl.textContent = `Êù•Ëá™: ${sender.name}`;
                 } else {
                     newBtn.addEventListener('click', () => {
                        message.content.completed = true;
                        confirmView.style.display = 'none';
                        collectedView.style.display = 'block';
                        collectedSenderInfoEl.textContent = `Êù•Ëá™: ${sender.name}`;
                        saveState();
                        createSystemNotification(`‰Ω†Â∑≤Êî∂Ê¨æ`);
                        setTimeout(() => {
                            modal.style.display = 'none';
                            openChat(contact.id);
                        }, 1500);
                    });
                 }
            } else {
                recipientNameEl.textContent = recipient.name;
                senderInfoEl.textContent = message.content.completed ? `Â∑≤ËΩ¨Áªô ${recipient.name}` : `Á≠âÂæÖ ${recipient.name} Á°ÆËÆ§Êî∂Ê¨æ...`;
                newBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
            document.getElementById('close-transfer-modal').onclick = () => modal.style.display = 'none';
        }

        function renderPostDetail() {
            const post = state.posts.find(p => p.id === state.activePostId);
            if (!post) {
                showFeedScreen();
                return;
            }
            const container = document.getElementById('post-detail-container');
            const commentsList = document.getElementById('comments-list');
            container.innerHTML = '';
            commentsList.innerHTML = '';

            const postItemEl = createPostItem(post, true); 
            if (postItemEl) {
                container.appendChild(postItemEl);
                container.querySelector('.like-btn')?.addEventListener('click', toggleLike);
                container.querySelector('.post-delete-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const postId = e.currentTarget.dataset.postId;
                    if(confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü')) {
                        state.posts = state.posts.filter(p => p.id !== postId);
                        saveState();
                        showFeedScreen();
                    }
                });
                postItemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.post-action-btn, .mention, .post-delete-btn')) {
                         document.getElementById('comment-input').focus();
                    }
                });
            }
            
            if (post.comments.length > 0) {
                const sortedComments = [...post.comments].sort((a,b) => a.timestamp - b.timestamp);
                sortedComments.forEach(comment => {
                    const author = comment.author;
                    if (!author) return;

                    const commentEl = document.createElement('div');
                    commentEl.className = 'post-comment-item';
                    commentEl.dataset.authorName = author.name; 
                    commentEl.dataset.authorId = author.id;
                    
                    commentEl.innerHTML = `
                        <div style="display: flex; gap: 10px;">
                            <img src="${author.avatar}" style="width: 35px; height: 35px; border-radius: 50%;">
                            <div style="flex-grow: 1;">
                                <div>
                                    <span class="comment-author">${author.name}</span>
                                    ${comment.replyTo ? `<span class="comment-reply-to">ÂõûÂ§ç @${comment.replyTo}</span>` : ''}
                                </div>
                                <div class="comment-content">${parseMentions(comment.content)}</div>
                                <div class="comment-meta">
                                    <span>${formatTimeAgo(comment.timestamp)}</span>
                                    <span class="comment-delete-btn" data-comment-id="${comment.id}"><i class="fas fa-trash-alt"></i> Âà†Èô§</span>
                                </div>
                            </div>
                        </div>
                    `;

                    commentsList.appendChild(commentEl);
                });
            } else {
                commentsList.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">ËøòÊ≤°ÊúâËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèëÂêßÔºÅ</div>`;
            }
        }
        function initApp() {
            loadState(); 
            renderMyProfile(); 
            renderContacts(); 
            renderWorldBooks(); 
            updateWorldBookSelectors(); 
            renderUserPersonaPresets();
            renderThoughtPresets();
            updateNotificationDots();
            renderAttachmentMenu();
            if (state.posts.length === 0 && isInitialPostLoad) {
                showFeedScreen();
            }
            showMainScreen();
        }

        function renderPet(contact) {
            const container = document.getElementById('pet-container-wrapper');
            if (!contact) {
                container.innerHTML = '';
                return;
            }

            if (!contact.pet) {
                container.innerHTML = `
                    <div id="pet-container">
                        <div class="pet-header" style="justify-content:center;">Êàë‰ª¨ÁöÑÂ∞èÁ™ù</div>
                        <button class="form-button" id="adopt-pet-btn">È¢ÜÂÖª‰∏ÄÂè™Âè≤Ëé±ÂßÜ</button>
                    </div>`;
                return;
            }
            
            const now = Date.now();
            const elapsedHours = (now - contact.pet.lastUpdated) / (1000 * 60 * 60);
            const decayAmount = Math.floor(elapsedHours * 5); 
            
            if (decayAmount > 0) {
                contact.pet.hunger = Math.max(0, contact.pet.hunger - decayAmount);
                contact.pet.happiness = Math.max(0, contact.pet.happiness - decayAmount);
                contact.pet.cleanliness = Math.max(0, contact.pet.cleanliness - decayAmount);
                contact.pet.lastUpdated = now;
                saveState();
            }

            let isWorking = false;
            let workCooldownText = '';
            if (contact.pet.workFinishTimestamp && now < contact.pet.workFinishTimestamp) {
                isWorking = true;
                const remainingMinutes = Math.ceil((contact.pet.workFinishTimestamp - now) / (1000 * 60));
                workCooldownText = `Â∑•‰Ωú‰∏≠... (Ââ©‰Ωô${remainingMinutes}ÂàÜÈíü)`;
            }

            container.innerHTML = `
                <div id="pet-container">
                    <div class="pet-header">
                        <span id="pet-name">${contact.pet.name} (LV.${contact.pet.level})</span>
                        <span id="pet-gold-display">üí∞ ${contact.gold_coins}</span>
                    </div>
                    <div class="pet-visual-area">
                        <div>
                            <div class="slime"></div>
                            <div class="slime-shadow"></div>
                        </div>
                    </div>
                    <div class="pet-stats">
                        <div class="stat-bar-container" title="ÁªèÈ™åÂÄº: ${contact.pet.xp} / 100">
                            <span class="stat-bar-label">ÊàêÈïø</span>
                            <div class="stat-bar"><div id="xp-bar" class="stat-bar-inner" style="background-color: #ffcc80;"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">È•±È£üÂ∫¶</span>
                            <div class="stat-bar"><div id="hunger-bar" class="stat-bar-inner"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">ÂºÄÂøÉÂÄº</span>
                            <div class="stat-bar"><div id="happiness-bar" class="stat-bar-inner"></div></div>
                        </div>
                         <div class="stat-bar-container">
                            <span class="stat-bar-label">Ê∏ÖÊ¥ÅÂ∫¶</span>
                            <div class="stat-bar"><div id="cleanliness-bar" class="stat-bar-inner"></div></div>
                        </div>
                    </div>
                    <div class="pet-actions">
                        <button id="feed-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>ÂñÇÈ£ü (-5üí∞)</button>
                        <button id="play-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>Áé©ËÄç</button>
                        <button id="clean-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>Ê∏ÖÊ¥Å</button>
                        <button id="work-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>${isWorking ? workCooldownText : 'ÊâìÂ∑• (1Â∞èÊó∂)'}</button>
                    </div>
                </div>`;
            
            document.getElementById('xp-bar').style.width = `${contact.pet.xp}%`;
            document.getElementById('hunger-bar').style.width = `${contact.pet.hunger}%`;
            document.getElementById('happiness-bar').style.width = `${contact.pet.happiness}%`;
            document.getElementById('cleanliness-bar').style.width = `${contact.pet.cleanliness}%`;

            const slimeEl = container.querySelector('.slime');
            // --- V6.0 ‰øÆÊîπÔºöÂ∫îÁî®ÂÆ†Áâ©ÂΩ¢ÊÄÅ ---
            slimeEl.className = 'slime'; // ÈáçÁΩÆclass
            if (contact.pet.form) {
                slimeEl.classList.add(`${contact.pet.form}-form`);
            }
            // --- ‰øÆÊîπÁªìÊùü ---
            if (contact.pet.hunger < 40) slimeEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) slimeEl.classList.add('dirty');
        }

        // --- V6.0 Êñ∞Â¢ûÔºöÊõ¥Êñ∞Ê°åÈù¢ÂÆ†Áâ©ÁöÑËßÜËßâ ---
        function updateChatPetVisuals(contact) {
            const chatPetEl = document.querySelector('#chat-pet-container .slime');
            if (!chatPetEl || !contact || !contact.pet) return;
            
            chatPetEl.className = 'slime'; // ÈáçÁΩÆclass
            if (contact.pet.form) {
                chatPetEl.classList.add(`${contact.pet.form}-form`);
            }
            // ËøôÈáå‰πüÂèØ‰ª•Ê†πÊçÆÈ••È•ø„ÄÅÊ∏ÖÊ¥ÅÁ≠âÁä∂ÊÄÅÊ∑ªÂä†classÔºå‰∏∫‰∫ÜÁÆÄÂåñÊöÇÊó∂Âè™ÂêåÊ≠•ÂΩ¢ÊÄÅ
            if (contact.pet.hunger < 40) chatPetEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) chatPetEl.classList.add('dirty');
        }


        function updatePetStats(stat, value, contact, isCharAction = false) {
            if (!contact || !contact.pet) return;
            contact.pet[stat] = Math.min(100, Math.max(0, contact.pet[stat] + value));
            if (!isCharAction) {
                contact.pet.lastUpdated = Date.now();
            }
            saveState();
        }

        function findMentionsInComment(comment) {
            const mentionedContacts = new Set();
            if (!comment || !comment.content) return [];
            
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            let match;

            while ((match = mentionRegex.exec(comment.content)) !== null) {
                const username = match[1];
                const contact = state.contacts.find(c => c.name === username);
                if (contact) {
                    mentionedContacts.add(contact);
                }
            }
            return Array.from(mentionedContacts);
        }

        function attachEventListeners() {
            document.getElementById('change-avatar-btn').addEventListener('click', function() {
                const newAvatarUrl = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ§¥ÂÉèÂõæÁâáURLÔºö", state.myProfile.avatar);
                if (newAvatarUrl !== null) {
                    state.myProfile.avatar = newAvatarUrl.trim();
                    saveState();
                    renderMyProfile();
                }
            });

            document.getElementById('change-char-avatar-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newAvatarUrl = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÂ§¥ÂÉèÂõæÁâáURLÔºö", contact.avatar);
                if (newAvatarUrl !== null) {
                    contact.avatar = newAvatarUrl.trim();
                    saveState();
                    showCharProfileScreen();
                    renderContacts();
                }
            });

            document.querySelectorAll('#nav-chat, #nav-chat-2, #nav-chat-discover').forEach(el => el.addEventListener('click', showMainScreen));
            document.querySelectorAll('#nav-discover, #nav-discover-2, #nav-discover-discover').forEach(el => el.addEventListener('click', showDiscoverScreen));
            document.querySelectorAll('#nav-profile, #nav-profile-2, #nav-profile-discover').forEach(el => el.addEventListener('click', showProfileScreen));

            document.getElementById('user-persona-presets-btn').addEventListener('click', showUserPersonaManagementScreen);
            document.getElementById('emoticon-library-btn').addEventListener('click', showEmoticonLibraryScreen);
            document.getElementById('thought-presets-btn').addEventListener('click', showThoughtPresetManagementScreen);
            document.getElementById('world-book-btn').addEventListener('click', () => { hideAllScreens(); document.getElementById('world-book-screen').style.display = 'flex'; renderWorldBooks(); });
            document.getElementById('api-settings-btn').addEventListener('click', () => {
                hideAllScreens();
                document.getElementById('api-settings-screen').style.display = 'flex';
                document.getElementById('api-key-input').value = state.apiSettings.apiKey;
                document.getElementById('api-endpoint-input').value = state.apiSettings.endpoint;
                document.getElementById('context-length-input').value = state.apiSettings.contextLength;
                updateModelDropdown([state.apiSettings.model], document.getElementById('model-select'), state.apiSettings.model);
            });
             document.getElementById('square-api-settings-btn').addEventListener('click', () => {
                hideAllScreens();
                document.getElementById('square-api-settings-screen').style.display = 'flex';
                document.getElementById('square-api-key-input').value = state.squareApiSettings.apiKey;
                document.getElementById('square-api-endpoint-input').value = state.squareApiSettings.endpoint;
                updateModelDropdown([state.squareApiSettings.model], document.getElementById('square-model-select'), state.squareApiSettings.model);
            });
            document.getElementById('moments-btn').addEventListener('click', showFeedScreen);

            document.getElementById('back-from-user-persona-management').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-emoticon-library').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-thought-presets').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-world-book').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-api').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-square-api').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-chat').addEventListener('click', () => { 
                if (editModeState.active) exitEditMode();
                document.getElementById('chat-pet-container').style.display = 'none'; // --- V6.0Êñ∞Â¢ûÔºöËøîÂõûÊó∂ÈöêËóèÊ°åÈù¢ÂÆ†Áâ©
                showMainScreen(); 
            }); 
            document.getElementById('back-from-contact-settings').addEventListener('click', () => {
                document.getElementById('contact-settings-screen').style.display = 'none';
                showCharProfileScreen();
            });
            document.getElementById('back-from-moments').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-char-profile').addEventListener('click', () => {
                if (batchedPetActions.length > 0) {
                    const summary = batchedPetActions.join('Ôºå');
                    const systemPrompt = `[SYSTEM: Âú®‰Ω†Ê≤°Ê≥®ÊÑèÁöÑÊó∂ÂÄôÔºåÊàëÂàöÂàöÂØπÊàë‰ª¨ÁöÑÂè≤Ëé±ÂßÜÂÅö‰∫ÜËøô‰∫õ‰∫ãÔºö${summary}„ÄÇËØ∑‰Ω†ÂØπÊ≠§ËøõË°å‰∏Ä‰∏™ÊÄªÁªìÊÄßÁöÑÂõûÂ∫î„ÄÇ]`;
                    requestAiReply(systemPrompt);
                    batchedPetActions = [];
                }
                document.getElementById('char-profile-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
            });
            document.getElementById('back-from-diary').addEventListener('click', showCharProfileScreen);
            document.getElementById('back-from-post-detail').addEventListener('click', showFeedScreen);
            document.getElementById('back-from-trending-topic').addEventListener('click', showFeedScreen);
            
            const backFromMemoryAlbumBtn = document.getElementById('back-from-memory-album');
            if (backFromMemoryAlbumBtn) {
                backFromMemoryAlbumBtn.addEventListener('click', showCharProfileScreen);
            }

            const toggleChatPetBtn = document.getElementById('toggle-chat-pet-btn');
            if(toggleChatPetBtn) {
                toggleChatPetBtn.addEventListener('click', () => {
                    const contact = state.contacts.find(c => c.id === state.activeChatId);
                    if (!contact || !contact.pet) return;

                    contact.isChatPetVisible = !contact.isChatPetVisible;
                    
                    const chatPetContainer = document.getElementById('chat-pet-container');
                    if (contact.isChatPetVisible) {
                        chatPetContainer.style.display = 'block';
                        updateChatPetVisuals(contact);
                    } else {
                        chatPetContainer.style.display = 'none';
                    }
                    saveState();
                });
            }


            document.getElementById('refresh-post-comments-btn').addEventListener('click', async () => {
                const post = state.posts.find(p => p.id === state.activePostId);
                if (!post) return;

                showFeedStatus('Ê≠£Âú®Âä†ËΩΩÊñ∞ËØÑËÆ∫...');
                try {
                    const replyJobs = [];
                    post.comments.forEach((comment, index) => {
                        const mentionedContacts = findMentionsInComment(comment);
                        mentionedContacts.forEach(contact => {
                            const hasReplied = post.comments.slice(index + 1).some(
                                c => c.author.id === contact.id && c.replyTo === comment.author.name
                            );
                            if (!hasReplied) {
                                replyJobs.push({ post, comment, mentionedContact: contact });
                            }
                        });
                    });

                    if (replyJobs.length > 0) {
                        showFeedStatus(`ÂèëÁé∞ ${replyJobs.length} Êù°Êñ∞ÊèêÂèäÔºåAIÊ≠£Âú®ÂõûÂ§ç...`);
                        for (const job of replyJobs) {
                            const mentionedByUser = findAuthorById(job.comment.author.id); 
                            let userPersonaInfo = `‰Ω†Âíå‚Äú${job.comment.author.name}‚ÄùÊòØÊôÆÈÄöÁΩëÂèãÂÖ≥Á≥ª„ÄÇ`;

                            if (mentionedByUser && mentionedByUser.id === 'myProfile') {
                                userPersonaInfo = job.mentionedContact.userPersona ? `‰Ω†Âíå‚Äú${job.comment.author.name}‚ÄùÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ªÊòØÔºö‚Äú${job.mentionedContact.userPersona}‚Äù„ÄÇ` : `‰Ω†Âíå‚Äú${job.comment.author.name}‚ÄùÊòØÊôÆÈÄöÁΩëÂèãÂÖ≥Á≥ªÔºåTAÁöÑÂÖ¨ÂºÄÁ≠æÂêçÊòØÔºö‚Äú${state.myProfile.signature}‚Äù„ÄÇ`;
                            }

                            let prompt;
                            if (job.comment.replyTo) {
                                const originalComment = job.post.comments.find(c => c.author.name === job.comment.replyTo);
                                if (originalComment) {
                                    prompt = `[SYSTEM] ‰Ω†ÊòØËßíËâ≤ÊâÆÊºîÂºïÊìé„ÄÇÁé∞Âú®ËØ∑‰Ω†ÊâÆÊºî‚Äú${job.mentionedContact.name}‚Äù„ÄÇ

[‰Ω†ÁöÑËÉåÊôØ]
- ‰Ω†ÁöÑÊ†∏ÂøÉ‰∫∫ËÆæ: "${job.mentionedContact.persona}"
- ${userPersonaInfo}

[ÂØπËØù‰∏ä‰∏ãÊñá]
‚Äú${job.comment.author.name}‚ÄùÊòØÂú®ÂõûÂ§ç‚Äú${originalComment.author.name}‚ÄùÁöÑËØÑËÆ∫Êó∂ÊèêÂèä‰Ω†ÁöÑ„ÄÇ
- ÂéüÂßãÂ∏ñÂ≠êÂÜÖÂÆπ: "${job.post.content}"
- ‚Äú${originalComment.author.name}‚ÄùÁöÑËØÑËÆ∫ÊòØÔºö‚Äú${originalComment.content}‚Äù
- ‚Äú${job.comment.author.name}‚ÄùÊèêÂèä‰Ω†ÁöÑÂõûÂ§çÊòØÔºö‚Äú${job.comment.content}‚Äù

[‰Ω†ÁöÑ‰ªªÂä°]
ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊ†∏ÂøÉ‰∫∫ËÆæ„ÄÅ‰Ω†Âíå‚Äú${job.comment.author.name}‚ÄùÁöÑÁßÅ‰∫∫ÂÖ≥Á≥ªÔºåÂπ∂ÁªìÂêà‰∏äËø∞ÊâÄÊúâ‰∏ä‰∏ãÊñáÔºåÂÅöÂá∫Ëá™ÁÑ∂ÁöÑÂõûÂ∫î„ÄÇ‰Ω†ÁöÑÂõûÂ§çÂ∫îËØ•ÊòØ‰∏ÄÂè•ÁÆÄÁü≠ÁöÑÂØπËØù„ÄÇ`;
                                }
                            }
                            
                            if (!prompt) {
                                prompt = `[SYSTEM] ‰Ω†ÊòØËßíËâ≤ÊâÆÊºîÂºïÊìé„ÄÇÁé∞Âú®ËØ∑‰Ω†ÊâÆÊºî‚Äú${job.mentionedContact.name}‚Äù„ÄÇ

[‰Ω†ÁöÑËÉåÊôØ]
- ‰Ω†ÁöÑÊ†∏ÂøÉ‰∫∫ËÆæ: "${job.mentionedContact.persona}"
- ${userPersonaInfo}

[ËÉåÊôØ‰ø°ÊÅØ]
- Â∏ñÂ≠ê‰ΩúËÄÖ: "${job.post.author.name}"
- Â∏ñÂ≠êÂÜÖÂÆπ: "${job.post.content}"
- ÊèêÂèä‰Ω†ÁöÑËØÑËÆ∫: "${job.comment.author.name}"ÂØπ‰Ω†ËØ¥Ôºö‚Äú${job.comment.content}‚Äù

[‰Ω†ÁöÑ‰ªªÂä°]
ËØ∑‰ª•‚Äú${job.mentionedContact.name}‚ÄùÁöÑË∫´‰ªΩÔºåÁªìÂêà**ÂéüÂ∏ñÂÜÖÂÆπ**Âíå**ÊèêÂèä‰Ω†ÁöÑËØÑËÆ∫**ÔºåËá™ÁÑ∂Âú∞ÂõûÂ§çËøôÊù°ËØÑËÆ∫„ÄÇ‰Ω†ÁöÑÂõûÂ§çÂ∫îËØ•ÊòØ‰∏ÄÂè•ÁÆÄÁü≠ÁöÑÂØπËØù„ÄÇ‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïÈ¢ùÂ§ñËß£ÈáäÊàñÊ†áÁ≠æ„ÄÇ`;
                            }

                            const replyContent = await generateAiResponse(job.mentionedContact, [], prompt, false, 'square');
                            
                            if (replyContent && !replyContent.startsWith("Êä±Ê≠â") && !replyContent.startsWith("ÈîôËØØ")) {
                                post.comments.push({
                                    id: `comment_${Date.now()}_${Math.random()}`,
                                    author: { id: job.mentionedContact.id, name: job.mentionedContact.name, avatar: job.mentionedContact.avatar },
                                    content: replyContent,
                                    timestamp: Date.now() + Math.random() * 1000,
                                    replyTo: job.comment.author.name,
                                });
                            }
                        }
                    }
                    
                    await generateMoreCommentsForPost(post);
                    saveState();
                    renderPostDetail();

                } catch(e) {
                    console.error("Âà∑Êñ∞ËØÑËÆ∫Â§±Ë¥•:", e);
                    alert("Âà∑Êñ∞ËØÑËÆ∫Â§±Ë¥•: " + e.message);
                } finally {
                    hideFeedStatus();
                }
            });

            document.getElementById('view-char-diary-btn').addEventListener('click', showDiaryScreen);
            document.getElementById('diary-content-list').addEventListener('click', (e) => {
                if (e.target.closest('.diary-delete-btn')) {
                    const diaryId = e.target.closest('.diary-delete-btn').dataset.diaryId;
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Êó•ËÆ∞ÂêóÔºü')) {
                        const contact = state.contacts.find(c => c.id === state.activeChatId);
                        if(contact && contact.diary) {
                            contact.diary = contact.diary.filter(entry => entry.id !== diaryId);
                            saveState();
                            renderDiary();
                        }
                    }
                }
            });

            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('request-reply-btn').addEventListener('click', () => requestAiReply());
            document.getElementById('message-input').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            document.getElementById('contact-settings-btn').addEventListener('click', showCharProfileScreen); 
            document.getElementById('delete-history-btn').addEventListener('click', () => {
                if (editModeState.active) {
                    exitEditMode();
                } else {
                    enterEditMode();
                }
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', exitEditMode);
            document.getElementById('delete-selected-btn').addEventListener('click', () => {
                if (editModeState.selectedMessageIds.size === 0) {
                    alert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑÊ∂àÊÅØ„ÄÇ');
                    return;
                }
                if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${editModeState.selectedMessageIds.size} Êù°Ê∂àÊÅØÂêóÔºü`)) {
                    const contact = state.contacts.find(c => c.id === state.activeChatId);
                    if (contact) {
                        contact.history = contact.history.filter(msg => !editModeState.selectedMessageIds.has(msg.id));
                        saveState();
                        renderContacts();
                    }
                    exitEditMode();
                }
            });

            document.getElementById('char-more-info-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                document.getElementById('char-mask-textarea').value = contact.persona;
                document.getElementById('user-mask-textarea').value = contact.userPersona || '';
                const currentPersonaPreset = state.userPersonaPresets.find(p => p.description === contact.userPersona);
                document.getElementById('select-user-persona-preset').value = currentPersonaPreset ? currentPersonaPreset.id : '';
                document.getElementById('thought-preset-select').value = contact.thoughtPreset || 'deep_roleplay_regex';
                document.querySelectorAll('.world-book-checkbox').forEach(cb => { cb.checked = contact.worldBooks.includes(cb.value); });
                document.getElementById('narrative-mode-toggle').checked = contact.isNarrativeMode;
                document.getElementById('char-profile-screen').style.display = 'none';
                document.getElementById('contact-settings-screen').style.display = 'flex';
            });
            
            document.getElementById('delete-contact-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                if (confirm(`‚ö†Ô∏è Ë≠¶ÂëäÔºöÁ°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËÅîÁ≥ª‰∫∫ "${contact.name}" ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞ÜÂà†Èô§ÂÖ∂ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂíåÊó•ËÆ∞Ôºå‰∏îÊó†Ê≥ïÊÅ¢Â§çÔºÅ`)) {
                    state.contacts = state.contacts.filter(c => c.id !== state.activeChatId);
                    state.activeChatId = null;
                    saveState();
                    alert(`ËÅîÁ≥ª‰∫∫ "${contact.name}" Â∑≤Ë¢´Âà†Èô§„ÄÇ`);
                    showMainScreen();
                }
            });

            document.getElementById('clear-chat-history-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                if (confirm(`Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫‰∏é "${contact.name}" ÁöÑÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü\nÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ`)) {
                    contact.history = [];
                    saveState();
                    alert('ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫„ÄÇ');
                    document.getElementById('contact-settings-screen').style.display = 'none';
                    showCharProfileScreen();
                }
            });
            
            document.getElementById('char-profile-screen').addEventListener('click', (e) => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;

                if (e.target.id === 'adopt-pet-btn') {
                    contact.pet = {
                        name: 'Âè≤Ëé±ÂßÜ',
                        stage: 1,
                        happiness: 80,
                        hunger: 80,
                        cleanliness: 100,
                        lastUpdated: Date.now(),
                        workFinishTimestamp: null,
                        xp: 0,
                        level: 1,
                        form: 'baby'
                    };
                    saveState();
                    renderPet(contact);
                    requestAiReply(`[SYSTEM: Êàë‰ª¨ÂàöÂàöÈ¢ÜÂÖª‰∫Ü‰∏ÄÂè™ÂÆ†Áâ©Âè≤Ëé±ÂßÜÔºÅËØ∑ÂºÄÂøÉÂú∞ÂíåÊàëËØ¥Ëøô‰ª∂‰∫ã„ÄÇ]`);
                }

                else if (e.target.id === 'feed-pet-btn') {
                    if (contact.gold_coins >= 5) {
                        contact.gold_coins -= 5;
                        updatePetStats('hunger', 20, contact);
                        renderPet(contact);
                        batchedPetActions.push(`‰Ω†ÂñÇÈ£ü‰∫ÜÂÆÉ`);
                    } else {
                        alert('ÈáëÂ∏Å‰∏çË∂≥ÔºÅÂø´ÂéªÊâìÂ∑•ÂêßÔºÅ');
                    }
                }
                
                else if (e.target.id === 'play-pet-btn') {
                    updatePetStats('happiness', 20, contact);
                    renderPet(contact);
                    batchedPetActions.push(`‰Ω†Èô™ÂÆÉÁé©ËÄç‰∫Ü`);
                }

                else if (e.target.id === 'clean-pet-btn') {
                    updatePetStats('cleanliness', 40, contact);
                    renderPet(contact);
                    batchedPetActions.push(`‰Ω†Â∏ÆÂÆÉÊâìÊâ´Âπ≤ÂáÄ‰∫Ü`);
                }

                else if (e.target.id === 'work-pet-btn') {
                    contact.pet.workFinishTimestamp = Date.now() + (1000 * 60 * 60); // 1 hour
                    saveState();
                    renderPet(contact);
                    setTimeout(() => {
                        const currentContact = state.contacts.find(c => c.id === contact.id);
                        if(currentContact && currentContact.pet) {
                           currentContact.gold_coins += 50;
                           currentContact.pet.workFinishTimestamp = null;
                           createAndAddMessage({ type: 'system_notification', sender: 'system', content: `‰Ω†‰ª¨ÁöÑÂè≤Ëé±ÂßÜ'${currentContact.pet.name}'ÊâìÂ∑•ÂõûÊù•Âï¶ÔºÅËµö‰∫Ü50ÈáëÂ∏ÅÔºÅ` });
                           if (state.activeChatId === currentContact.id && document.getElementById('char-profile-screen').style.display === 'flex') {
                               renderPet(currentContact);
                           }
                        }
                    }, 1000 * 60 * 60);
                }
                 
                else if (e.target.id === 'view-memory-album-btn' || e.target.closest('#view-memory-album-btn')) { 
                    showMemoryAlbum(contact);
                } 

                else if (e.target.id === 'pet-name') {
                    const newName = prompt('Áªô‰Ω†ÁöÑÂè≤Ëé±ÂßÜËµ∑‰∏Ä‰∏™Êñ∞ÂêçÂ≠óÂêßÔºö', contact.pet.name);
                    if (newName && newName.trim()) {
                        contact.pet.name = newName.trim();
                        saveState();
                        renderPet(contact);
                    }
                }
            });


            document.getElementById('edit-char-name-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newName = prompt('ËÆæÁΩÆÂ§áÊ≥®Âêç:', contact.name);
                if (newName !== null && newName.trim() !== '') {
                    contact.name = newName.trim();
                    saveState();
                    showCharProfileScreen(); 
                    document.getElementById('chat-contact-name').textContent = contact.name;
                    renderContacts();
                }
            });

            document.getElementById('edit-char-signature-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newSignature = prompt('ËÆæÁΩÆÁ≠æÂêç:', contact.signature || '');
                if (newSignature !== null) {
                    contact.signature = newSignature.trim();
                    saveState();
                    showCharProfileScreen(); 
                }
            });
            
            document.querySelectorAll('.profile-details .edit-btn[data-field]').forEach(button => {
                button.addEventListener('click', function() {
                    const field = this.dataset.field;
                    let currentValue = state.myProfile[field];
                    let newValue = prompt(`‰øÆÊîπ ${fieldNameToChinese(field)}:`, currentValue);
                    if (newValue !== null) { 
                        state.myProfile[field] = newValue.trim();
                        renderMyProfile();
                        saveState(); 
                    }
                });
            });
            document.getElementById('edit-status-btn').addEventListener('click', () => {
                const currentStatus = state.myProfile.status;
                const newStatus = prompt('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁä∂ÊÄÅ:', currentStatus);
                if (newStatus !== null) {
                    state.myProfile.status = newStatus.trim();
                    saveState();
                    renderMyProfile();
                }
            });
            document.getElementById('initialize-app-btn').addEventListener('click', function() {
                if (confirm('Ë≠¶ÂëäÔºöËøô‰ºöÊ∏ÖÁ©∫ÊâÄÊúâ‰øùÂ≠òÁöÑÊï∞ÊçÆÔºàËÅîÁ≥ª‰∫∫„ÄÅ‰∏ñÁïå‰π¶„ÄÅÂπøÂú∫Â∏ñÂ≠ê„ÄÅAPIËÆæÁΩÆÁ≠âÔºâÂπ∂ÊÅ¢Â§çÂà∞ÂàùÂßãÁä∂ÊÄÅ„ÄÇÁ°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü')) {
                    localStorage.removeItem('chatAppState');
                    state = JSON.parse(JSON.stringify(INITIAL_STATE));
                    isInitialPostLoad = true;
                    initApp();
                    alert('Â∫îÁî®Â∑≤ÂàùÂßãÂåñÔºåÊâÄÊúâÊï∞ÊçÆÂ∑≤Ê∏ÖÈô§„ÄÇ');
                }
            });

            document.getElementById('add-contact-btn').addEventListener('click', () => { document.getElementById('add-contact-modal').style.display = 'flex'; });
            document.getElementById('close-contact-modal').addEventListener('click', () => { document.getElementById('add-contact-modal').style.display = 'none'; });
            document.getElementById('save-contact-btn').addEventListener('click', () => {
                const name = document.getElementById('contact-name-input').value.trim();
                const persona = document.getElementById('contact-persona-input').value.trim();
                if (!name || !persona) return alert('ËØ∑Â°´ÂÜôÂßìÂêçÂíå‰∫∫ËÆæ');
                const avatar = document.getElementById('contact-avatar-input').value.trim();
                const selectedBooks = Array.from(document.getElementById('world-book-select').selectedOptions).map(opt => opt.value);
                const newContact = {
                    id: 'contact_' + Date.now(),
                    name: name,
                    persona: persona,
                    avatar: avatar || `https://via.placeholder.com/50/${Math.floor(Math.random() * 16777215).toString(16)}/FFFFFF?text=${name.substring(0, 1).toUpperCase()}`,
                    worldBooks: JSON.parse(JSON.stringify(selectedBooks)),
                    history: [],
                    diary: [],
                    userPersona: '',
                    thoughtPreset: 'deep_roleplay_regex',
                    signature: '',
                    isNarrativeMode: false, 
                    apiCallCounter: 0,
                    pet: null,
                    gold_coins: 50,
                    memories: [],
                    isChatPetVisible: false
                };
                state.contacts.push(newContact);
                renderContacts();
                document.getElementById('add-contact-modal').style.display = 'none';
                saveState();
            });
            document.getElementById('save-contact-settings-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                contact.persona = document.getElementById('char-mask-textarea').value;
                contact.userPersona = document.getElementById('user-mask-textarea').value;
                contact.thoughtPreset = document.getElementById('thought-preset-select').value;
                contact.worldBooks = Array.from(document.querySelectorAll('.world-book-checkbox:checked')).map(cb => cb.value);
                contact.isNarrativeMode = document.getElementById('narrative-mode-toggle').checked;

                document.getElementById('contact-settings-screen').style.display = 'none';
                showCharProfileScreen();
                saveState(); 
                alert('ËÅîÁ≥ª‰∫∫ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
            });
             document.getElementById('select-user-persona-preset').addEventListener('change', function() {
                const selectedPresetId = this.value;
                const preset = state.userPersonaPresets.find(p => p.id === selectedPresetId);
                document.getElementById('user-mask-textarea').value = preset ? preset.description : '';
            });
            
            document.getElementById('fetch-models-btn').addEventListener('click', (e) => {
                const apiKey = document.getElementById('api-key-input').value;
                const endpoint = document.getElementById('api-endpoint-input').value.trim();
                fetchModels(endpoint, apiKey, document.getElementById('model-select'), e.currentTarget);
            });
            document.getElementById('fetch-square-models-btn').addEventListener('click', (e) => {
                const apiKey = document.getElementById('square-api-key-input').value;
                const endpoint = document.getElementById('square-api-endpoint-input').value.trim();
                fetchModels(endpoint, apiKey, document.getElementById('square-model-select'), e.currentTarget);
            });

            document.getElementById('save-api-settings-btn').addEventListener('click', () => {
                state.apiSettings.apiKey = document.getElementById('api-key-input').value;
                state.apiSettings.model = document.getElementById('model-select').value;
                state.apiSettings.endpoint = document.getElementById('api-endpoint-input').value.trim();
                state.apiSettings.contextLength = parseInt(document.getElementById('context-length-input').value, 10) || 20;
                alert('ËÅäÂ§©APIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                showDiscoverScreen();
                saveState(); 
            });

            document.getElementById('save-square-api-settings-btn').addEventListener('click', () => {
                state.squareApiSettings.apiKey = document.getElementById('square-api-key-input').value;
                state.squareApiSettings.model = document.getElementById('square-model-select').value;
                state.squareApiSettings.endpoint = document.getElementById('square-api-endpoint-input').value.trim();
                alert('ÂπøÂú∫APIËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ');
                showDiscoverScreen();
                saveState(); 
            });

            document.getElementById('add-world-book-btn').addEventListener('click', () => { editingBookId = null; document.getElementById('world-book-modal-title').textContent = 'Ê∑ªÂä†‰∏ñÁïå‰π¶'; document.getElementById('book-name-input').value = ''; document.getElementById('book-content-input').value = ''; document.getElementById('add-world-book-modal').style.display = 'flex'; });
            document.getElementById('close-world-book-modal').addEventListener('click', () => { document.getElementById('add-world-book-modal').style.display = 'none'; });
            document.getElementById('save-world-book-btn').addEventListener('click', () => {
                const name = document.getElementById('book-name-input').value.trim();
                const content = document.getElementById('book-content-input').value.trim();
                if (!name || !content) return alert('ËØ∑Â°´ÂÜô‰π¶ÂêçÂíåÂÜÖÂÆπ');
                if (editingBookId) {
                    const book = state.worldBooks.find(b => b.id === editingBookId);
                    if (book) { book.name = name; book.content = content; }
                } else {
                    state.worldBooks.push({ id: 'book_' + Date.now(), name, content });
                }
                renderWorldBooks();
                updateWorldBookSelectors();
                document.getElementById('add-world-book-modal').style.display = 'none';
                saveState();
            });

            document.getElementById('add-user-persona-preset-btn').addEventListener('click', () => { editingUserPersonaId = null; document.getElementById('user-persona-modal-title').textContent = 'Ê∑ªÂä†Áî®Êà∑Èù¢ÂÖ∑È¢ÑËÆæ'; document.getElementById('user-persona-name-input').value = ''; document.getElementById('user-persona-description-input').value = ''; document.getElementById('user-persona-preset-modal').style.display = 'flex'; });
            document.getElementById('close-user-persona-preset-modal').addEventListener('click', () => { document.getElementById('user-persona-preset-modal').style.display = 'none'; });
            document.getElementById('save-user-persona-preset-btn').addEventListener('click', () => {
                const name = document.getElementById('user-persona-name-input').value.trim();
                const description = document.getElementById('user-persona-description-input').value.trim();
                if (!name || !description) return alert('ËØ∑Â°´ÂÜôÈù¢ÂÖ∑ÂêçÁß∞ÂíåÊèèËø∞ÔºÅ');
                if (editingUserPersonaId) {
                    const preset = state.userPersonaPresets.find(p => p.id === editingUserPersonaId);
                    if (preset) { preset.name = name; preset.description = description; }
                } else {
                    state.userPersonaPresets.push({ id: 'user_persona_' + Date.now(), name, description });
                }
                saveState();
                renderUserPersonaPresets();
                document.getElementById('user-persona-preset-modal').style.display = 'none';
            });

            document.getElementById('add-thought-preset-btn').addEventListener('click', () => {
                editingThoughtPresetId = null;
                document.getElementById('thought-preset-modal-title').textContent = 'Ê∑ªÂä†ÊÄùÁª¥È¢ÑËÆæ';
                document.getElementById('thought-preset-name-input').value = '';
                document.getElementById('thought-preset-prompt-input').value = '';
                document.getElementById('thought-preset-modal').style.display = 'flex';
            });
            document.getElementById('close-thought-preset-modal').addEventListener('click', () => {
                document.getElementById('thought-preset-modal').style.display = 'none';
            });
            document.getElementById('save-thought-preset-btn').addEventListener('click', () => {
                const name = document.getElementById('thought-preset-name-input').value.trim();
                const prompt = document.getElementById('thought-preset-prompt-input').value.trim();
                if (!name || !prompt) return alert('ËØ∑Â°´ÂÜôÈ¢ÑËÆæÂêçÁß∞ÂíåÊåá‰ª§ÔºÅ');

                if (editingThoughtPresetId) {
                    const preset = state.thoughtPresets.find(p => p.id === editingThoughtPresetId);
                    if (preset) {
                        preset.name = name;
                        preset.prompt = prompt;
                    }
                } else {
                    state.thoughtPresets.push({ id: `tp_${Date.now()}`, name, prompt });
                }
                saveState();
                renderThoughtPresets();
                document.getElementById('thought-preset-modal').style.display = 'none';
            });

            document.getElementById('add-emoticon-btn').addEventListener('click', () => {
                const modal = document.getElementById('add-emoticon-modal');
                const modalBody = modal.querySelector('.modal-body');

                modal.querySelector('#close-emoticon-modal').addEventListener('click', () => modal.style.display = 'none');

                modal.querySelector('.modal-title').textContent = 'ÊâπÈáèÊ∑ªÂä†Ë°®ÊÉÖÂåÖ';
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Ë°®ÊÉÖÂåÖÂàóË°® (ÊØèË°å‰∏Ä‰∏™)</label>
                        <textarea class="form-textarea" id="emoticon-batch-input" placeholder="ÊîØÊåÅÊ†ºÂºè:\n1. URL\n2. ÂêçÂ≠ó URL\n3. URL ÂêçÂ≠ó" style="height: 180px;"></textarea>
                    </div>
                    <button class="form-button" id="save-emoticon-batch-btn">ÂØºÂÖ•Ë°®ÊÉÖ</button>
                `;
                modal.style.display = 'flex';

                document.getElementById('save-emoticon-batch-btn').addEventListener('click', () => {
                    const text = document.getElementById('emoticon-batch-input').value.trim();
                    if (!text) return;
                    const lines = text.split('\n');
                    const newEmoticons = [];
                    let importedCount = 0;
                    lines.forEach((line, index) => {
                        line = line.trim();
                        if (!line) return;
                        const parts = line.split(/\s+/);
                        let url = '';
                        let name = '';
                        const urlIndex = parts.findIndex(p => p.startsWith('http'));
                        if (urlIndex !== -1) {
                            url = parts[urlIndex];
                            parts.splice(urlIndex, 1);
                            name = parts.join(' ').trim();
                        } else {
                            return;
                        }
                        if (!name) {
                            name = `Ë°®ÊÉÖ${state.emoticons.length + newEmoticons.length + 1}`;
                        }
                        newEmoticons.push({
                            id: `emo_${Date.now()}_${index}`,
                            name: name,
                            url: url
                        });
                        importedCount++;
                    });
                    if(newEmoticons.length > 0) {
                        state.emoticons = [...state.emoticons, ...newEmoticons];
                        saveState();
                        renderEmoticonLibrary();
                    }
                    modal.style.display = 'none';
                    alert(`ÊàêÂäüÂØºÂÖ• ${importedCount} ‰∏™Ë°®ÊÉÖÂåÖÔºÅ`);
                });
            });

            document.getElementById('emoji-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const emoticonPicker = document.getElementById('emoticon-picker');
                document.getElementById('attachment-menu').classList.remove('active'); 
                emoticonPicker.classList.toggle('active');
                if(emoticonPicker.classList.contains('active')) {
                    renderEmoticonPicker();
                }
            });

            document.getElementById('attachment-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                 document.getElementById('emoticon-picker').classList.remove('active'); 
                document.getElementById('attachment-menu').classList.toggle('active');
            });

            document.getElementById('attachment-menu').addEventListener('click', (e) => {
                const menuItem = e.target.closest('.attachment-menu-item');
                if (menuItem) {
                    const action = menuItem.dataset.action;
                    if (action) {
                        handleAttachmentAction(action);
                    }
                }
            });

            document.body.addEventListener('click', () => {
                 document.getElementById('emoticon-picker').classList.remove('active');
                 document.getElementById('attachment-menu').classList.remove('active');
            });
            document.getElementById('chat-screen').addEventListener('click', (e) => {
                if(!e.target.closest('#emoji-btn') && !e.target.closest('#emoticon-picker')) {
                    document.getElementById('emoticon-picker').classList.remove('active');
                }
                if(!e.target.closest('#attachment-btn') && !e.target.closest('#attachment-menu')) {
                    document.getElementById('attachment-menu').classList.remove('active');
                }
            });

            document.getElementById('chat-messages').addEventListener('click', (e) => {
                if (editModeState.active) return;
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const wrapper = e.target.closest('.message-wrapper');
                if (!wrapper) return;
                const msgId = wrapper.dataset.messageId;
                const msg = contact.history.find(m => m.id === msgId);
                if (!msg) return;
                const transcribedTextEl = wrapper.querySelector('.transcribed-text');
                if (msg.type === 'voice' || msg.type === 'picture_description') {
                    const textToShow = msg.type === 'voice' ? msg.content.text : msg.content.description;
                    document.querySelectorAll('.transcribed-text.visible').forEach(el => {
                        if (el !== transcribedTextEl) {
                           el.classList.remove('visible');
                           el.textContent = '';
                        }
                    });
                    if (transcribedTextEl.classList.contains('visible')) {
                        transcribedTextEl.classList.remove('visible');
                        transcribedTextEl.textContent = '';
                    } else {
                        transcribedTextEl.textContent = textToShow;
                        transcribedTextEl.classList.add('visible');
                    }
                } 
                else if (msg.type === 'red_packet') {
                    showRedPacketModal(msg, contact);
                }
                else if (msg.type === 'transfer') {
                    showTransferModal(msg, contact);
                }
            });

            document.getElementById('close-send-picture-modal').addEventListener('click', () => document.getElementById('send-picture-modal').style.display = 'none');
            document.getElementById('close-send-voice-modal').addEventListener('click', () => document.getElementById('send-voice-modal').style.display = 'none');
            document.getElementById('close-send-red-packet-modal').addEventListener('click', () => document.getElementById('send-red-packet-modal').style.display = 'none');
            document.getElementById('close-send-transfer-modal').addEventListener('click', () => document.getElementById('send-transfer-modal').style.display = 'none');
            
            document.getElementById('feed-tabs-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('feed-tab-btn')) {
                    state.activeFeedTab = e.target.dataset.tab;
                    renderFeed();
                }
            });
            document.getElementById('feed-sub-tabs-container').addEventListener('click', (e) => {
                 if (e.target.classList.contains('feed-sub-tab-btn')) {
                    state.activeFeedSubTab = e.target.dataset.subtab;
                    renderFeed();
                }
            });

            document.getElementById('moments-content').addEventListener('click', (e) => {
                const postItem = e.target.closest('.post-item');
                const trendingItem = e.target.closest('.trending-item');
                const deleteBtn = e.target.closest('.post-delete-btn');

                if(deleteBtn) {
                     e.stopPropagation();
                     if(confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Â∏ñÂ≠êÂêóÔºü')) {
                        const postId = deleteBtn.dataset.postId;
                        state.posts = state.posts.filter(p => p.id !== postId);
                        saveState();
                        renderFeed();
                    }
                    return;
                }

                if (postItem) {
                    showPostDetailScreen(postItem.dataset.postId);
                } else if (trendingItem) {
                    showTrendingTopicScreen(trendingItem.dataset.topicTitle);
                }
            });

            document.getElementById('trending-topic-screen').addEventListener('click', (e) => {
                const postItem = e.target.closest('.post-item');
                if (postItem) {
                     showPostDetailScreen(postItem.dataset.postId);
                }
            });

            document.getElementById('refresh-feed-btn').addEventListener('click', async () => {
                const apiConfig = getApiFor('square');
                if (!apiConfig.apiKey || !apiConfig.endpoint) {
                    alert('ËØ∑ÂÖàÂú®‚ÄúÂèëÁé∞ -> ÂπøÂú∫APIËÆæÁΩÆ‚Äù‰∏≠ÈÖçÁΩÆAPI„ÄÇ');
                    return;
                }
                
                try {
                    if (state.activeFeedTab === 'trending') {
                        showFeedStatus('Ê≠£Âú®Âà∑Êñ∞ÁÉ≠ÊêúÊ¶ú...');
                        await generateRandomTrendingTopicsAI();
                    } else if (state.activeFeedTab === 'recommended') {
                        showFeedStatus('Ê≠£Âú®Âà∑Êñ∞Êé®ËçêÂÜÖÂÆπ...');
                        await generatePostsForRecommendedTab(5);
                    } else { // 'following' tab
                        showFeedStatus('Ê≠£Âú®Âà∑Êñ∞ÂÖ≥Ê≥®ÂÜÖÂÆπ...');
                        await generatePostsForRecommendedTab(2);
                    }
                    renderFeed();
                } catch(e) {
                    console.error("Âà∑Êñ∞Â§±Ë¥•:", e);
                    alert("Âà∑Êñ∞Â§±Ë¥•: " + e.message);
                } finally {
                    hideFeedStatus();
                }
            });
            
            const commentInput = document.getElementById('comment-input');
            commentInput.addEventListener('blur', () => {
                if (commentInput.value.trim() === '' && activeReplyTarget) {
                    activeReplyTarget = null;
                    commentInput.placeholder = 'Áïô‰∏ã‰Ω†ÁöÑÁ≤æÂΩ©ËØÑËÆ∫Âêß...';
                }
            });

            document.getElementById('submit-comment-btn').addEventListener('click', () => {
                const input = document.getElementById('comment-input');
                const content = input.value.trim();
                if (!content) return;

                const post = state.posts.find(p => p.id === state.activePostId);
                if (post) {
                     const newComment = {
                        id: `comment_${Date.now()}`,
                        author: { id: 'myProfile', name: state.myProfile.name, avatar: state.myProfile.avatar },
                        content: content,
                        timestamp: Date.now(),
                        replyTo: activeReplyTarget ? activeReplyTarget.name : null,
                    };
                    post.comments.push(newComment);
                    input.value = '';
                    
                    activeReplyTarget = null;
                    input.placeholder = 'Áïô‰∏ã‰Ω†ÁöÑÁ≤æÂΩ©ËØÑËÆ∫Âêß...';

                    saveState();
                    renderPostDetail();
                    
                    triggerAiCommentDiscussion(post, newComment);
                }
            });
            
             document.getElementById('comments-list').addEventListener('click', (e) => {
                const commentItem = e.target.closest('.post-comment-item');
                if (!commentItem) return;

                const deleteBtn = e.target.closest('.comment-delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const commentId = deleteBtn.dataset.commentId;
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºü')) {
                        const post = state.posts.find(p => p.id === state.activePostId);
                        if(post) {
                            post.comments = post.comments.filter(c => c.id !== commentId);
                            saveState();
                            renderPostDetail();
                        }
                    }
                    return;
                }
                
                if (!e.target.closest('a, .mention, .comment-delete-btn')) {
                    const authorName = commentItem.dataset.authorName;
                    const authorId = commentItem.dataset.authorId;
                    
                    if (authorId === 'myProfile') return;

                    activeReplyTarget = { name: authorName, id: authorId };
                    const commentInput = document.getElementById('comment-input');
                    commentInput.placeholder = `ÂõûÂ§ç @${authorName}`;
                    commentInput.focus();
                }
            });

            document.getElementById('post-moment-btn').addEventListener('click', () => { document.getElementById('moment-content-input').value = ''; document.getElementById('post-moment-modal').style.display = 'flex'; });
            document.getElementById('close-post-moment-modal').addEventListener('click', () => { document.getElementById('post-moment-modal').style.display = 'none'; });
            document.getElementById('publish-moment-btn').addEventListener('click', () => {
                const content = document.getElementById('moment-content-input').value.trim();
                if (!content) return alert('ËØ∑ËæìÂÖ•Â∏ñÂ≠êÂÜÖÂÆπÔºÅ');
                const category = document.getElementById('post-category-select').value;

                state.posts.unshift({ 
                    id: 'post_' + Date.now(), 
                    author: { id: 'myProfile', name: state.myProfile.name, avatar: state.myProfile.avatar }, 
                    content, 
                    timestamp: Date.now(), 
                    likes: [], 
                    comments: [], 
                    reposts: 0, 
                    category: category 
                });
                saveState();
                state.activeFeedTab = 'recommended';
                state.activeFeedSubTab = category;
                showFeedScreen();
                document.getElementById('post-moment-modal').style.display = 'none';
            });

            document.getElementById('screen').addEventListener('click', e => {
                const mentionSpan = e.target.closest('.mention');
                if (mentionSpan) {
                    e.stopPropagation(); 
                    const userName = mentionSpan.textContent.substring(1);
                    alert(`Tapped on user: @${userName}`);
                }
            });
            
        }

        attachEventListeners();
        initApp();
    });
</script>
</body>
</html>
