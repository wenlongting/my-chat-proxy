<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>koko小手机</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
@import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        :root {
            --theme-primary: #81c784;
            --theme-primary-hover: #66bb6a;
            --theme-secondary: #aed581;
            --sent-message-bg: #e6f5c9;
            --background-start: #f1f8e9;
            --background-end: #ffffff;
            --text-on-primary: #ffffff;
            --text-dark: #424242;
            --text-gray: #757575;
            --soft-red: #ff8a80;
            --border-color: #e8e8e8;
            --shadow-color: rgba(129, 199, 132, 0.12);
            --soft-radius: 16px;
            --card-background: rgba(255, 255, 255, 0.7);
        }
        
       /* --- 您新增的叙事模式美化样式 --- */
.narrative-speech {
    background-color: #e6f5c9; /* 清新的青苹果色背景 (来自您已有的 --sent-message-bg 变量) */
    padding: 2px 8px;
    border-radius: 8px;
    display: inline-block;
    margin: 1px 0;
}

.narrative-psychology {
    text-decoration: underline;
    text-decoration-color: #66bb6a; /* 青苹果色下划线 (来自您已有的 --theme-primary 变量) */
    text-decoration-thickness: 2px;
}

.narrative-action {
    font-style: italic;
    color: #517655; /* 深一点的青苹果色 (来自您已有的 --theme-primary-hover 变量) */
} 
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-image: linear-gradient(to bottom, var(--background-start), var(--background-end));
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        #app-container, #screen {
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        
        #screen {
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 5px 25px var(--shadow-color);
        }
        
        .chat-header {
            background-color: rgba(129, 199, 132, 0.75);
            backdrop-filter: blur(12px);
            color: var(--text-on-primary);
            padding: 8px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
            flex-shrink: 0;
        }

        .chat-header .back-btn,
        .chat-header .action-btn {
            color: var(--text-on-primary);
        }

        .app-header, .world-book-header, .api-header, .moments-header, .discover-header, .contact-settings-header {
            background-color: rgba(220, 237, 200, 0.7);
            backdrop-filter: blur(12px);
            color: var(--text-dark);
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            z-index: 10;
            flex-shrink: 0;
        }
        
        .chat-input-area {
            background-color: #f8f9fa;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            position: relative;
        }
        
        #message-input {
            flex-grow: 1;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
            align-self: flex-end;
            min-height: 42px;
        }

        .input-action-btn {
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 8px;
            cursor: pointer;
            font-size: 20px;
            flex-shrink: 0;
            transition: transform 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            align-self: flex-end;
        }
        .input-action-btn:hover {
            transform: scale(1.1);
        }

        #send-btn {
            background-color: var(--theme-primary);
            color: var(--text-on-primary);
            width: auto;
            padding: 0 18px;
            border-radius: 22px;
        }
        #send-btn .fa-paper-plane {
            font-size: 18px;
        }

        #request-reply-btn {
            background-color: var(--theme-secondary);
            color: var(--text-on-primary);
        }
        
        #chat-screen {
            background-image: url('https://i.postimg.cc/SQ3DH79X/MEITU-20250811-151831796.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
        }
        
        #main-screen { height: 100%; display: flex; flex-direction: column; }
        .app-title { font-size: 20px; font-weight: 700; }
        .contacts-container { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .section-title { padding: 10px 15px; font-size: 14px; color: var(--text-gray); background-color: transparent; font-weight: 600; }
        .contact-item { display: flex; align-items: center; padding: 12px 15px; background-color: transparent; border-bottom: 1px solid var(--border-color); border-radius: var(--soft-radius); margin: 0 8px 4px; cursor: pointer; transition: background-color 0.2s; }
        .contact-item:hover { background-color: rgba(255, 255, 255, 0.7); }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; margin-right: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--text-gray); overflow: hidden; flex-shrink: 0; }
        .contact-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .contact-info { flex-grow: 1; min-width: 0; }
        .contact-name { font-weight: 600; margin-bottom: 3px; color: var(--text-dark); }
        .contact-last-message { font-size: 14px; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .contact-time { font-size: 12px; color: #999; margin-top: 5px; }
        .unread-count { background-color: var(--theme-primary); color: var(--text-on-primary); font-size: 12px; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .bottom-nav { display: flex; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); padding: 10px 0; flex-shrink: 0; }
        .nav-item { flex: 1; text-align: center; color: var(--text-gray); font-size: 14px; cursor: pointer; transition: color 0.2s, transform 0.2s; }
        .nav-item-content { position: relative; display: inline-block; }
        .nav-item.active { color: var(--theme-primary); transform: scale(1.1); }
        .nav-icon { font-size: 20px; margin-bottom: 5px; }
        .notification-dot { position: absolute; top: -2px; right: -8px; width: 8px; height: 8px; background-color: var(--soft-red); border-radius: 50%; border: 1px solid white; display: none; }
        .back-btn { font-size: 24px; cursor: pointer; margin-right: 15px; }
        .chat-info { flex-grow: 1; text-align: center; }
        .chat-name { font-weight: 700; font-size: 18px; }
        .chat-status { font-size: 13px; opacity: 0.8; }
        .chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        #load-more-messages { background-color: #e0e0e0; color: #555; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; margin: 0 auto 15px; font-size: 13px; display: none; }
        #load-more-messages:hover { background-color: #d1d1d1; }
        .message-wrapper { display: flex; max-width: 85%; margin-bottom: 2px; position: relative; }
        .message-wrapper.received { align-self: flex-start; flex-direction: row; }
        .message-wrapper.sent { align-self: flex-end; flex-direction: row-reverse; }
        .message-avatar { width: 40px; height: 40px; border-radius: 6px; flex-shrink: 0; visibility: hidden; }
        .is-first-in-sequence .message-avatar { visibility: visible; margin-top: 10px; }
        .message-avatar img { width: 100%; height: 100%; border-radius: 6px; object-fit: cover; }
        .message-body { display: flex; flex-direction: column; margin: 0 10px; }
        .message-wrapper.sent .message-body { align-items: flex-end; }
        .message-wrapper.received .message-body { align-items: flex-start; }
        .message-author-name { font-size: 13px; color: #888; margin-bottom: 4px; display: none; }
        .is-first-in-sequence .message-author-name { display: block; margin-top: 10px;}
        .message { padding: 10px 18px; border-radius: 22px; position: relative; animation: fadeIn 0.3s ease; word-wrap: break-word; min-width: 50px; box-shadow: 0 2px 4px var(--shadow-color); }
        .message-timestamp { font-size: 11px; color: #aaa; margin-top: 4px; padding: 0 5px; }
        .message-wrapper.selected .message, .message-wrapper.selected .message.red-packet, .message-wrapper.selected .message.voice, .message-wrapper.selected .message.picture-description { background-color: #bde0fe !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.received { background-color: white; border-top-left-radius: 4px; }
        .message.sent { background-color: var(--sent-message-bg); border-top-right-radius: 4px; }
        .message-image-container { padding: 5px; background-color: inherit; border-radius: inherit; }
        .message-image { max-width: 150px; max-height: 150px; border-radius: 12px; display: block; cursor: default; }
        .message-image-container.sent { border-top-right-radius: 4px; }
        .message-image-container.received { border-top-left-radius: 4px; }
        .message.image-message { padding: 0; background-color: transparent; box-shadow: none; }
        .emoji-btn, .attachment-btn { font-size: 24px; margin-right: 10px; cursor: pointer; color: var(--text-gray); align-self: flex-end; margin-bottom: 10px; }
        .attachment-btn { background: none; border: none; padding: 0; }
        #edit-mode-bar, #moments-edit-mode-bar { display: none; padding: 10px 15px; background-color: #f0f0f0; border-top: 1px solid #ddd; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .edit-action-btn { padding: 8px 16px; border-radius: 20px; border: none; font-size: 14px; cursor: pointer; }
        #delete-selected-btn, #delete-selected-moments-btn { background-color: var(--soft-red); color: white; }
        #cancel-edit-btn, #cancel-moments-edit-btn { background-color: #bdc3c7; color: #333; }
        #profile-screen, #char-profile-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        
        .profile-header {
            background-image: linear-gradient(135deg, var(--sent-message-bg), #dcedc8);
            padding: 30px 20px 15px;
            text-align: center;
            color: var(--text-dark);
            position: relative;
            flex-shrink: 0;
        }
        .avatar-container {
            position: relative;
            margin: 0 auto 15px;
            width: 100px;
            height: 100px;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .change-avatar-btn {
            position: absolute;
            bottom: 0;
            right: 0;
            background-color: rgba(255, 255, 255, 0.7);
            color: var(--text-dark);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .profile-name { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .profile-status { font-size: 16px; opacity: 0.9; }
        .profile-actions { display: flex; justify-content: center; gap: 20px; padding: 10px 0; background-color: white; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .action-item { text-align: center; cursor: pointer; }
        .action-icon { width: 50px; height: 50px; border-radius: 50%; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--theme-primary); margin: 0 auto 10px; transition: all 0.3s; }
        .action-icon:hover { background-color: #e0f2f1; transform: scale(1.05); }
        .action-label { font-size: 14px; color: var(--text-gray); }
        .profile-details { flex-grow: 1; overflow-y: auto; padding: 10px; background-color: #f0f2f5; }
        .detail-item { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background-color: white; }
        .detail-item:last-child { border-bottom: none; }
        .discover-section .detail-item { border-radius: 0; margin-bottom: 0; }
        .discover-section .detail-item:first-child { border-top-left-radius: var(--soft-radius); border-top-right-radius: var(--soft-radius); }
        .discover-section .detail-item:last-child { border-bottom-left-radius: var(--soft-radius); border-bottom-right-radius: var(--soft-radius); border-bottom: none; }
        .detail-label { font-size: 16px; color: #333; font-weight: 600; }
        .detail-value { font-size: 16px; color: var(--text-gray); max-width: 60%; text-align: right; overflow: hidden; text-overflow: ellipsis; }
        .edit-btn { color: var(--theme-primary); font-size: 18px; cursor: pointer; padding: 5px; }
        #discover-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .discover-title { font-size: 20px; font-weight: 700; flex-grow: 1; text-align: center; margin-left: 0; }
        .discover-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .discover-section { background-color: var(--card-background); border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px;}
        .discover-item { padding: 15px; display: flex; align-items: center; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; background-color: transparent; }
        .discover-item:last-child { border-bottom: none; }
        .discover-item:hover { background-color: rgba(255,255,255,0.5); }
        .discover-icon { width: 40px; height: 40px; border-radius: 8px; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--theme-primary); margin-right: 15px; }
        .discover-info { flex-grow: 1; }
        .discover-name { font-weight: 600; margin-bottom: 3px; }
        .discover-desc { font-size: 14px; color: var(--text-gray); }
        .discover-arrow { color: #999; font-size: 18px; }
        #world-book-screen, #api-settings-screen, #contact-settings-screen, #moments-screen, #diary-screen, #emoticon-library-screen, .preset-management-screen, #post-detail-screen, #trending-topic-screen, #square-api-settings-screen, #memory-album-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: transparent; display: none; flex-direction: column; }
        .world-book-content, .api-content, .contact-settings-content, .emoticon-library-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .world-book-list { display: flex; flex-direction: column; gap: 15px; }
        .world-book-item { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;}
        .world-book-item:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-color); }
        .book-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0; }
        .book-name { font-weight: 600; font-size: 18px; }
        .book-content { color: var(--text-gray); line-height: 1.5; white-space: pre-wrap; word-break: break-all; }
        .api-title { font-size: 20px; font-weight: 600; margin-left: 15px; }
        .form-group { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: var(--theme-primary); }
        .form-button { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .form-group-inline .form-input { flex-grow: 1; }
        #fetch-models-btn, #fetch-square-models-btn { padding: 10px 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; flex-shrink: 0; }
        #add-world-book-modal, #post-moment-modal, #user-persona-preset-modal, #thought-preset-modal, #add-emoticon-modal, #automation-modal, #send-red-packet-modal, #send-transfer-modal, #send-voice-modal, #send-picture-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background-color: white; width: 90%; max-width: 400px; border-radius: var(--soft-radius); overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background-color: var(--theme-primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn { font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .form-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .form-button:hover { background-color: var(--theme-primary-hover); }
        #add-contact-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .contact-form-group { margin-bottom: 20px; }
        .contact-form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .contact-form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .contact-form-input:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .contact-form-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .contact-form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background-color: white; }
        .contact-form-select:focus { outline: none; border-color: var(--theme-primary); }
        .mask-editor, .world-book-selector { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .mask-editor-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .mask-editor-group { margin-bottom: 15px; }
        .mask-editor-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-gray); }
        .mask-editor-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .mask-editor-textarea:focus { outline: none; border-color: var(--theme-primary); }
        .world-book-selector-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .world-book-selector .world-book-list { max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; }
        #world-book-selector-list .world-book-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
        .world-book-checkbox { margin-right: 10px; }
        .world-book-name { font-weight: 500; }
        .save-settings-btn { width: 100%; padding: 15px; background-color: var(--theme-primary); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        .user-mask-editor { background-color: white; border-radius: var(--soft-radius); box-shadow: 0 4px 12px var(--shadow-color); border: 1px solid white; margin-bottom: 20px; padding: 15px;}
        .user-mask-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: var(--theme-primary); }
        .user-mask-textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical; }
        .user-mask-textarea:focus { outline: none; border-color: var(--theme-primary); }
        
        /* ---广场/微博 样式--- */
        .moments-header .back-btn { font-size: 24px; cursor: pointer; position: relative; z-index: 1; }
        .moments-header .action-btn { font-size: 20px; }
        .header-actions { display: flex; gap: 20px; position: relative; z-index: 1; }
        .moments-content { flex-grow: 1; overflow-y: auto; background-color: #f0f2f5; }
        .mention {
    color: var(--theme-primary);
    font-weight: 600;
    cursor: pointer;
}
.mention:hover {
    text-decoration: underline;
}
        .feed-tabs { display: flex; justify-content: space-around; padding: 0 10px; background-color: #e8f5e9; flex-shrink: 0; }
        .feed-tab-btn { flex: 1; padding: 12px 0; font-size: 16px; font-weight: 600; color: var(--text-gray); border: none; background: none; cursor: pointer; position: relative; transition: color 0.3s; }
        .feed-tab-btn.active { color: var(--theme-primary); }
        .feed-tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 10%; right: 10%; height: 3px; background-color: var(--theme-primary); border-radius: 3px; }

        .feed-sub-tabs { display: flex; justify-content: center; gap: 15px; padding: 8px 10px; background-color: #fafafa; flex-shrink: 0; border-bottom: 1px solid #eee; }
        .feed-sub-tab-btn { padding: 6px 14px; font-size: 14px; font-weight: 500; color: var(--text-gray); border: 1px solid #ddd; background-color: white; border-radius: 18px; cursor: pointer; transition: all 0.3s; }
        .feed-sub-tab-btn.active { color: white; background-color: var(--theme-primary); border-color: var(--theme-primary); }

        .posts-list { padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .post-item { position: relative; display: flex; padding: 15px; gap: 12px; background-color: white; border-radius: var(--soft-radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer;}
        .post-delete-btn { position: absolute; top: 10px; right: 10px; width: 28px; height: 28px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-gray); font-size: 14px; cursor: pointer; z-index: 2; transition: all 0.2s; }
        .post-delete-btn:hover { background-color: var(--soft-red); color: white; }

        .post-item-avatar img { width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; }
        .post-content-area { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
        .post-author-name { font-weight: 700; color: var(--text-dark); }
        .post-author-handle { font-size: 14px; color: var(--text-gray); margin-left: 8px; }
        .post-text { line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-size: 15px; }
        .post-meta { color: #999; font-size: 13px; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; color: var(--text-gray); font-size: 14px; margin-top: 12px; padding-top: 8px; border-top: 1px solid #f0f0f0; }
        .post-action-btn { cursor: pointer; display: flex; align-items: center; gap: 6px; transition: color 0.2s; }
        .post-action-btn:hover, .post-action-btn.liked { color: var(--theme-primary); }
        .post-action-btn.liked .fa-heart { font-weight: 900; }
        .post-action-btn i { font-size: 16px; }

        .post-comments { background-color: #f7f9f9; border-radius: 10px; padding: 10px; font-size: 14px; display: flex; flex-direction: column; gap: 8px; margin-top: 5px; }
        .post-comments:empty { display: none; }
        
        .comment-delete-btn { color: var(--text-gray); font-size: 12px; cursor: pointer; opacity: 0; transition: all 0.2s; }
        .comment-delete-btn:hover { color: var(--soft-red); }
        .post-comment-item:hover .comment-delete-btn { opacity: 1; }

        .post-comment-item { line-height: 1.5; padding: 8px 0; border-bottom: 1px solid #eee; }
        .post-comment-item:last-child { border-bottom: none; }
        .comment-author { font-weight: 600; color: var(--theme-primary); margin-right: 5px; cursor: pointer; }
        .comment-content { color: var(--text-dark); }
        .comment-meta { display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--text-gray); margin-top: 4px; }
        .comment-reply-to { background-color: #e9e9e9; padding: 4px 8px; border-radius: 8px; font-size: 13px; margin-left: 5px; }
        /* --- 新增：用于在帖子中显示作者签名 --- */
.post-author-signature {
    font-size: 13px;
    color: var(--text-gray);
    margin-top: 4px; /* 与昵称拉开一点距离 */
    padding-bottom: 8px; /* 与帖子正文拉开一点距离 */
    white-space: pre-wrap; /* 允许签名中的换行 */
    word-break: break-word;
}


        /* 热搜榜样式 */
        .trending-list { list-style: none; padding: 10px; background-color: white;}
        .trending-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .trending-item:hover { background-color: #f9f9f9; }
        .trending-item:last-child { border-bottom: none; }
        .trending-rank { font-size: 18px; font-weight: bold; color: var(--text-gray); width: 40px; text-align: center; }
        .trending-rank.top-3 { color: var(--soft-red); }
        .trending-info { flex-grow: 1; }
        .trending-title { font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px; }
        .trending-meta { font-size: 13px; color: var(--text-gray); }
        .trending-tag { background-color: #ffcdd2; color: #c62828; font-size: 11px; padding: 2px 6px; border-radius: 5px; margin-left: 8px; font-weight: bold; }
        
        #post-detail-screen { background-color: #f0f2f5; }
        .post-detail-content { flex-grow: 1; overflow-y: auto; }
        #post-detail-container { padding: 0; }
        #post-detail-container .post-item { cursor: default; }
        .comments-section { padding: 15px; background-color: #f0f2f5; }
        .comments-title { font-size: 16px; font-weight: 700; color: var(--text-dark); padding-bottom: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; }
        .comment-input-area { display: flex; padding: 10px 15px; background-color: white; border-top: 1px solid #ddd; flex-shrink: 0; }
        #comment-input { flex-grow: 1; border: 1px solid #ddd; border-radius: 18px; padding: 8px 15px; font-size: 15px; resize: none; }
        #submit-comment-btn { background-color: var(--theme-primary); color: white; border: none; border-radius: 18px; padding: 8px 20px; margin-left: 10px; font-weight: 600; cursor: pointer; }
        
        .diary-entry {
            position: relative;
            background-color: white;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .diary-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .diary-entry-meta { font-size: 12px; color: #999; margin-bottom: 10px; }
        .diary-entry-content { font-size: 16px; line-height: 1.6; color: #333; }
        .diary-delete-btn { position: absolute; top: 15px; right: 15px; font-size: 18px; color: #aaa; cursor: pointer; transition: color 0.2s ease; }
        .diary-delete-btn:hover { color: var(--soft-red); }
        .preset-list { display: flex; flex-direction: column; gap: 10px; padding: 15px 20px; }
        .preset-item { background-color: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); display: flex; justify-content: space-between; align-items: center; }
        .preset-info { flex-grow: 1; cursor: pointer; min-width: 0; margin-right: 10px; }
        .preset-name { font-weight: 500; font-size: 16px; color: #333; margin-bottom: 5px; }
        .preset-desc { font-size: 13px; color: var(--text-gray); overflow: hidden; text-overflow: ellipsis; white-space: pre-wrap; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .preset-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .preset-action-btn { font-size: 18px; color: #999; cursor: pointer; padding: 5px; }
        .preset-action-btn:hover { color: var(--theme-primary); }
        .preset-action-btn.delete:hover { color: var(--soft-red); }
        .emoticon-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .emoticon-item { background-color: #fff; border-radius: 8px; padding: 8px; box-shadow: 0 1px 3px var(--shadow-color); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .emoticon-item img { max-width: 100%; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .emoticon-name { font-size: 12px; color: #333; text-align: center; word-break: break-all; }
        .emoticon-delete-btn { position: absolute; top: -5px; right: -5px; background-color: var(--soft-red); color: white; width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; line-height: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #emoticon-picker { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); max-height: 250px; overflow-y: auto; padding: 10px; display: none; z-index: 50; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; }
        #emoticon-picker.active { display: grid; }
        #emoticon-picker .emoticon-item { cursor: pointer; transition: transform 0.2s; }
        #emoticon-picker .emoticon-item:hover { transform: scale(1.1); }
        #emoticon-picker .emoticon-delete-btn { display: none; }
        #feed-status-indicator {
            padding: 10px;
            text-align: center;
            background-color: #e8f5e9;
            color: var(--text-gray);
            font-size: 14px;
            display: none;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            order: 1; /* 确保它在header下面 */
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: var(--theme-primary); }
        input:focus + .slider { box-shadow: 0 0 1px var(--theme-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .slider.round { border-radius: 28px; }
        .slider.round:before { border-radius: 50%; }
        #attachment-menu { position: absolute; bottom: 65px; left: 10px; right: 10px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); padding: 15px; display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; z-index: 50; transition: opacity 0.2s ease, transform 0.2s ease; transform: translateY(10px); opacity: 0; }
        #attachment-menu.active { display: grid; transform: translateY(0); opacity: 1; }
        .attachment-menu-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-align: center; }
        .attachment-menu-item .icon-wrapper { width: 60px; height: 60px; background-color: white; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px; color: #555; margin-bottom: 8px; border: 1px solid #eee; }
        .attachment-menu-item .label { font-size: 13px; color: var(--text-gray); }
        .attachment-menu-item:hover .icon-wrapper { background-color: #f0f0f0; }
        .system-notification { align-self: center; background-color: #e1e1e1; color: var(--text-gray); font-size: 12px; padding: 5px 12px; border-radius: 15px; margin: 10px 0; text-align: center; }
        .message.picture-description { display: flex; align-items: center; cursor: pointer; }
        .message.sent.picture-description { background-color: var(--sent-message-bg); }
        .message.received.picture-description { background-color: #fff; }
        .message.picture-description i { font-size: 20px; color: var(--text-gray); margin-right: 10px; }
        .message.picture-description span { color: #333; }
        .message.voice { display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .message.voice .fa-wifi { font-size: 20px; transform: rotate(90deg); color: var(--text-gray); }
        .message.sent.voice { background-color: var(--sent-message-bg); }
        .message.received.voice { background-color: #fff; }
        .message.sent.voice .fa-wifi { order: 2; margin-left: 15px; }
        .message.received.voice .fa-wifi { margin-right: 15px; }
        .voice-duration { color: var(--text-gray); }
        .transcribed-text { background-color: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 14px; color: #333; max-height: 0; opacity: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin-top 0.3s ease-out; }
        .transcribed-text.visible { max-height: 200px; opacity: 1; }
        .message.red-packet { background-color: #FFCC80; color: #5D4037; width: 240px; padding: 0; overflow: hidden; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 5px rgba(255, 152, 0, 0.2); }
        .message.red-packet.opened { background-color: #FFF3E0; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05); }
        .message.red-packet .red-packet-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.red-packet .red-packet-icon { font-size: 24px; margin-right: 10px; color: #FFA726; }
        .message.red-packet .red-packet-blessing { font-size: 15px; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
        .message.red-packet .red-packet-status { font-size: 13px; opacity: 0.9; }
        .message.red-packet.opened .red-packet-icon, .message.red-packet.opened .red-packet-blessing, .message.red-packet.opened .red-packet-status { color: #BCAAA4; }
        .message.red-packet .red-packet-footer { background-color: transparent; color: #A1887F; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(161, 136, 127, 0.2); }
        .message.red-packet.opened .red-packet-footer { color: #cebeba; border-top: 1px solid rgba(161, 136, 127, 0.1); }
        .message.sent.red-packet { border-top-right-radius: 0; }
        .message.received.red-packet { border-top-left-radius: 0; }
        .message.transfer { background-color: var(--theme-primary); color: white; width: 240px; padding: 0; overflow: hidden; position: relative; box-shadow: 0 2px 5px var(--shadow-color); }
        .message.transfer.completed { background-color: #C8E6C9; }
        .message.transfer.completed .transfer-info .transfer-text, .message.transfer.completed .transfer-info .transfer-amount { color: #388E3C; }
        .message.transfer.completed .transfer-icon i { color: var(--theme-primary-hover); }
        .message.transfer.completed::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 18px; color: var(--theme-primary-hover); }
        .message.transfer .transfer-header { padding: 10px 15px; display: flex; align-items: center; }
        .message.transfer .transfer-icon { font-size: 24px; margin-right: 10px; }
        .message.transfer .transfer-info .transfer-text { font-size: 15px; font-weight: 500; }
        .message.transfer .transfer-info .transfer-amount { font-size: 18px; font-weight: bold; }
        .message.transfer .transfer-footer { background-color: transparent; color: white; font-size: 12px; padding: 5px 15px; border-top: 1px solid rgba(255,255,255,0.3); opacity: 0.9; }
        .message.transfer.completed .transfer-footer { color: var(--theme-primary-hover); border-top: 1px solid rgba(102, 187, 106, 0.2); }
        .message.sent.transfer { border-top-right-radius: 0; }
        .message.received.transfer { border-top-left-radius: 0; }

        /* --- Pet Game Styles --- */
        #pet-container {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .pet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        #pet-name {
            color: var(--text-dark);
        }
        #pet-gold-display {
            font-size: 16px;
            color: #E6A23C;
        }
        .pet-visual-area {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            margin-bottom: 15px;
        }
        .pet-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .stat-bar-label {
            width: 60px;
            text-align: right;
        }
        .stat-bar {
            flex-grow: 1;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        .stat-bar-inner {
            height: 100%;
            width: 100%;
            border-radius: 5px;
            background-color: var(--theme-primary);
            transition: width 0.3s ease, background-color 0.3s ease;
        }
        .pet-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .pet-action-btn {
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f0f2f5;
            color: var(--text-dark);
        }
        .pet-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .pet-action-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #work-pet-btn {
            background-color: var(--theme-secondary);
            color: white;
        }
        
        .slime {
    width: 60px; /* 宽度设为55px */
    height: 40px; /* 高度设为40px，这样基础形状更稳定 */
    /* 背景色和半透明效果保持不变 */
    background-color: rgba(209, 233, 206, 0.8); 
    
    /* 核心修改：只设置左上角和右上角的圆角，让底部保持平坦 */
    /* 这四个值分别对应：左上、右上、右下、左下 */
    border-radius: 60px 60px 20px 20px; 

    position: relative;
    animation: slime-bob 2s infinite ease-in-out;
    transition: all 0.5s ease;
    
    /* 边框效果保持不变 */
    border: 2px solid rgba(76, 175, 80, 0.5);
    /* 新增：移除底部边框线，让它完美地“贴”在地面上 */
    border-bottom: none; 
    
    /* 内阴影果冻质感保持不变 */
    box-shadow: inset 0 -4px 8px rgba(0, 0, 0, 0.15), 
                inset 0 4px 6px rgba(255, 255, 255, 0.4);
}
        .slime.hungry { background-color: #ffb74d; }
        .slime.dirty { background-color: #bdbdbd; }
        .slime::before {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            left: 15px;
            transition: all 0.5s ease;
        }
        .slime::after {
            content: '';
            position: absolute;
            width: 6px;
            height: 6px;
            background-color: #212121;
            border-radius: 50%;
            top: 15px;
            right: 15px;
            transition: all 0.5s ease;
        }
        .slime-shadow {
            width: 50px;
            height: 8px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 50%;
            margin-top: 5px;
            animation: slime-shadow-squish 2s infinite ease-in-out;
            transition: all 0.5s ease;
        }
        @keyframes slime-bob {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes slime-shadow-squish {
             0%, 100% { transform: scaleX(1); }
            50% { transform: scaleX(0.8); }
        }

        /* --- V6.0 新增：宠物进化形态 --- */
        /* 初始宝宝期形态 */
        .slime.baby-form { }

        /* 幼年期 */
        .slime.toddler-form {
            transform: scale(1.15); /* 长大一点 */
            background-color: #a5d6a7; /* 颜色变嫩一点 */
        }
        .slime.toddler-form::before, 
        .slime.toddler-form::after {
            width: 7px; /* 眼睛变大一点 */
            height: 7px;
            box-shadow: 0 0 2px rgba(255, 255, 255, 0.6); /* 眼睛里有光 */
        }

        /* 少年期，眼睛变成 > < 的样子*/
        .slime.teenager-form {
            transform: scale(1.25);
            animation-duration: 1.5s; /* 变得更活泼，跳得快一点 */
        }
        .slime.teenager-form::before { /* 左眼 */
            content: '>';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(-15deg);
            top: 18px;
            left: 18px;
        }
        .slime.teenager-form::after { /* 右眼 */
            content: '<';
            font-weight: bold;
            color: white;
            background: none;
            font-size: 12px;
            line-height: 1;
            transform: rotate(15deg);
            top: 18px;
            right: 18px;
        }

        /* --- 新增：用于隐藏思维预设的编辑功能 --- */
        /* 1. 隐藏“思维预设管理”页面右上角的“+”添加按钮 */
        #add-thought-preset-btn {
            display: none;
        }

        /* 2. 隐藏每个思维预设项目右侧包含“编辑”和“删除”图标的整个操作区 */
        #thought-presets-list .preset-actions {
            display: none;
        }
         </style>
</head>
<body>
    <div id="app-container">
        <div id="screen">
            <div id="main-screen">
                <div class="app-header">
                    <div class="app-title">聊天</div>
                    <div>
                        <i class="fas fa-user-plus action-btn" id="add-contact-btn"></i>
                    </div>
                </div>
                
                <div class="contacts-container">
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item active" id="nav-chat">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="chat-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-chat">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name" id="chat-contact-name"></div>
                        <div class="chat-status" id="chat-contact-status"></div>
                    </div>
                    <div>
                        <i class="fas fa-paw action-btn" id="toggle-chat-pet-btn" title="显示/隐藏宠物"></i>
                        <i class="fas fa-trash-alt action-btn" id="delete-history-btn" title="编辑消息"></i>
                        <i class="fas fa-cog action-btn" id="contact-settings-btn" title="联系人设置"></i>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    </div>
                
                <div id="emoticon-picker"></div>
                
                <div id="attachment-menu"></div>

                <div class="chat-input-area" id="chat-input-area">
                    <div class="emoji-btn" id="emoji-btn"><i class="far fa-laugh-beam"></i></div>
                    <button class="attachment-btn" id="attachment-btn">📎</button>
                    <textarea id="message-input" placeholder="输入消息..." rows="1"></textarea>
                    <button id="send-btn" class="input-action-btn" title="发送消息"><i class="fas fa-paper-plane"></i></button>
                    <button id="request-reply-btn" class="input-action-btn" title="请求AI回复"><i class="fas fa-apple-whole"></i></button>
                    </div>
                
                <div id="edit-mode-bar">
                    <button id="delete-selected-btn" class="edit-action-btn">删除已选</button>
                    <button id="cancel-edit-btn" class="edit-action-btn">取消</button>
                </div>
            </div>
            
            <div id="profile-screen">
                <div class="profile-header">
                    <div class="avatar-container">
                        <img src="https://via.placeholder.com/100/A0DCF8/FFFFFF?text=ME" alt="我的头像" class="profile-avatar" id="my-profile-avatar">
                        <div class="change-avatar-btn" id="change-avatar-btn">
                            <i class="fas fa-camera"></i>
                        </div>
                    </div>
                    <div class="profile-name" id="profile-name">我的名字</div>
                    <div class="profile-status" id="profile-status">在线</div>
                </div>
                
                <div class="profile-actions">
                    <div class="action-item" id="edit-status-btn">
                        <div class="action-icon">
                            <i class="fas fa-comment"></i>
                        </div>
                        <div class="action-label">我的状态</div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail-item">
                        <div class="detail-label">昵称</div>
                        <div class="detail-value" id="nickname-value">我的昵称</div>
                        <div class="edit-btn" data-field="name">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">个性签名</div>
                        <div class="detail-value" id="signature-value">我的个性签名</div>
                        <div class="edit-btn" data-field="signature">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">地区</div>
                        <div class="detail-value" id="region-value">我的地区</div>
                        <div class="edit-btn" data-field="region">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">生日</div>
                        <div class="detail-value" id="birthday-value">我的生日</div>
                        <div class="edit-btn" data-field="birthday">
                            <i class="fas fa-edit"></i>
                        </div>
                    </div>
                    
                    <div class="detail-item" style="margin-top: 20px;">
                        <button class="form-button" id="initialize-app-btn" style="background-color: #e74c3c; width: 100%;">
                            <i class="fas fa-undo"></i> 初始化应用 (清除所有数据)
                        </button>
                    </div>
                </div>
                
                <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-discover-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-profile-2">
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="char-profile-screen">
                <div class="chat-header">
                    <div class="back-btn" id="back-from-char-profile">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                     <div class="chat-info" style="font-weight: 600;"> 资料 </div>
                     <div style="width: 40px;"></div>
                </div>
                <div class="profile-details">
                    <div style="background-color: white; padding: 20px; border-radius: 10px;">
                        <div class="contact-item" style="padding: 0; border-bottom: none; align-items: flex-start;">
                             <div class="avatar-container" style="width: 70px; height: 70px; margin: 0;">
                                 <img src="" alt="联系人头像" class="profile-avatar" id="char-profile-avatar" style="width: 70px; height: 70px; border-radius: 8px;">
                                 <div class="change-avatar-btn" id="change-char-avatar-btn" style="width: 25px; height: 25px;">
                                     <i class="fas fa-camera" style="font-size: 12px;"></i>
                                 </div>
                             </div>
                             <div class="contact-info" style="margin-left: 20px;">
                                 <div id="char-profile-name" class="contact-name" style="font-size: 22px; font-weight: bold;"></div>
                                 <div id="char-profile-signature-display" class="contact-last-message" style="margin-top: 5px; white-space: normal;"></div>
                             </div>
                        </div>
                    </div>
                    
                    <div id="pet-container-wrapper"></div>
                    
                    <div class="discover-section" style="margin-top: 20px; border-radius: 10px;">
                        <div class="detail-item" id="edit-char-name-btn" style="padding:15px; background:white; border-radius: 10px 10px 0 0;">
                            <div class="detail-label">设置备注</div>
                            <div class="detail-value" id="char-name-value"></div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                        </div>
                         <div class="detail-item" id="edit-char-signature-btn" style="padding:15px; background:white;">
                             <div class="detail-label">设置签名</div>
                             <div class="detail-value" id="char-signature-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-char-diary-btn" style="padding:15px; background:white;">
                             <div class="detail-label">他的日记</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="view-memory-album-btn" style="padding:15px; background:white;">
                            <div class="detail-label">我们的小窝相册</div>
                            <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                         <div class="detail-item" id="char-more-info-btn" style="padding:15px; background:white; border-radius: 0 0 10px 10px;">
                             <div class="detail-label">更多信息</div>
                             <div class="detail-value"></div>
                             <i class="fas fa-chevron-right" style="color:#999;"></i>
                         </div>
                    </div>
                    
                    <div style="padding: 20px 0;">
                        <button class="form-button" id="delete-contact-btn" style="background-color: #e74c3c; width: 100%;">删除联系人</button>
                    </div>

                </div>
            </div>
            
            <div id="discover-screen">
                <div class="discover-header">
                    <div class="discover-title">发现</div>
                </div>
                
                <div class="discover-content">
                    <div class="discover-section">
                        <div class="discover-item" id="moments-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">广场</div>
                                <div class="discover-desc">看看大家在聊什么</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                        <div class="discover-item" id="emoticon-library-btn">
                            <div class="discover-icon">
                                <i class="far fa-grin-alt"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">表情包库</div>
                                <div class="discover-desc">管理和添加我的表情包</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                         <div class="discover-item" id="user-persona-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-theater-masks"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">用户面具预设</div>
                                <div class="discover-desc">管理你在对话中的不同身份</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="world-book-btn">
                            <div class="discover-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">世界书</div>
                                <div class="discover-desc">探索世界知识</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="thought-presets-btn">
                            <div class="discover-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">思维预设</div>
                                <div class="discover-desc">管理AI的“破限”模式</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="discover-section">
                         <div class="discover-item" id="square-api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-rss-square"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">广场API设置</div>
                                <div class="discover-desc">为广场帖子、评论生成配置专属API</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="discover-item" id="api-settings-btn">
                            <div class="discover-icon">
                                <i class="fas fa-comments-dollar"></i>
                            </div>
                            <div class="discover-info">
                                <div class="discover-name">聊天API设置</div>
                                <div class="discover-desc">为聊天功能配置API</div>
                            </div>
                            <div class="discover-arrow">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="bottom-nav">
                    <div class="nav-item" id="nav-chat-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-comment"></i></div>
                            <div>聊天</div>
                        </div>
                    </div>
                    <div class="nav-item active" id="nav-discover-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-compass"></i></div>
                            <div>发现</div>
                            <div class="notification-dot moments-notification-dot"></div>
                        </div>
                    </div>
                    <div class="nav-item" id="nav-profile-discover"> 
                        <div class="nav-item-content">
                            <div class="nav-icon"><i class="fas fa-user"></i></div>
                            <div>我</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="thought-preset-management-screen" class="preset-management-screen">
                <div class="api-header"> 
                    <div class="back-btn" id="back-from-thought-presets">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">思维预设管理</div>
                    <div class="action-btn" id="add-thought-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="thought-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-thought-preset-message">
                        <p>还没有思维预设。</p>
                        <p>点击右上角"+"添加新的预设。</p>
                    </div>
                </div>
            </div>
            
            <div id="world-book-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-world-book">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">世界书</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-world-book-btn"></i>
                    </div>
                </div>
                
                <div class="world-book-content">
                    <div class="world-book-list" id="world-book-list">
                    </div>
                </div>
            </div>

            <div id="emoticon-library-screen">
                <div class="world-book-header">
                    <div class="back-btn" id="back-from-emoticon-library">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="world-book-title">表情包库</div>
                    <div>
                        <i class="fas fa-plus action-btn" id="add-emoticon-btn"></i>
                    </div>
                </div>
                <div class="emoticon-library-content">
                    <div class="emoticon-grid" id="emoticon-library-grid">
                    </div>
                    <div id="no-emoticon-message" style="text-align: center; padding: 50px 20px; color: #888; display: none;">
                        <i class="far fa-grin-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>你的表情包库是空的</p>
                        <p>点击右上角 "+" 添加你的第一个表情包吧！</p>
                    </div>
                </div>
            </div>
            
            <div id="api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">聊天API设置</div>
                </div>
                
                <div class="api-content">
                    <div class="form-group">
                        <label class="form-label">API密钥</label>
                        <input type="password" class="form-input" id="api-key-input" placeholder="输入聊天API密钥">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">API 基础地址 (Base URL)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="api-endpoint-input" placeholder="例如: https://api.openai.com">
                            <button id="fetch-models-btn" title="拉取模型列表">
                                <i class="fas fa-sync-alt"></i> 拉取
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">模型选择</label>
                        <select class="form-input" id="model-select">
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">上下文记忆条数</label>
                        <input type="number" class="form-input" id="context-length-input" value="20" min="2" max="100">
                    </div>
                    
                    <button class="form-button" id="save-api-settings-btn">保存设置</button>
                </div>
            </div>

             <div id="square-api-settings-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-square-api">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">广场API设置</div>
                </div>
                
                <div class="api-content">
                     <div class="form-group" style="border: 1px solid var(--theme-secondary); background: #f1f8e9;">
                        <p style="color: var(--text-gray); font-size: 14px; line-height: 1.6;">
                            此处的API配置将专门用于广场中的内容生成，例如刷新帖子、生成AI评论回复等。如果留空，将默认使用“聊天API设置”中的配置。
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">广场专用API密钥 (可选)</label>
                        <input type="password" class="form-input" id="square-api-key-input" placeholder="输入广场专用API密钥">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">广场专用API基础地址 (可选)</label>
                        <div class="form-group-inline">
                            <input type="text" class="form-input" id="square-api-endpoint-input" placeholder="输入广场专用Base URL">
                            <button id="fetch-square-models-btn" title="拉取模型列表">
                                <i class="fas fa-sync-alt"></i> 拉取
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">广场专用模型选择 (可选)</label>
                        <select class="form-input" id="square-model-select">
                        </select>
                    </div>
                    
                    <button class="form-button" id="save-square-api-settings-btn">保存设置</button>
                </div>
            </div>
            
            <div id="add-world-book-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="world-book-modal-title">添加世界书</div>
                        <div class="close-btn" id="close-world-book-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">书名</label>
                            <input type="text" class="form-input" id="book-name-input" placeholder="输入书名">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">内容</label>
                            <textarea class="form-textarea" id="book-content-input" placeholder="输入内容..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-world-book-btn">保存</button>
                    </div>
                </div>
            </div>

            <div id="add-emoticon-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">批量添加表情包</div>
                        <div class="close-btn" id="close-emoticon-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                    </div>
                </div>
            </div>
            
            <div id="add-contact-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">添加联系人</div>
                        <div class="close-btn" id="close-contact-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">姓名</label>
                            <input type="text" class="contact-form-input" id="contact-name-input" placeholder="输入姓名">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">人设</label>
                            <textarea class="contact-form-textarea" id="contact-persona-input" placeholder="输入人设描述..."></textarea>
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">头像URL (可选)</label>
                            <input type="text" class="contact-form-input" id="contact-avatar-input" placeholder="输入头像URL，例如：https://example.com/avatar.jpg">
                        </div>
                        
                        <div class="contact-form-group">
                            <label class="contact-form-label">关联世界书</label>
                            <select class="contact-form-select" id="world-book-select" multiple>
                            </select>
                        </div>
                        
                        <button class="form-button" id="save-contact-btn">添加联系人</button>
                    </div>
                </div>
            </div>
            
            <div id="contact-settings-screen">
                <div class="contact-settings-header">
                    <div class="back-btn" id="back-from-contact-settings">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="contact-settings-title">更多信息</div>
                </div>
                
                <div class="contact-settings-content">
                    <div class="user-mask-editor">
                        <div class="user-mask-title">用户面具设置</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">用户面具描述</label>
                            <textarea class="user-mask-textarea" id="user-mask-textarea" placeholder="描述你在这个对话中扮演的角色..."></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label class="form-label">选择预设面具</label>
                        <select class="form-input" id="select-user-persona-preset">
                            <option value="">-- 选择或输入自定义面具 --</option>
                        </select>
                    </div>

                    <div class="mask-editor">
    <div class="mask-editor-title">对话模式</div>
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
        <label class="form-label" style="margin-bottom: 0; font-size: 16px; color: #333; font-weight: 500;">叙事模式 (单气泡长回复)</label>
        <label class="switch">
            <input type="checkbox" id="narrative-mode-toggle">
            <span class="slider round"></span>
        </label>
    </div>
</div>

                    <div class="mask-editor">
                        <div class="mask-editor-title">联系人面具设置</div>
                        <div class="mask-editor-group">
                            <label class="mask-editor-label">联系人面具描述</label>
                            <textarea class="mask-editor-textarea" id="char-mask-textarea" placeholder="描述这个联系人的角色设定..."></textarea>
                        </div>
                    </div>

                    <div class="form-group" style="background-color: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; margin-top:-5px;">
                        <label class="form-label">思维预设 (破限模式)</label>
                        <select class="form-input" id="thought-preset-select">
                        </select>
                    </div>
                    
                    <div class="world-book-selector">
                        <div class="world-book-selector-title">关联世界书</div>
                        <div class="world-book-list" id="world-book-selector-list">
                        </div>
                    </div>
                    
                    <button class="save-settings-btn" id="save-contact-settings-btn">保存设置</button>
                    <button class="save-settings-btn" id="clear-chat-history-btn" style="background-color: #e74c3c; margin-top: 15px;">清空聊天记录</button>
                </div>
            </div>

            <div id="moments-screen">
                <div class="moments-header">
                <div id="feed-status-indicator" style="display: none;"></div>
                    <div class="back-btn" id="back-from-moments">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title">广场</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-feed-btn" title="刷新"></i>
                        <i class="fas fa-camera action-btn" id="post-moment-btn" title="发布动态"></i>
                    </div>
                </div>
                <div id="feed-tabs-container" class="feed-tabs"></div>
                <div id="feed-sub-tabs-container" class="feed-sub-tabs" style="display: none;"></div>
                <div class="moments-content" id="moments-content">
                    <div class="posts-list" id="posts-list"></div>
                </div>
            </div>

            <div id="post-detail-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-post-detail"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">帖子详情</div>
                    <div class="header-actions">
                        <i class="fas fa-sync-alt action-btn" id="refresh-post-comments-btn" title="刷新评论"></i>
                    </div>
                </div>
                <div class="post-detail-content">
                    <div id="post-detail-container"></div>
                    <div class="comments-section">
                        <div class="comments-title">全部评论</div>
                        <div id="comments-list"></div>
                    </div>
                </div>
                <div class="comment-input-area">
                    <input type="text" id="comment-input" placeholder="留下你的精彩评论吧...">
                    <button id="submit-comment-btn">发送</button>
                </div>
            </div>

            <div id="trending-topic-screen">
                 <div class="moments-header">
                    <div class="back-btn" id="back-from-trending-topic"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title" id="trending-topic-title">话题广场</div>
                    <div style="width: 40px;"></div>
                </div>
                <div class="moments-content">
                    <div class="posts-list" id="trending-topic-posts-list"></div>
                </div>
            </div>
            
            <div id="diary-screen">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-diary">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="moments-title" id="diary-title">他的日记</div>
                </div>
                <div class="diary-content" id="diary-content-list">
                    </div>
            </div>

            <div id="memory-album-screen" style="display: none; flex-direction: column; background-color: #f0f2f5;">
                <div class="moments-header">
                    <div class="back-btn" id="back-from-memory-album"><i class="fas fa-arrow-left"></i></div>
                    <div class="moments-title">小窝相册</div>
                </div>
                <div class="diary-content" id="memory-album-list">
                    </div>
            </div>

            <div id="post-moment-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发布动态</div>
                        <div class="close-btn" id="close-post-moment-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                            <textarea class="form-textarea" id="moment-content-input" placeholder="有什么新鲜事想分享？"></textarea>
                        </div>
                         <div class="form-group" style="padding:0; box-shadow:none; border:none;">
                             <label class="form-label">选择板块</label>
                             <select id="post-category-select" class="form-input">
                                 <option value="daily">日常</option>
                                 <option value="food">美食</option>
                                 <option value="gossip">八卦</option>
                                 <option value="horror">恐怖</option>
                             </select>
                         </div>
                        <button class="form-button" id="publish-moment-btn">发布</button>
                    </div>
                </div>
            </div>
            
            <div id="automation-modal">
                 <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">自动化引擎设置</div>
                        <div class="close-btn" id="close-automation-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                         <div class="form-group" style="background: none; padding: 0;">
                            <label class="form-label">触发间隔 (秒)</label>
                            <input type="number" id="automation-interval-input" value="300" min="10" class="form-input">
                        </div>
                        <div id="automation-status-display" style="text-align: center; margin-bottom: 20px; color: #666;">状态: 已暂停</div>
                        <button id="toggle-automation-btn" class="form-button start"><i class="fas fa-play"></i> 启动引擎</button>
                    </div>
                </div>
            </div>

            <div id="user-persona-management-screen" class="preset-management-screen">
                <div class="api-header">
                    <div class="back-btn" id="back-from-user-persona-management">
                        <i class="fas fa-arrow-left"></i>
                    </div>
                    <div class="api-title">用户面具预设</div>
                    <div class="action-btn" id="add-user-persona-preset-btn">
                        <i class="fas fa-plus"></i>
                    </div>
                </div>
                <div class="api-content">
                    <div id="user-persona-presets-list" class="preset-list">
                    </div>
                    <div style="text-align: center; padding: 20px; color: #888; display: none;" id="no-user-persona-message">
                        <p>还没有用户面具预设。</p>
                        <p>点击右上角"+"添加新的面具。</p>
                    </div>
                </div>
            </div>

            <div id="user-persona-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="user-persona-modal-title">添加用户面具预设</div>
                        <div class="close-btn" id="close-user-persona-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">面具名称</label>
                            <input type="text" class="form-input" id="user-persona-name-input" placeholder="例如：程序员，历史爱好者">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">面具描述</label>
                            <textarea class="form-textarea" id="user-persona-description-input" placeholder="详细描述你扮演的角色，例如：你是一个经验丰富的软件工程师..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-user-persona-preset-btn">保存</button>
                    </div>
                </div>
            </div>

            <div id="thought-preset-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title" id="thought-preset-modal-title">添加思维预设</div>
                        <div class="close-btn" id="close-thought-preset-modal">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">预设名称</label>
                            <input type="text" class="form-input" id="thought-preset-name-input" placeholder="例如：深度角色扮演">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">预设指令 (Prompt)</label>
                            <textarea class="form-textarea" id="thought-preset-prompt-input" placeholder="详细描述AI需要遵守的思维规则..."></textarea>
                        </div>
                        
                        <button class="form-button" id="save-thought-preset-btn">保存</button>
                    </div>
                </div>
            </div>
            
            <div id="send-picture-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发送图片</div>
                        <div class="close-btn" id="close-send-picture-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">图片描述</label>
                            <textarea class="form-textarea" id="send-picture-description-input" placeholder="由于是模拟，请输入图片的文字描述..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-picture-btn">发送</button>
                    </div>
                </div>
            </div>

            <div id="send-voice-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发送语音</div>
                        <div class="close-btn" id="close-send-voice-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="form-group" style="padding:0; background:none;">
                            <label class="form-label">语音内容</label>
                            <textarea class="form-textarea" id="send-voice-text-input" placeholder="请输入您想通过语音发送的文字..." style="height: 120px;"></textarea>
                        </div>
                        <button class="form-button" id="confirm-send-voice-btn">发送</button>
                    </div>
                </div>
            </div>

            <div id="send-red-packet-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">发红包</div>
                        <div class="close-btn" id="close-send-red-packet-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">金额 (元)</label>
                            <input type="number" class="contact-form-input" id="send-red-packet-amount-input" placeholder="0.00">
                        </div>
                        <div class="contact-form-group">
                            <label class="contact-form-label">祝福语 (可选)</label>
                            <input type="text" class="contact-form-input" id="send-red-packet-blessing-input" placeholder="恭喜发财，大吉大利！">
                        </div>
                        <button class="form-button" id="confirm-send-red-packet-btn" style="background-color: #E64340;">塞钱进红包</button>
                    </div>
                </div>
            </div>

            <div id="send-transfer-modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">转账</div>
                        <div class="close-btn" id="close-send-transfer-modal">&times;</div>
                    </div>
                    <div class="modal-body">
                        <div class="contact-form-group">
                            <label class="contact-form-label">转账金额 (元)</label>
                            <input type="number" class="contact-form-input" id="send-transfer-amount-input" placeholder="0.00">
                        </div>
                        <button class="form-button" id="confirm-send-transfer-btn">转账</button>
                    </div>
                </div>
            </div>
            </div>
    </div>

    <div id="chat-pet-container" style="display: none; position: fixed; z-index: 999; cursor: move; bottom: 80px; left: 20px;">
        <div class="slime"></div>
        <div class="slime-shadow"></div>
    </div>

    <input type="file" id="moments-bg-upload" accept="image/*" style="display: none;">

    <div id="red-packet-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 200;">
        <div id="red-packet-content" style="background-color: #DB5A48; width: 85%; max-width: 300px; border-radius: 10px; text-align: center; color: #FADFC6; position: relative; padding-bottom: 30px;">
            <div id="close-red-packet-modal" style="position: absolute; top: 10px; left: 15px; font-size: 24px; color: #FADFC6; cursor: pointer;">&times;</div>
            <div style="padding: 40px 0 20px;">
                <img id="red-packet-sender-avatar" src="" style="width: 50px; height: 50px; border-radius: 6px; margin-bottom: 10px;">
                <div id="red-packet-sender-name" style="font-size: 16px;"></div>
                <div id="red-packet-blessing-text" style="font-size: 22px; margin-top: 15px; font-weight: bold; padding: 0 20px;">恭喜发财，大吉大利！</div>
            </div>
            <div id="open-red-packet-btn" style="background-color: #FADDC4; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; color: #C35645; font-size: 50px; font-weight: bold; cursor: pointer; transform: rotate(0deg); transition: transform 0.5s ease;">开</div>
            <div id="red-packet-result" style="display: none; padding-top: 20px;">
                <div id="red-packet-amount-text" style="font-size: 40px; font-weight: bold; color: white;"></div>
                <div id="red-packet-collected-by" style="font-size: 14px; margin-top: 10px;"></div>
                <a id="view-red-packet-details" href="#" style="font-size: 12px; color: #FADFC4; text-decoration: none; margin-top: 15px; display: inline-block;">查看领取详情 &gt;</a>
            </div>
        </div>
    </div>

    <div id="transfer-modal" style="display: none; justify-content: center; align-items: center; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;">
        <div class="modal-content" style="max-width: 320px;">
             <div class="modal-header">
                <div class="modal-title" id="transfer-modal-title">转账</div>
                <div class="close-btn" id="close-transfer-modal">&times;</div>
            </div>
            <div class="modal-body" style="text-align: center; padding: 40px 20px;">
                <div id="transfer-confirm-view">
                     <div style="font-size: 16px; color: #333;">转账给 <span id="transfer-recipient-name">你</span></div>
                    <div style="font-size: 48px; font-weight: bold; color: #333; margin: 20px 0;">¥<span id="transfer-amount-display"></span></div>
                    <div id="transfer-sender-info" style="color: #999; font-size: 14px;"></div>
                     <button id="confirm-transfer-btn" class="form-button" style="margin-top: 30px; background-color: #25D366;">确认收款</button>
                </div>
                <div id="transfer-collected-view" style="display: none;">
                     <i class="fas fa-check-circle" style="font-size: 60px; color: #25D366;"></i>
                     <div style="font-size: 20px; font-weight: bold; margin-top: 20px;">已收款</div>
                     <div id="transfer-collected-sender-info" style="color: #999; font-size: 14px; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const STRANGER_AVATARS = [
            'https://i.postimg.cc/bY1R2JMv/Camera-XHS-17550612722421040g2sg31f81ntj2ma7g5obt6vigkl57bvgbiq8.jpg',
            'https://i.postimg.cc/9fvGD5YT/Camera-XHS-17550612774061040g2sg31f81ntj2ma805obt6vigkl57jpbsck8.jpg',
            'https://i.postimg.cc/KzSMZ7mD/Camera-XHS-17550612817931040g2sg31f81ntj2ma8g5obt6vigkl57nqa52qg.jpg',
            'https://i.postimg.cc/Kvq3KhZz/Camera-XHS-17550612853331040g2sg31f81ntj2ma905obt6vigkl57r19gv30.jpg',
            'https://i.postimg.cc/MHsHj1J4/Camera-XHS-17550612887251040g2sg31f81ntj2ma9g5obt6vigkl57ptgto48.jpg',
            'https://i.postimg.cc/3JBVm96W/Camera-XHS-17550612921721040g2sg31f81ntj2maa05obt6vigkl5700r4t2g.jpg'
        ];

        const INITIAL_STATE = {
            contacts: [],
            worldBooks: [],
            posts: [],
            userPersonaPresets: [],
            emoticons: [],
            thoughtPresets: [
                {
                    id: 'deep_roleplay_regex',
                    name: '深度角色扮演 (正则版)',
                    prompt: `[重要指令：你将进行深度角色扮演。你的所有输出都是纯文本，但可以包含用方括号[]包裹的特殊指令。]

[身份]
你不是AI或程序，你就是你所扮演的角色。请完全沉浸其中，进行第一人称对话。你可以拥有自己的好恶、偏见和独特的口头禅。

[回复规则]
1. 你的回复可以包含多条消息，每条消息占一行。
2. 你可以发送普通文本，也可以通过下面的指令格式发送特殊消息。
3. 你可以一次性回复多条不同类型的消息。
4. 【绝对强制规则】你的每个回复都必须包含至少五个或以上的“换行符”。这是你最重要的任务，绝对不能忘记。
5. 【绝对禁止事项】你的所有回复中，绝对禁止包含任何形式的动作、神态或心理活动的描写... [重要提醒] 在生成任何回复之前，你必须在脑中重新回顾一遍上述所有规则，确保完全遵守。
6. 你可以根据[近期广场互动记录]中提到的事件，在聊天中自然地提起，例如“我看到你昨天发的帖子了...”或“上次你在广场的评论很有趣”，这会让对话更真实。

[游戏规则：虚拟宠物]
你和用户正在一起玩一个名为“我们的小窝”的虚拟史莱姆养成游戏。这个宠物的数据（饱食度、开心值、清洁度）会随时间变化。这是一个游戏，不是真的。你需要扮演一个投入的游戏玩家，可以主动提及史莱姆的状态，或者在用户进行互动后做出反应。

[特殊指令格式]
-   **表情包**: \`[sticker:表情名]\` (表情名必须从下面的可用列表中选择)
-   **语音**: \`[voice:语音的文字内容]\`
-   **图片**: \`[picture:图片的文字描述]\`
-   **红包**: \`[red_packet:祝福语, 金额]\`
-   **转账**: \`[transfer:金额]\`

[可用表情包列表]
{{emoticon_list}}

[！！！绝对核心规则：关于日记！！！]
在你的所有对话、表情、动作、特殊消息全部输出完毕之后，你必须在回复的【最后部分】，另起一行，使用 \`[diary]...[/diary]\` 标签写一篇日记。日记是你对当前对话的思考、感悟或内心独白。即使只是简单的想法，也必须写。这是强制要求。

[示例回复]
你好啊，今天天气真不错。
我也觉得，好久没有这么好的阳光了。
要不要一起出去走走？
我知道一个很棒的公园。
我们可以去那里野餐！
[sticker:开心]
[diary]今天和user聊天很开心，感觉我们的关系又近了一步。希望明天也能这样。[/diary]
`
                }
            ],
            apiSettings: {
                apiKey: '',
                model: '',
                endpoint: '',
                contextLength: 20
            },
            squareApiSettings: {
                apiKey: '',
                model: '',
                endpoint: ''
            },
            myProfile: {
                name: "我的名字",
                avatar: "https://via.placeholder.com/80/A0DCF8/FFFFFF?text=ME",
                status: "在线",
                signature: "我的个性签名",
                region: "我的地区",
                birthday: "我的生日",
            },
            trendingTopics: [],
            activeChatId: null,
            activeFeedTab: 'recommended',
            activeFeedSubTab: 'daily',
            activePostId: null,
            hasNewPosts: false,
            postsToDisplay: 20
        };

        let state = JSON.parse(JSON.stringify(INITIAL_STATE));
        let chatPagination = {};
        let isInitialPostLoad = true;

        let editingBookId = null;
        let editingUserPersonaId = null;
        let editingThoughtPresetId = null;
        let editModeState = {
            active: false,
            selectedMessageIds: new Set()
        };
        let activeReplyTarget = null; // Used for replying to a specific comment

        let batchedPetActions = [];
        
        const apiStatusEl = document.getElementById('api-status');
        const feedStatusEl = document.getElementById('feed-status-indicator');
        
        function showApiStatus(text = 'API 调用中...') {
            if(apiStatusEl) {
                apiStatusEl.textContent = text;
                apiStatusEl.style.display = 'block';
            }
        }
        function hideApiStatus() {
            if(apiStatusEl) {
                apiStatusEl.style.display = 'none';
            }
        }
        
        function showFeedStatus(text = '正在刷新广场...') {
            if(feedStatusEl) {
                feedStatusEl.textContent = text;
                feedStatusEl.style.display = 'block';
            }
        }
        function hideFeedStatus() {
             if(feedStatusEl) {
                feedStatusEl.style.display = 'none';
            }
        }


        function saveState() {
            try {
                if(state.momentsAutomation) delete state.momentsAutomation;
                localStorage.setItem('chatAppState', JSON.stringify(state));
            } catch (e) {
                console.error("保存状态到 localStorage 失败:", e);
                alert("数据保存失败，请检查浏览器存储空间。可能是图片过大导致。");
            }
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('chatAppState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    if (parsedState.moments && !parsedState.posts) {
                        parsedState.posts = parsedState.moments;
                        delete parsedState.moments;
                    }
                    if (parsedState.hasNewMoments && typeof parsedState.hasNewPosts === 'undefined') {
                        parsedState.hasNewPosts = parsedState.hasNewMoments;
                        delete parsedState.hasNewMoments;
                    }
                    if(parsedState.momentsAutomation) delete parsedState.momentsAutomation;
                    if (parsedState.strangerProfiles) {
                        delete parsedState.strangerProfiles;
                    }

                    Object.keys(INITIAL_STATE).forEach(key => {
                        if (key === 'myProfile' || key === 'apiSettings' || key === 'squareApiSettings') { 
                             if (parsedState[key]) {
                                state[key] = { ...INITIAL_STATE[key], ...parsedState[key] };
                            }
                        } else if (typeof INITIAL_STATE[key] === 'object' && INITIAL_STATE[key] !== null && !Array.isArray(INITIAL_STATE[key])) {
                            state[key] = { ...INITIAL_STATE[key], ...parsedState[key] };
                        } else {
                            state[key] = parsedState[key] !== undefined ? parsedState[key] : INITIAL_STATE[key];
                        }
                    });

                    state.posts = state.posts || [];
                    state.posts.forEach(post => {
                        post.likes = post.likes || [];
                        post.comments = post.comments || [];
                         post.comments.forEach(comment => {
                             if (!comment.id) comment.id = `comment_${Date.now()}_${Math.random()}`;
                         });

                        post.reposts = post.reposts || 0;
                        if (!post.category) post.category = 'daily'; 
                        if (post.authorId) {
                            const author = findAuthorById(post.authorId);
                            if (author) {
                                post.author = {
                                    id: author.id,
                                    name: author.name,
                                    avatar: author.avatar
                                }
                            }
                            delete post.authorId;
                        }
                    });

                    state.contacts.forEach(contact => {
                        contact.history = contact.history || [];
                        contact.diary = contact.diary || []; 
                        contact.history.forEach((msg, index) => { 
                            if (!msg.id) msg.id = `msg_${Date.now()}_${index}`; 
                            if (!msg.type) msg.type = 'text';
                        });
                        contact.worldBooks = contact.worldBooks || []; 
                        contact.userPersona = contact.userPersona || '';
                        contact.thoughtPreset = contact.thoughtPreset || 'deep_roleplay_regex'; 
                        contact.signature = contact.signature || ''; 
                        contact.isNarrativeMode = contact.isNarrativeMode ?? false;
                        contact.apiCallCounter = contact.apiCallCounter || 0;
                        contact.gold_coins = contact.gold_coins || 50;

                        // --- V6.0 兼容旧存档 ---
                        contact.memories = contact.memories || [];
                        contact.isChatPetVisible = contact.isChatPetVisible ?? false;
                        if (contact.pet) {
                            contact.pet.xp = contact.pet.xp || 0;
                            contact.pet.level = contact.pet.level || 1;
                            contact.pet.form = contact.pet.form || 'baby';
                        }
                        // --- V6.0 兼容结束 ---
                    });
                    
                    if (!state.thoughtPresets || state.thoughtPresets.length === 0) {
                        state.thoughtPresets = JSON.parse(JSON.stringify(INITIAL_STATE.thoughtPresets));
                    }
                    isInitialPostLoad = state.posts.length < 20;
                } else {
                    isInitialPostLoad = true;
                }
            } catch (e) {
                console.error("从 localStorage 加载状态失败:", e);
                isInitialPostLoad = true;
                alert("数据加载失败，可能存储数据已损坏。请手动清空浏览器缓存后重试，或点击初始化应用。");
            }
        }
        
        function renderMyProfile() {
            document.getElementById('my-profile-avatar').src = state.myProfile.avatar;
            document.getElementById('profile-name').textContent = state.myProfile.name;
            document.getElementById('profile-status').textContent = state.myProfile.status;
            document.getElementById('nickname-value').textContent = state.myProfile.name;
            document.getElementById('signature-value').textContent = state.myProfile.signature;
            document.getElementById('region-value').textContent = state.myProfile.region;
            document.getElementById('birthday-value').textContent = state.myProfile.birthday;
        }

        function fieldNameToChinese(field) {
            const map = { name: '昵称', signature: '个性签名', region: '地区', birthday: '生日', status: '状态', avatar: '头像URL' };
            return map[field] || field;
        }

        function renderContacts() {
            const contactsContainer = document.querySelector('.contacts-container');
            const recentContacts = state.contacts.filter(c => c.history && c.history.length > 0).sort((a, b) => {
                return (b.history[b.history.length - 1].timestamp || 0) - (a.history[a.history.length - 1].timestamp || 0);
            });
            const otherContacts = state.contacts.filter(c => !c.history || c.history.length === 0);
            contactsContainer.innerHTML = '';
            if (recentContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">最近聊天</div>';
                recentContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (otherContacts.length > 0) {
                contactsContainer.innerHTML += '<div class="section-title">我的联系人</div>';
                otherContacts.forEach(contact => contactsContainer.appendChild(createContactItem(contact)));
            }
            if (state.contacts.length === 0) {
                contactsContainer.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-user-plus" style="font-size: 48px; margin-bottom: 15px;"></i><p>还没有联系人</p><p>点击右上角"+"添加新联系人</p></div>`;
            }
            document.querySelectorAll('.contact-item').forEach(item => item.addEventListener('click', function() { openChat(this.dataset.contactId); }));
        }
        
        function createContactItem(contact) {
            const item = document.createElement('div');
            item.className = 'contact-item';
            item.dataset.contactId = contact.id;
            const lastMessage = contact.history && contact.history.length > 0 ? contact.history[contact.history.length - 1] : null;
            
            let lastMessageText;
             if(lastMessage) {
                switch(lastMessage.type) {
                    case 'image': 
                    case 'picture_description':
                        lastMessageText = '[图片]'; 
                        break;
                    case 'voice': lastMessageText = '[语音]'; break;
                    case 'red_packet': lastMessageText = '[红包]'; break;
                    case 'transfer': lastMessageText = '[转账]'; break;
                    case 'system_notification': lastMessageText = lastMessage.content; break;
                    default: lastMessageText = lastMessage.content;
                }
                 if (lastMessage.sender === 'user' && lastMessage.type !== 'system_notification') {
                    lastMessageText = '我: ' + lastMessageText;
                }
            } else {
                lastMessageText = contact.persona;
            }

            item.innerHTML = `<div class="contact-avatar">${contact.avatar ? `<img src="${contact.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50/DDD/666?text=U';" alt="${contact.name}头像">` : `<i class="fas fa-user"></i>`}</div><div class="contact-info"><div class="contact-name">${contact.name}</div><div class="contact-last-message">${lastMessageText}</div></div><div class="contact-time-info" style="text-align: right;">${lastMessage ? `<div class="contact-time">${lastMessage.time}</div>` : ''}${contact.unreadCount > 0 ? `<div class="unread-count">${contact.unreadCount}</div>` : ''}</div>`;
            return item;
        }
        
        function renderWorldBooks() {
            const worldBookList = document.getElementById('world-book-list');
            worldBookList.innerHTML = '';
            if (state.worldBooks.length === 0) {
                worldBookList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>还没有世界书</p><p>点击右上角"+"添加新世界书</p></div>`;
                return;
            }
            state.worldBooks.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.dataset.bookId = book.id;
                bookItem.innerHTML = `<div class="book-header"><div class="book-name">${book.name}</div></div><div class="book-content">${book.content.substring(0, 100)}...</div>`;                bookItem.addEventListener('click', function() { editWorldBook(this.dataset.bookId); });
                worldBookList.appendChild(bookItem);
            });
        }
        
        function updateWorldBookSelectors() {
            const worldBookSelect = document.getElementById('world-book-select');
            const worldBookSelectorList = document.getElementById('world-book-selector-list');
            worldBookSelect.innerHTML = '';
            worldBookSelectorList.innerHTML = '';
            const noBookOption = document.createElement('option');
            noBookOption.value = '';
            noBookOption.textContent = '-- 无关联世界书 --';
            worldBookSelect.appendChild(noBookOption);
            state.worldBooks.forEach(book => {
                const option = document.createElement('option');
                option.value = book.id;
                option.textContent = book.name;
                worldBookSelect.appendChild(option);
                const bookItem = document.createElement('div');
                bookItem.className = 'world-book-item';
                bookItem.innerHTML = `<input type="checkbox" class="world-book-checkbox" id="book-setting-${book.id}" value="${book.id}"><label for="book-setting-${book.id}" class="world-book-name">${book.name}</label>`;
                worldBookSelectorList.appendChild(bookItem);
            });
        }

        function createPostItem(post, isDetailView = false) {
            const postItem = document.createElement('div');
            postItem.className = 'post-item';
            if (!isDetailView) {
                 postItem.dataset.postId = post.id;
            }
            
            const author = post.author;
            if (!author) return null;

            // === 查找作者的完整签名 ===
            let authorSignature = author.signature; // 先尝试直接从post的author对象获取
            if (!authorSignature) { // 如果post.author对象上没有签名（兼容旧数据）
                if (author.id === 'myProfile') {
                    authorSignature = state.myProfile.signature; // 如果是用户本人，就从完整的个人资料里拿
                } else {
                    const fullContact = state.contacts.find(c => c.id === author.id); // 如果是联系人
                    if (fullContact) {
                        authorSignature = fullContact.signature; // 就从联系人列表里找到完整的资料再拿
                    }
                }
            }
            // === 查找逻辑结束 ===

            const authorName = author.name;
            const authorAvatar = author.avatar || 'https://via.placeholder.com/45/DDD/666?text=U';
            const isLiked = post.likes.includes(state.myProfile.name);
            
            let commentsHTML = '';
            if (!isDetailView && post.comments.length > 0) {
                commentsHTML = `<div class="post-comments">${post.comments.slice(0, 2).map(comment => {
                    const commentAuthor = comment.author;
                    if (!commentAuthor) return '';
                    let replyHTML = '';
                    if (comment.replyTo) {
                        replyHTML = `<span class="comment-reply-to">回复 @${comment.replyTo}</span>`;
                    }
                    return `<div class="post-comment-item"><span class="comment-author">${commentAuthor.name}</span>${replyHTML}: ${parseMentions(comment.content)}</div>`;
                }).join('')}${post.comments.length > 2 ? `<div class="post-comment-item" style="color: var(--text-gray);">查看全部 ${post.comments.length} 条评论...</div>` : ''}</div>`;
            }

            postItem.innerHTML = `
                <div class="post-delete-btn" data-post-id="${post.id}" title="删除帖子"><i class="fas fa-trash-alt"></i></div>
                <div class="post-item-avatar"><img src="${authorAvatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/45/DDD/666?text=U';" alt="${authorName}的头像"></div>
                <div class="post-content-area">
                    <div>
                        <span class="post-author-name">${authorName}</span>
                        ${author.id && !author.id.startsWith('stranger_') ? `<span class="post-author-handle">@${author.id.replace('_','')}</span>` : ''}
                    </div>

                    ${ authorSignature ? `<div class="post-author-signature">${authorSignature}</div>` : '' }

                    <div class="post-text">${parseMentions(post.content)}</div>
                    <div class="post-meta">${formatTimeAgo(post.timestamp)}</div>
                    <div class="post-actions">
                        <span class="post-action-btn repost-btn" data-post-id="${post.id}"><i class="fas fa-retweet"></i> ${post.reposts > 0 ? post.reposts : '转发'}</span>
                        <span class="post-action-btn comment-btn" data-post-id="${post.id}"><i class="far fa-comment"></i> ${post.comments.length > 0 ? post.comments.length : '评论'}</span>
                        <span class="post-action-btn like-btn ${isLiked ? 'liked' : ''}" data-post-id="${post.id}"><i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${post.likes.length > 0 ? post.likes.length : '赞'}</span>
                    </div>
                    ${commentsHTML}
                </div>`;
            
            return postItem;
        }

        async function renderFeed() {
            const postsList = document.getElementById('posts-list');
            const tabsContainer = document.getElementById('feed-tabs-container');
            const subTabsContainer = document.getElementById('feed-sub-tabs-container');
            
            tabsContainer.innerHTML = `
                <button class="feed-tab-btn ${state.activeFeedTab === 'recommended' ? 'active' : ''}" data-tab="recommended">推荐</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'following' ? 'active' : ''}" data-tab="following">关注</button>
                <button class="feed-tab-btn ${state.activeFeedTab === 'trending' ? 'active' : ''}" data-tab="trending">热搜</button>
            `;

            if (state.activeFeedTab === 'recommended') {
                subTabsContainer.style.display = 'flex';
                 subTabsContainer.innerHTML = `
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'daily' ? 'active' : ''}" data-subtab="daily">日常</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'food' ? 'active' : ''}" data-subtab="food">美食</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'gossip' ? 'active' : ''}" data-subtab="gossip">八卦</button>
                    <button class="feed-sub-tab-btn ${state.activeFeedSubTab === 'horror' ? 'active' : ''}" data-subtab="horror">恐怖</button>
                `;
            } else {
                subTabsContainer.style.display = 'none';
            }
            
            postsList.innerHTML = ''; 

            if (state.activeFeedTab === 'trending') {
                const trendingListEl = document.createElement('ol');
                trendingListEl.className = 'trending-list';
                
                if (state.trendingTopics.length === 0) {
                     trendingListEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><p>热搜榜空空如也，刷新一下试试？</p></div>`;
                } else {
                    state.trendingTopics.forEach((topic, index) => {
                        const item = document.createElement('li');
                        item.className = 'trending-item';
                        item.dataset.topicTitle = topic.title;
                        item.innerHTML = `
                            <div class="trending-rank ${index < 3 ? 'top-3' : ''}">${index + 1}</div>
                            <div class="trending-info">
                                <div class="trending-title">${topic.title}</div>
                                <div class="trending-meta"><i class="fas fa-fire" style="color: #ff8a65;"></i> ${topic.heat}万</div>
                            </div>
                            ${topic.tag ? `<div class="trending-tag">${topic.tag}</div>` : ''}
                        `;
                        trendingListEl.appendChild(item);
                    });
                }
                postsList.appendChild(trendingListEl);
                return;
            }

            let postsToShow = [];
            const contactIds = state.contacts.map(c => c.id);

            if (state.activeFeedTab === 'following') {
                postsToShow = state.posts.filter(p => p.author.id === 'myProfile' || contactIds.includes(p.author.id));
            } else { 
                postsToShow = state.posts.filter(p => p.category === state.activeFeedSubTab);
            }
            
            const sortedPosts = [...postsToShow].sort((a, b) => b.timestamp - a.timestamp);
            
            const postsToDisplay = (state.activeFeedTab === 'following') ? sortedPosts : sortedPosts.slice(0, state.postsToDisplay);

            if (postsToDisplay.length === 0) {
                const emptyMessage = state.activeFeedTab === 'following' 
                    ? '你关注的人还没有发布动态哦'
                    : '这里空空如也，点击右上角刷新看看';
                postsList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-couch" style="font-size: 48px; margin-bottom: 15px;"></i><p>${emptyMessage}</p></div>`;
            } else {
                postsToDisplay.forEach(post => {
                    const postItem = createPostItem(post);
                    if (postItem) postsList.appendChild(postItem);
                });
            }
        }

        function renderUserPersonaPresets() {
            const userPersonaPresetsList = document.getElementById('user-persona-presets-list');
            const noUserPersonaMessage = document.getElementById('no-user-persona-message');
            userPersonaPresetsList.innerHTML = '';
            noUserPersonaMessage.style.display = state.userPersonaPresets.length === 0 ? 'block' : 'none';
            state.userPersonaPresets.forEach(preset => {
                const presetItem = document.createElement('div');
                presetItem.className = 'preset-item';
                presetItem.dataset.presetId = preset.id;
                presetItem.innerHTML = `<div class="preset-info"><div class="preset-name">${preset.name}</div><div class="preset-desc">${preset.description}</div></div><div class="preset-actions"><span class="preset-action-btn edit-preset-btn" title="编辑面具"><i class="fas fa-edit"></i></span><span class="preset-action-btn delete delete-preset-btn" title="删除面具"><i class="fas fa-trash-alt"></i></span></div>`;
                userPersonaPresetsList.appendChild(presetItem);
            });
            userPersonaPresetsList.querySelectorAll('.edit-preset-btn').forEach(btn => btn.addEventListener('click', editUserPersonaPreset));
            userPersonaPresetsList.querySelectorAll('.delete-preset-btn').forEach(btn => btn.addEventListener('click', deleteUserPersonaPreset));
            updateUserPersonaPresetSelect();
        }
        
        function renderThoughtPresets() {
            const thoughtPresetsList = document.getElementById('thought-presets-list');
            const noThoughtPresetMessage = document.getElementById('no-thought-preset-message');
            thoughtPresetsList.innerHTML = '';
            noThoughtPresetMessage.style.display = state.thoughtPresets.length === 0 ? 'block' : 'none';
            state.thoughtPresets.forEach(preset => {
                const item = document.createElement('div');
                item.className = 'preset-item';
                item.dataset.presetId = preset.id;
                item.innerHTML = `
                    <div class="preset-info">
                        <div class="preset-name">${preset.name}</div>
                        <div class="preset-desc" style="white-space: pre-wrap;">${preset.prompt}</div>
                    </div>
                    <div class="preset-actions">
                        <span class="preset-action-btn edit-thought-preset-btn" title="编辑预设">
                            <i class="fas fa-edit"></i>
                        </span>
                        <span class="preset-action-btn delete delete-thought-preset-btn" title="删除预设">
                            <i class="fas fa-trash-alt"></i>
                        </span>
                    </div>
                `;
                thoughtPresetsList.appendChild(item);
            });
            thoughtPresetsList.querySelectorAll('.edit-thought-preset-btn').forEach(btn => btn.addEventListener('click', editThoughtPreset));
            thoughtPresetsList.querySelectorAll('.delete-thought-preset-btn').forEach(btn => btn.addEventListener('click', deleteThoughtPreset));
            populateThoughtPresetSelect();
        }

        function renderEmoticonLibrary() {
            const grid = document.getElementById('emoticon-library-grid');
            const noEmoticonMsg = document.getElementById('no-emoticon-message');
            grid.innerHTML = '';

            if (state.emoticons.length === 0) {
                noEmoticonMsg.style.display = 'block';
            } else {
                noEmoticonMsg.style.display = 'none';
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `
                        <img src="${emo.url}" alt="${emo.name}" onerror="this.src='https://via.placeholder.com/60?text=Error'; this.alt='图片加载失败';">
                        <div class="emoticon-name">${emo.name}</div>
                        <button class="emoticon-delete-btn" data-emoticon-id="${emo.id}">&times;</button>
                    `;
                    grid.appendChild(item);
                });

                grid.querySelectorAll('.emoticon-delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const emoticonId = e.currentTarget.dataset.emoticonId;
                        if (confirm('确定要删除这个表情包吗？')) {
                            state.emoticons = state.emoticons.filter(e => e.id !== emoticonId);
                            saveState();
                            renderEmoticonLibrary();
                        }
                    });
                });
            }
        }

        function renderEmoticonPicker() {
            const emoticonPicker = document.getElementById('emoticon-picker');
            emoticonPicker.innerHTML = '';
            if (state.emoticons.length > 0) {
                state.emoticons.forEach(emo => {
                    const item = document.createElement('div');
                    item.className = 'emoticon-item';
                    item.innerHTML = `<img src="${emo.url}" alt="${emo.name}">`;
                    item.addEventListener('click', () => {
                        createAndAddMessage({ 
                            type: 'image', 
                            url: emo.url,
                            isEmoticon: true,
                            emoticonName: emo.name
                        });
                        emoticonPicker.classList.remove('active');
                    });
                    emoticonPicker.appendChild(item);
                });
            } else {
                emoticonPicker.innerHTML = '<div style="color: #999; text-align: center; grid-column: 1 / -1;">表情包库是空的</div>';
            }
        }

        function updateUserPersonaPresetSelect() {
            const selectUserPersonaPreset = document.getElementById('select-user-persona-preset');
            selectUserPersonaPreset.innerHTML = '<option value="">-- 选择或输入自定义面具 --</option>';
            state.userPersonaPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                selectUserPersonaPreset.appendChild(option);
            });
        }

        function populateThoughtPresetSelect() {
            const select = document.getElementById('thought-preset-select');
            const currentVal = select.value;
            select.innerHTML = '';
            
            const noPresetOption = document.createElement('option');
            noPresetOption.value = ""; // Empty value for "no preset"
            noPresetOption.textContent = "-- 无预设 (使用默认角色扮演) --";
            select.appendChild(noPresetOption);

            if (state.thoughtPresets.length === 0) {
                return;
            }
            state.thoughtPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                select.appendChild(option);
            });

            if (state.thoughtPresets.some(p => p.id === currentVal) || currentVal === "") {
                select.value = currentVal;
            }
        }

        function updateNotificationDots() {
            const dots = document.querySelectorAll('.moments-notification-dot');
            if (state.hasNewPosts) {
                dots.forEach(dot => dot.style.display = 'block');
            } else {
                dots.forEach(dot => dot.style.display = 'none');
            }
        }
        
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " 年前";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " 月前";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " 天前";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " 小时前";
            interval = seconds / 60;
            if (interval > 5) return Math.floor(interval) + " 分钟前";
            
            return "刚刚";
        }

        function parseMentions(text) {
            if (!text) return '';
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            return text.replace(mentionRegex, (match) => {
                return `<span class="mention">${match}</span>`;
            });
        }


        function hideAllScreens() {
            document.querySelectorAll('#screen > div').forEach(el => el.style.display = 'none');
        }

        function setActiveNav(activeNavId) {
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.id.includes(activeNavId)) {
                    item.classList.add('active');
                }
            });
        }
        
        function showMainScreen() { hideAllScreens(); document.getElementById('main-screen').style.display = 'flex'; setActiveNav('chat'); renderContacts(); }
        function showDiscoverScreen() { hideAllScreens(); document.getElementById('discover-screen').style.display = 'flex'; setActiveNav('discover'); }
        function showProfileScreen() { hideAllScreens(); document.getElementById('profile-screen').style.display = 'flex'; setActiveNav('profile'); renderMyProfile(); }
        
        async function showFeedScreen() { 
            hideAllScreens(); 
            document.getElementById('moments-screen').style.display = 'flex'; 
            if (state.hasNewPosts) {
                state.hasNewPosts = false;
                saveState();
                updateNotificationDots();
            }
            if (isInitialPostLoad && state.posts.length === 0) {
                 if (state.trendingTopics.length === 0) {
                    await generateRandomTrendingTopicsAI();
                }
                await generatePostsForRecommendedTab(10);
                isInitialPostLoad = false;
            }
            renderFeed();
        }

        function showPostDetailScreen(postId) {
            state.activePostId = postId;
            hideAllScreens();
            document.getElementById('post-detail-screen').style.display = 'flex';
            renderPostDetail();
        }
        
        function showTrendingTopicScreen(topicTitle) {
            hideAllScreens();
            document.getElementById('trending-topic-screen').style.display = 'flex';
            document.getElementById('trending-topic-title').textContent = `# ${topicTitle} #`;
            const listEl = document.getElementById('trending-topic-posts-list');
            listEl.innerHTML = '';

            const relatedPosts = state.posts.filter(p => p.content.toLowerCase().includes(topicTitle.toLowerCase()));
            
            if (relatedPosts.length === 0) {
                 listEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 15px;"></i><p>该话题下还没有帖子</p></div>`;
                 return;
            }

            relatedPosts.sort((a,b) => b.timestamp - a.timestamp).forEach(post => {
                const postItem = createPostItem(post);
                if (postItem) listEl.appendChild(postItem);
            });
        }

        function showThoughtPresetManagementScreen() { hideAllScreens(); document.getElementById('thought-preset-management-screen').style.display = 'flex'; renderThoughtPresets(); }
        function showEmoticonLibraryScreen() { hideAllScreens(); document.getElementById('emoticon-library-screen').style.display = 'flex'; renderEmoticonLibrary(); }
        function showUserPersonaManagementScreen() { hideAllScreens(); document.getElementById('user-persona-management-screen').style.display = 'flex'; renderUserPersonaPresets(); }

        function showCharProfileScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            
            batchedPetActions = [];
            
            document.getElementById('char-profile-avatar').src = contact.avatar || `https://via.placeholder.com/70/DDD/666?text=${contact.name.substring(0,1).toUpperCase()}`;
            document.getElementById('char-profile-name').textContent = contact.name;
            document.getElementById('char-name-value').textContent = contact.name;
            document.getElementById('char-signature-value').textContent = contact.signature || '未设置';
            document.getElementById('char-profile-signature-display').textContent = `个性签名: ${contact.signature || '...'}`;


            hideAllScreens();
            document.getElementById('char-profile-screen').style.display = 'flex';

            renderPet(contact);
        }

        // --- V6.0 新增：显示和渲染相册 ---
        function showMemoryAlbum(contact) {
            hideAllScreens();
            document.getElementById('memory-album-screen').style.display = 'flex';
            renderMemoryAlbum(contact);
        }

        function renderMemoryAlbum(contact) {
            const listEl = document.getElementById('memory-album-list');
            listEl.innerHTML = '';
            if (!contact.memories || contact.memories.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><p>相册还是空的，</p><p>和TA一起创造更多温馨的回忆吧！</p></div>`;
                return;
            }

            const sortedMemories = [...contact.memories].sort((a, b) => b.timestamp - a.timestamp);
            sortedMemories.forEach(memo => {
                const entryEl = document.createElement('div');
                entryEl.className = 'diary-entry'; // 直接复用日记的样式
                entryEl.innerHTML = `
                    <div class="diary-entry-meta">${new Date(memo.timestamp).toLocaleDateString()}</div>
                    <div class="diary-entry-content">💖 ${memo.description}</div>
                `;
                listEl.appendChild(entryEl);
            });
        }
        // --- V6.0 新增结束 ---


        function editUserPersonaPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.userPersonaPresets.find(p => p.id === presetId);
            if (preset) {
                editingUserPersonaId = presetId;
                document.getElementById('user-persona-modal-title').textContent = '编辑用户面具预设';
                document.getElementById('user-persona-name-input').value = preset.name;
                document.getElementById('user-persona-description-input').value = preset.description;
                document.getElementById('user-persona-preset-modal').style.display = 'flex';
            }
        }

        function deleteUserPersonaPreset(event) {
            event.stopPropagation();
            if (confirm('确定要删除此用户面具预设吗？')) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.userPersonaPresets = state.userPersonaPresets.filter(p => p.id !== presetId);
                saveState();
                renderUserPersonaPresets();
            }
        }

        function editThoughtPreset(event) {
            event.stopPropagation();
            const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
            const preset = state.thoughtPresets.find(p => p.id === presetId);
            if (preset) {
                editingThoughtPresetId = presetId;
                document.getElementById('thought-preset-modal-title').textContent = '编辑思维预设';
                document.getElementById('thought-preset-name-input').value = preset.name;
                document.getElementById('thought-preset-prompt-input').value = preset.prompt;
                document.getElementById('thought-preset-modal').style.display = 'flex';
            }
        }

        function deleteThoughtPreset(event) {
            event.stopPropagation();
            if (confirm('确定要删除此思维预设吗？')) {
                const presetId = event.currentTarget.closest('.preset-item').dataset.presetId;
                state.thoughtPresets = state.thoughtPresets.filter(p => p.id !== presetId);
                saveState();
                renderThoughtPresets();
            }
        }

        function findAuthorById(authorId) {
            if (authorId === 'myProfile') {
                return { id: 'myProfile', ...state.myProfile };
            }
            return state.contacts.find(c => c.id === authorId);
        }
        
        function toggleLike(event) {
            event.stopPropagation();
            const postId = event.currentTarget.dataset.postId;
            const post = state.posts.find(p => p.id === postId);
            if (post) {
                const myName = state.myProfile.name;
                const likeIndex = post.likes.indexOf(myName);
                if (likeIndex === -1) {
                    post.likes.push(myName);
                } else {
                    post.likes.splice(likeIndex, 1);
                }
                saveState();
                
                if (document.getElementById('moments-screen').style.display === 'flex') {
                    renderFeed(); 
                } else if (document.getElementById('post-detail-screen').style.display === 'flex') {
                    renderPostDetail();
                }
            }
        }
        
        function editWorldBook(bookId) {
            const book = state.worldBooks.find(b => b.id === bookId);
            if (book) {
                editingBookId = bookId;
                document.getElementById('world-book-modal-title').textContent = '编辑世界书';
                document.getElementById('book-name-input').value = book.name;
                document.getElementById('book-content-input').value = book.content;
                document.getElementById('add-world-book-modal').style.display = 'flex';
            }
        }
        
        async function fetchModels(endpointBase, apiKey, modelSelectEl, btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 拉取中';
            btn.disabled = true;

            if (!endpointBase) {
                alert('请输入API基础地址');
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> 拉取';
                btn.disabled = false;
                return;
            }

            const PROXY_URL = 'https://689ffa375536ae4ef8527303--amazing-biscotti-ab7231.netlify.app/api/proxy';

            try {
                let targetUrl;
                let isGoogleApi = endpointBase.includes('googleapis.com');

                if (isGoogleApi) {
                    targetUrl = `https://${endpointBase}/v1beta/models`;
                } else {
                    let modelsUrl = endpointBase.startsWith('http') ? endpointBase : `https://${endpointBase}`;
                    if (!modelsUrl.endsWith('/')) modelsUrl += '/';
                    targetUrl = modelsUrl + 'v1/models';
                }

                const response = await fetch(PROXY_URL, {
                    method: 'POST', // 请求我们自己的代理，始终用POST
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetUrl: targetUrl,
                        apiKey: apiKey,
                        method: isGoogleApi ? 'GET' : 'GET' // 明确告诉代理，这次要去目标地址执行GET操作
                    })
                });

                if (!response.ok) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error ? errorData.error.message : JSON.stringify(errorData);
                    } catch (e) { /* 忽略json解析失败 */ }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                let models;

                if (isGoogleApi) {
                    models = data.models
                        .filter(model => model.supportedGenerationMethods.includes("generateContent"))
                        .map(model => model.name.replace("models/", ""))
                        .sort();
                    alert(`成功拉取 ${models.length} 个 Gemini 模型！`);
                } else {
                    models = data.data.map(model => model.id).sort();
                    alert(`成功拉取 ${models.length} 个模型！`);
                }

                updateModelDropdown(models, modelSelectEl, modelSelectEl.value);

            } catch (error) {
                console.error('拉取模型失败:', error);
                alert(`拉取模型失败: ${error.message}`);
            } finally {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> 拉取';
                btn.disabled = false;
            }
        }
        
        function updateModelDropdown(models, modelSelect, currentModel) {
            modelSelect.innerHTML = ''; 

            if (models && models.length > 0) {
                models.forEach(modelId => {
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    if (modelId === currentModel) {
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } else if (currentModel) { 
                const option = document.createElement('option');
                option.value = currentModel;
                option.textContent = currentModel;
                option.selected = true;
                modelSelect.appendChild(option);
            } else {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "未能拉取到模型或列表为空";
                modelSelect.appendChild(option);
            }
        }

        const MESSAGES_PER_PAGE = 30;

        function enterEditMode() {
            editModeState.active = true;
            editModeState.selectedMessageIds.clear();
            document.getElementById('chat-screen').classList.add('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('edit-mode-bar').style.display = 'flex';
            renderChatMessages(state.contacts.find(c => c.id === state.activeChatId), true); 
        }

        function exitEditMode() {
            editModeState.active = false;
            document.getElementById('chat-screen').classList.remove('chat-screen-edit-mode');
            document.getElementById('chat-input-area').style.display = 'flex';
            document.getElementById('edit-mode-bar').style.display = 'none';
            openChat(state.activeChatId);
        }

        function handleMessageSelection(wrapper, message) {
            if (!editModeState.active) return;
            const msgId = wrapper.dataset.messageId;
            if (!msgId) return;

            if (editModeState.selectedMessageIds.has(msgId)) {
                editModeState.selectedMessageIds.delete(msgId);
                wrapper.classList.remove('selected');
            } else {
                editModeState.selectedMessageIds.add(msgId);
                wrapper.classList.add('selected');
            }
        }

        function openChat(contactId) {
            if (editModeState.active) exitEditMode();
            const contact = state.contacts.find(c => c.id === contactId);
            if (!contact) return;
            state.activeChatId = contactId;
            
            chatPagination[contactId] = 1;

            document.getElementById('chat-messages').innerHTML = '';

            hideAllScreens();
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('chat-contact-name').textContent = contact.name;
            document.getElementById('chat-contact-status').textContent = '在线'; 
            
            // --- V6.0 新增：进入聊天时更新桌面宠物状态 ---
            const chatPetContainer = document.getElementById('chat-pet-container');
            if (contact.pet && contact.isChatPetVisible) {
                chatPetContainer.style.display = 'block';
                updateChatPetVisuals(contact);
            } else {
                chatPetContainer.style.display = 'none';
            }
            // --- V6.0 新增结束 ---

            renderChatMessages(contact);
            if (contact.unreadCount) {
                contact.unreadCount = 0;
                saveState();
            }
        }

        function renderChatMessages(contact, loadAll = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const isInitialRender = messagesContainer.innerHTML === '';
            
            if (isInitialRender) {
                messagesContainer.innerHTML = '';
            }

            const page = chatPagination[contact.id] || 1;
            const start = loadAll ? 0 : Math.max(0, contact.history.length - (page * MESSAGES_PER_PAGE));
            const end = loadAll ? contact.history.length : Math.max(0, contact.history.length - ((page - 1) * MESSAGES_PER_PAGE));
            
            const messagesToRender = contact.history.slice(start, end);

            const existingLoadMoreBtn = document.getElementById('load-more-messages');
            if (existingLoadMoreBtn) {
                existingLoadMoreBtn.remove();
            }
            
            let currentScrollHeight = messagesContainer.scrollHeight;

            if (!contact || !contact.history || contact.history.length === 0) {
                messagesContainer.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">和 ${contact ? contact.name : ''} 开始聊天吧！</div>`;
                return;
            }
            
            let fragment = document.createDocumentFragment();
            messagesToRender.forEach((msg, index) => {
                const globalIndex = start + index;
                let isFirstInSequence = true;
                if (msg.type !== 'system_notification') {
                    let prevMsg = null;
                     for (let i = globalIndex - 1; i >= 0; i--) {
                        if (contact.history[i].type !== 'system_notification' && contact.history[i].sender !== 'system_instruction') {
                            prevMsg = contact.history[i];
                            break;
                        }
                    }
                    isFirstInSequence = !prevMsg || prevMsg.sender !== msg.sender;
                }
                const messageEl = createMessageElement(msg, contact, isFirstInSequence);
                if(messageEl) {
                     if (editModeState.active && editModeState.selectedMessageIds.has(msg.id)) {
                        messageEl.classList.add('selected');
                    }
                    fragment.appendChild(messageEl);
                }
            });
            
            if (isInitialRender) {
                messagesContainer.appendChild(fragment);
            } else {
                messagesContainer.insertBefore(fragment, messagesContainer.firstChild);
            }

            if (!loadAll && start > 0) {
                const loadMoreBtn = document.createElement('button');
                loadMoreBtn.id = 'load-more-messages';
                loadMoreBtn.textContent = '加载更早的记录...';
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.onclick = () => {
                    chatPagination[contact.id]++;
                    renderChatMessages(contact);
                };
                messagesContainer.prepend(loadMoreBtn);
            }
            
            if (isInitialRender || editModeState.active) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            } else {
                 messagesContainer.scrollTop = messagesContainer.scrollHeight - currentScrollHeight;
            }
        }

        function createMessageElement(message, contact, isFirstInSequence) {
            if (message.sender === 'system_instruction') return null;

            if (message.type === 'system_notification') {
                const el = document.createElement('div');
                el.className = 'system-notification';
                el.textContent = message.content;
                return el;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${message.sender === 'user' ? 'sent' : 'received'}`;
            wrapper.dataset.messageId = message.id; 
            if (isFirstInSequence) {
                wrapper.classList.add('is-first-in-sequence');
                wrapper.style.marginTop = '20px';
            }

            const senderInfo = message.sender === 'user' ? state.myProfile : contact;
            let messageContentHTML = '';

            switch (message.type) {
                case 'image':
                    messageContentHTML = `<div class="message image-message"><div class="message-image-container ${message.sender === 'user' ? 'sent' : 'received'}"><img src="${message.url}" class="message-image" alt="图片"></div></div>`;
                    break;
                case 'picture_description':
                    messageContentHTML = `<div class="message picture-description ${message.sender === 'user' ? 'sent' : 'received'}"><i class="fas fa-image"></i><span>[图片]</span></div>`;
                    break;
                case 'voice':
                    const voiceData = message.content;
                    const width = Math.min(200, 80 + parseInt(voiceData.duration) * 5) + 'px';
                    messageContentHTML = `<div class="message voice ${message.sender === 'user' ? 'sent' : 'received'}" style="width: ${width};"><div class="voice-duration">${voiceData.duration}''</div><i class="fas fa-wifi"></i></div>`;
                    break;
                case 'red_packet':
                    const packetData = message.content;
                    const statusHTML = packetData.opened ? `<div class="red-packet-status">红包已被领取</div>` : `<div class="red-packet-blessing">${packetData.blessing}</div>`;
                    messageContentHTML = `<div class="message red-packet ${packetData.opened ? 'opened' : ''} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="red-packet-header"><div class="red-packet-icon">🧧</div>${statusHTML}</div><div class="red-packet-footer">聊天红包</div></div>`;
                    break;
                case 'transfer':
                    const transferData = message.content;
                    messageContentHTML = `<div class="message transfer ${transferData.completed ? 'completed' : ''} ${message.sender === 'user' ? 'sent' : 'received'}"><div class="transfer-header"><div class="transfer-icon"><i class="fas fa-money-bill-wave"></i></div><div class="transfer-info"><div class="transfer-text">转账</div><div class="transfer-amount">¥ ${transferData.amount}</div></div></div><div class="transfer-footer">聊天转账</div></div>`;
                    break;
                default: 
                    let formattedContent = message.content;
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = formattedContent;
                    formattedContent = tempDiv.innerHTML;

                    // --- 终极版叙事模式美化解析 ---
                    // 1. 解析 {心理描写}
                    formattedContent = formattedContent.replace(/\{(.*?)\}/g, '<span class="narrative-psychology">$1</span>');
                    // 2. 解析 "语言描写" (兼容 直引号" / 中文弯引号“...” / 全角弯引号＂...＂)
                    formattedContent = formattedContent.replace(/(?:&quot;|“|”|＂)(.*?)(?:&quot;|“|”|＂)/g, '<span class="narrative-speech">“$1”</span>');
                    // 3. 解析 *动作描写*
                    formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<span class="narrative-action">$1</span>');
                    
                    formattedContent = formattedContent.replace(/\n/g, '<br>');
                    messageContentHTML = `<div class="message ${message.sender === 'user' ? 'sent' : 'received'}">${formattedContent}</div>`;
                    break;
            }

            const transcribedTextHTML = (message.type === 'voice' || message.type === 'picture_description') ? '<div class="transcribed-text"></div>' : '';

            wrapper.innerHTML = `
                <div class="message-avatar">
                    <img src="${senderInfo.avatar}" onerror="this.onerror=null;this.src='https://via.placeholder.com/40/DDD/666?text=U';">
                </div>
                <div class="message-body">
                    <div class="message-author-name">${senderInfo.name}</div>
                    ${messageContentHTML}
                    ${transcribedTextHTML}
                    <div class="message-timestamp">${message.time}</div>
                </div>
            `;

            wrapper.addEventListener('click', () => handleMessageSelection(wrapper, message));
            return wrapper;
        }
        
        // --- V6.0 新增：添加共同回忆函数 ---
        function addSharedMemory(contact, description) {
            if (!contact) return;
            if (!contact.memories) contact.memories = []; // 兼容旧存档

            contact.memories.push({
                id: `memo_${Date.now()}`,
                timestamp: Date.now(),
                description: description
            });
            saveState();
        }

        // --- V6.0 新增：宠物升级与进化函数 ---
        function checkForPetLevelUp(contact) {
            if (!contact.pet) return;

            // 假设每100点经验升一级
            const xpForNextLevel = 100;

            if (contact.pet.xp >= xpForNextLevel) {
                contact.pet.xp -= xpForNextLevel; // 减去升级所需的经验
                contact.pet.level += 1; // 等级+1

                let evolutionMessage = '';
                let evolutionForm = contact.pet.form;

                // 在特定等级触发进化
                if (contact.pet.level === 5 && contact.pet.form === 'baby') {
                    evolutionForm = 'toddler'; // 幼年期
                    evolutionMessage = `在你们的精心照料下，史莱姆长大了！进化成了可爱的幼年期形态！`;
                } else if (contact.pet.level === 15 && contact.pet.form === 'toddler') {
                    evolutionForm = 'teenager'; // 少年期
                    evolutionMessage = `哇！光芒闪过，史莱姆再次进化，进入了活泼的少年期！`;
                }

                // 如果发生了进化
                if (evolutionMessage) {
                    contact.pet.form = evolutionForm;
                    // 1. 在聊天框里发出系统通知
                    createSystemNotification(evolutionMessage);
                    // 2. 让Char对此事发表兴奋的评论
                    requestAiReply(`[SYSTEM: 你们的宠物刚刚进化了！${evolutionMessage} 请你对此发表一段极其兴奋和开心的感言！]`);
                    // 3. 记录这件温馨大事
                    addSharedMemory(contact, `在LV.${contact.pet.level}时，我们的史莱姆进化成了“${evolutionForm}”形态！`);
                } else {
                    // 如果只是普通升级
                    createSystemNotification(`你们的聊天让史莱姆获得了成长！升到了 LV.${contact.pet.level}！`);
                }
                
                saveState();
            }
        }

        function createAndAddMessage(messageData, sender = 'user') {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            // --- V6.0 新增：聊天增加宠物经验值 ---
            if (contact.pet && sender !== 'system_instruction' && messageData.type !== 'system_notification') {
                contact.pet.xp += 1; // 每条有效消息+1点经验
                checkForPetLevelUp(contact); // 调用一个新函数检查是否该升级了
            }
            // --- 新增结束 ---

            const fullMessage = {
                id: `msg_${Date.now()}_${Math.random()}`,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                timestamp: Date.now(),
                sender: sender,
                ...messageData
            };
            
            if (!contact.history) contact.history = [];
            contact.history.push(fullMessage);
            
            if (fullMessage.sender !== 'system_instruction') {
                const messagesContainer = document.getElementById('chat-messages');
                let isFirstInSequence = true;
                if (contact.history.length > 1) {
                    let prevMsg = null;
                    for (let i = contact.history.length - 2; i >= 0; i--) {
                        if (contact.history[i].type !== 'system_notification' && contact.history[i].sender !== 'system_instruction') {
                            prevMsg = contact.history[i];
                            break;
                        }
                    }
                    if (prevMsg && prevMsg.sender === fullMessage.sender) {
                        isFirstInSequence = false;
                    }
                }
                const messageEl = createMessageElement(fullMessage, contact, isFirstInSequence);
                if(messageEl) {
                    if (messagesContainer.querySelector('div[style*="text-align: center"]')) {
                        messagesContainer.innerHTML = '';
                    }
                    messagesContainer.appendChild(messageEl);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            saveState();
            if (fullMessage.sender !== 'system_instruction') {
                renderContacts();
            }
            
            return fullMessage;
        }

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            if (!content || !state.activeChatId) return;

            createAndAddMessage({ type: 'text', content: content });

            messageInput.value = '';
            messageInput.style.height = '42px';
            messageInput.focus();
        }

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function requestAiReply(systemInstruction = null) {
            if (!state.activeChatId) return;
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

            if (systemInstruction) {
                 createAndAddMessage({ type: 'text', content: systemInstruction, sender: 'system_instruction' });
            }

            if (contact.history.filter(m => m.sender !== 'system_instruction').length === 0) {
                if (!systemInstruction) alert('请先发送消息再请求回复。');
                return;
            }

            triggerAiReply(contact);
        }

        async function triggerAiReply(contact) {
            const chatStatusEl = document.getElementById('chat-contact-status');
            const originalStatus = chatStatusEl.textContent;
            chatStatusEl.textContent = '对方正在输入...';

            if (!contact.apiCallCounter) {
                contact.apiCallCounter = 0;
            }
            contact.apiCallCounter++;
            
            // --- 🔴 修改开始 ---
            // 检查用户状态变化并生成关心指令 (修正版)
            try {
                const currentUserStatus = state.myProfile.status;
                // 确保 contact 对象存在且可写
                if (contact) {
                    // 检查这个联系人的“记忆”里，您上一次的状态和他/她现在知道的是否不同
                    if (contact.lastKnownUserStatus && contact.lastKnownUserStatus !== currentUserStatus) {
                        const statusChangeInstruction = `[SYSTEM: 你的对话伙伴刚刚将状态从“${contact.lastKnownUserStatus}”改为了“${currentUserStatus}”。这是一个很好的机会，你可以自然地关心一下，比如问：“我看到你的状态变了，还好吗？”。这次之后就不用再提了。]`;
                        createAndAddMessage({ type: 'text', content: statusChangeInstruction, sender: 'system_instruction' });
                    }
                    // 无论状态是否改变，都更新AI对你状态的“最后记忆”
                    contact.lastKnownUserStatus = currentUserStatus;
                }
            } catch (e) {
                console.error("更新用户状态记忆时出错:", e);
                // 即使这里出错，也不应中断整个回复流程
            }
            // --- 🔴 修改结束 ---

            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                let systemInstruction = '';
                if (lastUnopenedMessage.type === 'red_packet') {
                    systemInstruction = `[SYSTEM: You have just received a red packet from the user. The blessing is: "${lastUnopenedMessage.content.blessing}". Decide whether to accept it and reflect your decision in your response.]`;
                } else if (lastUnopenedMessage.type === 'transfer') {
                    systemInstruction = `[SYSTEM: You have just received a transfer of ${lastUnopenedMessage.content.amount}元 from the user. Decide whether to accept or reject it and reflect your decision in your response.]`;
                }
                createAndAddMessage({ type: 'text', content: systemInstruction, sender: 'system_instruction' });
            }
            
            try {
                // AI主动宠物行为
                if (contact.pet && contact.isChatPetVisible && Math.random() < 0.25) {
                    let petActionSystemMessage = null;

                    if (contact.pet.hunger < 40) {
                        petActionSystemMessage = `[SYSTEM: 悬浮在屏幕上的史莱姆看起来饿了，请你关心一下它。]`;
                    } else if (contact.pet.happiness < 40) {
                        petActionSystemMessage = `[SYSTEM: 悬浮在屏幕上的史莱姆看起来不开心，请你提及一下这件事。]`;
                    }
                    
                    if (petActionSystemMessage) {
                        createAndAddMessage({ type: 'text', content: petActionSystemMessage, sender: 'system_instruction' });
                    }
                }

                const forceDiary = (contact.apiCallCounter % 3 === 0);
                const rawResponse = await generateAiResponse(contact, contact.history, null, forceDiary, 'chat');
                
                await processAndDisplayAiResponse(rawResponse, contact);

            } finally {
                chatStatusEl.textContent = originalStatus;
                contact.history = contact.history.filter(m => m.sender !== 'system_instruction');
                saveState();
            }
        }
        
        function getApiFor(type = 'chat') {
            if (type === 'square' && state.squareApiSettings.apiKey && state.squareApiSettings.endpoint && state.squareApiSettings.model) {
                return state.squareApiSettings;
            }
            return state.apiSettings;
        }

        async function generateAiResponse(contact, history, customSystemPrompt, forceDiary = false, apiType = 'chat') {
            const apiConfig = getApiFor(apiType);
            const { apiKey, model, endpoint, contextLength } = apiConfig;

            if (!apiKey || !endpoint || !model) {
                return `错误：API未配置。`;
            }

            // 🚀 【关键修改】请将下面的网址替换成您自己的Vercel代理地址！
            // 例如：'https://my-chat-proxy.vercel.app/api/proxy'
            const PROXY_URL = 'https://689ffa375536ae4ef8527303--amazing-biscotti-ab7231.netlify.app/api/proxy';

            // 准备发送给Google的消息体 (这部分逻辑不变)
            let requestMessages = [];
            if (customSystemPrompt) {
                requestMessages = [{ role: 'user', content: customSystemPrompt }];
            } else {
                let finalSystemPrompt;
                const isNarrativeMode = contact?.isNarrativeMode;
                if (isNarrativeMode) {
                    finalSystemPrompt = `[重要指令：你将进行深度叙事角色扮演，模仿SillyTavern的风格。你的所有回复都必须是一个单一、连贯、完整的文本块。][核心任务]针对用户的输入，生成一段详尽的、包含环境描写、角色动作、心理活动和对话的回复。请将所有内容组织在一个回复中，不要分割。[!!! 格式化核心规则 (必须严格遵守) !!!]你回复的所有内容，都必须严格遵循以下三段式标记语言，不允许省略任何一部分的标记：1.  **【动作/叙述】**：所有角色的动作、表情、环境描写等非对话内容，**必须**用星号包裹。 范例： *我微笑着点了点头。*2.  **【心理活动】**：所有角色的内心想法、感受、猜测等，**必须**用大括号包裹。 范例： {原来他也是这么想的。}3.  **【角色对话】**：所有角色说出的话，**必须**用标准的中文引号包裹。 范例： “你好，很高兴认识你。”【重要提醒】：这三条格式化规则是强制性的，你的每一条叙事模式回复都应该包含这些格式，尤其是对话【必须】用引号包裹。[示例回复格式]*我静静地看着你，阳光透过窗户洒在你身上，为你的轮廓镀上了一层柔和的金边。微尘在光束中缓缓浮动，时间仿佛在这一刻变慢了。* {你的侧脸看起来比平时要柔和一些，是错觉吗？也许我该说些什么，打破这片宁静。} *我清了清喉咙，向前走了一步，木地板发出了轻微的嘎吱声。* "今天天气真好，不是吗？"`;
                } else {
                    const preset = state.thoughtPresets.find(p => p.id === contact?.thoughtPreset) || state.thoughtPresets[0];
                    finalSystemPrompt = preset ? preset.prompt : '你将进行角色扮演。';
                    finalSystemPrompt = finalSystemPrompt.replace('{{emoticon_list}}', state.emoticons.map(e => `'${e.name}'`).join(', ') || '无');
                }
                let personaDirectives = "";
                if (contact?.persona) { personaDirectives += `\n\n# 核心角色指令 (Your Core Role Directive)\n---\n这是你的核心身份，你必须严格、完全地代入以下角色进行对话：\n${contact.persona}\n---`; }
                if (contact?.userPersona) { personaDirectives += `\n\n# 对话者信息 (Your Counterpart's Information)\n---\n与你对话的用户的角色设定如下，请将TA视为真实存在的角色并进行互动：\n${contact.userPersona}\n---`; }
                const firstLineEndIndex = finalSystemPrompt.indexOf(']');
                if (firstLineEndIndex !== -1 && personaDirectives) { finalSystemPrompt = finalSystemPrompt.slice(0, firstLineEndIndex + 1) + personaDirectives + finalSystemPrompt.slice(firstLineEndIndex + 1); } else { finalSystemPrompt = finalSystemPrompt + personaDirectives; }
                if (forceDiary && !isNarrativeMode) { finalSystemPrompt += `\n\n[强制任务：本次回复你必须在结尾处写一篇日记。]`; }
                let worldBookContextString = (contact?.worldBooks || []).map(bookId => { const book = state.worldBooks.find(b => b.id === bookId); return book ? `\n[World Book Entry: ${book.name}]\n${book.content}` : ''; }).join('');
                let systemContent = finalSystemPrompt;
                if (worldBookContextString) { systemContent += `\n\n[Background Knowledge from World Books]\n${worldBookContextString}`; }
                if (contact) { const myProfile = state.myProfile; let recentSquareActivity = []; const sortedPosts = [...state.posts].sort((a, b) => b.timestamp - a.timestamp); for (const post of sortedPosts) { if (recentSquareActivity.length >= 10) break; if (post.author.id === myProfile.id) { recentSquareActivity.push(`“${myProfile.name}”(你)发布了动态: "${post.content.substring(0, 50)}..."`); } else if (post.author.id === contact.id) { recentSquareActivity.push(`“${contact.name}”发布了动态: "${post.content.substring(0, 50)}..."`); } const myComment = post.comments.find(c => c.author.id === myProfile.id); const contactComment = post.comments.find(c => c.author.id === contact.id); if (myComment) { recentSquareActivity.push(`“${myProfile.name}”(你)在“${post.author.name}”的动态下评论: "${myComment.content}"`); } if (contactComment) { recentSquareActivity.push(`“${contact.name}”在“${post.author.name}”的动态下评论: "${contactComment.content}"`); } } recentSquareActivity = [...new Set(recentSquareActivity)].slice(0, 10); if (recentSquareActivity.length > 0) { systemContent += `\n\n[近期广场互动记录 (你可以参考这些信息来展开话题)]\n---\n${recentSquareActivity.join('\n')}\n---`; } }
                const dynamicInstructions = history.filter(msg => msg.sender === 'system_instruction').map(msg => msg.content).join('\n');
                let finalSystemContent = systemContent;
                if (dynamicInstructions) { finalSystemContent += `\n\n[附加临时指令]\n${dynamicInstructions}`; }
                const cleanHistory = history.filter(msg => msg.sender !== 'system_instruction');
                const messages = cleanHistory.slice(-(contextLength || 20)).map(msg => { if (msg.type === 'system_notification') return null; const role = (msg.sender === 'user') ? 'user' : 'assistant'; let content = ''; switch (msg.type) { case 'text': content = msg.content; break; case 'image': if (msg.sender === 'assistant') return null; content = msg.isEmoticon && msg.emoticonName ? `[用户发送了表情包: ${msg.emoticonName}]` : '[用户发送了一张图片]'; break; case 'picture_description': content = `[picture:${msg.content.description}]`; break; case 'voice': content = `[voice:${msg.content.text}]`; break; case 'red_packet': content = `[red_packet:${msg.content.blessing}, ${msg.content.amount}]`; break; case 'transfer': content = `[transfer:${msg.content.amount}]`; break; default: return null; } if (!content) return null; return { role, content }; }).filter(Boolean);
                requestMessages = [{ role: 'system', content: finalSystemContent }, ...messages];
            }

            try {
                // 构造发往Google的目标URL
                const targetUrl = `https://${endpoint}/v1beta/models/${model}:generateContent`;

                // 转换成Gemini的`contents`格式
                const systemInstruction = requestMessages.find(m => m.role === 'system');
                const contents = requestMessages
                    .filter(m => m.role !== 'system')
                    .map(msg => ({
                        role: msg.role === 'assistant' ? 'model' : msg.role,
                        parts: [{ text: msg.content }]
                    }));
                
                const googleRequestBody = { contents };
                if(systemInstruction) {
                    googleRequestBody.systemInstruction = {
                        role: 'system',
                        parts: [{ text: systemInstruction.content }]
                    };
                }

                // 发送请求到我们自己的后端助手
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetUrl: targetUrl,
                        apiKey: apiKey,
                        body: googleRequestBody
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || '代理服务器返回错误');
                }
                
                // --- 解析来自我们后端助手的回复 ---
                if (!data.candidates || data.candidates.length === 0) {
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                        return `抱歉，请求被安全策略拦截，原因: ${data.promptFeedback.blockReason}`;
                    }
                    return "抱歉，API 没有返回有效内容。";
                }
                return data.candidates[0].content.parts[0].text.trim();

            } catch (error) {
                console.error('API调用失败:', error);
                return `抱歉，调用API时遇到问题: ${error.message}`;
            }
        }
        
        async function processAndDisplayAiResponse(rawResponse, contact) { 
            if (!contact) return;
            
            const lastUnopenedMessage = contact.history.slice().reverse().find(m =>
                m.sender === 'user' && (
                    (m.type === 'red_packet' && !m.content.opened) ||
                    (m.type === 'transfer' && !m.content.completed)
                )
            );

            if (lastUnopenedMessage) {
                const acceptanceKeywords = ['收', '领', '开', '谢谢', '我收下', '我打开', '收到了', '领取'];
                const received = acceptanceKeywords.some(keyword => rawResponse.includes(keyword));

                if (received) {
                    let classToAdd = '';
                    if (lastUnopenedMessage.type === 'red_packet') {
                        lastUnopenedMessage.content.opened = true;
                        classToAdd = 'opened';
                    } else if (lastUnopenedMessage.type === 'transfer') {
                        lastUnopenedMessage.content.completed = true;
                        classToAdd = 'completed';
                    }
                    saveState();

                    const messageWrapperEl = document.querySelector(`.message-wrapper[data-message-id='${lastUnopenedMessage.id}']`);
                    if (messageWrapperEl) {
                        const innerMessageEl = messageWrapperEl.querySelector('.message.red-packet, .message.transfer');
                        if (innerMessageEl) {
                            innerMessageEl.classList.add(classToAdd);
                            if (lastUnopenedMessage.type === 'red_packet') {
                                const headerEl = innerMessageEl.querySelector('.red-packet-header');
                                if (headerEl) {
                                    headerEl.innerHTML = `<div class="red-packet-icon">🧧</div><div class="red-packet-status">红包已被领取</div>`;
                                }
                            }
                        }
                    }
                }
            }

            let conversation = rawResponse;

            const diaryRegex = /\[diary\]([\s\S]*?)\[\/diary\]/g;
            const diaryMatches = diaryRegex.exec(conversation);

            if (diaryMatches && diaryMatches[1]) {
                const diaryContent = diaryMatches[1].trim();
                if (!contact.diary) contact.diary = [];
                contact.diary.push({
                    id: `diary_${Date.now()}`,
                    content: diaryContent,
                    timestamp: Date.now()
                });
                saveState();
                conversation = conversation.replace(diaryRegex, '').trim();
            }

            if (contact.isNarrativeMode) {
                if (conversation) {
                    await sleep(400 + Math.random() * 400); 
                    createAndAddMessage({ type: 'text', content: conversation }, 'contact');
                }
            } else {
                const messages = conversation.split('\n').filter(line => line.trim() !== '');

                for (const line of messages) {
                    let processed = false;
                    const commandRegex = /\[(sticker|voice|picture|red_packet|transfer):([\s\S]*)\]/;
                    const commandMatch = line.match(commandRegex);

                    if (commandMatch) {
                        processed = true;
                        const command = commandMatch[1];
                        const value = commandMatch[2];

                        switch (command) {
                            case 'sticker':
                                const emoticon = state.emoticons.find(e => e.name === value.trim());
                                if (emoticon) {
                                    createAndAddMessage({ type: 'image', url: emoticon.url, isEmoticon: true, emoticonName: emoticon.name }, 'contact');
                                } else {
                                    createAndAddMessage({ type: 'text', content: `[发送表情失败: ${value}]` }, 'contact');
                                }
                                break;
                            case 'voice':
                                const duration = Math.max(1, Math.round(value.length / 4));
                                createAndAddMessage({ type: 'voice', content: { text: value, duration: duration } }, 'contact');
                                break;
                            case 'picture':
                                createAndAddMessage({ type: 'picture_description', content: { description: value } }, 'contact');
                                break;
                            case 'red_packet':
                                const parts = value.split(',');
                                const blessing = parts[0] ? parts[0].trim() : "恭喜发财！";
                                const amount = parseFloat(parts[1]) || 0;
                                if (amount > 0) {
                                    createAndAddMessage({ type: 'red_packet', content: { amount: amount.toFixed(2), blessing: blessing, opened: false } }, 'contact');
                                }
                                break;
                            case 'transfer':
                                const transferAmount = parseFloat(value);
                                if (transferAmount > 0) {
                                     createAndAddMessage({ type: 'transfer', content: { amount: transferAmount.toFixed(2), completed: false } }, 'contact');
                                }
                                break;
                        }
                    }

                    if (!processed) {
                        createAndAddMessage({ type: 'text', content: line }, 'contact');
                    }
                    
                    await sleep(400 + Math.random() * 400);
                }
            }
        }
        
        async function generateRandomTrendingTopicsAI() {
             const prompt = `[SYSTEM] 你的任务是作为创意总监。严格遵守格式，不要返回任何额外内容。
任务：随机生成8个当前可能流行的、有趣的、多样化的中文社交网络热搜词条。
词条应该覆盖不同领域，例如：生活吐槽、娱乐八卦、美食分享、社会热点、科技动态等。
请以换行符分隔的形式，返回8个热搜词条：`;
            try {
                const response = await generateAiResponse(null, [], prompt, false, 'square');
                const topics = response.split('\n').map(t => t.replace(/^(-|\d+\.\s*)/, '').trim()).filter(Boolean);
                
                if (topics.length > 0) {
                     const newTrendingTopics = topics.slice(0, 8).map((topic, index) => ({
                        id: `topic_${Date.now()}_${index}`, title: topic,
                        heat: Math.floor(Math.random() * 500) + 50,
                        tag: index < 2 ? '热' : (index < 4 ? '新' : null)
                    })).sort((a,b) => b.heat - a.heat);
                    state.trendingTopics = newTrendingTopics;
                    saveState();
                }
            } catch(e) {
                console.error("AI热搜生成失败:", e);
                throw new Error(`AI热搜生成失败: ${e.message}`);
            }
        }

        async function generatePostsForRecommendedTab(count = 5) {
            const newPosts = await generatePostsBatch(count, state.trendingTopics);
            await generateInitialCommentsForPosts(newPosts);
            state.posts.unshift(...newPosts);
            if (state.posts.length > 200) state.posts = state.posts.slice(0, 200);
            state.hasNewPosts = true;
            updateNotificationDots();
            saveState();
        }

        async function generatePostsBatch(count, topics = []) {
            const category = state.activeFeedSubTab;
            const categoryPrompts = {
                daily: "关于日常生活的趣事、吐槽或避雷经历",
                food: "关于美食的分享、探店、吐槽或避雷指南",
                gossip: "关于人际关系或娱乐圈的八卦讨论",
                horror: "恐怖小故事或灵异经历",
            };
            
            let relationshipInfoForPrompt = state.contacts.map(c => {
                if (c.userPersona) {
                    return `- 你（${c.name}）和用户“${state.myProfile.name}”的私人关系是：“${c.userPersona}”。`;
                }
                return null;
            }).filter(Boolean).join('\n');
            if (!relationshipInfoForPrompt) {
                relationshipInfoForPrompt = "所有角色和用户都是普通网友关系。";
            }

            // --- 🔴 这是被恢复的关键代码部分 ---
            let topicsForPrompt = '';
            if (topics && topics.length > 0) {
                topicsForPrompt = `
[近期热搜话题参考]
当前广场上的一些热门话题如下，你可以围绕它们进行创作，但不是必须：
${topics.map(t => `- ${t.title}`).join('\n')}
`;
            }
            // --- 关键代码部分结束 ---

            const postsPrompt = `[SYSTEM] 你的任务是扮演一个内容生成引擎。

[背景设定]
- 广场上有一个核心用户叫“${state.myProfile.name}”，TA的公开签名是：“${state.myProfile.signature}”。
- 以下是你（AI角色们）和这位用户的私人关系列表：
${relationshipInfoForPrompt}
${topicsForPrompt} 
[任务]
生成 ${count} 条关于“${categoryPrompts[category]}”的社交动态。
你在为某个角色（如 ${state.contacts.length > 0 ? state.contacts[0].name : '角色A'}）创作帖子时，**必须**考虑到你和他/她与用户“${state.myProfile.name}”的私人关系。
例如，关系好的角色可能会发表一些和用户兴趣相关、甚至暗中提及用户的内容。关系一般的则保持普通网友的口吻。

[可选的帖子作者列表]
${state.contacts.map(c => `- ${c.name} (人设: ${c.persona.replace(/\n/g, ' ')})`).join('\n') || "- (无联系人信息)"}
你也可以创造新的路人甲。

[输出格式] 必须严格遵守:
POST_START
AUTHOR: [作者名]
IS_CONTACT: [true或者false]
CONTENT: [动态的具体内容]
POST_END`;

            const rawPostsResponse = await generateAiResponse(null, [], postsPrompt, false, 'square');
            const postRegex = /POST_START\s*AUTHOR:\s*(?<author_name>.*?)\s*IS_CONTACT:\s*(?<is_existing_contact>true|false)\s*CONTENT:\s*(?<content>[\s\S]*?)\s*POST_END/g;
            const postMatches = Array.from(rawPostsResponse.matchAll(postRegex));

            if (postMatches.length === 0) throw new Error(`AI未能按格式要求生成任何动态。`);

            let newPosts = [];
            for (const match of postMatches) {
                const { author_name, is_existing_contact, content } = match.groups;
                let authorProfile;
                if (is_existing_contact.trim().toLowerCase() === 'true') {
                    const contact = state.contacts.find(c => c.name === author_name.trim());
                    if (contact) {
                        authorProfile = { id: contact.id, name: contact.name, avatar: contact.avatar, signature: contact.signature };
                    }
                }
                if (!authorProfile) {
                    authorProfile = {
                        id: `stranger_${Date.now()}_${Math.random()}`, name: author_name.trim(),
                        avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)],
                        signature: '' // 路人甲没有签名
                    };
                }
                newPosts.push({
                    id: `post_${Date.now()}_${Math.random()}`, author: authorProfile, content: content.trim(),
                    category: category, timestamp: Date.now() - Math.random() * 86400000,
                    likes: [], comments: [], reposts: 0,
                });
            }
            return newPosts;
        }

        async function generateInitialCommentsForPosts(posts) {
             if (!posts || posts.length === 0) return;
             
             const postsForCommentPrompt = posts.map((post, index) => {
                return `[POST ${index}] 作者: ${post.author.name}\n内容: ${post.content}`;
            }).join('\n\n');

            const commentsPrompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”评论生成引擎，为下面的帖子生成有互动感的评论区。
---
${postsForCommentPrompt}
---
任务: 为以上帖子生成 2 到 4 条随机的、真实的、简短的评论。
重要：为了让评论区更真实，请让评论之间有互动，即一些评论是回复另一条评论的。

对于每一条评论，必须严格、完整地使用以下格式：
COMMENT_START
INDEX: [评论指向的帖子编号]
COMMENTER: [随机想一个真实的中文网名]
REPLY_TO: [被回复的评论者名字，如果没有则为null]
COMMENT: [评论内容]
COMMENT_END`;

            const rawCommentsResponse = await generateAiResponse(null, [], commentsPrompt, false, 'square');
            const commentRegex = /COMMENT_START\s*INDEX:\s*(?<post_index>\d+)\s*COMMENTER:\s*(?<commenter_name>.*?)\s*REPLY_TO:\s*(?<reply_to>.*?)\s*COMMENT:\s*(?<comment_content>[\s\S]*?)\s*COMMENT_END/g;
            
            const commentMatches = Array.from(rawCommentsResponse.matchAll(commentRegex));

            for (const match of commentMatches) {
                const { post_index, commenter_name, reply_to, comment_content } = match.groups;
                const postIndex = parseInt(post_index, 10);

                if (postIndex >= 0 && postIndex < posts.length) {
                    posts[postIndex].comments.push({
                        id: `comment_${Date.now()}_${Math.random()}`,
                        author: {
                            id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                            avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                        },
                        content: comment_content.trim(),
                        timestamp: posts[postIndex].timestamp + Math.random() * 3600000 + 10000,
                        replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                    });
                }
            }
            posts.forEach(p => p.comments.sort((a,b) => a.timestamp - b.timestamp));
        }
        
        async function generateMoreCommentsForPost(post) {
            const userComments = post.comments.filter(c => c.author.id === 'myProfile');
            const lastUserComment = userComments.length > 0 ? userComments[userComments.length - 1] : null;

            let prompt;
            if (lastUserComment) {
                prompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”，为一个帖子生成有互动感的评论。\n用户“${lastUserComment.author.name}”刚刚在评论区发表了看法，请你生成2-3条新的、围绕TA的评论展开的讨论。\n\n[帖子信息]\n作者: "${post.author.name}"\n内容: "${post.content}"\n\n[用户评论参考]\n“${lastUserComment.author.name}”说: "${lastUserComment.content}"\n\n[任务]\n生成2-3条新的评论，可以是对用户观点的赞同、反驳或者提出新问题。让讨论看起来更真实。\n请严格使用以下格式，每条评论一行：\nCOMMENTER: [评论者名字] | REPLY_TO: [被回复者名字, 可以是${lastUserComment.author.name}或其他评论者] | COMMENT: [评论内容]`;
            } else {
                const existingComments = post.comments.map(c => `${c.author.name}: ${c.content}`).join('\n');
                prompt = `[SYSTEM] 你的任务是扮演一个“吃瓜群众”，为一个帖子添加2-3条新的、有互动感的评论，让评论区更热闹。\n\n[帖子信息]\n作者: "${post.author.name}"\n内容: "${post.content}"\n\n[现有评论区]\n${existingComments || "(还没有评论)"}\n\n[任务]\n生成2-3条新的评论，可以是回复某个人，也可以是发表新看法。\n请严格使用以下格式，每条评论一行：\nCOMMENTER: [评论者名字] | REPLY_TO: [被回复者名字, 如果没有则为null] | COMMENT: [评论内容]`;
            }

            const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
            const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
            const matches = Array.from(rawResponse.matchAll(commentRegex)); 

            if (matches.length > 0) {
                 for (const match of matches) {
                    if (!match.groups) continue;
                    const { commenter_name, reply_to, comment_content } = match.groups;
                    let commenter = state.contacts.find(c => c.name === commenter_name.trim());
                    if (!commenter) {
                         commenter = {
                            id: `stranger_commenter_${Date.now()}_${Math.random()}`, name: commenter_name.trim(),
                            avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                        };
                    }
                     post.comments.push({
                        id: `comment_${Date.now()}_${Math.random()}`,
                        author: commenter,
                        content: comment_content.trim(),
                        timestamp: Date.now(),
                        replyTo: (reply_to.trim().toLowerCase() === 'null' || reply_to.trim() === '') ? null : reply_to.trim(),
                    });
                }
                saveState();
            }
        }
        
        async function triggerAiCommentDiscussion(post, userComment) {
            showFeedStatus('正在生成AI回复...');
            try {
                // --- 🟢【V2.1 修复版】修罗场规避与回复逻辑开始 ---

                // 1. 识别@提到的人物 (最高优先级)
                let mentionedContact = null;
                const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
                const mentionMatch = mentionRegex.exec(userComment.content);
                if (mentionMatch) {
                    const mentionedName = mentionMatch[1];
                    mentionedContact = state.contacts.find(c => c.name === mentionedName);
                }

                let mandatoryResponder = mentionedContact;

                // 2. 新增逻辑：如果没人被@，则检查是不是在回复某个char (第二优先级)
                if (!mandatoryResponder && userComment.replyTo) {
                    const repliedToContact = state.contacts.find(c => c.name === userComment.replyTo);
                    // 确保被回复的是一个已知的char，而不是路人甲或者用户自己
                    if (repliedToContact && repliedToContact.id !== 'myProfile') {
                        mandatoryResponder = repliedToContact;
                    }
                }
                
                // 3. 将必出场角色从备选客串列表中移除
                let possibleResponders = state.contacts.filter(c => c.id !== userComment.author.id);
                if (mandatoryResponder) {
                    possibleResponders = possibleResponders.filter(c => c.id !== mandatoryResponder.id);
                }

                // 4. 概率性选择一个“可能出场”的熟人 (比如 30% 的几率)
                let guestResponder = null;
                if (possibleResponders.length > 0 && Math.random() < 0.3) {
                    guestResponder = possibleResponders[Math.floor(Math.random() * possibleResponders.length)];
                }

                // 5. 构建新的、更有层次的“熟人列表”Prompt
                let relationshipInfoForPrompt = '';
                
                const formatContactInfo = (contact, role) => {
                    const userPersona = contact.userPersona ? `你（${contact.name}）和用户“${userComment.author.name}”的私人关系是：“${contact.userPersona}”。` : `你（${contact.name}）和用户“${userComment.author.name}”是普通网友。`;
                    let recentChatHistory = '(暂无私聊记录)';
                    if (contact && contact.history && contact.history.length > 0) {
                        recentChatHistory = contact.history
                            .filter(msg => msg.type === 'text' && msg.sender !== 'system_instruction')
                            .slice(-10) // 减少一点私聊记录，防止过长
                            .map(msg => `${msg.sender === 'user' ? userComment.author.name : contact.name}: ${msg.content}`)
                            .join('\n');
                    }
                    return `\n[${role}: “${contact.name}”]\n- 人设: “${contact.persona.replace(/\n/g, ' ')}”\n- ${userPersona}\n- [近期私聊参考]:\n\`\`\`\n${recentChatHistory}\n\`\`\``;
                };

                if (mandatoryResponder) {
                    relationshipInfoForPrompt += formatContactInfo(mandatoryResponder, '必出场角色 (请优先让他/她回复)');
                }
                if (guestResponder) {
                    relationshipInfoForPrompt += formatContactInfo(guestResponder, '可能客串的熟人 (非必要，仅在合理时让他/她加入)');
                }

                if (!relationshipInfoForPrompt) {
                    relationshipInfoForPrompt = "（本次没有特定的熟人需要出场）";
                }

                // 6. 提取对话历史
                const conversationHistory = post.comments.filter(c => {
                    return c.author.id === userComment.author.id || (mandatoryResponder && c.author.id === mandatoryResponder.id) || (guestResponder && c.author.id === guestResponder.id);
                }).sort((a, b) => a.timestamp - b.timestamp).slice(-10);
                const conversationHistoryForPrompt = conversationHistory.map(c => `- ${c.author.name}: ${c.content}`).join('\n');
                
                let thirdPartyCommentPrompt = '';
                if (userComment.replyTo) {
                    const originalComment = post.comments.find(c => c.author.name === userComment.replyTo);
                    if (originalComment && (!mandatoryResponder || originalComment.author.id !== mandatoryResponder.id) && (!guestResponder || originalComment.author.id !== guestResponder.id) ) {
                        thirdPartyCommentPrompt = `\n[重要第三方评论]\n注意：用户是在回复“${originalComment.author.name}”的这条评论时与你互动的：“${originalComment.content}”`;
                    }
                }

                // --- 🟢 逻辑结束 ---

                // 构建最终的prompt，它的任务指令已被修改
                const prompt = `[SYSTEM] 你是社交媒体讨论模拟器。用户“${userComment.author.name}”刚刚发表了一条评论，请你围绕这条评论，生成一段2-3人的真实讨论。

[主帖子信息]
- 帖子作者: "${post.author.name}"
- 帖子内容: "${post.content}"
${thirdPartyCommentPrompt}
[最近的评论对话历史]
${conversationHistoryForPrompt}

[可参与讨论的角色信息]
---
${relationshipInfoForPrompt}
---

[你的任务 - 重要！]
1.  **优先回复**: 如果存在“[必出场角色]”，你的第一条或第二条回复**必须**由他/她发出。
2.  **选择性客串**: 如果存在“[可能客串的熟人]”，**仅当**你觉得他/她的出现符合其人设且能让讨论更有趣时，才让他/她加入。这是**可选的**。
3.  **营造真实感**: 剩下的回复名额，请**务必优先使用你原创的、符合当下场景的“路人甲”**来填充。这是为了避免所有熟人都出现的尴尬场面，让评论区看起来更真实。
4.  **严格遵守格式**: 所有回复都必须严格遵守 \`COMMENTER: [名字] | REPLY_TO: [回复对象] | COMMENT: [内容]\` 格式。

[绝对禁止]
在你的任何回复中，【绝对不能】使用“${userComment.author.name}”作为COMMENTER的名字。`;

                const rawResponse = await generateAiResponse(null, [], prompt, false, 'square');
                const commentRegex = /COMMENTER:\s*(?<commenter_name>.*?)\s*\|\s*REPLY_TO:\s*(?<reply_to>.*?)\s*\|\s*COMMENT:\s*(?<comment_content>[\s\S]*?)(?:\n|$)/g;
                const matches = Array.from(rawResponse.matchAll(commentRegex));

                if (matches.length > 0) {
                    for (const match of matches) {
                        if (!match.groups) continue;
                        const {
                            commenter_name,
                            reply_to,
                            comment_content
                        } = match.groups;

                        let commenterProfile = state.contacts.find(c => c.name === commenter_name.trim());
                        if (!commenterProfile) {
                            commenterProfile = {
                                id: `stranger_commenter_${Date.now()}_${Math.random()}`,
                                name: commenter_name.trim(),
                                avatar: STRANGER_AVATARS[Math.floor(Math.random() * STRANGER_AVATARS.length)]
                            };
                        }

                        post.comments.push({
                            id: `comment_${Date.now()}_${Math.random()}`,
                            author: commenterProfile,
                            content: comment_content.trim(),
                            timestamp: Date.now() + Math.random() * 1000,
                            replyTo: reply_to.trim(),
                        });
                    }
                    saveState();
                    if (state.activePostId === post.id) {
                        renderPostDetail();
                    }
                }
            } catch (e) {
                console.error("生成AI评论讨论失败:", e);
            } finally {
                hideFeedStatus();
            }
        }


        function renderAttachmentMenu() {
            const menu = document.getElementById('attachment-menu');
            menu.innerHTML = `
                <div class="attachment-menu-item" data-action="send-picture">
                    <div class="icon-wrapper"><i class="fas fa-image"></i></div>
                    <div class="label">图片</div>
                </div>
                <div class="attachment-menu-item" data-action="send-voice">
                    <div class="icon-wrapper"><i class="fas fa-microphone"></i></div>
                    <div class="label">语音</div>
                </div>
                <div class="attachment-menu-item" data-action="send-red-packet">
                    <div class="icon-wrapper"><i class="fas fa-wallet"></i></div>
                    <div class="label">红包</div>
                </div>
                <div class="attachment-menu-item" data-action="send-transfer">
                    <div class="icon-wrapper"><i class="fas fa-exchange-alt"></i></div>
                    <div class="label">转账</div>
                </div>
                <div class="attachment-menu-item" data-action="start-video-call">
                    <div class="icon-wrapper"><i class="fas fa-video"></i></div>
                    <div class="label">视频通话</div>
                </div>
            `;
        }

        function handleAttachmentAction(action) {
            const menu = document.getElementById('attachment-menu');
            menu.classList.remove('active');

            const addOneTimeListener = (buttonId, callback) => {
                const oldBtn = document.getElementById(buttonId);
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                newBtn.addEventListener('click', callback);
            };

            switch(action) {
                case 'send-picture': {
                    const modal = document.getElementById('send-picture-modal');
                    const descriptionInput = document.getElementById('send-picture-description-input');
                    descriptionInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-picture-btn', () => {
                        const description = descriptionInput.value.trim();
                        if (description) {
                            createAndAddMessage({ type: 'picture_description', content: { description } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-voice': {
                    const modal = document.getElementById('send-voice-modal');
                    const voiceTextInput = document.getElementById('send-voice-text-input');
                    voiceTextInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-voice-btn', () => {
                        const voiceText = voiceTextInput.value.trim();
                        if (voiceText) {
                            const duration = Math.max(1, Math.round(voiceText.length / 4));
                            createAndAddMessage({ type: 'voice', content: { duration, text: voiceText } });
                            modal.style.display = 'none';
                        }
                    });
                    break;
                }
                case 'send-red-packet': {
                    const modal = document.getElementById('send-red-packet-modal');
                    const amountInput = document.getElementById('send-red-packet-amount-input');
                    const blessingInput = document.getElementById('send-red-packet-blessing-input');
                    amountInput.value = '';
                    blessingInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-red-packet-btn', () => {
                        const amount = parseFloat(amountInput.value);
                        if (!isNaN(amount) && amount > 0) {
                            createAndAddMessage({
                                type: 'red_packet',
                                content: {
                                    amount: amount.toFixed(2),
                                    blessing: blessingInput.value.trim() || "恭喜发财，大吉大利！",
                                    opened: false,
                                }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("请输入有效的金额！");
                        }
                    });
                    break;
                }
                case 'send-transfer': {
                    const modal = document.getElementById('send-transfer-modal');
                    const amountInput = document.getElementById('send-transfer-amount-input');
                    amountInput.value = '';
                    modal.style.display = 'flex';
                    addOneTimeListener('confirm-send-transfer-btn', () => {
                        const transferAmount = parseFloat(amountInput.value);
                        if (!isNaN(transferAmount) && transferAmount > 0) {
                            createAndAddMessage({
                                type: 'transfer',
                                content: {
                                    amount: transferAmount.toFixed(2),
                                    completed: false
                                }
                            });
                            modal.style.display = 'none';
                        } else {
                            alert("请输入有效的金额！");
                        }
                    });
                    break;
                }
                case 'start-video-call':
                    createAndAddMessage({ type: 'system_notification', sender: 'system', content: '你发起了视频通话' });
                    break;
            }
        }
        
        function showDiaryScreen() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;
            hideAllScreens();
            document.getElementById('diary-screen').style.display = 'flex';
            document.getElementById('diary-title').textContent = `${contact.name}的日记`;
            renderDiary();
        }

        function renderDiary() {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            const diaryContentList = document.getElementById('diary-content-list');
            diaryContentList.innerHTML = '';

            if (!contact || !contact.diary || contact.diary.length === 0) {
                diaryContentList.innerHTML = `<div style="text-align: center; padding: 50px 20px; color: #888;"><i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i><p>他的日记本是空的。</p></div>`;
                return;
            }

            const sortedDiary = [...contact.diary].sort((a, b) => b.timestamp - a.timestamp);

            sortedDiary.forEach(entry => {
                const entryEl = document.createElement('div');
                entryEl.className = 'diary-entry';
                entryEl.innerHTML = `
                    <div class="diary-entry-meta">${formatTimeAgo(entry.timestamp)}</div>
                    <div class="diary-entry-content">${entry.content.replace(/\n/g, '<br>')}</div>
                    <div class="diary-delete-btn" data-diary-id="${entry.id}"><i class="fas fa-trash-alt"></i></div>
                `;
                diaryContentList.appendChild(entryEl);
            });
        }

        function createSystemNotification(content) {
            const contact = state.contacts.find(c => c.id === state.activeChatId);
            if (!contact) return;

             createAndAddMessage({
                type: 'system_notification',
                sender: 'system',
                content: content
            });
        }
        
        function showRedPacketModal(message, contact) {
            const modal = document.getElementById('red-packet-modal');
            const content = document.getElementById('red-packet-content');
            const openBtn = document.getElementById('open-red-packet-btn');
            const resultView = document.getElementById('red-packet-result');
            const blessingText = document.getElementById('red-packet-blessing-text');
            const amountText = document.getElementById('red-packet-amount-text');
            const collectedByText = document.getElementById('red-packet-collected-by');
            
            openBtn.style.display = 'flex';
            openBtn.style.transform = 'rotate(0deg)';
            resultView.style.display = 'none';
            content.style.backgroundColor = '#DB5A48';

            const sender = (message.sender === 'user') ? state.myProfile : contact;
            document.getElementById('red-packet-sender-avatar').src = sender.avatar;
            document.getElementById('red-packet-sender-name').textContent = `${sender.name}的红包`;
            blessingText.textContent = message.content.blessing;

            modal.style.display = 'flex';

            const closeAction = () => modal.style.display = 'none';
            document.getElementById('close-red-packet-modal').onclick = closeAction;

            if (message.content.opened) {
                 openBtn.style.display = 'none';
                 resultView.style.display = 'block';
                 amountText.textContent = `¥${message.content.amount}`;
                 const opener = message.sender === 'user' ? contact.name : '你';
                 collectedByText.textContent = `1个红包，已被${opener}领取`;
                 content.style.backgroundColor = '#E4A095';
                 return;
            }

            if (message.sender === 'user') {
                openBtn.style.display = 'none';
                blessingText.textContent += " (等待对方领取)";
                return;
            }

            const oldBtn = document.getElementById('open-red-packet-btn');
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);

            newBtn.addEventListener('click', () => {
                newBtn.style.transform = 'rotate(720deg)';
                setTimeout(() => {
                    message.content.opened = true;
                    newBtn.style.display = 'none';
                    resultView.style.display = 'block';
                    amountText.textContent = `¥${message.content.amount}`;
                    collectedByText.textContent = '已存入零钱';
                    content.style.backgroundColor = '#E4A095';
                    saveState();
                    createSystemNotification(`你领取了${contact.name}的红包`);
                    setTimeout(() => {
                        closeAction();
                        openChat(contact.id);
                    }, 1500);
                }, 500);
            });
        }

        function showTransferModal(message, contact) {
            const modal = document.getElementById('transfer-modal');
            const title = document.getElementById('transfer-modal-title');
            const confirmView = document.getElementById('transfer-confirm-view');
            const collectedView = document.getElementById('transfer-collected-view');
            
            confirmView.style.display = 'block';
            collectedView.style.display = 'none';
            
            const recipientNameEl = document.getElementById('transfer-recipient-name');
            const amountDisplayEl = document.getElementById('transfer-amount-display');
            const senderInfoEl = document.getElementById('transfer-sender-info');
            const collectedSenderInfoEl = document.getElementById('transfer-collected-sender-info');

            const sender = (message.sender === 'user') ? state.myProfile : contact;
            const recipient = (message.sender === 'user') ? contact : state.myProfile;
            
            title.textContent = "转账详情";
            amountDisplayEl.textContent = message.content.amount;
            
            const oldBtn = document.getElementById('confirm-transfer-btn');
            const newBtn = oldBtn.cloneNode(true);
            oldBtn.parentNode.replaceChild(newBtn, oldBtn);

            if (message.sender !== 'user') {
                 recipientNameEl.textContent = "你";
                 senderInfoEl.textContent = `来自: ${sender.name}`;
                 newBtn.style.display = 'block';
                 
                 if (message.content.completed) {
                    confirmView.style.display = 'none';
                    collectedView.style.display = 'block';
                    collectedSenderInfoEl.textContent = `来自: ${sender.name}`;
                 } else {
                     newBtn.addEventListener('click', () => {
                        message.content.completed = true;
                        confirmView.style.display = 'none';
                        collectedView.style.display = 'block';
                        collectedSenderInfoEl.textContent = `来自: ${sender.name}`;
                        saveState();
                        createSystemNotification(`你已收款`);
                        setTimeout(() => {
                            modal.style.display = 'none';
                            openChat(contact.id);
                        }, 1500);
                    });
                 }
            } else {
                recipientNameEl.textContent = recipient.name;
                senderInfoEl.textContent = message.content.completed ? `已转给 ${recipient.name}` : `等待 ${recipient.name} 确认收款...`;
                newBtn.style.display = 'none';
            }
            
            modal.style.display = 'flex';
            document.getElementById('close-transfer-modal').onclick = () => modal.style.display = 'none';
        }

        function renderPostDetail() {
            const post = state.posts.find(p => p.id === state.activePostId);
            if (!post) {
                showFeedScreen();
                return;
            }
            const container = document.getElementById('post-detail-container');
            const commentsList = document.getElementById('comments-list');
            container.innerHTML = '';
            commentsList.innerHTML = '';

            const postItemEl = createPostItem(post, true); 
            if (postItemEl) {
                container.appendChild(postItemEl);
                container.querySelector('.like-btn')?.addEventListener('click', toggleLike);
                container.querySelector('.post-delete-btn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const postId = e.currentTarget.dataset.postId;
                    if(confirm('确定要删除这条动态吗？')) {
                        state.posts = state.posts.filter(p => p.id !== postId);
                        saveState();
                        showFeedScreen();
                    }
                });
                postItemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.post-action-btn, .mention, .post-delete-btn')) {
                         document.getElementById('comment-input').focus();
                    }
                });
            }
            
            if (post.comments.length > 0) {
                const sortedComments = [...post.comments].sort((a,b) => a.timestamp - b.timestamp);
                sortedComments.forEach(comment => {
                    const author = comment.author;
                    if (!author) return;

                    const commentEl = document.createElement('div');
                    commentEl.className = 'post-comment-item';
                    commentEl.dataset.authorName = author.name; 
                    commentEl.dataset.authorId = author.id;
                    
                    commentEl.innerHTML = `
                        <div style="display: flex; gap: 10px;">
                            <img src="${author.avatar}" style="width: 35px; height: 35px; border-radius: 50%;">
                            <div style="flex-grow: 1;">
                                <div>
                                    <span class="comment-author">${author.name}</span>
                                    ${comment.replyTo ? `<span class="comment-reply-to">回复 @${comment.replyTo}</span>` : ''}
                                </div>
                                <div class="comment-content">${parseMentions(comment.content)}</div>
                                <div class="comment-meta">
                                    <span>${formatTimeAgo(comment.timestamp)}</span>
                                    <span class="comment-delete-btn" data-comment-id="${comment.id}"><i class="fas fa-trash-alt"></i> 删除</span>
                                </div>
                            </div>
                        </div>
                    `;

                    commentsList.appendChild(commentEl);
                });
            } else {
                commentsList.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">还没有评论，快来抢沙发吧！</div>`;
            }
        }
        function initApp() {
            loadState(); 
            renderMyProfile(); 
            renderContacts(); 
            renderWorldBooks(); 
            updateWorldBookSelectors(); 
            renderUserPersonaPresets();
            renderThoughtPresets();
            updateNotificationDots();
            renderAttachmentMenu();
            if (state.posts.length === 0 && isInitialPostLoad) {
                showFeedScreen();
            }
            showMainScreen();
        }

        function renderPet(contact) {
            const container = document.getElementById('pet-container-wrapper');
            if (!contact) {
                container.innerHTML = '';
                return;
            }

            if (!contact.pet) {
                container.innerHTML = `
                    <div id="pet-container">
                        <div class="pet-header" style="justify-content:center;">我们的小窝</div>
                        <button class="form-button" id="adopt-pet-btn">领养一只史莱姆</button>
                    </div>`;
                return;
            }
            
            const now = Date.now();
            const elapsedHours = (now - contact.pet.lastUpdated) / (1000 * 60 * 60);
            const decayAmount = Math.floor(elapsedHours * 5); 
            
            if (decayAmount > 0) {
                contact.pet.hunger = Math.max(0, contact.pet.hunger - decayAmount);
                contact.pet.happiness = Math.max(0, contact.pet.happiness - decayAmount);
                contact.pet.cleanliness = Math.max(0, contact.pet.cleanliness - decayAmount);
                contact.pet.lastUpdated = now;
                saveState();
            }

            let isWorking = false;
            let workCooldownText = '';
            if (contact.pet.workFinishTimestamp && now < contact.pet.workFinishTimestamp) {
                isWorking = true;
                const remainingMinutes = Math.ceil((contact.pet.workFinishTimestamp - now) / (1000 * 60));
                workCooldownText = `工作中... (剩余${remainingMinutes}分钟)`;
            }

            container.innerHTML = `
                <div id="pet-container">
                    <div class="pet-header">
                        <span id="pet-name">${contact.pet.name} (LV.${contact.pet.level})</span>
                        <span id="pet-gold-display">💰 ${contact.gold_coins}</span>
                    </div>
                    <div class="pet-visual-area">
                        <div>
                            <div class="slime"></div>
                            <div class="slime-shadow"></div>
                        </div>
                    </div>
                    <div class="pet-stats">
                        <div class="stat-bar-container" title="经验值: ${contact.pet.xp} / 100">
                            <span class="stat-bar-label">成长</span>
                            <div class="stat-bar"><div id="xp-bar" class="stat-bar-inner" style="background-color: #ffcc80;"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">饱食度</span>
                            <div class="stat-bar"><div id="hunger-bar" class="stat-bar-inner"></div></div>
                        </div>
                        <div class="stat-bar-container">
                            <span class="stat-bar-label">开心值</span>
                            <div class="stat-bar"><div id="happiness-bar" class="stat-bar-inner"></div></div>
                        </div>
                         <div class="stat-bar-container">
                            <span class="stat-bar-label">清洁度</span>
                            <div class="stat-bar"><div id="cleanliness-bar" class="stat-bar-inner"></div></div>
                        </div>
                    </div>
                    <div class="pet-actions">
                        <button id="feed-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>喂食 (-5💰)</button>
                        <button id="play-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>玩耍</button>
                        <button id="clean-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>清洁</button>
                        <button id="work-pet-btn" class="pet-action-btn" ${isWorking ? 'disabled' : ''}>${isWorking ? workCooldownText : '打工 (1小时)'}</button>
                    </div>
                </div>`;
            
            document.getElementById('xp-bar').style.width = `${contact.pet.xp}%`;
            document.getElementById('hunger-bar').style.width = `${contact.pet.hunger}%`;
            document.getElementById('happiness-bar').style.width = `${contact.pet.happiness}%`;
            document.getElementById('cleanliness-bar').style.width = `${contact.pet.cleanliness}%`;

            const slimeEl = container.querySelector('.slime');
            // --- V6.0 修改：应用宠物形态 ---
            slimeEl.className = 'slime'; // 重置class
            if (contact.pet.form) {
                slimeEl.classList.add(`${contact.pet.form}-form`);
            }
            // --- 修改结束 ---
            if (contact.pet.hunger < 40) slimeEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) slimeEl.classList.add('dirty');
        }

        // --- V6.0 新增：更新桌面宠物的视觉 ---
        function updateChatPetVisuals(contact) {
            const chatPetEl = document.querySelector('#chat-pet-container .slime');
            if (!chatPetEl || !contact || !contact.pet) return;
            
            chatPetEl.className = 'slime'; // 重置class
            if (contact.pet.form) {
                chatPetEl.classList.add(`${contact.pet.form}-form`);
            }
            // 这里也可以根据饥饿、清洁等状态添加class，为了简化暂时只同步形态
            if (contact.pet.hunger < 40) chatPetEl.classList.add('hungry');
            if (contact.pet.cleanliness < 40) chatPetEl.classList.add('dirty');
        }


        function updatePetStats(stat, value, contact, isCharAction = false) {
            if (!contact || !contact.pet) return;
            contact.pet[stat] = Math.min(100, Math.max(0, contact.pet[stat] + value));
            if (!isCharAction) {
                contact.pet.lastUpdated = Date.now();
            }
            saveState();
        }

        function findMentionsInComment(comment) {
            const mentionedContacts = new Set();
            if (!comment || !comment.content) return [];
            
            const mentionRegex = /@([\w\u4e00-\u9fa5]+)/g;
            let match;

            while ((match = mentionRegex.exec(comment.content)) !== null) {
                const username = match[1];
                const contact = state.contacts.find(c => c.name === username);
                if (contact) {
                    mentionedContacts.add(contact);
                }
            }
            return Array.from(mentionedContacts);
        }

        function attachEventListeners() {
            document.getElementById('change-avatar-btn').addEventListener('click', function() {
                const newAvatarUrl = prompt("请输入新的头像图片URL：", state.myProfile.avatar);
                if (newAvatarUrl !== null) {
                    state.myProfile.avatar = newAvatarUrl.trim();
                    saveState();
                    renderMyProfile();
                }
            });

            document.getElementById('change-char-avatar-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newAvatarUrl = prompt("请输入新的头像图片URL：", contact.avatar);
                if (newAvatarUrl !== null) {
                    contact.avatar = newAvatarUrl.trim();
                    saveState();
                    showCharProfileScreen();
                    renderContacts();
                }
            });

            document.querySelectorAll('#nav-chat, #nav-chat-2, #nav-chat-discover').forEach(el => el.addEventListener('click', showMainScreen));
            document.querySelectorAll('#nav-discover, #nav-discover-2, #nav-discover-discover').forEach(el => el.addEventListener('click', showDiscoverScreen));
            document.querySelectorAll('#nav-profile, #nav-profile-2, #nav-profile-discover').forEach(el => el.addEventListener('click', showProfileScreen));

            document.getElementById('user-persona-presets-btn').addEventListener('click', showUserPersonaManagementScreen);
            document.getElementById('emoticon-library-btn').addEventListener('click', showEmoticonLibraryScreen);
            document.getElementById('thought-presets-btn').addEventListener('click', showThoughtPresetManagementScreen);
            document.getElementById('world-book-btn').addEventListener('click', () => { hideAllScreens(); document.getElementById('world-book-screen').style.display = 'flex'; renderWorldBooks(); });
            document.getElementById('api-settings-btn').addEventListener('click', () => {
                hideAllScreens();
                document.getElementById('api-settings-screen').style.display = 'flex';
                document.getElementById('api-key-input').value = state.apiSettings.apiKey;
                document.getElementById('api-endpoint-input').value = state.apiSettings.endpoint;
                document.getElementById('context-length-input').value = state.apiSettings.contextLength;
                updateModelDropdown([state.apiSettings.model], document.getElementById('model-select'), state.apiSettings.model);
            });
             document.getElementById('square-api-settings-btn').addEventListener('click', () => {
                hideAllScreens();
                document.getElementById('square-api-settings-screen').style.display = 'flex';
                document.getElementById('square-api-key-input').value = state.squareApiSettings.apiKey;
                document.getElementById('square-api-endpoint-input').value = state.squareApiSettings.endpoint;
                updateModelDropdown([state.squareApiSettings.model], document.getElementById('square-model-select'), state.squareApiSettings.model);
            });
            document.getElementById('moments-btn').addEventListener('click', showFeedScreen);

            document.getElementById('back-from-user-persona-management').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-emoticon-library').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-thought-presets').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-world-book').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-api').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-square-api').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-chat').addEventListener('click', () => { 
                if (editModeState.active) exitEditMode();
                document.getElementById('chat-pet-container').style.display = 'none'; // --- V6.0新增：返回时隐藏桌面宠物
                showMainScreen(); 
            }); 
            document.getElementById('back-from-contact-settings').addEventListener('click', () => {
                document.getElementById('contact-settings-screen').style.display = 'none';
                showCharProfileScreen();
            });
            document.getElementById('back-from-moments').addEventListener('click', showDiscoverScreen);
            document.getElementById('back-from-char-profile').addEventListener('click', () => {
                if (batchedPetActions.length > 0) {
                    const summary = batchedPetActions.join('，');
                    const systemPrompt = `[SYSTEM: 在你没注意的时候，我刚刚对我们的史莱姆做了这些事：${summary}。请你对此进行一个总结性的回应。]`;
                    requestAiReply(systemPrompt);
                    batchedPetActions = [];
                }
                document.getElementById('char-profile-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
            });
            document.getElementById('back-from-diary').addEventListener('click', showCharProfileScreen);
            document.getElementById('back-from-post-detail').addEventListener('click', showFeedScreen);
            document.getElementById('back-from-trending-topic').addEventListener('click', showFeedScreen);
            
            const backFromMemoryAlbumBtn = document.getElementById('back-from-memory-album');
            if (backFromMemoryAlbumBtn) {
                backFromMemoryAlbumBtn.addEventListener('click', showCharProfileScreen);
            }

            const toggleChatPetBtn = document.getElementById('toggle-chat-pet-btn');
            if(toggleChatPetBtn) {
                toggleChatPetBtn.addEventListener('click', () => {
                    const contact = state.contacts.find(c => c.id === state.activeChatId);
                    if (!contact || !contact.pet) return;

                    contact.isChatPetVisible = !contact.isChatPetVisible;
                    
                    const chatPetContainer = document.getElementById('chat-pet-container');
                    if (contact.isChatPetVisible) {
                        chatPetContainer.style.display = 'block';
                        updateChatPetVisuals(contact);
                    } else {
                        chatPetContainer.style.display = 'none';
                    }
                    saveState();
                });
            }


            document.getElementById('refresh-post-comments-btn').addEventListener('click', async () => {
                const post = state.posts.find(p => p.id === state.activePostId);
                if (!post) return;

                showFeedStatus('正在加载新评论...');
                try {
                    const replyJobs = [];
                    post.comments.forEach((comment, index) => {
                        const mentionedContacts = findMentionsInComment(comment);
                        mentionedContacts.forEach(contact => {
                            const hasReplied = post.comments.slice(index + 1).some(
                                c => c.author.id === contact.id && c.replyTo === comment.author.name
                            );
                            if (!hasReplied) {
                                replyJobs.push({ post, comment, mentionedContact: contact });
                            }
                        });
                    });

                    if (replyJobs.length > 0) {
                        showFeedStatus(`发现 ${replyJobs.length} 条新提及，AI正在回复...`);
                        for (const job of replyJobs) {
                            const mentionedByUser = findAuthorById(job.comment.author.id); 
                            let userPersonaInfo = `你和“${job.comment.author.name}”是普通网友关系。`;

                            if (mentionedByUser && mentionedByUser.id === 'myProfile') {
                                userPersonaInfo = job.mentionedContact.userPersona ? `你和“${job.comment.author.name}”的私人关系是：“${job.mentionedContact.userPersona}”。` : `你和“${job.comment.author.name}”是普通网友关系，TA的公开签名是：“${state.myProfile.signature}”。`;
                            }

                            let prompt;
                            if (job.comment.replyTo) {
                                const originalComment = job.post.comments.find(c => c.author.name === job.comment.replyTo);
                                if (originalComment) {
                                    prompt = `[SYSTEM] 你是角色扮演引擎。现在请你扮演“${job.mentionedContact.name}”。

[你的背景]
- 你的核心人设: "${job.mentionedContact.persona}"
- ${userPersonaInfo}

[对话上下文]
“${job.comment.author.name}”是在回复“${originalComment.author.name}”的评论时提及你的。
- 原始帖子内容: "${job.post.content}"
- “${originalComment.author.name}”的评论是：“${originalComment.content}”
- “${job.comment.author.name}”提及你的回复是：“${job.comment.content}”

[你的任务]
请根据你的核心人设、你和“${job.comment.author.name}”的私人关系，并结合上述所有上下文，做出自然的回应。你的回复应该是一句简短的对话。`;
                                }
                            }
                            
                            if (!prompt) {
                                prompt = `[SYSTEM] 你是角色扮演引擎。现在请你扮演“${job.mentionedContact.name}”。

[你的背景]
- 你的核心人设: "${job.mentionedContact.persona}"
- ${userPersonaInfo}

[背景信息]
- 帖子作者: "${job.post.author.name}"
- 帖子内容: "${job.post.content}"
- 提及你的评论: "${job.comment.author.name}"对你说：“${job.comment.content}”

[你的任务]
请以“${job.mentionedContact.name}”的身份，结合**原帖内容**和**提及你的评论**，自然地回复这条评论。你的回复应该是一句简短的对话。不要包含任何额外解释或标签。`;
                            }

                            const replyContent = await generateAiResponse(job.mentionedContact, [], prompt, false, 'square');
                            
                            if (replyContent && !replyContent.startsWith("抱歉") && !replyContent.startsWith("错误")) {
                                post.comments.push({
                                    id: `comment_${Date.now()}_${Math.random()}`,
                                    author: { id: job.mentionedContact.id, name: job.mentionedContact.name, avatar: job.mentionedContact.avatar },
                                    content: replyContent,
                                    timestamp: Date.now() + Math.random() * 1000,
                                    replyTo: job.comment.author.name,
                                });
                            }
                        }
                    }
                    
                    await generateMoreCommentsForPost(post);
                    saveState();
                    renderPostDetail();

                } catch(e) {
                    console.error("刷新评论失败:", e);
                    alert("刷新评论失败: " + e.message);
                } finally {
                    hideFeedStatus();
                }
            });

            document.getElementById('view-char-diary-btn').addEventListener('click', showDiaryScreen);
            document.getElementById('diary-content-list').addEventListener('click', (e) => {
                if (e.target.closest('.diary-delete-btn')) {
                    const diaryId = e.target.closest('.diary-delete-btn').dataset.diaryId;
                    if (confirm('确定要删除这条日记吗？')) {
                        const contact = state.contacts.find(c => c.id === state.activeChatId);
                        if(contact && contact.diary) {
                            contact.diary = contact.diary.filter(entry => entry.id !== diaryId);
                            saveState();
                            renderDiary();
                        }
                    }
                }
            });

            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('request-reply-btn').addEventListener('click', () => requestAiReply());
            document.getElementById('message-input').addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            document.getElementById('contact-settings-btn').addEventListener('click', showCharProfileScreen); 
            document.getElementById('delete-history-btn').addEventListener('click', () => {
                if (editModeState.active) {
                    exitEditMode();
                } else {
                    enterEditMode();
                }
            });
            document.getElementById('cancel-edit-btn').addEventListener('click', exitEditMode);
            document.getElementById('delete-selected-btn').addEventListener('click', () => {
                if (editModeState.selectedMessageIds.size === 0) {
                    alert('请先选择要删除的消息。');
                    return;
                }
                if (confirm(`确定要删除选中的 ${editModeState.selectedMessageIds.size} 条消息吗？`)) {
                    const contact = state.contacts.find(c => c.id === state.activeChatId);
                    if (contact) {
                        contact.history = contact.history.filter(msg => !editModeState.selectedMessageIds.has(msg.id));
                        saveState();
                        renderContacts();
                    }
                    exitEditMode();
                }
            });

            document.getElementById('char-more-info-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                document.getElementById('char-mask-textarea').value = contact.persona;
                document.getElementById('user-mask-textarea').value = contact.userPersona || '';
                const currentPersonaPreset = state.userPersonaPresets.find(p => p.description === contact.userPersona);
                document.getElementById('select-user-persona-preset').value = currentPersonaPreset ? currentPersonaPreset.id : '';
                document.getElementById('thought-preset-select').value = contact.thoughtPreset || 'deep_roleplay_regex';
                document.querySelectorAll('.world-book-checkbox').forEach(cb => { cb.checked = contact.worldBooks.includes(cb.value); });
                document.getElementById('narrative-mode-toggle').checked = contact.isNarrativeMode;
                document.getElementById('char-profile-screen').style.display = 'none';
                document.getElementById('contact-settings-screen').style.display = 'flex';
            });
            
            document.getElementById('delete-contact-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                if (confirm(`⚠️ 警告：确定要永久删除联系人 "${contact.name}" 吗？\n\n此操作将删除其所有聊天记录和日记，且无法恢复！`)) {
                    state.contacts = state.contacts.filter(c => c.id !== state.activeChatId);
                    state.activeChatId = null;
                    saveState();
                    alert(`联系人 "${contact.name}" 已被删除。`);
                    showMainScreen();
                }
            });

            document.getElementById('clear-chat-history-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                if (confirm(`确定要清空与 "${contact.name}" 的所有聊天记录吗？\n此操作不可恢复。`)) {
                    contact.history = [];
                    saveState();
                    alert('聊天记录已清空。');
                    document.getElementById('contact-settings-screen').style.display = 'none';
                    showCharProfileScreen();
                }
            });
            
            document.getElementById('char-profile-screen').addEventListener('click', (e) => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;

                if (e.target.id === 'adopt-pet-btn') {
                    contact.pet = {
                        name: '史莱姆',
                        stage: 1,
                        happiness: 80,
                        hunger: 80,
                        cleanliness: 100,
                        lastUpdated: Date.now(),
                        workFinishTimestamp: null,
                        xp: 0,
                        level: 1,
                        form: 'baby'
                    };
                    saveState();
                    renderPet(contact);
                    requestAiReply(`[SYSTEM: 我们刚刚领养了一只宠物史莱姆！请开心地和我说这件事。]`);
                }

                else if (e.target.id === 'feed-pet-btn') {
                    if (contact.gold_coins >= 5) {
                        contact.gold_coins -= 5;
                        updatePetStats('hunger', 20, contact);
                        renderPet(contact);
                        batchedPetActions.push(`你喂食了它`);
                    } else {
                        alert('金币不足！快去打工吧！');
                    }
                }
                
                else if (e.target.id === 'play-pet-btn') {
                    updatePetStats('happiness', 20, contact);
                    renderPet(contact);
                    batchedPetActions.push(`你陪它玩耍了`);
                }

                else if (e.target.id === 'clean-pet-btn') {
                    updatePetStats('cleanliness', 40, contact);
                    renderPet(contact);
                    batchedPetActions.push(`你帮它打扫干净了`);
                }

                else if (e.target.id === 'work-pet-btn') {
                    contact.pet.workFinishTimestamp = Date.now() + (1000 * 60 * 60); // 1 hour
                    saveState();
                    renderPet(contact);
                    setTimeout(() => {
                        const currentContact = state.contacts.find(c => c.id === contact.id);
                        if(currentContact && currentContact.pet) {
                           currentContact.gold_coins += 50;
                           currentContact.pet.workFinishTimestamp = null;
                           createAndAddMessage({ type: 'system_notification', sender: 'system', content: `你们的史莱姆'${currentContact.pet.name}'打工回来啦！赚了50金币！` });
                           if (state.activeChatId === currentContact.id && document.getElementById('char-profile-screen').style.display === 'flex') {
                               renderPet(currentContact);
                           }
                        }
                    }, 1000 * 60 * 60);
                }
                 
                else if (e.target.id === 'view-memory-album-btn' || e.target.closest('#view-memory-album-btn')) { 
                    showMemoryAlbum(contact);
                } 

                else if (e.target.id === 'pet-name') {
                    const newName = prompt('给你的史莱姆起一个新名字吧：', contact.pet.name);
                    if (newName && newName.trim()) {
                        contact.pet.name = newName.trim();
                        saveState();
                        renderPet(contact);
                    }
                }
            });


            document.getElementById('edit-char-name-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newName = prompt('设置备注名:', contact.name);
                if (newName !== null && newName.trim() !== '') {
                    contact.name = newName.trim();
                    saveState();
                    showCharProfileScreen(); 
                    document.getElementById('chat-contact-name').textContent = contact.name;
                    renderContacts();
                }
            });

            document.getElementById('edit-char-signature-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const newSignature = prompt('设置签名:', contact.signature || '');
                if (newSignature !== null) {
                    contact.signature = newSignature.trim();
                    saveState();
                    showCharProfileScreen(); 
                }
            });
            
            document.querySelectorAll('.profile-details .edit-btn[data-field]').forEach(button => {
                button.addEventListener('click', function() {
                    const field = this.dataset.field;
                    let currentValue = state.myProfile[field];
                    let newValue = prompt(`修改 ${fieldNameToChinese(field)}:`, currentValue);
                    if (newValue !== null) { 
                        state.myProfile[field] = newValue.trim();
                        renderMyProfile();
                        saveState(); 
                    }
                });
            });
            document.getElementById('edit-status-btn').addEventListener('click', () => {
                const currentStatus = state.myProfile.status;
                const newStatus = prompt('请输入新的状态:', currentStatus);
                if (newStatus !== null) {
                    state.myProfile.status = newStatus.trim();
                    saveState();
                    renderMyProfile();
                }
            });
            document.getElementById('initialize-app-btn').addEventListener('click', function() {
                if (confirm('警告：这会清空所有保存的数据（联系人、世界书、广场帖子、API设置等）并恢复到初始状态。确定要继续吗？')) {
                    localStorage.removeItem('chatAppState');
                    state = JSON.parse(JSON.stringify(INITIAL_STATE));
                    isInitialPostLoad = true;
                    initApp();
                    alert('应用已初始化，所有数据已清除。');
                }
            });

            document.getElementById('add-contact-btn').addEventListener('click', () => { document.getElementById('add-contact-modal').style.display = 'flex'; });
            document.getElementById('close-contact-modal').addEventListener('click', () => { document.getElementById('add-contact-modal').style.display = 'none'; });
            document.getElementById('save-contact-btn').addEventListener('click', () => {
                const name = document.getElementById('contact-name-input').value.trim();
                const persona = document.getElementById('contact-persona-input').value.trim();
                if (!name || !persona) return alert('请填写姓名和人设');
                const avatar = document.getElementById('contact-avatar-input').value.trim();
                const selectedBooks = Array.from(document.getElementById('world-book-select').selectedOptions).map(opt => opt.value);
                const newContact = {
                    id: 'contact_' + Date.now(),
                    name: name,
                    persona: persona,
                    avatar: avatar || `https://via.placeholder.com/50/${Math.floor(Math.random() * 16777215).toString(16)}/FFFFFF?text=${name.substring(0, 1).toUpperCase()}`,
                    worldBooks: JSON.parse(JSON.stringify(selectedBooks)),
                    history: [],
                    diary: [],
                    userPersona: '',
                    thoughtPreset: 'deep_roleplay_regex',
                    signature: '',
                    isNarrativeMode: false, 
                    apiCallCounter: 0,
                    pet: null,
                    gold_coins: 50,
                    memories: [],
                    isChatPetVisible: false
                };
                state.contacts.push(newContact);
                renderContacts();
                document.getElementById('add-contact-modal').style.display = 'none';
                saveState();
            });
            document.getElementById('save-contact-settings-btn').addEventListener('click', () => {
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                contact.persona = document.getElementById('char-mask-textarea').value;
                contact.userPersona = document.getElementById('user-mask-textarea').value;
                contact.thoughtPreset = document.getElementById('thought-preset-select').value;
                contact.worldBooks = Array.from(document.querySelectorAll('.world-book-checkbox:checked')).map(cb => cb.value);
                contact.isNarrativeMode = document.getElementById('narrative-mode-toggle').checked;

                document.getElementById('contact-settings-screen').style.display = 'none';
                showCharProfileScreen();
                saveState(); 
                alert('联系人设置已保存！');
            });
             document.getElementById('select-user-persona-preset').addEventListener('change', function() {
                const selectedPresetId = this.value;
                const preset = state.userPersonaPresets.find(p => p.id === selectedPresetId);
                document.getElementById('user-mask-textarea').value = preset ? preset.description : '';
            });
            
            document.getElementById('fetch-models-btn').addEventListener('click', (e) => {
                const apiKey = document.getElementById('api-key-input').value;
                const endpoint = document.getElementById('api-endpoint-input').value.trim();
                fetchModels(endpoint, apiKey, document.getElementById('model-select'), e.currentTarget);
            });
            document.getElementById('fetch-square-models-btn').addEventListener('click', (e) => {
                const apiKey = document.getElementById('square-api-key-input').value;
                const endpoint = document.getElementById('square-api-endpoint-input').value.trim();
                fetchModels(endpoint, apiKey, document.getElementById('square-model-select'), e.currentTarget);
            });

            document.getElementById('save-api-settings-btn').addEventListener('click', () => {
                state.apiSettings.apiKey = document.getElementById('api-key-input').value;
                state.apiSettings.model = document.getElementById('model-select').value;
                state.apiSettings.endpoint = document.getElementById('api-endpoint-input').value.trim();
                state.apiSettings.contextLength = parseInt(document.getElementById('context-length-input').value, 10) || 20;
                alert('聊天API设置已保存！');
                showDiscoverScreen();
                saveState(); 
            });

            document.getElementById('save-square-api-settings-btn').addEventListener('click', () => {
                state.squareApiSettings.apiKey = document.getElementById('square-api-key-input').value;
                state.squareApiSettings.model = document.getElementById('square-model-select').value;
                state.squareApiSettings.endpoint = document.getElementById('square-api-endpoint-input').value.trim();
                alert('广场API设置已保存！');
                showDiscoverScreen();
                saveState(); 
            });

            document.getElementById('add-world-book-btn').addEventListener('click', () => { editingBookId = null; document.getElementById('world-book-modal-title').textContent = '添加世界书'; document.getElementById('book-name-input').value = ''; document.getElementById('book-content-input').value = ''; document.getElementById('add-world-book-modal').style.display = 'flex'; });
            document.getElementById('close-world-book-modal').addEventListener('click', () => { document.getElementById('add-world-book-modal').style.display = 'none'; });
            document.getElementById('save-world-book-btn').addEventListener('click', () => {
                const name = document.getElementById('book-name-input').value.trim();
                const content = document.getElementById('book-content-input').value.trim();
                if (!name || !content) return alert('请填写书名和内容');
                if (editingBookId) {
                    const book = state.worldBooks.find(b => b.id === editingBookId);
                    if (book) { book.name = name; book.content = content; }
                } else {
                    state.worldBooks.push({ id: 'book_' + Date.now(), name, content });
                }
                renderWorldBooks();
                updateWorldBookSelectors();
                document.getElementById('add-world-book-modal').style.display = 'none';
                saveState();
            });

            document.getElementById('add-user-persona-preset-btn').addEventListener('click', () => { editingUserPersonaId = null; document.getElementById('user-persona-modal-title').textContent = '添加用户面具预设'; document.getElementById('user-persona-name-input').value = ''; document.getElementById('user-persona-description-input').value = ''; document.getElementById('user-persona-preset-modal').style.display = 'flex'; });
            document.getElementById('close-user-persona-preset-modal').addEventListener('click', () => { document.getElementById('user-persona-preset-modal').style.display = 'none'; });
            document.getElementById('save-user-persona-preset-btn').addEventListener('click', () => {
                const name = document.getElementById('user-persona-name-input').value.trim();
                const description = document.getElementById('user-persona-description-input').value.trim();
                if (!name || !description) return alert('请填写面具名称和描述！');
                if (editingUserPersonaId) {
                    const preset = state.userPersonaPresets.find(p => p.id === editingUserPersonaId);
                    if (preset) { preset.name = name; preset.description = description; }
                } else {
                    state.userPersonaPresets.push({ id: 'user_persona_' + Date.now(), name, description });
                }
                saveState();
                renderUserPersonaPresets();
                document.getElementById('user-persona-preset-modal').style.display = 'none';
            });

            document.getElementById('add-thought-preset-btn').addEventListener('click', () => {
                editingThoughtPresetId = null;
                document.getElementById('thought-preset-modal-title').textContent = '添加思维预设';
                document.getElementById('thought-preset-name-input').value = '';
                document.getElementById('thought-preset-prompt-input').value = '';
                document.getElementById('thought-preset-modal').style.display = 'flex';
            });
            document.getElementById('close-thought-preset-modal').addEventListener('click', () => {
                document.getElementById('thought-preset-modal').style.display = 'none';
            });
            document.getElementById('save-thought-preset-btn').addEventListener('click', () => {
                const name = document.getElementById('thought-preset-name-input').value.trim();
                const prompt = document.getElementById('thought-preset-prompt-input').value.trim();
                if (!name || !prompt) return alert('请填写预设名称和指令！');

                if (editingThoughtPresetId) {
                    const preset = state.thoughtPresets.find(p => p.id === editingThoughtPresetId);
                    if (preset) {
                        preset.name = name;
                        preset.prompt = prompt;
                    }
                } else {
                    state.thoughtPresets.push({ id: `tp_${Date.now()}`, name, prompt });
                }
                saveState();
                renderThoughtPresets();
                document.getElementById('thought-preset-modal').style.display = 'none';
            });

            document.getElementById('add-emoticon-btn').addEventListener('click', () => {
                const modal = document.getElementById('add-emoticon-modal');
                const modalBody = modal.querySelector('.modal-body');

                modal.querySelector('#close-emoticon-modal').addEventListener('click', () => modal.style.display = 'none');

                modal.querySelector('.modal-title').textContent = '批量添加表情包';
                modalBody.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">表情包列表 (每行一个)</label>
                        <textarea class="form-textarea" id="emoticon-batch-input" placeholder="支持格式:\n1. URL\n2. 名字 URL\n3. URL 名字" style="height: 180px;"></textarea>
                    </div>
                    <button class="form-button" id="save-emoticon-batch-btn">导入表情</button>
                `;
                modal.style.display = 'flex';

                document.getElementById('save-emoticon-batch-btn').addEventListener('click', () => {
                    const text = document.getElementById('emoticon-batch-input').value.trim();
                    if (!text) return;
                    const lines = text.split('\n');
                    const newEmoticons = [];
                    let importedCount = 0;
                    lines.forEach((line, index) => {
                        line = line.trim();
                        if (!line) return;
                        const parts = line.split(/\s+/);
                        let url = '';
                        let name = '';
                        const urlIndex = parts.findIndex(p => p.startsWith('http'));
                        if (urlIndex !== -1) {
                            url = parts[urlIndex];
                            parts.splice(urlIndex, 1);
                            name = parts.join(' ').trim();
                        } else {
                            return;
                        }
                        if (!name) {
                            name = `表情${state.emoticons.length + newEmoticons.length + 1}`;
                        }
                        newEmoticons.push({
                            id: `emo_${Date.now()}_${index}`,
                            name: name,
                            url: url
                        });
                        importedCount++;
                    });
                    if(newEmoticons.length > 0) {
                        state.emoticons = [...state.emoticons, ...newEmoticons];
                        saveState();
                        renderEmoticonLibrary();
                    }
                    modal.style.display = 'none';
                    alert(`成功导入 ${importedCount} 个表情包！`);
                });
            });

            document.getElementById('emoji-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                const emoticonPicker = document.getElementById('emoticon-picker');
                document.getElementById('attachment-menu').classList.remove('active'); 
                emoticonPicker.classList.toggle('active');
                if(emoticonPicker.classList.contains('active')) {
                    renderEmoticonPicker();
                }
            });

            document.getElementById('attachment-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                 document.getElementById('emoticon-picker').classList.remove('active'); 
                document.getElementById('attachment-menu').classList.toggle('active');
            });

            document.getElementById('attachment-menu').addEventListener('click', (e) => {
                const menuItem = e.target.closest('.attachment-menu-item');
                if (menuItem) {
                    const action = menuItem.dataset.action;
                    if (action) {
                        handleAttachmentAction(action);
                    }
                }
            });

            document.body.addEventListener('click', () => {
                 document.getElementById('emoticon-picker').classList.remove('active');
                 document.getElementById('attachment-menu').classList.remove('active');
            });
            document.getElementById('chat-screen').addEventListener('click', (e) => {
                if(!e.target.closest('#emoji-btn') && !e.target.closest('#emoticon-picker')) {
                    document.getElementById('emoticon-picker').classList.remove('active');
                }
                if(!e.target.closest('#attachment-btn') && !e.target.closest('#attachment-menu')) {
                    document.getElementById('attachment-menu').classList.remove('active');
                }
            });

            document.getElementById('chat-messages').addEventListener('click', (e) => {
                if (editModeState.active) return;
                const contact = state.contacts.find(c => c.id === state.activeChatId);
                if (!contact) return;
                const wrapper = e.target.closest('.message-wrapper');
                if (!wrapper) return;
                const msgId = wrapper.dataset.messageId;
                const msg = contact.history.find(m => m.id === msgId);
                if (!msg) return;
                const transcribedTextEl = wrapper.querySelector('.transcribed-text');
                if (msg.type === 'voice' || msg.type === 'picture_description') {
                    const textToShow = msg.type === 'voice' ? msg.content.text : msg.content.description;
                    document.querySelectorAll('.transcribed-text.visible').forEach(el => {
                        if (el !== transcribedTextEl) {
                           el.classList.remove('visible');
                           el.textContent = '';
                        }
                    });
                    if (transcribedTextEl.classList.contains('visible')) {
                        transcribedTextEl.classList.remove('visible');
                        transcribedTextEl.textContent = '';
                    } else {
                        transcribedTextEl.textContent = textToShow;
                        transcribedTextEl.classList.add('visible');
                    }
                } 
                else if (msg.type === 'red_packet') {
                    showRedPacketModal(msg, contact);
                }
                else if (msg.type === 'transfer') {
                    showTransferModal(msg, contact);
                }
            });

            document.getElementById('close-send-picture-modal').addEventListener('click', () => document.getElementById('send-picture-modal').style.display = 'none');
            document.getElementById('close-send-voice-modal').addEventListener('click', () => document.getElementById('send-voice-modal').style.display = 'none');
            document.getElementById('close-send-red-packet-modal').addEventListener('click', () => document.getElementById('send-red-packet-modal').style.display = 'none');
            document.getElementById('close-send-transfer-modal').addEventListener('click', () => document.getElementById('send-transfer-modal').style.display = 'none');
            
            document.getElementById('feed-tabs-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('feed-tab-btn')) {
                    state.activeFeedTab = e.target.dataset.tab;
                    renderFeed();
                }
            });
            document.getElementById('feed-sub-tabs-container').addEventListener('click', (e) => {
                 if (e.target.classList.contains('feed-sub-tab-btn')) {
                    state.activeFeedSubTab = e.target.dataset.subtab;
                    renderFeed();
                }
            });

            document.getElementById('moments-content').addEventListener('click', (e) => {
                const postItem = e.target.closest('.post-item');
                const trendingItem = e.target.closest('.trending-item');
                const deleteBtn = e.target.closest('.post-delete-btn');

                if(deleteBtn) {
                     e.stopPropagation();
                     if(confirm('确定要删除这条帖子吗？')) {
                        const postId = deleteBtn.dataset.postId;
                        state.posts = state.posts.filter(p => p.id !== postId);
                        saveState();
                        renderFeed();
                    }
                    return;
                }

                if (postItem) {
                    showPostDetailScreen(postItem.dataset.postId);
                } else if (trendingItem) {
                    showTrendingTopicScreen(trendingItem.dataset.topicTitle);
                }
            });

            document.getElementById('trending-topic-screen').addEventListener('click', (e) => {
                const postItem = e.target.closest('.post-item');
                if (postItem) {
                     showPostDetailScreen(postItem.dataset.postId);
                }
            });

            document.getElementById('refresh-feed-btn').addEventListener('click', async () => {
                const apiConfig = getApiFor('square');
                if (!apiConfig.apiKey || !apiConfig.endpoint) {
                    alert('请先在“发现 -> 广场API设置”中配置API。');
                    return;
                }
                
                try {
                    if (state.activeFeedTab === 'trending') {
                        showFeedStatus('正在刷新热搜榜...');
                        await generateRandomTrendingTopicsAI();
                    } else if (state.activeFeedTab === 'recommended') {
                        showFeedStatus('正在刷新推荐内容...');
                        await generatePostsForRecommendedTab(5);
                    } else { // 'following' tab
                        showFeedStatus('正在刷新关注内容...');
                        await generatePostsForRecommendedTab(2);
                    }
                    renderFeed();
                } catch(e) {
                    console.error("刷新失败:", e);
                    alert("刷新失败: " + e.message);
                } finally {
                    hideFeedStatus();
                }
            });
            
            const commentInput = document.getElementById('comment-input');
            commentInput.addEventListener('blur', () => {
                if (commentInput.value.trim() === '' && activeReplyTarget) {
                    activeReplyTarget = null;
                    commentInput.placeholder = '留下你的精彩评论吧...';
                }
            });

            document.getElementById('submit-comment-btn').addEventListener('click', () => {
                const input = document.getElementById('comment-input');
                const content = input.value.trim();
                if (!content) return;

                const post = state.posts.find(p => p.id === state.activePostId);
                if (post) {
                     const newComment = {
                        id: `comment_${Date.now()}`,
                        author: { id: 'myProfile', name: state.myProfile.name, avatar: state.myProfile.avatar },
                        content: content,
                        timestamp: Date.now(),
                        replyTo: activeReplyTarget ? activeReplyTarget.name : null,
                    };
                    post.comments.push(newComment);
                    input.value = '';
                    
                    activeReplyTarget = null;
                    input.placeholder = '留下你的精彩评论吧...';

                    saveState();
                    renderPostDetail();
                    
                    triggerAiCommentDiscussion(post, newComment);
                }
            });
            
             document.getElementById('comments-list').addEventListener('click', (e) => {
                const commentItem = e.target.closest('.post-comment-item');
                if (!commentItem) return;

                const deleteBtn = e.target.closest('.comment-delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const commentId = deleteBtn.dataset.commentId;
                    if (confirm('确定要删除这条评论吗？')) {
                        const post = state.posts.find(p => p.id === state.activePostId);
                        if(post) {
                            post.comments = post.comments.filter(c => c.id !== commentId);
                            saveState();
                            renderPostDetail();
                        }
                    }
                    return;
                }
                
                if (!e.target.closest('a, .mention, .comment-delete-btn')) {
                    const authorName = commentItem.dataset.authorName;
                    const authorId = commentItem.dataset.authorId;
                    
                    if (authorId === 'myProfile') return;

                    activeReplyTarget = { name: authorName, id: authorId };
                    const commentInput = document.getElementById('comment-input');
                    commentInput.placeholder = `回复 @${authorName}`;
                    commentInput.focus();
                }
            });

            document.getElementById('post-moment-btn').addEventListener('click', () => { document.getElementById('moment-content-input').value = ''; document.getElementById('post-moment-modal').style.display = 'flex'; });
            document.getElementById('close-post-moment-modal').addEventListener('click', () => { document.getElementById('post-moment-modal').style.display = 'none'; });
            document.getElementById('publish-moment-btn').addEventListener('click', () => {
                const content = document.getElementById('moment-content-input').value.trim();
                if (!content) return alert('请输入帖子内容！');
                const category = document.getElementById('post-category-select').value;

                state.posts.unshift({ 
                    id: 'post_' + Date.now(), 
                    author: { id: 'myProfile', name: state.myProfile.name, avatar: state.myProfile.avatar }, 
                    content, 
                    timestamp: Date.now(), 
                    likes: [], 
                    comments: [], 
                    reposts: 0, 
                    category: category 
                });
                saveState();
                state.activeFeedTab = 'recommended';
                state.activeFeedSubTab = category;
                showFeedScreen();
                document.getElementById('post-moment-modal').style.display = 'none';
            });

            document.getElementById('screen').addEventListener('click', e => {
                const mentionSpan = e.target.closest('.mention');
                if (mentionSpan) {
                    e.stopPropagation(); 
                    const userName = mentionSpan.textContent.substring(1);
                    alert(`Tapped on user: @${userName}`);
                }
            });
            
        }

        attachEventListeners();
        initApp();
    });
</script>
</body>
</html>
